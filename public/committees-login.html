<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8">
  <title>ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ - Ù†Ø¸Ø§Ù… Ø§Ù„Ù„Ø¬Ø§Ù†</title>
  <link rel="icon" type="image/png" href="https://www.dropbox.com/scl/fi/f283e4rvv5cf9x12a1cic/my-website-logo.png?rlkey=yia776im7klypy27af32m0scy&e=1&st=vhaprvzh&dl=1"
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <!-- Bootstrap (RTL) + Icons -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.rtl.min.css" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css" rel="stylesheet">

  <style>
    body {
      background: linear-gradient(135deg, #f3f4f6, #e5e7eb);
      font-family: 'Segoe UI', Tahoma, sans-serif;
      min-height: 100vh;
      display: flex;
      align-items: center;
    }
    .login-card {
      max-width: 420px; width: 100%; margin: auto;
      background: #fff; border-radius: 16px;
      box-shadow: 0 15px 30px rgba(0,0,0,.08);
      overflow: hidden;
    }
    .login-header {
      background: #0d6efd; color: #fff; padding: 18px; text-align: center;
    }
    .brand {
      font-size: 18px; font-weight: 700; display: flex; align-items: center; gap: 8px; justify-content: center;
    }
    .brand i { font-style: normal; font-weight: 400; opacity: .9; }
    .login-body { padding: 20px 22px 24px; }
    .form-control:focus { box-shadow: 0 0 0 .2rem rgba(13,110,253,.15); }
    .btn-primary { border-radius: 10px; }
    .toast-container { position: fixed; top: 20px; left: 50%; transform: translateX(-50%); z-index: 2000; }
    .spinner-border-sm { --bs-spinner-width: 1rem; --bs-spinner-height: 1rem; }
    .password-toggle-btn { min-width: 2.75rem; }
  </style>
</head>
<body>
  <div class="login-card" aria-live="polite">
    <div class="login-header">
      <div class="brand">ğŸ” Ù†Ø¸Ø§Ù… Ø§Ù„Ù„Ø¬Ø§Ù† <i>| ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„</i></div>
    </div>

    <div class="login-body">
      <form id="loginForm" novalidate>
        <div class="mb-3">
          <label class="form-label" for="username">Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…</label>
          <input
            type="text"
            id="username"
            class="form-control"
            placeholder="Ù…Ø«Ø§Ù„: b01578"
            autocomplete="username"
            autocapitalize="none"
            spellcheck="false"
            inputmode="text"
            required
          >
          <div class="invalid-feedback">ÙŠØ±Ø¬Ù‰ Ø¥Ø¯Ø®Ø§Ù„ Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù….</div>
        </div>

        <div class="mb-2">
          <label class="form-label" for="password">ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±</label>
          <div class="input-group">
            <input
              type="password"
              id="password"
              class="form-control"
              placeholder="â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢"
              autocomplete="current-password"
              required
            >
            <button
              id="togglePwBtn"
              class="btn btn-outline-secondary password-toggle-btn"
              type="button"
              aria-label="Ø¥Ø¸Ù‡Ø§Ø± ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±"
              title="Ø¥Ø¸Ù‡Ø§Ø±/Ø¥Ø®ÙØ§Ø¡ ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±"
            >
              <i class="bi bi-eye" aria-hidden="true"></i>
            </button>
            <div class="invalid-feedback">ÙŠØ±Ø¬Ù‰ Ø¥Ø¯Ø®Ø§Ù„ ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±.</div>
          </div>
        </div>

        <div class="d-grid mt-3">
          <button type="submit" id="submitBtn" class="btn btn-primary" aria-busy="false">
            <span class="btn-text">Ø¯Ø®ÙˆÙ„</span>
            <span class="btn-wait d-none">
              <span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span>
              Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù‚Ù‚...
            </span>
          </button>
        </div>
      </form>
    </div>
  </div>

  <!-- Toasts -->
  <div class="toast-container">
    <div id="toastSuccess" class="toast text-bg-success border-0" role="alert" aria-live="assertive" aria-atomic="true" data-bs-delay="3500" data-bs-autohide="true">
      <div class="d-flex">
        <div class="toast-body">âœ… ØªÙ… ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø¨Ù†Ø¬Ø§Ø­</div>
        <button type="button" class="btn-close btn-close-white m-2 me-3" data-bs-dismiss="toast" aria-label="Close"></button>
      </div>
    </div>
    <div id="toastError" class="toast text-bg-danger border-0" role="alert" aria-live="assertive" aria-atomic="true" data-bs-delay="5000" data-bs-autohide="true">
      <div class="d-flex">
        <div class="toast-body">âŒ Ø­Ø¯Ø« Ø®Ø·Ø£</div>
        <button type="button" class="btn-close btn-close-white m-2 me-3" data-bs-dismiss="toast" aria-label="Close"></button>
      </div>
    </div>
    <div id="toastInfo" class="toast text-bg-primary border-0" role="status" aria-live="polite" aria-atomic="true" data-bs-delay="2500" data-bs-autohide="true">
      <div class="d-flex">
        <div class="toast-body">â„¹ï¸</div>
        <button type="button" class="btn-close btn-close-white m-2 me-3" data-bs-dismiss="toast" aria-label="Close"></button>
      </div>
    </div>
  </div>

  <!-- Scripts -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  <script>
    /* === Ø¥Ø¹Ø¯Ø§Ø¯ Ø£Ø³Ø§Ø³ Ø§Ù„ÙˆØ§Ø¬Ù‡Ø© Ø§Ù„Ø®Ù„ÙÙŠØ© Ø­Ø³Ø¨ Ø§Ù„Ø¨ÙŠØ¦Ø© === */
    const RENDER_BASE = 'https://vdash-qkyv.onrender.com';
    const host = location.hostname;
    const isGithub = host.endsWith('github.io');
    const isLocal  = host === 'localhost' || host === '127.0.0.1';
    const API_BASE = isGithub ? RENDER_BASE : (isLocal ? 'http://localhost:3000' : '');
    const go = (path) => isGithub ? (RENDER_BASE + path) : path;

    /* === Toast helpers === */
    const TSuccess = new bootstrap.Toast(document.getElementById('toastSuccess'));
    const TError   = new bootstrap.Toast(document.getElementById('toastError'));
    const TInfo    = new bootstrap.Toast(document.getElementById('toastInfo'));
    function setToast(el, msg) { el._element.querySelector('.toast-body').textContent = msg; }
    function showSuccess(msg){ setToast(TSuccess, msg); TSuccess.show(); }
    function showError(msg){ setToast(TError, msg); TError.show(); }
    function showInfo(msg){ setToast(TInfo, msg); TInfo.show(); }

    /* === Password toggle (Ø«Ø§Ø¨ØªØ© ÙˆØªØ¹Ù…Ù„ Ù…Ø¹ Ø§Ù„Ø£ÙŠÙ‚ÙˆÙ†Ø©) === */
    const pwInput = document.getElementById('password');
    const togglePwBtn = document.getElementById('togglePwBtn');
    togglePwBtn.addEventListener('click', () => {
      const isPw = pwInput.type === 'password';
      pwInput.type = isPw ? 'text' : 'password';
      // ØªØ¨Ø¯ÙŠÙ„ Ø§Ù„Ø£ÙŠÙ‚ÙˆÙ†Ø© ÙˆÙ†Øµ Ø§Ù„ÙˆØµÙˆÙ„ÙŠØ©
      const icon = togglePwBtn.querySelector('i');
      icon.className = isPw ? 'bi bi-eye-slash' : 'bi bi-eye';
      togglePwBtn.setAttribute('aria-label', isPw ? 'Ø¥Ø®ÙØ§Ø¡ ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±' : 'Ø¥Ø¸Ù‡Ø§Ø± ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±');
      // Ø¥Ø¨Ù‚Ø§Ø¡ Ø§Ù„ØªØ±ÙƒÙŠØ² Ø¯Ø§Ø®Ù„ Ø§Ù„Ø­Ù‚Ù„ Ù„ØªØ¬Ø±Ø¨Ø© Ø£ÙØ¶Ù„
      pwInput.focus({ preventScroll: true });
    });

    /* === Ø­Ø³Ø§Ø¨ ØµÙØ­Ø© Ø§Ù„ØªØ­ÙˆÙŠÙ„ Ø¨Ø¹Ø¯ Ø§Ù„Ù†Ø¬Ø§Ø­ === */
    function getNextUrl() {
      const params = new URLSearchParams(window.location.search);
      const next = params.get('next');
      const safe = next && next.startsWith('/') ? next : '/committees-home.html';
      return go(safe);
    }

    /* === Ø²Ø± Ø§Ù„ØªØ­Ù…ÙŠÙ„/Ø§Ù„Ø§Ù†Ø´ØºØ§Ù„ === */
    function setSubmitting(isLoading) {
      const btn = document.getElementById('submitBtn');
      btn.disabled = isLoading;
      btn.setAttribute('aria-busy', String(!!isLoading));
      btn.querySelector('.btn-text').classList.toggle('d-none', isLoading);
      btn.querySelector('.btn-wait').classList.toggle('d-none', !isLoading);
    }
    function markInvalid(el, on = true) {
      el.classList.toggle('is-invalid', !!on);
    }

    /* === Ù…Ù‡Ù„Ø© Ù„Ù„Ø´Ø¨ÙƒØ© === */
    function fetchWithTimeout(resource, options = {}) {
      const { timeout = 10000 } = options;
      const controller = new AbortController();
      const id = setTimeout(() => controller.abort(), timeout);
      return fetch(resource, { ...options, signal: controller.signal })
        .finally(() => clearTimeout(id));
    }

    /* === Ø¥Ù† ÙƒØ§Ù† Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ù…Ø³Ø¬Ù‘Ù„Ø§Ù‹ Ø¨Ø§Ù„ÙØ¹Ù„ØŒ ÙŠØ¹Ø§Ø¯ ØªÙˆØ¬ÙŠÙ‡Ù‡ ÙÙˆØ±Ù‹Ø§ === */
    (async function redirectIfAuthenticated(){
      try {
        const r = await fetch(`${API_BASE}/auth/committees/me`, { credentials: 'include' });
        const j = await r.json().catch(()=> ({}));
        if (j?.authenticated) {
          showInfo('âœ… Ø£Ù†Øª Ù…Ø³Ø¬Ù‘Ù„ Ø¯Ø®ÙˆÙ„Ù‹Ø§ØŒ Ø¬Ø§Ø±Ù ØªØ­ÙˆÙŠÙ„Ùƒâ€¦');
          setTimeout(() => { window.location.href = getNextUrl(); }, 400);
        }
      } catch { /* ØªØ¬Ø§Ù‡Ù„ */ }
    })();

    /* === Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ù†Ù…ÙˆØ°Ø¬ (Ø¨Ø¯ÙˆÙ† Ù…Ø³ØªÙ…Ø¹ Enter Ø¥Ø¶Ø§ÙÙŠ Ù„Ù…Ù†Ø¹ Ø§Ù„Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ù…Ø²Ø¯ÙˆØ¬) === */
    document.getElementById('loginForm').addEventListener('submit', async (e) => {
      e.preventDefault();

      const btn = document.getElementById('submitBtn');
      const u   = document.getElementById('username');
      const p   = document.getElementById('password');

      if (btn.disabled) return; // Ù…Ù†Ø¹ Ø§Ù„Ù†Ù‚Ø±Ø§Øª Ø§Ù„Ù…ØªÙƒØ±Ø±Ø©

      // ØªØ­Ù‚Ù‚ Ø£ÙˆÙ„ÙŠ
      let valid = true;
      if (!u.value.trim()) { markInvalid(u, true); valid = false; } else { markInvalid(u, false); }
      if (!p.value.trim()) { markInvalid(p, true); valid = false; } else { markInvalid(p, false); }
      if (!valid) { showError('âš ï¸ ÙŠØ±Ø¬Ù‰ ØªØ¹Ø¨Ø¦Ø© Ø§Ù„Ø­Ù‚ÙˆÙ„ Ø§Ù„Ù…Ø·Ù„ÙˆØ¨Ø©'); return; }

      try {
        setSubmitting(true);
        const res = await fetchWithTimeout(`${API_BASE}/auth/committees/login`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          credentials: 'include',
          timeout: 10000,
          body: JSON.stringify({ username: u.value.trim(), password: p.value })
        });

        let data = {};
        try { data = await res.json(); } catch { /* ØªØ¬Ø§Ù‡Ù„ */ }

        if (!res.ok) {
          // ØªØ®ØµÙŠØµ Ø§Ù„Ø±Ø³Ø§Ø¦Ù„ Ø­Ø³Ø¨ Ø§Ù„Ø­Ø§Ù„Ø©
          if (res.status === 400) {
            markInvalid(u, !u.value.trim());
            markInvalid(p, !p.value.trim());
            showError(data?.message || 'âŒ Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…/Ø§Ù„Ø¨Ø±ÙŠØ¯ ÙˆÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± Ù…Ø·Ù„ÙˆØ¨Ø©');
          } else if (res.status === 401) {
            // Ø§Ù„Ø®Ø§Ø¯Ù… Ù„Ø§ ÙŠÙÙØµØ­ Ø¥Ù† ÙƒØ§Ù† Ø§Ù„Ø­Ø³Ø§Ø¨ Ù…Ø¹Ø·Ù‘ÙÙ„ Ø£Ùˆ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø®Ø§Ø·Ø¦Ø©ØŒ
            // Ù„ÙƒÙ† Ø¥Ù† Ø£Ø±Ø³Ù„ Ø±Ø³Ø§Ù„Ø© ÙˆØ§Ø¶Ø­Ø© Ù†ÙØ¸Ù‡Ø±Ù‡Ø§ ÙƒÙ…Ø§ Ù‡ÙŠ.
            const msg = (data?.message || '').toLowerCase();
            if (msg.includes('Ù…Ø¹Ø·Ù„') || msg.includes('ØºÙŠØ± Ù†Ø´Ø·') || msg.includes('inactive')) {
              showError('ğŸš« Ø­Ø³Ø§Ø¨Ùƒ Ù…Ø¹Ø·Ù‘Ù„. Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø§Ù„ØªÙˆØ§ØµÙ„ Ù…Ø¹ Ø§Ù„Ù…Ø´Ø±Ù Ù„ØªÙØ¹ÙŠÙ„Ù‡.');
            } else {
              showError('âŒ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø¯Ø®ÙˆÙ„ ØºÙŠØ± ØµØ­ÙŠØ­Ø© Ø£Ùˆ Ø£Ù† Ø§Ù„Ø­Ø³Ø§Ø¨ Ù…Ø¹Ø·Ù‘Ù„.');
            }
            markInvalid(u, true);
            markInvalid(p, true);
          } else if (res.status === 403) {
            showError(data?.message || 'âŒ ØºÙŠØ± Ù…ØµØ±Ø­ Ø¨Ø§Ù„Ø¯Ø®ÙˆÙ„');
          } else {
            showError(data?.message || 'âŒ ØªØ¹Ø°Ù‘Ø± ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ (Ø®Ø·Ø£ ØºÙŠØ± Ù…ØªÙˆÙ‚Ø¹)');
          }
          return;
        }

        // Ù†Ø¬Ø§Ø­
        showSuccess(data?.message || 'âœ… ØªÙ… ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø¨Ù†Ø¬Ø§Ø­');
        setTimeout(() => { window.location.href = getNextUrl(); }, 700);

      } catch (err) {
        if (err?.name === 'AbortError') {
          showError('â±ï¸ Ø§Ù†ØªÙ‡Øª Ù…Ù‡Ù„Ø© Ø§Ù„Ø§ØªØµØ§Ù„. ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ø´Ø¨ÙƒØ© ÙˆØ­Ø§ÙˆÙ„ Ù…Ø¬Ø¯Ø¯Ù‹Ø§.');
        } else {
          showError('âŒ ØªØ¹Ø°Ù‘Ø± Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø§Ù„Ø®Ø§Ø¯Ù…');
        }
      } finally {
        setSubmitting(false);
      }
    });
  </script>
</body>
</html>
