<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8">
  <title>ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ - Ù†Ø¸Ø§Ù… Ø§Ù„Ù„Ø¬Ø§Ù†</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.rtl.min.css" rel="stylesheet">
  <style>
    body { background: linear-gradient(135deg, #f3f4f6, #e5e7eb); font-family: 'Segoe UI', Tahoma, sans-serif; min-height: 100vh; display: flex; align-items: center; }
    .login-card { max-width: 420px; width: 100%; margin: auto; background: #fff; border-radius: 16px; box-shadow: 0 15px 30px rgba(0,0,0,.08); overflow: hidden; }
    .login-header { background: #0d6efd; color: #fff; padding: 18px; text-align: center; }
    .login-body { padding: 20px 22px 24px; }
    .brand { font-size: 18px; font-weight: 700; display: flex; align-items: center; gap: 8px; justify-content: center; }
    .brand i { font-style: normal; font-weight: 400; opacity: .9; }
    .form-control:focus { box-shadow: 0 0 0 .2rem rgba(13,110,253,.15); }
    .btn-primary { border-radius: 10px; }
    .small-link { font-size: 13px; color: #6b7280; }
    .toast-container { position: fixed; top: 20px; left: 50%; transform: translateX(-50%); z-index: 2000; }
    .spinner-border-sm { --bs-spinner-width: 1rem; --bs-spinner-height: 1rem; }
  </style>
</head>
<body>
  <div class="login-card">
    <div class="login-header">
      <div class="brand">ğŸ” Ù†Ø¸Ø§Ù… Ø§Ù„Ù„Ø¬Ø§Ù† <i>| ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„</i></div>
    </div>
    <div class="login-body">
      <form id="loginForm" novalidate>
        <div class="mb-3">
          <label class="form-label">Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…</label>
          <input type="text" id="username" class="form-control" placeholder="Ù…Ø«Ø§Ù„: b01578" autocomplete="username" required>
          <div class="invalid-feedback">ÙŠØ±Ø¬Ù‰ Ø¥Ø¯Ø®Ø§Ù„ Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù….</div>
        </div>
        <div class="mb-2">
          <label class="form-label d-flex justify-content-between align-items-center">
            <span>ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±</span>
            <a href="#" class="small-link" tabindex="-1" onclick="event.preventDefault(); togglePassword();">Ø¥Ø¸Ù‡Ø§Ø±/Ø¥Ø®ÙØ§Ø¡</a>
          </label>
          <div class="input-group">
            <input type="password" id="password" class="form-control" placeholder="â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢" autocomplete="current-password" required>
            <button class="btn btn-outline-secondary" type="button" onclick="togglePassword()" aria-label="Ø¥Ø¸Ù‡Ø§Ø±/Ø¥Ø®ÙØ§Ø¡">
              ğŸ‘ï¸
            </button>
            <div class="invalid-feedback">ÙŠØ±Ø¬Ù‰ Ø¥Ø¯Ø®Ø§Ù„ ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±.</div>
          </div>
        </div>
        <div class="d-grid mt-3">
          <button type="submit" id="submitBtn" class="btn btn-primary">
            <span class="btn-text">Ø¯Ø®ÙˆÙ„</span>
            <span class="btn-wait d-none"><span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù‚Ù‚...</span>
          </button>
        </div>
      </form>
      <div class="text-center mt-3 small-link">Ù‡Ø°Ù‡ Ø§Ù„ØµÙØ­Ø© Ù…Ø®ØµÙ‘ØµØ© Ù„Ù†Ø¸Ø§Ù… Ø§Ù„Ù„Ø¬Ø§Ù† ÙÙ‚Ø·</div>
    </div>
  </div>

  <!-- Toasts -->
  <div class="toast-container">
    <div id="toastSuccess" class="toast text-bg-success border-0" role="alert" aria-live="assertive" aria-atomic="true">
      <div class="d-flex">
        <div class="toast-body">âœ… ØªÙ… ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø¨Ù†Ø¬Ø§Ø­</div>
        <button type="button" class="btn-close btn-close-white m-2 me-3" data-bs-dismiss="toast" aria-label="Close"></button>
      </div>
    </div>
    <div id="toastError" class="toast text-bg-danger border-0" role="alert" aria-live="assertive" aria-atomic="true">
      <div class="d-flex">
        <div class="toast-body">âŒ Ø­Ø¯Ø« Ø®Ø·Ø£</div>
        <button type="button" class="btn-close btn-close-white m-2 me-3" data-bs-dismiss="toast" aria-label="Close"></button>
      </div>
    </div>
    <div id="toastInfo" class="toast text-bg-primary border-0" role="alert" aria-live="polite" aria-atomic="true">
      <div class="d-flex">
        <div class="toast-body">â„¹ï¸</div>
        <button type="button" class="btn-close btn-close-white m-2 me-3" data-bs-dismiss="toast" aria-label="Close"></button>
      </div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  <script>
    /* === Ø¥Ø¹Ø¯Ø§Ø¯ Ø£Ø³Ø§Ø³ Ø§Ù„ÙˆØ§Ø¬Ù‡Ø© Ø§Ù„Ø®Ù„ÙÙŠØ© Ø­Ø³Ø¨ Ø§Ù„Ø¨ÙŠØ¦Ø© === */
    const RENDER_BASE = 'https://vdash-qkyv.onrender.com';
    const host = location.hostname;
    const isGithub = host.endsWith('github.io');
    const isLocal  = host === 'localhost' || host === '127.0.0.1';
    const API_BASE = isGithub ? RENDER_BASE : (isLocal ? 'http://localhost:3000' : '');
    const go = (path) => isGithub ? (RENDER_BASE + path) : path;

    // (Ø¬Ø¯ÙŠØ¯) Ø£Ø¯ÙˆØ§Øª Ø§Ù„ØªÙˆØ³Øª
    const TSuccess = new bootstrap.Toast(document.getElementById('toastSuccess'));
    const TError   = new bootstrap.Toast(document.getElementById('toastError'));
    const TInfo    = new bootstrap.Toast(document.getElementById('toastInfo'));
    function setToast(el, msg) { el._element.querySelector('.toast-body').textContent = msg; }
    function showSuccess(msg){ setToast(TSuccess, msg); TSuccess.show(); }
    function showError(msg){ setToast(TError, msg); TError.show(); }
    function showInfo(msg){ setToast(TInfo, msg); TInfo.show(); }

    // Ø¥Ø¸Ù‡Ø§Ø±/Ø¥Ø®ÙØ§Ø¡ ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±
    function togglePassword() {
      const p = document.getElementById('password');
      p.type = (p.type === 'password') ? 'text' : 'password';
    }

    // Ù‚Ø±Ø§Ø¡Ø© next Ù„Ø¹Ù…Ù„ÙŠØ© Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„ØªÙˆØ¬ÙŠÙ‡ Ø¨Ø¹Ø¯ Ø§Ù„Ù†Ø¬Ø§Ø­
    function getNextUrl() {
      const params = new URLSearchParams(window.location.search);
      const next = params.get('next');
      const safe = next && next.startsWith('/') ? next : '/committees-home.html';
      return go(safe);
    }

    // ØªØ¨Ø¯ÙŠÙ„ Ø­Ø§Ù„Ø© Ø²Ø± Ø§Ù„Ø¥Ø±Ø³Ø§Ù„
    function setSubmitting(isLoading) {
      const btn = document.getElementById('submitBtn');
      btn.disabled = isLoading;
      btn.querySelector('.btn-text').classList.toggle('d-none', isLoading);
      btn.querySelector('.btn-wait').classList.toggle('d-none', !isLoading);
    }

    // Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ù†Ù…ÙˆØ°Ø¬
    document.getElementById('loginForm').addEventListener('submit', async (e) => {
      e.preventDefault();
      const u = document.getElementById('username');
      const p = document.getElementById('password');

      // ÙØ­Øµ Ø¨Ø³ÙŠØ·
      let valid = true;
      if (!u.value.trim()) { u.classList.add('is-invalid'); valid = false; } else { u.classList.remove('is-invalid'); }
      if (!p.value.trim()) { p.classList.add('is-invalid'); valid = false; } else { p.classList.remove('is-invalid'); }
      if (!valid) { showError('âš ï¸ ÙŠØ±Ø¬Ù‰ ØªØ¹Ø¨Ø¦Ø© Ø§Ù„Ø­Ù‚ÙˆÙ„ Ø§Ù„Ù…Ø·Ù„ÙˆØ¨Ø©'); return; }

      try {
        setSubmitting(true);
        const res = await fetch(`${API_BASE}/auth/committees/login`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          credentials: 'include',              // Ù…Ù‡Ù… Ù„Ù„Ø¬Ù„Ø³Ø© Ø¹Ø¨Ø± Ø§Ù„Ù†Ø·Ø§Ù‚Ø§Øª
          body: JSON.stringify({ username: u.value.trim(), password: p.value })
        });

        const data = await res.json().catch(() => ({}));
        if (!res.ok) {
          const msg = data?.message || 'âŒ ÙØ´Ù„ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„';
          showError(msg);
          setSubmitting(false);
          return;
        }

        showSuccess(data?.message || 'âœ… ØªÙ… ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø¨Ù†Ø¬Ø§Ø­');
        setTimeout(() => {
          window.location.href = getNextUrl(); // ØªÙˆØ¬ÙŠÙ‡ Ù„Ù†ÙØ³ Ø£ØµÙ„ Ø§Ù„Ù€API Ø¹Ù†Ø¯ Ø§Ù„Ø­Ø§Ø¬Ø©
        }, 700);
      } catch (err) {
        showError('âŒ ØªØ¹Ø°Ø± Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø§Ù„Ø®Ø§Ø¯Ù…');
      } finally {
        setSubmitting(false);
      }
    });

    // Enter ÙÙŠ Ø§Ù„Ø­Ù‚ÙˆÙ„ ÙŠØ±Ø³Ù„ Ø§Ù„Ù†Ù…ÙˆØ°Ø¬ ØªÙ„Ù‚Ø§Ø¦ÙŠÙ‹Ø§
    document.getElementById('username').addEventListener('keydown', e => { if (e.key === 'Enter') document.getElementById('loginForm').dispatchEvent(new Event('submit')); });
    document.getElementById('password').addEventListener('keydown', e => { if (e.key === 'Enter') document.getElementById('loginForm').dispatchEvent(new Event('submit')); });
  </script>
</body>
</html>
