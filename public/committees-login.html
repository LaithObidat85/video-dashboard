<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8">
  <title>تسجيل الدخول - نظام اللجان</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.rtl.min.css" rel="stylesheet">
  <style>
    body { background: linear-gradient(135deg, #f3f4f6, #e5e7eb); font-family: 'Segoe UI', Tahoma, sans-serif; min-height: 100vh; display: flex; align-items: center; }
    .login-card { max-width: 420px; width: 100%; margin: auto; background: #fff; border-radius: 16px; box-shadow: 0 15px 30px rgba(0,0,0,.08); overflow: hidden; }
    .login-header { background: #0d6efd; color: #fff; padding: 18px; text-align: center; }
    .login-body { padding: 20px 22px 24px; }
    .brand { font-size: 18px; font-weight: 700; display: flex; align-items: center; gap: 8px; justify-content: center; }
    .brand i { font-style: normal; font-weight: 400; opacity: .9; }
    .form-control:focus { box-shadow: 0 0 0 .2rem rgba(13,110,253,.15); }
    .btn-primary { border-radius: 10px; }
    .small-link { font-size: 13px; color: #6b7280; }
    .toast-container { position: fixed; top: 20px; left: 50%; transform: translateX(-50%); z-index: 2000; }
    .spinner-border-sm { --bs-spinner-width: 1rem; --bs-spinner-height: 1rem; }
  </style>
</head>
<body>
  <div class="login-card">
    <div class="login-header">
      <div class="brand">🔐 نظام اللجان <i>| تسجيل الدخول</i></div>
    </div>
    <div class="login-body">
      <form id="loginForm" novalidate>
        <div class="mb-3">
          <label class="form-label">اسم المستخدم</label>
          <input type="text" id="username" class="form-control" placeholder="مثال: b01578" autocomplete="username" required>
          <div class="invalid-feedback">يرجى إدخال اسم المستخدم.</div>
        </div>
        <div class="mb-2">
          <label class="form-label d-flex justify-content-between align-items-center">
            <span>كلمة المرور</span>
            <a href="#" class="small-link" tabindex="-1" onclick="event.preventDefault(); togglePassword();">إظهار/إخفاء</a>
          </label>
          <div class="input-group">
            <input type="password" id="password" class="form-control" placeholder="••••••••" autocomplete="current-password" required>
            <button class="btn btn-outline-secondary" type="button" onclick="togglePassword()" aria-label="إظهار/إخفاء">
              👁️
            </button>
            <div class="invalid-feedback">يرجى إدخال كلمة المرور.</div>
          </div>
        </div>
        <div class="d-grid mt-3">
          <button type="submit" id="submitBtn" class="btn btn-primary">
            <span class="btn-text">دخول</span>
            <span class="btn-wait d-none"><span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> جاري التحقق...</span>
          </button>
        </div>
      </form>
      <div class="text-center mt-3 small-link">هذه الصفحة مخصّصة لنظام اللجان فقط</div>
    </div>
  </div>

  <!-- Toasts -->
  <div class="toast-container">
    <div id="toastSuccess" class="toast text-bg-success border-0" role="alert" aria-live="assertive" aria-atomic="true">
      <div class="d-flex">
        <div class="toast-body">✅ تم تسجيل الدخول بنجاح</div>
        <button type="button" class="btn-close btn-close-white m-2 me-3" data-bs-dismiss="toast" aria-label="Close"></button>
      </div>
    </div>
    <div id="toastError" class="toast text-bg-danger border-0" role="alert" aria-live="assertive" aria-atomic="true">
      <div class="d-flex">
        <div class="toast-body">❌ حدث خطأ</div>
        <button type="button" class="btn-close btn-close-white m-2 me-3" data-bs-dismiss="toast" aria-label="Close"></button>
      </div>
    </div>
    <div id="toastInfo" class="toast text-bg-primary border-0" role="alert" aria-live="polite" aria-atomic="true">
      <div class="d-flex">
        <div class="toast-body">ℹ️</div>
        <button type="button" class="btn-close btn-close-white m-2 me-3" data-bs-dismiss="toast" aria-label="Close"></button>
      </div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  <script>
    /* === إعداد أساس الواجهة الخلفية حسب البيئة === */
    const RENDER_BASE = 'https://vdash-qkyv.onrender.com';
    const host = location.hostname;
    const isGithub = host.endsWith('github.io');
    const isLocal  = host === 'localhost' || host === '127.0.0.1';
    const API_BASE = isGithub ? RENDER_BASE : (isLocal ? 'http://localhost:3000' : '');
    const go = (path) => isGithub ? (RENDER_BASE + path) : path;

    // (جديد) أدوات التوست
    const TSuccess = new bootstrap.Toast(document.getElementById('toastSuccess'));
    const TError   = new bootstrap.Toast(document.getElementById('toastError'));
    const TInfo    = new bootstrap.Toast(document.getElementById('toastInfo'));
    function setToast(el, msg) { el._element.querySelector('.toast-body').textContent = msg; }
    function showSuccess(msg){ setToast(TSuccess, msg); TSuccess.show(); }
    function showError(msg){ setToast(TError, msg); TError.show(); }
    function showInfo(msg){ setToast(TInfo, msg); TInfo.show(); }

    // إظهار/إخفاء كلمة المرور
    function togglePassword() {
      const p = document.getElementById('password');
      p.type = (p.type === 'password') ? 'text' : 'password';
    }

    // قراءة next لعملية إعادة التوجيه بعد النجاح
    function getNextUrl() {
      const params = new URLSearchParams(window.location.search);
      const next = params.get('next');
      const safe = next && next.startsWith('/') ? next : '/committees-home.html';
      return go(safe);
    }

    // تبديل حالة زر الإرسال
    function setSubmitting(isLoading) {
      const btn = document.getElementById('submitBtn');
      btn.disabled = isLoading;
      btn.querySelector('.btn-text').classList.toggle('d-none', isLoading);
      btn.querySelector('.btn-wait').classList.toggle('d-none', !isLoading);
    }

    // إرسال النموذج
    document.getElementById('loginForm').addEventListener('submit', async (e) => {
      e.preventDefault();
      const u = document.getElementById('username');
      const p = document.getElementById('password');

      // فحص بسيط
      let valid = true;
      if (!u.value.trim()) { u.classList.add('is-invalid'); valid = false; } else { u.classList.remove('is-invalid'); }
      if (!p.value.trim()) { p.classList.add('is-invalid'); valid = false; } else { p.classList.remove('is-invalid'); }
      if (!valid) { showError('⚠️ يرجى تعبئة الحقول المطلوبة'); return; }

      try {
        setSubmitting(true);
        const res = await fetch(`${API_BASE}/auth/committees/login`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          credentials: 'include',              // مهم للجلسة عبر النطاقات
          body: JSON.stringify({ username: u.value.trim(), password: p.value })
        });

        const data = await res.json().catch(() => ({}));
        if (!res.ok) {
          const msg = data?.message || '❌ فشل تسجيل الدخول';
          showError(msg);
          setSubmitting(false);
          return;
        }

        showSuccess(data?.message || '✅ تم تسجيل الدخول بنجاح');
        setTimeout(() => {
          window.location.href = getNextUrl(); // توجيه لنفس أصل الـAPI عند الحاجة
        }, 700);
      } catch (err) {
        showError('❌ تعذر الاتصال بالخادم');
      } finally {
        setSubmitting(false);
      }
    });

    // Enter في الحقول يرسل النموذج تلقائيًا
    document.getElementById('username').addEventListener('keydown', e => { if (e.key === 'Enter') document.getElementById('loginForm').dispatchEvent(new Event('submit')); });
    document.getElementById('password').addEventListener('keydown', e => { if (e.key === 'Enter') document.getElementById('loginForm').dispatchEvent(new Event('submit')); });
  </script>
</body>
</html>
