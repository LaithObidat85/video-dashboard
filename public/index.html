<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8">
  <title>Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©</title>
  <link rel="icon" type="image/png" href="https://www.dropbox.com/scl/fi/f283e4rvv5cf9x12a1cic/my-website-logo.png?rlkey=yia776im7klypy27af32m0scy&e=1&st=vhaprvzh&dl=1">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.rtl.min.css">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css">
  <style>
    body {
      background: linear-gradient(to right, #e0eafc, #cfdef3);
      padding: 20px;
      font-family: 'Segoe UI', sans-serif;
      min-height: 100vh;
      display: flex;
      flex-direction: column;
      justify-content: space-between;
    }
    .header-controls {display:flex;justify-content:center;align-items:center;position:relative;gap:10px;}
    .header-controls h3 {flex:1;text-align:center;margin:0;}
    .video-card {background:white;border-radius:12px;box-shadow:0 2px 6px rgba(0,0,0,0.1);padding:12px;margin:5px;width:300px;display:flex;flex-direction:column;justify-content:flex-start;transition:transform 0.2s ease, box-shadow 0.2s ease;}
    .video-card:hover {transform:scale(1.02);box-shadow:0 4px 12px rgba(0,0,0,0.15);}
    .video-title {font-weight:bold;margin-bottom:6px;min-height:48px;overflow:hidden;display:-webkit-box;-webkit-line-clamp:2;-webkit-box-orient:vertical;}
    .video-description {color:#0d6efd;cursor:pointer;min-height:40px;overflow:hidden;display:-webkit-box;-webkit-line-clamp:2;-webkit-box-orient:vertical;margin-bottom:8px;}
    .video-grid {display:flex;flex-wrap:wrap;justify-content:center;gap:15px;}
    video,iframe {width:100%;height:200px;border-radius:6px;}
    .sharepoint-frame {width:100%;height:200px;border-radius:6px;display:block;object-fit:cover;}
    .popout-button {background-color:#0d6efd;color:white;border:none;padding:6px 12px;border-radius:5px;cursor:pointer;margin-top:6px;}
    footer {text-align:center;margin-top:10px;font-weight:bold;color:#333;font-size:1.1rem;animation:glow 1.5s infinite alternate;}
    @keyframes glow {from{color:#333;text-shadow:none;}to{color:#0d6efd;text-shadow:0 0 10px #0d6efd;}}
    .bottom-buttons {display:flex;justify-content:center;gap:10px;margin-bottom:10px;}
    .navbar-nav .nav-link {transition:color 0.3s ease, background 0.3s ease;padding:8px 12px;border-radius:5px;}
    .navbar-nav .nav-link:hover {background:rgba(255,255,255,0.15);}
    .navbar-nav .nav-link::after {content:'';position:absolute;width:0;height:2px;left:0;bottom:0;background:white;transition:width 0.3s ease;}
    .navbar-nav .nav-link:hover::after,.navbar-nav .nav-link.active::after {width:100%;}
    .scrolled {box-shadow:0 4px 10px rgba(0,0,0,0.2)!important;}
    body.dark-mode {background:#121212!important;color:#eaeaea!important;}
    body.dark-mode nav {background:linear-gradient(to right,#222,#000)!important;}
  </style>
</head>
<body>

<nav id="mainNavbar" class="navbar navbar-expand-lg sticky-top shadow-sm" 
     style="background: linear-gradient(to right, #0d6efd, #0b5ed7); transition: box-shadow 0.3s ease;">
  <div class="container-fluid">
    <div class="collapse navbar-collapse" id="navbarContent">
      <ul class="navbar-nav mb-2 mb-lg-0">
        <li class="nav-item">
          <a class="nav-link text-white fw-semibold position-relative" href="#" onclick="requestDashboardAccess()">
            <i class="bi bi-shield-lock-fill fs-5"></i> Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ…
          </a>
        </li>
        <li class="nav-item">
          <a class="nav-link text-white fw-semibold position-relative" href="https://video-dashboard-backend.onrender.com/viewlinks.html">
            <i class="bi bi-link-45deg fs-5"></i> Ø±ÙˆØ§Ø¨Ø· Ù…Ù‡Ù…Ø©
          </a>
        </li>
        <li class="nav-item" id="logoutNavItem" style="display:none;">
          <a class="nav-link text-white fw-semibold position-relative" href="#" onclick="logout()">
            <i class="bi bi-box-arrow-right fs-5"></i> ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬
          </a>
        </li>
      </ul>
    </div>
    <a class="navbar-brand text-white fw-bold ms-auto d-flex align-items-center" href="#">
      <i class="bi bi-collection-play-fill fs-4 me-1"></i> Video Dashboard
    </a>
    <button class="navbar-toggler text-white border-0" type="button" data-bs-toggle="collapse" data-bs-target="#navbarContent">
      <span class="navbar-toggler-icon"></span>
    </button>
    <button id="themeToggle" class="btn btn-sm btn-outline-light ms-2">
      <i class="bi bi-moon-stars-fill"></i>
    </button>
  </div>
</nav>

<div class="container text-center">
  <h3>Ø§Ø®ØªØ± Ø§Ù„Ù‚Ø³Ù… Ù„Ø¹Ø±Ø¶ Ø§Ù„ÙÙŠØ¯ÙŠÙˆÙ‡Ø§Øª</h3>
  <select id="departmentSelect" class="form-select mb-3">
    <option value="">-- Ø§Ø®ØªØ± Ø§Ù„Ù‚Ø³Ù… --</option>
  </select>
  <input id="searchInput" class="form-control mb-4" type="text" placeholder="Ø§Ø¨Ø­Ø« Ø¨Ø¹Ù†ÙˆØ§Ù† Ø£Ùˆ ÙˆØµÙ Ø§Ù„ÙÙŠØ¯ÙŠÙˆ..." disabled>
  <div id="videoContainer" class="video-grid"></div>
</div>

<footer>Ø¨Ø±Ù…Ø¬Ø© ÙˆØªØ·ÙˆÙŠØ±: Ù„ÙŠØ« Ø¹Ø¨ÙŠØ¯Ø§Øª</footer>

<!-- Ù†Ø§ÙØ°Ø© Ø¹Ø±Ø¶ Ø§Ù„ÙˆØµÙ -->
<div class="modal fade" id="descModal" tabindex="-1">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="descTitle"></h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body" id="descContent" style="white-space: pre-wrap; text-align: justify;"></div>
    </div>
  </div>
</div>

<!-- Ù†Ø§ÙØ°Ø© ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± -->
<div class="modal fade" id="passwordModal" tabindex="-1">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">ğŸ” Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø¥Ù„Ù‰ Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ…</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <input type="password" id="dashboardPassword" class="form-control" placeholder="Ø£Ø¯Ø®Ù„ ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±" lang="en">
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Ø¥Ù„ØºØ§Ø¡</button>
        <button type="button" class="btn btn-primary" id="confirmDashboardAccess">Ø¯Ø®ÙˆÙ„</button>
      </div>
    </div>
  </div>
</div>

<script>
const API_BASE = 'https://video-dashboard-backend.onrender.com';
let videos = [];
let passwordModal;

// ğŸ†• Ø¯Ø§Ù„Ø© Ù„ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ù‚Ø³Ù… Ø§Ù„Ø­Ø§Ù„ÙŠ Ù…Ù† Ø§Ø³Ù… Ø§Ù„ØµÙØ­Ø©
function getSectionName() {
  const path = window.location.pathname;
  if (path.includes("dashboard.html")) return "dashboard";
  if (path.includes("links.html")) return "links";
  if (path.includes("viewlinks.html")) return "viewlinks";
  if (path.includes("backups.html")) return "backups";
  if (path.includes("add.html")) return "add";
  if (path.includes("edit.html")) return "edit";
  return "general"; // Ø§ÙØªØ±Ø§Ø¶ÙŠ Ø¥Ø°Ø§ Ù„Ù… ÙŠÙ†Ø·Ø¨Ù‚ Ø£ÙŠ Ø´ÙŠØ¡
}

async function checkSessionStatus() {
  try {
    const res = await fetch(`${API_BASE}/api/check-session`);
    const data = await res.json();
    if (data.authenticated) {
      document.getElementById("logoutNavItem").style.display = "block";
    } else {
      document.getElementById("logoutNavItem").style.display = "none";
    }
  } catch (err) { console.error("Ø®Ø·Ø£ ÙÙŠ Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ø¬Ù„Ø³Ø©:", err); }
}

async function logout() {
  try {
    await fetch(`${API_BASE}/api/logout`, { method: "POST" });
    sessionStorage.clear(); // ğŸ†• ØªÙ†Ø¸ÙŠÙ ÙƒÙ„ Ø§Ù„Ø¬Ù„Ø³Ø§Øª
    document.getElementById("logoutNavItem").style.display = "none";
    alert("ØªÙ… ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬ Ø¨Ù†Ø¬Ø§Ø­ âœ…");
  } catch (err) { alert("âŒ Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬"); }
}

async function requestDashboardAccess() {
  const section = "dashboard"; // Ø§Ù„Ø²Ø± Ø®Ø§Øµ Ø¨Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ… ÙÙ‚Ø·

  // 1ï¸âƒ£ ØªØ­Ù‚Ù‚ Ø£ÙˆÙ„Ø§Ù‹ Ù…Ù† Ø§Ù„ØªØ®Ø²ÙŠÙ† Ø§Ù„Ù…Ø­Ù„ÙŠ (sessionStorage)
  if (sessionStorage.getItem("loggedInAt_" + section)) {
    window.location.href = section + ".html";
    return;
  }

  // 2ï¸âƒ£ ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ø³ÙŠØ±ÙØ± (ÙÙŠ Ø­Ø§Ù„ ØªÙ… ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ù…Ù† Ù†Ø§ÙØ°Ø© Ø£Ø®Ø±Ù‰ Ø¨Ù†ÙØ³ Ø§Ù„Ø¨Ø±Ø§ÙˆØ²Ø±)
  try {
    const res = await fetch(`${API_BASE}/api/check-session`);
    const data = await res.json();
    if (data.authenticated) { 
      // âœ… Ø³Ø¬Ù„ Ø§Ù„Ø¬Ù„Ø³Ø© Ù…Ø­Ù„ÙŠØ§Ù‹ Ù„Ù„Ù€ dashboard
      sessionStorage.setItem("loggedInAt_" + section, Date.now().toString());
      window.location.href = section + ".html";
      return;
    }
  } catch (err) { 
    console.error("Ø®Ø·Ø£ ÙÙŠ Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ø¬Ù„Ø³Ø©:", err); 
  }

  // 3ï¸âƒ£ Ø¥Ø°Ø§ Ù…Ø§ ÙÙŠ Ø¬Ù„Ø³Ø© Ù…Ø­Ù„ÙŠØ© ÙˆÙ„Ø§ Ø³ÙŠØ±ÙØ± â†’ Ø§Ø·Ù„Ø¨ ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±
  const modalEl = document.getElementById('passwordModal');
  passwordModal = new bootstrap.Modal(modalEl);
  modalEl.addEventListener('shown.bs.modal', () => {
    const input = document.getElementById('dashboardPassword'); 
    input.value=''; 
    input.focus();
  });
  passwordModal.show();

 document.getElementById('confirmDashboardAccess').onclick = async () => {
  const passwordInput = document.getElementById('dashboardPassword');
  const password = passwordInput.value.trim();
  if (!password) return;

  try {
    const response = await fetch(`${API_BASE}/api/verify-password`, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ section, password })
    });

    if (response.ok) {
      sessionStorage.setItem("loggedInAt_" + section, Date.now().toString());
      passwordModal.hide();
      window.location.href = section + '.html';
    } else { 
      alert('âŒ ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± ØºÙŠØ± ØµØ­ÙŠØ­Ø©'); 
      passwordInput.value = "";   // ğŸ†• ÙŠÙ…Ø³Ø­ Ø§Ù„Ø­Ù‚Ù„
      passwordInput.focus();      // ğŸ†• ÙŠØ±Ø¬Ø¹ Ø§Ù„ÙÙˆÙƒØ³ Ù„Ù„Ø­Ù‚Ù„
    }
  } catch { 
    alert('âŒ Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø§Ù„Ø®Ø§Ø¯Ù…'); 
  }
};

// ğŸ†• Ø§Ø³ØªÙ…Ø§Ø¹ Ù„Ù…ÙØªØ§Ø­ Enter Ø¯Ø§Ø®Ù„ Ø­Ù‚Ù„ ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±
document.getElementById('dashboardPassword').addEventListener("keydown", (e) => {
  if (e.key === "Enter") {
    document.getElementById('confirmDashboardAccess').click();
  }
});

}
async function fetchVideos() {
  try {
    const res = await fetch(`${API_BASE}/api/videos`);
    videos = await res.json();
    populateDepartmentOptions();
  }
  catch (err) { console.error('ÙØ´Ù„ ØªØ­Ù…ÙŠÙ„ Ø§Ù„ÙÙŠØ¯ÙŠÙˆÙ‡Ø§Øª:', err); }
}

function renderVideos() {
  const dep=document.getElementById('departmentSelect').value;
  const q=document.getElementById('searchInput').value.trim().toLowerCase();
  const c=document.getElementById('videoContainer');c.innerHTML='';
  if(!dep)return;
  const filtered=videos.filter(v=>{
    const d=v.department?.trim().toLowerCase();
    const t=v.title?.toLowerCase()||'';
    const desc=v.description?.toLowerCase()||'';
    return d===dep.trim().toLowerCase()&&(t.includes(q)||desc.includes(q));
  });
  if(filtered.length===0){
    c.innerHTML='<p class="text-muted">ğŸš« Ù„Ø§ ØªÙˆØ¬Ø¯ ÙÙŠØ¯ÙŠÙˆÙ‡Ø§Øª Ù…Ø·Ø§Ø¨Ù‚Ø© Ù„Ù„Ø¨Ø­Ø«</p>';
    return;
  }
  filtered.forEach(video=>{
    const card=document.createElement('div');card.className='video-card';
    const title=`<div class="video-title">Ø¹Ù†ÙˆØ§Ù† Ø§Ù„ÙÙŠØ¯ÙŠÙˆ: ${video.title}</div>`;
    const desc=`<div class="video-description" onclick="showDescription('${escapeHtml(video.title)}','${escapeHtml(video.description)}')">ÙˆØµÙ Ø§Ù„ÙÙŠØ¯ÙŠÙˆ: ${video.description}</div>`;
    let media='';const link=video.link||video.url||'';let pop=link;
    if(link.includes('youtube.com')||link.includes('youtu.be')){
      media=`<iframe src="https://www.youtube.com/embed/${extractYouTubeID(link)}" allowfullscreen></iframe>`;
    }
    else if(link.includes('drive.google.com/file/d/')){
      const m=link.match(/\/file\/d\/(.*?)(\/|$)/);
      media=m?`<iframe src="https://drive.google.com/file/d/${m[1]}/preview" allowfullscreen></iframe>`:`<video controls src="${link}"></video>`;
    }
    else if(link.includes("sharepoint.com/")&&link.includes("/embed.aspx")){
      media=`<iframe class="sharepoint-frame" src="${link}" allowfullscreen></iframe>`;
      const m=link.match(/UniqueId=([a-zA-Z0-9\-]+)/);
      if(m)pop=`https://ymkh-my.sharepoint.com/personal/laith_obaidat_iu_edu_jo/_layouts/15/stream.aspx?UniqueId=${m[1]}`;
    }
    else if(link.includes("sharepoint.com/")&&link.includes("/stream.aspx")){
      const m=link.match(/UniqueId=([a-zA-Z0-9\-]+)/);
      if(m){
        const e=`https://ymkh-my.sharepoint.com/personal/laith_obaidat_iu_edu_jo/_layouts/15/embed.aspx?UniqueId=${m[1]}&embed=%7B%22ust%22%3Atrue%7D&referrer=StreamWebApp&referrerScenario=EmbedDialog.Create`;
        media=`<iframe class="sharepoint-frame" src="${e}" allowfullscreen></iframe>`;
        pop=link;
      }else{
        media=`<video controls src="${link}"></video>`;
      }
    }
    else{media=`<video controls src="${link}"></video>`;}
    const btn=`<button class="popout-button" onclick="window.open('${pop}','_blank','width=800,height=600')">Ø¹Ø±Ø¶ Ø§Ù„ÙÙŠØ¯ÙŠÙˆ</button>`;
    card.innerHTML=title+desc+media+btn;c.appendChild(card);
  });
}
function escapeHtml(t){return t?.replace(/"/g,'&quot;').replace(/'/g,'&#39;')||'';}
function extractYouTubeID(u){const m=u.match(/[?&]v=([^&#]*)|youtu\.be\/([^&#]*)/);return m?(m[1]||m[2]):'';}
function showDescription(t,d){document.getElementById('descTitle').textContent=t;document.getElementById('descContent').innerHTML=d;new bootstrap.Modal(document.getElementById('descModal')).show();}
function populateDepartmentOptions(){
  const counts=videos.reduce((a,v)=>{a[v.department]=(a[v.department]||0)+1;return a;},{});const sel=document.getElementById('departmentSelect');
  sel.innerHTML='<option value="">-- Ø§Ø®ØªØ± Ø§Ù„Ù‚Ø³Ù… --</option>';
  Object.entries(counts).forEach(([dep,c])=>{
    const o=document.createElement('option');
    o.value=dep;o.textContent=`${dep} (${c})`;
    sel.appendChild(o);
  });
}

document.getElementById('departmentSelect').addEventListener('change',()=>{
  document.getElementById('searchInput').disabled=false;
  renderVideos();
});
document.getElementById('searchInput').addEventListener('input',renderVideos);
document.addEventListener("DOMContentLoaded",()=>{
  checkSessionStatus();
  fetchVideos();
});

// Navbar scroll + theme toggle
window.addEventListener('scroll',()=>{
  const nav=document.getElementById('mainNavbar');
  if(window.scrollY>20)nav.classList.add('scrolled');else nav.classList.remove('scrolled');
});
document.getElementById('themeToggle').addEventListener('click',()=>{
  document.body.classList.toggle('dark-mode');
  const icon=document.querySelector("#themeToggle i");
  if(document.body.classList.contains("dark-mode")){
    icon.classList.replace("bi-moon-stars-fill","bi-brightness-high-fill");
  }else{
    icon.classList.replace("bi-brightness-high-fill","bi-moon-stars-fill");
  }
});
</script>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
