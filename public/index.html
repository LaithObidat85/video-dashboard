<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8">
  <title>Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©</title>
  <link rel="icon" type="image/png" href="https://www.dropbox.com/scl/fi/f283e4rvv5cf9x12a1cic/my-website-logo.png?rlkey=yia776im7klypy27af32m0scy&e=1&st=vhaprvzh&dl=1">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.rtl.min.css">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css">
  <style>
    body {
      background: linear-gradient(to right, #e0eafc, #cfdef3);
      padding: 20px;
      font-family: 'Segoe UI', sans-serif;
      min-height: 100vh;
      display: flex;
      flex-direction: column;
      justify-content: space-between;
      transition: background 0.4s ease, color 0.4s ease;
    }
    /* ØªØ­Ø³ÙŠÙ† Ø§Ù„Ù†Ø§ÙØ¨Ø§Ø± */
    nav {
      backdrop-filter: blur(8px);
      background: rgba(13,110,253,0.9)!important;
      border-radius: 0 0 12px 12px;
    }
    .navbar-nav .nav-link {transition: all 0.3s ease;padding:8px 14px;border-radius:6px;position:relative;}
    .navbar-nav .nav-link:hover {background:rgba(255,255,255,0.15);transform:translateY(-2px);}
    .navbar-nav .nav-link::after {content:'';position:absolute;width:0;height:2px;left:0;bottom:0;background:white;transition:width 0.3s ease;}
    .navbar-nav .nav-link:hover::after,.navbar-nav .nav-link.active::after {width:100%;}
    .scrolled {box-shadow:0 4px 12px rgba(0,0,0,0.25)!important;}

    /* Ø¨Ø·Ø§Ù‚Ø§Øª Ø§Ù„ÙÙŠØ¯ÙŠÙˆ */
    .video-card {background:white;border-radius:15px;box-shadow:0 4px 12px rgba(0,0,0,0.12);padding:14px;margin:8px;width:300px;
      display:flex;flex-direction:column;justify-content:flex-start;transition:transform 0.3s ease, box-shadow 0.3s ease;}
    .video-card:hover {transform:translateY(-6px) scale(1.03);box-shadow:0 8px 20px rgba(0,0,0,0.18);}
    .video-title {font-weight:bold;margin-bottom:6px;min-height:48px;overflow:hidden;display:-webkit-box;-webkit-line-clamp:2;-webkit-box-orient:vertical;}
    .video-description {color:#0d6efd;cursor:pointer;min-height:40px;overflow:hidden;display:-webkit-box;-webkit-line-clamp:2;-webkit-box-orient:vertical;margin-bottom:8px;}

    /* ØªØ­Ø³ÙŠÙ† Ø§Ù„Ø¥Ø¯Ø®Ø§Ù„Ø§Øª */
    select, input[type="text"] {
      border-radius: 10px!important;
      border: 2px solid #0d6efd!important;
      transition: all 0.3s ease;
    }
    select:focus, input[type="text"]:focus {
      box-shadow:0 0 8px rgba(13,110,253,0.6)!important;
      transform: scale(1.02);
    }

    /* Ø£Ø²Ø±Ø§Ø± Ø§Ù„ÙÙŠØ¯ÙŠÙˆ */
    .popout-button {background:linear-gradient(to right,#0d6efd,#0b5ed7);color:white;border:none;padding:8px 14px;border-radius:8px;cursor:pointer;margin-top:6px;transition:all 0.3s ease;}
    .popout-button:hover {background:linear-gradient(to right,#0b5ed7,#084298);transform:scale(1.05);}

    /* Toast Ù…Ø­Ø³Ù‘Ù† */
    .toast-container {
      position: fixed;
      top: 30%;
      left: 50%;
      transform: translate(-50%, -50%);
      z-index: 2000;
      animation: fadeIn 0.5s ease;
    }
    @keyframes fadeIn {from{opacity:0;transform:translate(-50%,-40%);}to{opacity:1;transform:translate(-50%,-50%);}}

    /* Footer */
    footer {text-align:center;margin-top:10px;font-weight:bold;color:#333;font-size:1.1rem;animation:glow 1.5s infinite alternate;}
    @keyframes glow {from{color:#333;text-shadow:none;}to{color:#0d6efd;text-shadow:0 0 10px #0d6efd;}}

    /* Spinner */
    #loadingSpinner {
      display:none;
      position:fixed;
      top:50%;left:50%;
      transform:translate(-50%,-50%);
      z-index:3000;
    }

    /* Ø§Ù„ÙˆØ¶Ø¹ Ø§Ù„Ø¯Ø§ÙƒÙ† */
    body.dark-mode {background:#121212!important;color:#eaeaea!important;}
    body.dark-mode nav {background:rgba(34,34,34,0.95)!important;}
    body.dark-mode .video-card {background:#1e1e1e;color:#ddd;}
    body.dark-mode .video-description {color:#9bbcff;}
/* Ø´Ø¨ÙƒØ© Ø§Ù„ÙÙŠØ¯ÙŠÙˆÙ‡Ø§Øª */
.video-grid {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
  gap: 16px;
  justify-content: center;
  margin-top: 20px;
}
.video-card {
  width: 100% !important; /* Ø®Ù„ÙŠÙ‡ ÙŠØªÙ…Ø¯Ø¯ Ø­Ø³Ø¨ Ø§Ù„Ø¹Ù…ÙˆØ¯ */
}

    /* ğŸ¨ ØªÙ†Ø³ÙŠÙ‚ Ø§Ù„Ù…ÙˆØ¯Ø§Ù„ Ø­Ø³Ø¨ Ø§Ù„ÙˆØ¶Ø¹ */

/* Ø§Ù„ÙˆØ¶Ø¹ Ø§Ù„Ø¯Ø§ÙƒÙ† */
body.dark-mode .modal-content {
  background-color: #1e1e1e; /* Ø®Ù„ÙÙŠØ© Ø¯Ø§ÙƒÙ†Ø© */
  color: #eaeaea;           /* Ø®Ø· ÙØ§ØªØ­ */
}

body.dark-mode .modal-header {
  border-bottom: 1px solid #444;
}

body.dark-mode .modal-body {
  color: #eaeaea;
}

body.dark-mode .modal-title {
  color: #fff;
}

/* Ø²Ø± Ø§Ù„Ø¥ØºÙ„Ø§Ù‚ ÙÙŠ Ø§Ù„ÙˆØ¶Ø¹ Ø§Ù„Ø¯Ø§ÙƒÙ† */
body.dark-mode .btn-close {
  filter: invert(1) grayscale(100%) brightness(200%);
}

/* Ø§Ù„ÙˆØ¶Ø¹ Ø§Ù„Ø¹Ø§Ø¯ÙŠ (Ø§Ù„Ø§ÙØªØ±Ø§Ø¶ÙŠ) */
body:not(.dark-mode) .modal-content {
  background-color: #fff;   /* Ø®Ù„ÙÙŠØ© Ø¨ÙŠØ¶Ø§Ø¡ */
  color: #212529;           /* Ø®Ø· ØºØ§Ù…Ù‚ */
}

body:not(.dark-mode) .modal-title {
  color: #000;
}

    
  </style>
</head>
<body>

<!-- Spinner -->
<div id="loadingSpinner" class="spinner-border text-primary" role="status">
  <span class="visually-hidden">Loading...</span>
</div>

<nav id="mainNavbar" class="navbar navbar-expand-lg sticky-top shadow-sm">
  <div class="container-fluid">
    <div class="collapse navbar-collapse" id="navbarContent">
      <ul class="navbar-nav mb-2 mb-lg-0">
        <li class="nav-item">
          <a class="nav-link text-white fw-semibold" href="#" onclick="requestDashboardAccess()">
            <i class="bi bi-shield-lock-fill fs-5"></i> Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ…
          </a>
        </li>
        <li class="nav-item">
          <a class="nav-link text-white fw-semibold" href="https://video-dashboard-backend.onrender.com/viewlinks.html">
            <i class="bi bi-link-45deg fs-5"></i> Ø±ÙˆØ§Ø¨Ø· Ù…Ù‡Ù…Ø©
          </a>
        </li>
        <li class="nav-item" id="logoutNavItem" style="display:none;">
          <a class="nav-link text-white fw-semibold" href="#" onclick="logout()">
            <i class="bi bi-box-arrow-right fs-5"></i> ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬
          </a>
        </li>
      </ul>
    </div>
    <a class="navbar-brand text-white fw-bold ms-auto d-flex align-items-center" href="#">
      <i class="bi bi-collection-play-fill fs-4 me-1"></i> Video Dashboard
    </a>
    <button class="navbar-toggler text-white border-0" type="button" data-bs-toggle="collapse" data-bs-target="#navbarContent">
      <span class="navbar-toggler-icon"></span>
    </button>
    <button id="themeToggle" class="btn btn-sm btn-outline-light ms-2">
      <i class="bi bi-moon-stars-fill"></i>
    </button>
  </div>
</nav>

<div class="container text-center">
  <h3 class="my-3 fw-bold">ğŸ¥ Ø§Ø®ØªØ± Ø§Ù„Ù‚Ø³Ù… Ù„Ø¹Ø±Ø¶ Ø§Ù„ÙÙŠØ¯ÙŠÙˆÙ‡Ø§Øª</h3>
  <select id="departmentSelect" class="form-select mb-3">
    <option value="">-- Ø§Ø®ØªØ± Ø§Ù„Ù‚Ø³Ù… --</option>
  </select>
  <input id="searchInput" class="form-control mb-4" type="text" placeholder="ğŸ” Ø§Ø¨Ø­Ø« Ø¨Ø¹Ù†ÙˆØ§Ù† Ø£Ùˆ ÙˆØµÙ Ø§Ù„ÙÙŠØ¯ÙŠÙˆ..." disabled>
  <div id="videoContainer" class="video-grid"></div>
</div>

<footer>Ø¨Ø±Ù…Ø¬Ø© ÙˆØªØ·ÙˆÙŠØ±: Ù„ÙŠØ« Ø¹Ø¨ÙŠØ¯Ø§Øª</footer>

<!-- Ù†Ø§ÙØ°Ø© Ø¹Ø±Ø¶ Ø§Ù„ÙˆØµÙ -->
<div class="modal fade" id="descModal" tabindex="-1">
  <div class="modal-dialog modal-lg modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="descTitle"></h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body" id="descContent" style="white-space: pre-wrap; text-align: justify;"></div>
    </div>
  </div>
</div>

<!-- Ù†Ø§ÙØ°Ø© ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± -->
<div class="modal fade" id="passwordModal" tabindex="-1">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">ğŸ” Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø¥Ù„Ù‰ Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ…</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <input type="password" id="dashboardPassword" class="form-control" placeholder="Ø£Ø¯Ø®Ù„ ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±" lang="en">
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Ø¥Ù„ØºØ§Ø¡</button>
        <button type="button" class="btn btn-primary" id="confirmDashboardAccess">Ø¯Ø®ÙˆÙ„</button>
      </div>
    </div>
  </div>
</div>

<!-- Toast Container -->
<div class="toast-container" id="toastContainer"></div>

<script>
const API_BASE = 'https://video-dashboard-backend.onrender.com';
let videos = [];
let passwordModal;

// âœ… Ø¯Ø§Ù„Ø© Ø¥Ø¸Ù‡Ø§Ø± Toast
function showToast(message, type="info") {
  const toastId = "toast" + Date.now();
  const bgClass = type==="success" ? "bg-success" : type==="error" ? "bg-danger" : "bg-info";
  const html = `
    <div id="${toastId}" class="toast align-items-center text-white ${bgClass} border-0 mb-2" role="alert">
      <div class="d-flex">
        <div class="toast-body">${message}</div>
        <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button>
      </div>
    </div>`;
  const container = document.getElementById("toastContainer");
  container.insertAdjacentHTML("beforeend", html);
  const toastEl = document.getElementById(toastId);
  const toast = new bootstrap.Toast(toastEl, { delay: 3000 });
  toast.show();
}

// Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ø¬Ù„Ø³Ø©
async function checkSessionStatus() {
  try {
    const res = await fetch(`${API_BASE}/api/check-session`);
    const data = await res.json();
    document.getElementById("logoutNavItem").style.display = data.authenticated ? "block" : "none";
  } catch (err) { console.error("Ø®Ø·Ø£ ÙÙŠ Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ø¬Ù„Ø³Ø©:", err); }
}

// ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬
async function logout() {
  try {
    await fetch(`${API_BASE}/api/logout`, { method: "POST" });
    sessionStorage.clear();
    document.getElementById("logoutNavItem").style.display = "none";
    showToast("âœ… ØªÙ… ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬ Ø¨Ù†Ø¬Ø§Ø­","success");
  } catch (err) {
    showToast("âŒ Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬","error");
  }
}

// Ø·Ù„Ø¨ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ù„Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ…
async function requestDashboardAccess() {
  const section = "dashboard";
  if (sessionStorage.getItem("loggedInAt_" + section)) {
    window.location.href = section + ".html";
    return;
  }
  try {
    const res = await fetch(`${API_BASE}/api/check-session`);
    const data = await res.json();
    if (data.authenticated) {
      sessionStorage.setItem("loggedInAt_" + section, Date.now().toString());
      window.location.href = section + ".html";
      return;
    }
  } catch (err) { console.error("Ø®Ø·Ø£ ÙÙŠ Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ø¬Ù„Ø³Ø©:", err); }

  const modalEl = document.getElementById('passwordModal');
  passwordModal = new bootstrap.Modal(modalEl);
  modalEl.addEventListener('shown.bs.modal', () => {
    const input = document.getElementById('dashboardPassword');
    input.value='';input.focus();
  });
  passwordModal.show();

  document.getElementById('confirmDashboardAccess').onclick = async () => {
    const passwordInput = document.getElementById('dashboardPassword');
    const password = passwordInput.value.trim();
    if (!password) return;

    try {
      const response = await fetch(`${API_BASE}/api/verify-password`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ section, password })
      });

      if (response.ok) {
        sessionStorage.setItem("loggedInAt_" + section, Date.now().toString());
        passwordModal.hide();
        window.location.href = section + '.html';
      } else { 
        showToast("âŒ ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± ØºÙŠØ± ØµØ­ÙŠØ­Ø©","error");
        passwordInput.value = "";
        passwordInput.focus();
      }
    } catch { 
      showToast("âŒ Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø§Ù„Ø®Ø§Ø¯Ù…","error");
    }
  };

  document.getElementById('dashboardPassword').addEventListener("keydown",(e)=>{
    if(e.key==="Enter") document.getElementById('confirmDashboardAccess').click();
  });
}

// Ø¬Ù„Ø¨ Ø§Ù„ÙÙŠØ¯ÙŠÙˆÙ‡Ø§Øª
async function fetchVideos() {
  try {
    document.getElementById("loadingSpinner").style.display="block";
    const res = await fetch(`${API_BASE}/api/videos`);
    videos = await res.json();
    populateDepartmentOptions();
  }
  catch (err) { console.error('ÙØ´Ù„ ØªØ­Ù…ÙŠÙ„ Ø§Ù„ÙÙŠØ¯ÙŠÙˆÙ‡Ø§Øª:', err); }
  finally {document.getElementById("loadingSpinner").style.display="none";}
}

// Ø¹Ø±Ø¶ Ø§Ù„ÙÙŠØ¯ÙŠÙˆÙ‡Ø§Øª
function renderVideos() {
  const dep=document.getElementById('departmentSelect').value;
  const q=document.getElementById('searchInput').value.trim().toLowerCase();
  const c=document.getElementById('videoContainer');c.innerHTML='';
  if(!dep)return;
  const filtered=videos.filter(v=>{
    const d=v.department?.trim().toLowerCase();
    const t=v.title?.toLowerCase()||'';
    const desc=v.description?.toLowerCase()||'';
    return d===dep.trim().toLowerCase()&&(t.includes(q)||desc.includes(q));
  });
  if(filtered.length===0){
    c.innerHTML='<p class="text-muted">ğŸš« Ù„Ø§ ØªÙˆØ¬Ø¯ ÙÙŠØ¯ÙŠÙˆÙ‡Ø§Øª Ù…Ø·Ø§Ø¨Ù‚Ø© Ù„Ù„Ø¨Ø­Ø«</p>';
    return;
  }
  filtered.forEach(video=>{
    const card=document.createElement('div');card.className='video-card';
    const title=`<div class="video-title">Ø¹Ù†ÙˆØ§Ù† Ø§Ù„ÙÙŠØ¯ÙŠÙˆ: ${video.title}</div>`;
    const desc=`<div class="video-description" onclick="showDescription('${escapeHtml(video.title)}','${escapeHtml(video.description)}')">ÙˆØµÙ Ø§Ù„ÙÙŠØ¯ÙŠÙˆ: ${video.description}</div>`;
    let media='';const link=video.link||video.url||'';let pop=link;
    if(link.includes('youtube.com')||link.includes('youtu.be')){
      media=`<iframe src="https://www.youtube.com/embed/${extractYouTubeID(link)}" allowfullscreen></iframe>`;
    }
    else if(link.includes('drive.google.com/file/d/')){
      const m=link.match(/\/file\/d\/(.*?)(\/|$)/);
      media=m?`<iframe src="https://drive.google.com/file/d/${m[1]}/preview" allowfullscreen></iframe>`:`<video controls src="${link}"></video>`;
    }
    else if(link.includes("sharepoint.com/")&&link.includes("/embed.aspx")){
      media=`<iframe class="sharepoint-frame" src="${link}" allowfullscreen></iframe>`;
      const m=link.match(/UniqueId=([a-zA-Z0-9\-]+)/);
      if(m)pop=`https://ymkh-my.sharepoint.com/personal/laith_obaidat_iu_edu_jo/_layouts/15/stream.aspx?UniqueId=${m[1]}`;
    }
    else if(link.includes("sharepoint.com/")&&link.includes("/stream.aspx")){
      const m=link.match(/UniqueId=([a-zA-Z0-9\-]+)/);
      if(m){
        const e=`https://ymkh-my.sharepoint.com/personal/laith_obaidat_iu_edu_jo/_layouts/15/embed.aspx?UniqueId=${m[1]}&embed=%7B%22ust%22%3Atrue%7D&referrer=StreamWebApp&referrerScenario=EmbedDialog.Create`;
        media=`<iframe class="sharepoint-frame" src="${e}" allowfullscreen></iframe>`;
        pop=link;
      }else{
        media=`<video controls src="${link}"></video>`;
      }
    }
    else{media=`<video controls src="${link}"></video>`;}
    const btn=`<button class="popout-button" onclick="window.open('${pop}','_blank','width=800,height=600')">Ø¹Ø±Ø¶ Ø§Ù„ÙÙŠØ¯ÙŠÙˆ</button>`;
    card.innerHTML=title+desc+media+btn;c.appendChild(card);
  });
}
function escapeHtml(t){return t?.replace(/"/g,'&quot;').replace(/'/g,'&#39;')||'';}
function extractYouTubeID(u){const m=u.match(/[?&]v=([^&#]*)|youtu\.be\/([^&#]*)/);return m?(m[1]||m[2]):'';}
function showDescription(t,d){document.getElementById('descTitle').textContent=t;document.getElementById('descContent').innerHTML=d;new bootstrap.Modal(document.getElementById('descModal')).show();}
function populateDepartmentOptions(){
  const counts=videos.reduce((a,v)=>{a[v.department]=(a[v.department]||0)+1;return a;},{});const sel=document.getElementById('departmentSelect');
  sel.innerHTML='<option value="">-- Ø§Ø®ØªØ± Ø§Ù„Ù‚Ø³Ù… --</option>';
  Object.entries(counts).forEach(([dep,c])=>{
    const o=document.createElement('option');
    o.value=dep;o.textContent=`${dep} (${c})`;
    sel.appendChild(o);
  });
}

document.getElementById('departmentSelect').addEventListener('change',()=>{
  document.getElementById('searchInput').disabled=false;
  renderVideos();
});
document.getElementById('searchInput').addEventListener('input',renderVideos);
document.addEventListener("DOMContentLoaded",()=>{
  checkSessionStatus();
  fetchVideos();
});

// Navbar scroll + theme toggle
window.addEventListener('scroll',()=>{
  const nav=document.getElementById('mainNavbar');
  if(window.scrollY>20)nav.classList.add('scrolled');else nav.classList.remove('scrolled');
});
document.getElementById('themeToggle').addEventListener('click',()=>{
  document.body.classList.toggle('dark-mode');
  const icon=document.querySelector("#themeToggle i");
  if(document.body.classList.contains("dark-mode")){
    icon.classList.replace("bi-moon-stars-fill","bi-brightness-high-fill");
  }else{
    icon.classList.replace("bi-brightness-high-fill","bi-moon-stars-fill");
  }
});
</script>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
