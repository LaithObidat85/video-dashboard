<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <title>لوحة نظام اللجان</title>
  <link rel="icon" type="image/png" href="https://www.dropbox.com/scl/fi/f283e4rvv5cf9x12a1cic/my-website-logo.png?rlkey=yia776im7klypy27af32m0scy&e=1&st=vhaprvzh&dl=1">
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.rtl.min.css">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@latest/font/bootstrap-icons.css">
  <style>
    .user-chip{
      display:inline-flex;
      align-items:center;
      gap:.25rem;
      font-size:1rem;
      padding:.375rem .75rem;
      line-height:1.5;
      border-radius:.375rem
    }
    body{background:#f8f9fa;font-family:'Segoe UI',sans-serif}
    .container{max-width:1100px;margin-top:40px}
    .card-link{display:block;text-decoration:none;color:inherit;border-radius:16px;box-shadow:0 6px 18px rgba(0,0,0,.08);transition:.2s}
    .card-link:hover{transform:translateY(-3px);box-shadow:0 8px 24px rgba(0,0,0,.12)}
    .icon{font-size:38px}
    .admin-only{display:none}
    .user-chip{font-size:.9rem}

    /* منع وميض البطاقات قبل معرفة الدور */
    .cards-stealth{opacity:0; visibility:hidden; transition:opacity .15s ease}
    .cards-stealth.cards-ready{opacity:1; visibility:visible}
  </style>
</head>
<body>
  <div class="container">
    <div class="d-flex flex-wrap justify-content-between align-items-center mb-4 gap-2">
      <h3 class="mb-0">لوحة نظام اللجان</h3>
      <div class="d-flex align-items-center gap-2">
        <span id="userInfo" class="user-chip badge bg-light text-dark border">
          <i class="bi bi-person"></i>
          <span id="userUsername">—</span>
          <span class="mx-1">—</span>
          <span id="userFullName">—</span>
          <span class="ms-2 badge bg-secondary" id="userRole">—</span>
        </span>
        <button id="logoutBtn" class="btn btn-danger">
          <i class="bi bi-box-arrow-right"></i> خروج
        </button>
      </div>
    </div>

    <!-- لودر يظهر إلى أن نتأكد من الدور -->
    <div id="pageLoader" class="d-flex justify-content-center align-items-center py-5">
      <div class="spinner-border" role="status" aria-label="Loading"></div>
    </div>

    <div id="cardsGrid" class="row g-4 cards-stealth">
      <!-- إدخال تقييم لجنة (user/admin) -->
      <div class="col-12 col-sm-6 col-lg-4">
        <a href="/add_evaluation.html" class="card-link p-4 bg-white d-block h-100">
          <div class="icon text-primary"><i class="bi bi-journal-plus"></i></div>
          <h5 class="mt-3">إدخال تقييم لجنة</h5>
          <p class="mb-0 text-muted">إضافة تقييم جديد</p>
        </a>
      </div>

      <!-- إدارة تقييم اللجان (user يرى الرابط المطلوب + admin بالطبع) -->
      <div class="col-12 col-sm-6 col-lg-4" data-admin="true">
        <a href="https://vdash-qkyv.onrender.com/manage_committees.html" class="card-link p-4 bg-white d-block h-100">
          <div class="icon text-success"><i class="bi bi-gear"></i></div>
          <h5 class="mt-3">إدارة تقييم اللجان</h5>
          <p class="mb-0 text-muted">تحرير/حذف التقييمات</p>
        </a>
      </div>

      <!-- إدارة أسماء اللجان (admin-only) -->
      <div class="col-12 col-sm-6 col-lg-4 admin-only" data-admin="true">
        <a href="/committees-names-manage.html" class="card-link p-4 bg-white d-block h-100">
          <div class="icon text-info"><i class="bi bi-list-check"></i></div>
          <h5 class="mt-3">إدارة أسماء اللجان</h5>
          <p class="mb-0 text-muted">قاموس أسماء اللجان</p>
        </a>
      </div>

      <!-- إدارة الكليات (admin-only) -->
      <div class="col-12 col-sm-6 col-lg-4 admin-only" data-admin="true">
        <a href="/manage_colleges.html" class="card-link p-4 bg-white d-block h-100">
          <div class="icon text-warning"><i class="bi bi-building"></i></div>
          <h5 class="mt-3">إدارة الكليات</h5>
          <p class="mb-0 text-muted">إضافة/تعديل/حذف</p>
        </a>
      </div>

      <!-- إدارة المدققين (admin-only) -->
      <div class="col-12 col-sm-6 col-lg-4 admin-only" data-admin="true">
        <a href="/manage_auditors.html" class="card-link p-4 bg-white d-block h-100">
          <div class="icon text-danger"><i class="bi bi-person-badge"></i></div>
          <h5 class="mt-3">إدارة المدققين</h5>
          <p class="mb-0 text-muted">إضافة/تعديل/حذف</p>
        </a>
      </div>

      <!-- إدارة المستخدمين (admin-only) -->
      <div class="col-12 col-sm-6 col-lg-4 admin-only" data-admin="true">
        <a href="/users-manage.html" class="card-link p-4 bg-white d-block h-100">
          <div class="icon text-dark"><i class="bi bi-people-fill"></i></div>
          <h5 class="mt-3">إدارة المستخدمين</h5>
          <p class="mb-0 text-muted">إضافة/تعديل/تعطيل مستخدم</p>
        </a>
      </div>

      <!-- ✅ سجل العمليات (admin-only) -->
      <div class="col-12 col-sm-6 col-lg-4 admin-only" data-admin="true">
        <a href="/audit-logs.html" class="card-link p-4 bg-white d-block h-100">
          <div class="icon text-secondary"><i class="bi bi-clipboard-data"></i></div>
          <h5 class="mt-3">سجل العمليات</h5>
          <p class="mb-0 text-muted">من أجرى الإضافة/التعديل/الحذف</p>
        </a>
      </div>

      <!-- ✅ NEW: تكليفات اللجان (admin-only) -->
      <div class="col-12 col-sm-6 col-lg-4 admin-only" data-admin="true">
        <a href="/committees-assignments.html" class="card-link p-4 bg-white d-block h-100">
          <div class="icon text-primary"><i class="bi bi-kanban"></i></div>
          <h5 class="mt-3">تكليفات اللجان</h5>
          <p class="mb-0 text-muted">إنشاء وتوزيع ومتابعة التكليفات</p>
        </a>
      </div>

      <!-- عرض التقييمات (عام) -->
      <div class="col-12 col-sm-6 col-lg-4">
        <a href="/evaluations_dashboard.html" class="card-link p-4 bg-white d-block h-100" target="_blank">
          <div class="icon text-secondary"><i class="bi bi-bar-chart-line"></i></div>
          <h5 class="mt-3">عرض تقييم اللجان (عام)</h5>
          <p class="mb-0 text-muted">يفتح في تبويب جديد</p>
        </a>
      </div>

      <!-- ✅ NEW: إضافة روابط ملفات اللجان (يظهر للجميع) -->
      <div class="col-12 col-sm-6 col-lg-4">
        <a href="/committees-files-add.html" class="card-link p-4 bg-white d-block h-100">
          <div class="icon text-primary"><i class="bi bi-link-45deg"></i></div>
          <h5 class="mt-3">إضافة ملفات اللجان</h5>
          <p class="mb-0 text-muted">إدخال وحفظ روابط المستندات لكل لجنة</p>
        </a>
      </div>

      <!-- ✅ NEW: عرض روابط ملفات اللجان (admin & user فقط) -->
      <div class="col-12 col-sm-6 col-lg-4" data-role-visible="admin,user">
        <a href="/committees-files-show.html" class="card-link p-4 bg-white d-block h-100">
          <div class="icon text-success"><i class="bi bi-collection"></i></div>
          <h5 class="mt-3">عرض ملفات اللجان</h5>
          <p class="mb-0 text-muted">تصفّح وفتح الروابط بحسب الكلية/العام/الفصل/اللجنة</p>
        </a>
      </div>
    </div>
  </div>

  <!-- Toasts -->
  <div class="toast-container position-fixed top-0 start-50 translate-middle-x p-3" style="z-index:2000">
    <div id="toastSuccess" class="toast align-items-center text-bg-success border-0 mb-2" role="alert">
      <div class="d-flex">
        <div class="toast-body">✅ تم التنفيذ بنجاح</div>
        <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button>
      </div>
    </div>
    <div id="toastError" class="toast align-items-center text-bg-danger border-0 mb-2" role="alert">
      <div class="d-flex">
        <div class="toast-body">❌ حدث خطأ</div>
        <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button>
      </div>
    </div>
    <div id="toastInfo" class="toast align-items-center text-bg-primary border-0 mb-2" role="alert">
      <div class="d-flex">
        <div class="toast-body">ℹ️ معلومات</div>
        <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button>
      </div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  <script>
    const toastSuccess = new bootstrap.Toast(document.getElementById('toastSuccess'));
    const toastError   = new bootstrap.Toast(document.getElementById('toastError'));
    const toastInfo    = new bootstrap.Toast(document.getElementById('toastInfo'));
    function setToast(el, msg){ el._element.querySelector('.toast-body').innerText = msg; }

    async function fetchMe() {
      try {
        const res = await fetch('/auth/committees/me', { credentials: 'include' });
        if (!res.ok) throw new Error('HTTP ' + res.status);
        return await res.json();
      } catch {
        return { authenticated:false };
      }
    }

    function renderUser(user){
      const username = user?.username || (user?.email ? user.email.split('@')[0] : '—');
      document.getElementById('userUsername').textContent = username || '—';
      document.getElementById('userFullName').textContent = user?.name || '—';

      // عرض "member" بدل "user" في الشارة فقط
      const roleRaw = (user?.role || '—').toLowerCase();
      const roleShown = roleRaw === 'user' ? 'member' : (user?.role || '—');
      document.getElementById('userRole').textContent = roleShown;

      const cols = document.querySelectorAll('#cardsGrid > [class^="col-"]');

      // helper لإظهار العناصر حسب دالة مطابقة
      function showBy(fn){
        cols.forEach(col => {
          const a = col.querySelector('a.card-link');
          if (!a) return;
          const href = a.getAttribute('href') || '';
          col.style.display = fn(href, col) ? '' : 'none';
        });
      }

      // admin يرى كل شيء (بما فيها سجل العمليات)
      if (roleRaw === 'admin') {
        document.querySelectorAll('.admin-only').forEach(el => el.classList.remove('admin-only'));
        cols.forEach(col => { col.style.display = ''; });
        return;
      }

      // user: يرى إدخال التقييم + العرض العام + إدارة تقييم اللجان
      //      + إضافة روابط اللجان + عرض روابط اللجان
      if (roleRaw === 'user') {
        showBy((href) =>
          /\/add_evaluation\.html\b/.test(href) ||
          /\/evaluations_dashboard\.html\b/.test(href) ||
          /manage_committees\.html\b/.test(href) ||
          /\/committees-files-add\.html\b/.test(href) ||
          /\/committees-files-show\.html\b/.test(href)
        );
        return;
      }

      // subuser-member: يرى العرض العام + إضافة روابط اللجان فقط
      if (roleRaw === 'subuser-member') {
        showBy((href) =>
          /\/evaluations_dashboard\.html\b/.test(href) ||
          /\/committees-files-add\.html\b/.test(href)
        );
        return;
      }

      // أي دور آخر غير معروف: العرض العام فقط
      showBy((href) =>
        /\/evaluations_dashboard\.html\b/.test(href)
      );
    }

    async function ensureAuth(){
      const me = await fetchMe();
      if (!me.authenticated) {
        const next = encodeURIComponent('/committees-home.html');
        window.location.href = `/committees-login.html?next=${next}`;
        return;
      }
      renderUser(me.user);

      // ✅ بعد تطبيق صلاحيات الدور: أخفِ اللودر وأظهر الشبكة بسلاسة
      document.getElementById('pageLoader')?.classList.add('d-none');
      document.getElementById('cardsGrid')?.classList.add('cards-ready');
    }

    async function logout(){
      try {
        const res = await fetch('/auth/committees/logout', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          credentials: 'include'
        });
        if (res.ok) {
          setToast(toastSuccess, '✅ تم تسجيل الخروج');
          toastSuccess.show();
          setTimeout(() => { window.location.href = '/committees-login.html'; }, 700);
        } else {
          setToast(toastError, '❌ تعذر تسجيل الخروج'); toastError.show();
        }
      } catch {
        setToast(toastError, '❌ خطأ في الاتصال بالخادم'); toastError.show();
      }
    }

    document.getElementById('logoutBtn').addEventListener('click', logout);
    ensureAuth();
  </script>
</body>
</html>
