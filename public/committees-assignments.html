<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <title>Ø¥Ø¯Ø§Ø±Ø© ØªØ¹ÙŠÙŠÙ†Ø§Øª Ø§Ù„Ù„Ø¬Ø§Ù† â€” Ù†Ø¸Ø§Ù… Ø§Ù„Ù„Ø¬Ø§Ù†</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <link rel="icon" type="image/png" href="https://www.dropbox.com/scl/fi/f283e4rvv5cf9x12a1cic/my-website-logo.png?rlkey=yia776im7klypy27af32m0scy&e=1&dl=1">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.rtl.min.css">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css">
  <style>
    body{background:#f8f9fa;font-family:'Segoe UI',sans-serif}
    .container-fluid{margin-top:24px;max-width:100%}
    .user-chip{display:inline-flex;align-items:center;gap:.25rem;font-size:1rem!important;padding:.375rem .75rem!important;line-height:1.5!important;border-radius:.375rem;font-weight:700!important}
    .user-chip.badge #userRole{font-weight:500!important}
    .table thead th{position:sticky;top:0;background:#fff;z-index:5;cursor:pointer}
    .table td, .table th{vertical-align:middle}
    .badge-role{font-size:.85rem}
    .dirty-row{background:#fff9e6}
    .toolbar .form-control, .toolbar .form-select{min-width:160px}
    .spinner-overlay{position:fixed;inset:0;background:rgba(255,255,255,.6);display:none;align-items:center;justify-content:center;z-index:3000}
  </style>
</head>
<body>
  <div class="container-fluid">
    <!-- Header -->
    <div class="d-flex flex-wrap justify-content-between align-items-center mb-3 gap-2">
      <h4 class="mb-0">Ø¥Ø¯Ø§Ø±Ø© ØªØ¹ÙŠÙŠÙ†Ø§Øª Ø§Ù„Ù„Ø¬Ø§Ù†</h4>
      <div class="d-flex align-items-center gap-2">
        <span id="userInfo" class="user-chip badge bg-light text-dark border">
          <i class="bi bi-person"></i>
          <span id="userUsername">â€”</span>
          <span class="mx-1">â€”</span>
          <span id="userFullName">â€”</span>
          <span class="ms-2 badge bg-secondary" id="userRole">â€”</span>
        </span>
        <a class="btn btn-outline-primary" id="homeBtn" href="/committees-home.html"><i class="bi bi-grid"></i> Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ…</a>
        <button id="logoutBtn" class="btn btn-danger"><i class="bi bi-box-arrow-right"></i> Ø®Ø±ÙˆØ¬</button>
      </div>
    </div>

    <!-- Toolbar -->
    <div class="card mb-3">
      <div class="card-body d-flex flex-wrap align-items-center gap-2 toolbar">
        <input id="qInput" class="form-control" placeholder="Ø¨Ø­Ø«: Ø§Ø³Ù…/Ù…Ø³ØªØ®Ø¯Ù…/Ø¨Ø±ÙŠØ¯/ÙƒÙ„ÙŠØ©/Ù„Ø¬Ù†Ø©/Ù…Ù„Ø§Ø­Ø¸Ø©">
        <select id="roleFilter" class="form-select">
          <option value="">ÙƒÙ„ Ø§Ù„Ø£Ø¯ÙˆØ§Ø±</option>
          <option value="subuser-member">subuser-member</option>
          <option value="user">user</option>
          <option value="admin">admin</option>
        </select>
        <select id="collegeFilter" class="form-select"><option value="">ÙƒÙ„ Ø§Ù„ÙƒÙ„ÙŠØ§Øª</option></select>
        <select id="committeeFilter" class="form-select"><option value="">ÙƒÙ„ Ø§Ù„Ù„Ø¬Ø§Ù†</option></select>
        <select id="pageSize" class="form-select">
          <option value="10">10</option>
          <option value="20" selected>20</option>
          <option value="50">50</option>
          <option value="100">100</option>
        </select>

        <button id="refreshBtn" class="btn btn-outline-secondary ms-auto">
          <i class="bi bi-arrow-clockwise"></i> ØªØ­Ø¯ÙŠØ«
        </button>
        <button id="saveAllBtn" class="btn btn-success" disabled>
          <i class="bi bi-save"></i> Ø­ÙØ¸ Ø§Ù„ØªØºÙŠÙŠØ±Ø§Øª
        </button>
        <button id="cancelAllBtn" class="btn btn-outline-secondary" disabled>
          <i class="bi bi-x-circle"></i> Ø¥Ù„ØºØ§Ø¡ Ø§Ù„ØªØºÙŠÙŠØ±Ø§Øª
        </button>
        <button id="addBtn" class="btn btn-primary">
          <i class="bi bi-plus-circle"></i> Ø¥Ø¶Ø§ÙØ© ØªØ¹ÙŠÙŠÙ†
        </button>
        <span class="small text-muted">Ù‡Ø°Ù‡ Ø§Ù„ØµÙØ­Ø© Ù„Ù„Ù…Ø´Ø±Ù ÙÙ‚Ø· (admin)</span>
      </div>
    </div>

    <!-- Table -->
    <div class="card">
      <div class="card-body p-0">
        <div class="table-responsive">
          <table class="table align-middle mb-0 w-100">
            <thead>
              <tr>
                <th>Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…</th>
                <th>Ø§Ù„Ø¨Ø±ÙŠØ¯</th>
                <th>Ø§Ù„Ø¯ÙˆØ±</th>
                <th data-sort="college" class="text-nowrap">Ø§Ù„ÙƒÙ„ÙŠØ©</th>
                <th data-sort="committee_name" class="text-nowrap">Ø§Ù„Ù„Ø¬Ù†Ø©</th>
                <th data-sort="note">Ø§Ù„Ù…Ù„Ø§Ø­Ø¸Ø©</th>
                <th class="text-center">Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª</th>
              </tr>
            </thead>
            <tbody id="rows"><tr><td colspan="7" class="text-center py-4">â€”</td></tr></tbody>
          </table>
        </div>
        <div class="d-flex align-items-center justify-content-between p-2">
          <div class="small text-muted" id="metaText">â€”</div>
          <div class="btn-group">
            <button class="btn btn-outline-primary btn-sm" id="prevPage">&laquo; Ø§Ù„Ø³Ø§Ø¨Ù‚</button>
            <button class="btn btn-outline-primary btn-sm" id="nextPage">Ø§Ù„ØªØ§Ù„ÙŠ &raquo;</button>
          </div>
        </div>
      </div>
    </div>

    <!-- Toasts -->
    <div class="toast-container position-fixed top-0 start-50 translate-middle-x p-3" style="z-index:2000">
      <div id="toastSuccess" class="toast align-items-center text-bg-success border-0 mb-2" role="alert">
        <div class="d-flex"><div class="toast-body">âœ… ØªÙ…Øª Ø§Ù„Ø¹Ù…Ù„ÙŠØ© Ø¨Ù†Ø¬Ø§Ø­</div><button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button></div>
      </div>
      <div id="toastError" class="toast align-items-center text-bg-danger border-0 mb-2" role="alert">
        <div class="d-flex"><div class="toast-body">âŒ Ø­Ø¯Ø« Ø®Ø·Ø£</div><button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button></div>
      </div>
      <div id="toastInfo" class="toast align-items-center text-bg-info border-0 mb-2" role="alert">
        <div class="d-flex"><div class="toast-body" id="toastInfoBody">â„¹ï¸</div><button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button></div>
      </div>
    </div>
  </div>

  <!-- Spinner -->
  <div class="spinner-overlay" id="spinner">
    <div class="spinner-border" role="status"><span class="visually-hidden">Loading...</span></div>
  </div>

  <!-- Modal: add -->
  <div class="modal fade" id="addModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">Ø¥Ø¶Ø§ÙØ© ØªØ¹ÙŠÙŠÙ†</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <div class="vstack gap-3">
            <div>
              <label class="form-label">Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… (subuser-member)</label>
              <select id="userSelect" class="form-select"></select>
            </div>
            <div>
              <label class="form-label">Ø§Ù„ÙƒÙ„ÙŠØ©</label>
              <select id="collegeSelect" class="form-select"><option value="">â€” Ø§Ø®ØªØ± â€”</option></select>
            </div>
            <div>
              <label class="form-label">Ø§Ø³Ù… Ø§Ù„Ù„Ø¬Ù†Ø©</label>
              <select id="committeeSelect" class="form-select"><option value="">â€” Ø§Ø®ØªØ± â€”</option></select>
            </div>
            <div>
              <label class="form-label">Ù…Ù„Ø§Ø­Ø¸Ø© (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)</label>
              <input id="noteInput" class="form-control" placeholder="Ø§Ø®ØªÙŠØ§Ø±ÙŠ">
            </div>
          </div>
        </div>
        <div class="modal-footer">
          <button class="btn btn-secondary" data-bs-dismiss="modal">Ø¥Ù„ØºØ§Ø¡</button>
          <button id="saveAddBtn" class="btn btn-success"><i class="bi bi-save"></i> Ø­ÙØ¸</button>
        </div>
      </div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  <script>
    /* ====== Ø¨ÙŠØ¦Ø© Ù…ÙˆØ­Ù‘Ø¯Ø© ====== */
    const RENDER_BASE='https://vdash-qkyv.onrender.com';
    const host=location.hostname;
    const isGithub=host.endsWith('github.io');
    const isLocal=host==='localhost'||host==='127.0.0.1';
    const API_BASE=isGithub?RENDER_BASE:(isLocal?'http://localhost:3000':'');
    const go=(path)=>isGithub?(RENDER_BASE+path):path;

    const toastSuccess=new bootstrap.Toast(document.getElementById('toastSuccess'));
    const toastError  =new bootstrap.Toast(document.getElementById('toastError'));
    const toastInfo   =new bootstrap.Toast(document.getElementById('toastInfo'));
    const setInfo=(t)=>{ document.getElementById('toastInfoBody').textContent=t; toastInfo.show(); };
    const apiFetch=(path,opts={})=>fetch(`${API_BASE}${path}`,{credentials:'include',...opts});
    const spinner = document.getElementById('spinner');
    const showSpinner=()=>spinner.style.display='flex';
    const hideSpinner=()=>spinner.style.display='none';

    document.getElementById('homeBtn').href=go('/committees-home.html');

    /* ====== Ø¬Ù„Ø³Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… ====== */
    let CURRENT_USER=null;
    async function ensureAuth(){
      const r=await apiFetch('/auth/committees/me'); const j=await r.json();
      if(!j?.authenticated){ location.href=go('/committees-login.html?next='+encodeURIComponent('/committees-assignments.html')); throw 0; }
      CURRENT_USER=j.user;
      userUsername.textContent=j.user.username || (j.user.email? j.user.email.split('@')[0]:'â€”');
      userFullName.textContent=j.user.name||'â€”';
      userRole.textContent=j.user.role||'â€”';
      if(j.user.role!=='admin'){ setInfo('Ù‡Ø°Ù‡ Ø§Ù„ØµÙØ­Ø© Ù„Ù„Ù…Ø´Ø±Ù ÙÙ‚Ø·'); location.href=go('/committees-home.html'); throw 0; }
    }
    logoutBtn.addEventListener('click',async()=>{
      try{
        const r=await apiFetch('/auth/committees/logout',{method:'POST',headers:{'Content-Type':'application/json'}});
        if(r.ok){ toastSuccess.show(); setTimeout(()=>location.href=go('/committees-login.html'),700); } else toastError.show();
      }catch{ toastError.show(); }
    });

    /* ====== Ù…ØµØ§Ø¯Ø± Ø§Ù„Ù‚ÙˆØ§Ø¦Ù… ====== */
    function normalizeName(item){ if(typeof item==='string') return item; return item?.name||item?.committee_name||item?.college||''; }
    async function loadSubusers(){
      const r = await apiFetch('/api/users?role=subuser-member&limit=200');
      const j = await r.json();
      const users = j?.data || [];
      userSelect.innerHTML='';
      users.forEach(u=>{
        const o=document.createElement('option');
        o.value=u._id||u.id; o.textContent=`${u.name} (${u.username})`;
        userSelect.appendChild(o);
      });
    }
    async function loadCollegesTo(selectEl){
      const r=await apiFetch('/api/colleges'); const arr=await r.json().catch(()=>[]);
      selectEl.innerHTML = selectEl === collegeFilter ? '<option value="">ÙƒÙ„ Ø§Ù„ÙƒÙ„ÙŠØ§Øª</option>' : '<option value="">â€” Ø§Ø®ØªØ± â€”</option>';
      (arr||[]).forEach(c=>{ const n=normalizeName(c); if(!n) return; const o=document.createElement('option'); o.value=n; o.textContent=n; selectEl.appendChild(o); });
    }
    async function loadCommitteesTo(selectEl){
      const r=await apiFetch('/api/committee-names?q=').catch(()=>apiFetch('/api/committees-master'));
      const arr=await r.json().catch(()=>[]);
      selectEl.innerHTML = selectEl === committeeFilter ? '<option value="">ÙƒÙ„ Ø§Ù„Ù„Ø¬Ø§Ù†</option>' : '<option value="">â€” Ø§Ø®ØªØ± â€”</option>';
      (arr||[]).forEach(c=>{ const n=normalizeName(c); if(!n) return; const o=document.createElement('option'); o.value=n; o.textContent=n; selectEl.appendChild(o); });
    }

    /* ====== Ø­Ø§Ù„Ø© Ø§Ù„Ø¬Ø¯ÙˆÙ„ ====== */
    let state = {
      page: 1,
      limit: 20,
      sort: '-createdAt', // Ø§Ù„Ø®Ø§Ø¯Ù… ÙŠØ¯Ø¹Ù…: createdAt, college, committee_name, note
      q: '',
      role: '',
      college: '',
      committee_name: '',
      total: 0,
      rows: [],      // Ø¨ÙŠØ§Ù†Ø§Øª Ø¢Ø®Ø± ØªØ­Ù…ÙŠÙ„
      original: {},  // Ù†Ø³Ø®Ø© Ø£ØµÙ„ÙŠØ© Ù„Ù„Ù…Ù‚Ø§Ø±Ù†Ø©
      dirty: new Set()
    };

    // Ù„Ø§ ØªÙ…Ø³Ø­ Ø§Ù„Ø£ØµÙ„ Ø¨Ø¹Ø¯ Ø§Ù„ØªØ­Ù…ÙŠÙ„ â€” Ù†Ø¹Ø·ÙŠ Ø®ÙŠØ§Ø± Ø§Ù„Ø¥Ø¨Ù‚Ø§Ø¡ Ø¹Ù„Ù‰ Ø§Ù„Ø£ØµÙ„
    function resetDirty(keepOriginal=false){
      if(!keepOriginal) state.original = {};
      state.dirty.clear();
      saveAllBtn.disabled = true;
      cancelAllBtn.disabled = true;
      document.querySelectorAll('tr[data-id]').forEach(tr=>tr.classList.remove('dirty-row'));
    }

    function markDirty(id, tr){
      state.dirty.add(id);
      const row = state.rows.find(r=>r._id===id);
      if(row) row._dirty = true;
      tr.classList.add('dirty-row');
      saveAllBtn.disabled = false;
      cancelAllBtn.disabled = false;
    }

    function unmarkIfClean(id, tr){
      // Ø¥Ù† Ù„Ù… ÙŠØ¹Ø¯ Ù‡Ù†Ø§Ùƒ Ø§Ø®ØªÙ„Ø§ÙØ§Øª Ù„ÙƒÙ„ Ø§Ù„Ø­Ù‚ÙˆÙ„ØŒ Ø§Ø²Ù„ Ø§Ù„ÙˆØ³Ù…
      const a = state.rows.find(x=>x._id===id);
      const o = state.original[id] || {};
      if(a && o){
        const isClean =
          (a.college||'')=== (o.college||'') &&
          (a.committee_name||'')=== (o.committee_name||'') &&
          (a.note||'')=== (o.note||'');
        if(isClean){
          state.dirty.delete(id);
          if(tr) tr.classList.remove('dirty-row');
          if(!state.dirty.size){ saveAllBtn.disabled = true; cancelAllBtn.disabled = true; }
        }
      }
    }

    function captureOriginal(rows){
      state.original = {};
      rows.forEach(r=>{
        state.original[r._id] = {
          college: r.college || '',
          committee_name: r.committee_name || '',
          note: r.note || ''
        };
      });
    }

    function getSortFor(th){
      const key = th.getAttribute('data-sort'); if(!key) return null;
      if (state.sort === key) return '-' + key;
      if (state.sort === '-' + key) return key;
      return key;
    }

    /* ====== ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØªØ¹ÙŠÙŠÙ†Ø§Øª ====== */
    async function loadAssignments(){
      const tbody=rows; tbody.innerHTML='<tr><td colspan="7" class="text-center py-4">Ø¬Ø§Ø±Ù Ø§Ù„ØªØ­Ù…ÙŠÙ„â€¦</td></tr>';
      showSpinner();
      try{
        const params = new URLSearchParams({
          page: state.page,
          limit: state.limit,
          sort: state.sort,
          q: state.q,
          role: state.role,
          college: state.college,
          committee_name: state.committee_name
        });
        const r=await apiFetch('/api/committee-assignments?'+params.toString());
        const j=await r.json();
        const arr = j?.data || [];
        state.total = j?.meta?.total || arr.length;

        tbody.innerHTML='';
        if(!arr.length){
          tbody.innerHTML='<tr><td colspan="7" class="text-center py-4">Ù„Ø§ ØªÙˆØ¬Ø¯ ØªØ¹ÙŠÙŠÙ†Ø§Øª</td></tr>';
          metaText.textContent='â€”';
          resetDirty(true); // Ø¥Ø¨Ù‚Ù Ø§Ù„Ø£ØµÙ„ ÙƒÙ…Ø§ Ù‡Ùˆ (ÙØ§Ø±Øº Ù‡Ù†Ø§) ÙˆØ§ØºÙ„Ù‚ Ø§Ù„Ø£Ø²Ø±Ø§Ø±
          hideSpinner();
          return;
        }

        state.rows = arr.map(a=>({ ...a, _dirty:false }));
        captureOriginal(state.rows); // Ø³Ø¬Ù„ Ø§Ù„Ø£ØµÙ„ Ù‚Ø¨Ù„ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„Ø§Øª

        for(const a of state.rows){
          const tr=document.createElement('tr'); tr.setAttribute('data-id', a._id);

          // Ù…Ø³ØªØ®Ø¯Ù…/Ø¨Ø±ÙŠØ¯/Ø¯ÙˆØ±
          const userCell = `<div class="text-nowrap">${a.userId?.name||'â€”'} <span class="text-muted">(${a.userId?.username||'â€”'})</span></div>`;
          const emailCell = `${a.userId?.email||'â€”'}`;
          const roleCell  = `<span class="badge text-bg-secondary badge-role">${a.userId?.role||'â€”'}</span>`;

          // Ø¹Ù†Ø§ØµØ± Ù‚Ø§Ø¨Ù„Ø© Ù„Ù„ØªØ¹Ø¯ÙŠÙ„
          const collegeSel = document.createElement('select');
          collegeSel.className='form-select form-select-sm';
          collegeSel.innerHTML = collegeFilter.innerHTML.replace('ÙƒÙ„ Ø§Ù„ÙƒÙ„ÙŠØ§Øª','â€” Ø§Ø®ØªØ± â€”');
          collegeSel.value = a.college || '';

          const commSel = document.createElement('select');
          commSel.className='form-select form-select-sm';
          commSel.innerHTML = committeeFilter.innerHTML.replace('ÙƒÙ„ Ø§Ù„Ù„Ø¬Ø§Ù†','â€” Ø§Ø®ØªØ± â€”');
          commSel.value = a.committee_name || '';

          const noteInp = document.createElement('input');
          noteInp.type='text'; noteInp.className='form-control form-control-sm';
          noteInp.placeholder='Ù…Ù„Ø§Ø­Ø¸Ø©'; noteInp.value = a.note || '';

          // Ø£Ø­Ø¯Ø§Ø« Ø§Ù„ØªØ¹Ø¯ÙŠÙ„ (Ù…Ø¹ Ù…Ù‚Ø§Ø±Ù†Ø© Ø¨Ø§Ù„Ø£ØµÙ„ Ø§Ù„Ù…Ø®Ø²Ù‘Ù†)
          collegeSel.addEventListener('change', ()=>{
            a.college = collegeSel.value;
            const o = state.original[a._id] || {};
            if(collegeSel.value !== (o.college||'')) markDirty(a._id, tr); else unmarkIfClean(a._id, tr);
          });
          commSel.addEventListener('change', ()=>{
            a.committee_name = commSel.value;
            const o = state.original[a._id] || {};
            if(commSel.value !== (o.committee_name||'')) markDirty(a._id, tr); else unmarkIfClean(a._id, tr);
          });
          noteInp.addEventListener('input', ()=>{
            a.note = noteInp.value;
            const o = state.original[a._id] || {};
            if(noteInp.value !== (o.note||'')) markDirty(a._id, tr); else unmarkIfClean(a._id, tr);
          });

          tr.innerHTML = `
            <td>${userCell}</td>
            <td>${emailCell}</td>
            <td>${roleCell}</td>
            <td></td>
            <td></td>
            <td></td>
            <td class="text-center">
              <button class="btn btn-sm btn-outline-danger"><i class="bi bi-trash"></i></button>
            </td>
          `;
          tr.children[3].appendChild(collegeSel);
          tr.children[4].appendChild(commSel);
          tr.children[5].appendChild(noteInp);

          // Ø­Ø°Ù
          tr.children[6].querySelector('button').addEventListener('click', ()=>confirmDelete(a._id));

          tbody.appendChild(tr);
        }

        const start = (state.page - 1) * state.limit + 1;
        const end   = start + state.rows.length - 1;
        metaText.textContent = `Ø§Ù„Ø¹Ù†Ø§ØµØ± ${start}â€“${end} Ù…Ù† ${state.total}`;

        // Ø¨Ø¹Ø¯ Ø§Ù„ØªØ­Ù…ÙŠÙ„: Ù†Ø¸Ù‘Ù Ø­Ø§Ù„Ø© "Ù‚ÙŠØ¯ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„" ÙÙ‚Ø· Ø¯ÙˆÙ† Ø§Ù„Ù…Ø³Ø§Ø³ Ø¨Ø§Ù„Ø£ØµÙ„
        resetDirty(true);
      }catch(e){
        rows.innerHTML='<tr><td colspan="7" class="text-center py-4 text-danger">ØªØ¹Ø°Ø± Ø§Ù„Ø¬Ù„Ø¨</td></tr>';
      }finally{
        hideSpinner();
      }
    }

    /* ====== Ø­Ø°Ù Ù…Ø¹ ØªØ£ÙƒÙŠØ¯ ====== */
    async function confirmDelete(id){
      const ok = confirm('ğŸ—‘ï¸ Ø­Ø°Ù Ù‡Ø°Ø§ Ø§Ù„ØªØ¹ÙŠÙŠÙ†ØŸ');
      if(!ok) return;
      try{
        showSpinner();
        const r=await apiFetch(`/api/committee-assignments/${id}`,{method:'DELETE'});
        hideSpinner();
        if(!r.ok){
          const j=await r.json().catch(()=>({}));
          setInfo('ÙØ´Ù„ Ø§Ù„Ø­Ø°Ù: '+(j.message||r.status)); return;
        }
        toastSuccess.show(); loadAssignments();
      }catch{
        hideSpinner(); toastError.show();
      }
    }

    /* ====== Ø­ÙØ¸ Ø¬Ù…Ø§Ø¹ÙŠ ====== */
    async function saveAll(){
      if(!state.dirty.size) return;
      const updates = [];
      for (const id of state.dirty){
        const r = state.rows.find(x=>x._id===id);
        if(!r) continue;
        const { college, committee_name, note } = r;
        updates.push({ id, college, committee_name, note });
      }
      try{
        showSpinner();
        const r=await apiFetch('/api/committee-assignments/bulk',{
          method:'POST',
          headers:{'Content-Type':'application/json'},
          body: JSON.stringify({ updates, deletes: [] })
        });
        if(r.ok){
          hideSpinner();
          toastSuccess.show();
          await loadAssignments();
          return;
        }
        //Fallback Ù„ÙƒÙ„ ØµÙ (Ø¥Ù† Ù„Ù… ÙŠØ¯Ø¹Ù… Ø§Ù„Ø³ÙŠØ±ÙØ± bulk Ù„Ø£ÙŠ Ø³Ø¨Ø¨)
        for(const u of updates){
          const pr = await apiFetch(`/api/committee-assignments/${u.id}`,{
            method:'PUT', headers:{'Content-Type':'application/json'}, body: JSON.stringify(u)
          });
          if(!pr.ok){
            const j=await pr.json().catch(()=>({}));
            setInfo('ÙØ´Ù„ ØªØ¹Ø¯ÙŠÙ„ ØµÙ: '+(j.message||pr.status));
          }
        }
        hideSpinner();
        toastSuccess.show();
        await loadAssignments();
      }catch{
        hideSpinner();
        toastError.show();
      }
    }

    /* ====== Ø£Ø­Ø¯Ø§Ø« Ø§Ù„Ø´Ø±ÙŠØ· ====== */
    let qTimer=null;
    qInput.addEventListener('input', ()=>{
      clearTimeout(qTimer);
      qTimer=setTimeout(()=>{ state.q=qInput.value.trim(); state.page=1; loadAssignments(); }, 300);
    });
    roleFilter.addEventListener('change', ()=>{ state.role=roleFilter.value; state.page=1; loadAssignments(); });
    collegeFilter.addEventListener('change', ()=>{ state.college=collegeFilter.value; state.page=1; loadAssignments(); });
    committeeFilter.addEventListener('change', ()=>{ state.committee_name=committeeFilter.value; state.page=1; loadAssignments(); });
    pageSize.addEventListener('change', ()=>{ state.limit=parseInt(pageSize.value,10)||20; state.page=1; loadAssignments(); });

    document.querySelectorAll('th[data-sort]').forEach(th=>{
      th.addEventListener('click', ()=>{
        state.sort = getSortFor(th);
        state.page = 1;
        loadAssignments();
      });
    });

    prevPage.addEventListener('click', ()=>{ if(state.page>1){ state.page--; loadAssignments(); }});
    nextPage.addEventListener('click', ()=>{ state.page++; loadAssignments(); });

    refreshBtn.addEventListener('click', loadAssignments);
    saveAllBtn.addEventListener('click', saveAll);
    cancelAllBtn.addEventListener('click', loadAssignments);

    /* ====== Ø¥Ø¶Ø§ÙØ© ØªØ¹ÙŠÙŠÙ† ====== */
    const addModal = new bootstrap.Modal('#addModal');
    addBtn.addEventListener('click', async ()=>{
      await Promise.all([loadSubusers(), loadCollegesTo(collegeSelect), loadCommitteesTo(committeeSelect)]);
      addModal.show();
    });
    saveAddBtn.addEventListener('click', async ()=>{
      const userId=(userSelect.value||'').trim();
      const college=(collegeSelect.value||'').trim();
      const committee_name=(committeeSelect.value||'').trim();
      const note=(noteInput.value||'').trim();
      if(!userId||!college||!committee_name){ setInfo('Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… ÙˆØ§Ù„ÙƒÙ„ÙŠØ© ÙˆØ§Ù„Ù„Ø¬Ù†Ø©'); return; }
      try{
        showSpinner();
        const r=await apiFetch('/api/committee-assignments',{
          method:'POST',
          headers:{'Content-Type':'application/json'},
          body:JSON.stringify({ userId, college, committee_name, note })
        });
        hideSpinner();
        if(!r.ok){
          const j=await r.json().catch(()=>({}));
          setInfo('ÙØ´Ù„ Ø§Ù„Ø­ÙØ¸: '+(j.message||r.status)); return;
        }
        addModal.hide(); noteInput.value='';
        toastSuccess.show(); loadAssignments();
      }catch{ hideSpinner(); toastError.show(); }
    });

    /* ====== Ø¨Ø¯Ø¡ Ø§Ù„ØªØ´ØºÙŠÙ„ ====== */
    (async function init(){
      try{
        await ensureAuth();
        await Promise.all([loadCollegesTo(collegeFilter), loadCommitteesTo(committeeFilter)]);
        pageSize.value = String(state.limit);
        await loadAssignments();
      }catch{}
    })();
  </script>
</body>
</html>
