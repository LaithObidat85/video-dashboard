<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8">
  <title>ุฅุฏุฎุงู ุชูููู ูุฌูุฉ</title>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.rtl.min.css">
  <link href="https://cdn.quilljs.com/1.3.6/quill.snow.css" rel="stylesheet">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/tom-select/dist/css/tom-select.bootstrap5.min.css">
  <style>
    body { background-color: #f8f9fa; font-family: 'Segoe UI', sans-serif; }
    .form-container { max-width: 800px; margin: 40px auto; background: #fff; padding: 25px; border-radius: 12px; box-shadow: 0 4px 12px rgba(0,0,0,0.1); }
    .form-section { margin-bottom: 20px; padding: 15px; border: 1px solid #dee2e6; border-radius: 10px; background: #fdfdfd; }
    .form-section h6 { margin-bottom: 15px; font-weight: bold; color: #0d6efd; }
    .toast-container { position: fixed; top: 20px; left: 20px; z-index: 2000; }
    #editor { height: 150px; background: #fff; }
  </style>
</head>
<body>
  <div class="form-container">
    <h4 class="mb-4 text-center">๐ ุฅุฏุฎุงู ุชูููู ูุฌูุฉ</h4>
    <form id="committeeForm">

      <!-- ุจูุงูุงุช ุงููุฌูุฉ -->
      <div class="form-section">
        <h6>ุจูุงูุงุช ุงููุฌูุฉ</h6>
        <div class="mb-3">
          <label class="form-label">ุงููููุฉ</label>
          <select class="form-select" name="college" id="collegeSelect" required>
            <option value="">ุงุฎุชุฑ ุงููููุฉ...</option>
          </select>
        </div>
        <div class="mb-3">
          <label class="form-label" for="committeeSelect">ุงุณู ุงููุฌูุฉ</label>
          <select class="form-select" name="committee_name" id="committeeSelect" required placeholder="ุงูุชุจ ููุจุญุซ ุฃู ุฃุถู ุงุณููุง ุฌุฏูุฏูุง"></select>
        </div>
      </div>

      <!-- ุนูุงุตุฑ ุงูุชูููู (ุจููุฆุฉ ุฌุฏูู) -->
      <div class="form-section">
        <h6 class="d-flex align-items-center justify-content-between">
          ุงูุชูููู ุงูุชูุตููู
          <div class="form-check form-switch">
            <input class="form-check-input" type="checkbox" id="fillOnes">
            <label class="form-check-label" for="fillOnes">ุชุนุจุฆุฉ ุชููุงุฆูุฉ ุจุงูุฑูู 1</label>
          </div>
        </h6>

        <div class="table-responsive">
          <table class="table table-bordered align-middle mb-0">
            <thead class="table-light">
              <tr>
                <th style="width:70%">ุงูุจูุฏ</th>
                <th style="width:30%">ุงูุฏุฑุฌุฉ</th>
              </tr>
            </thead>
            <tbody>
              <tr>
                <td><label for="formation_decision">ูุฑุงุฑ ุงูุชุดููู</label></td>
                <td><input type="number" step="0.25" min="0" max="1" class="form-control score" name="formation_decision" id="formation_decision" placeholder="0"></td>
              </tr>
              <tr>
                <td><label for="work_plan">ุฎุทุฉ ุนูู ุงููุฌูุฉ</label></td>
                <td><input type="number" step="0.25" min="0" max="1" class="form-control score" name="work_plan" id="work_plan" placeholder="0"></td>
              </tr>
              <tr>
                <td><label for="performance_indicators">ูุคุดุฑุงุช ุฃุฏุงุก ุฎุทุฉ ุนูู ุงููุฌูุฉ ูุงุจูุฉ ููููุงุณ</label></td>
                <td><input type="number" step="0.25" min="0" max="1" class="form-control score" name="performance_indicators" id="performance_indicators" placeholder="0"></td>
              </tr>
              <tr>
                <td><label for="meetings">ุนุฏุฏ ุงูุงุฌุชูุงุนุงุช</label></td>
                <td><input type="number" step="0.25" min="0" max="1" class="form-control score" name="meetings" id="meetings" placeholder="0"></td>
              </tr>
              <tr>
                <td><label for="consistency">ุงูุชูุงูู ุจูู ุงูุฏุนูุงุช ูุงูุงุฌุชูุงุนุงุช</label></td>
                <td><input type="number" step="0.25" min="0" max="1" class="form-control score" name="consistency" id="consistency" placeholder="0"></td>
              </tr>
              <tr>
                <td><label for="coverage_books">ูุชุจ ุงูุชุบุทูุฉ</label></td>
                <td><input type="number" step="0.25" min="0" max="1" class="form-control score" name="coverage_books" id="coverage_books" placeholder="0"></td>
              </tr>
              <tr>
                <td><label for="report1">ุชูุฑูุฑ ุฅูุฌุงุฒ 1</label></td>
                <td><input type="number" step="0.25" min="0" max="1" class="form-control score" name="report1" id="report1" placeholder="0"></td>
              </tr>
              <tr>
                <td><label for="report2">ุชูุฑูุฑ ุฅูุฌุงุฒ 2</label></td>
                <td><input type="number" step="0.25" min="0" max="1" class="form-control score" name="report2" id="report2" placeholder="0"></td>
              </tr>
              <tr>
                <td><label for="report3">ุชูุฑูุฑ ุฅูุฌุงุฒ 3</label></td>
                <td><input type="number" step="0.25" min="0" max="1" class="form-control score" name="report3" id="report3" placeholder="0"></td>
              </tr>
              <tr>
                <td><label for="statistical_analysis">ุชูููู ุฃุฏุงุก ุงููุฌูุฉ (ุงูุชุญููู ุงูุฅุญุตุงุฆู)</label></td>
                <td><input type="number" step="0.25" min="0" max="1" class="form-control score" name="statistical_analysis" id="statistical_analysis" placeholder="0"></td>
              </tr>
            </tbody>
          </table>
        </div>
      </div>

      <!-- ุฏุฑุฌุฉ ุงูุชููุฑ ูุงูููุงุญุธุงุช -->
      <div class="form-section">
        <h6>ุงููุชุงุฆุฌ ุงูููุงุฆูุฉ</h6>
        <div class="mb-3">
          <label class="form-label">ุฏุฑุฌุฉ ุงูุชููุฑ (ุชูุญุณุจ ุชููุงุฆููุง)</label>
          <input type="number" class="form-control" id="availability_score" name="availability_score" readonly>
        </div>
        <div class="mb-3">
          <label class="form-label">ููุงุญุธุงุช</label>
          <div id="editor"></div>
          <input type="hidden" name="notes" id="notesInput">
        </div>
        <div class="row">
          <div class="col-md-6 mb-3"><label class="form-label">ุชุงุฑูุฎ ุงูุชุฏููู</label><input type="date" class="form-control" name="audit_date"></div>
          <div class="col-md-6 mb-3">
            <label class="form-label">ุงุณู ุงููุฏูู</label>
            <select class="form-select" name="auditor_name" id="auditorSelect" required>
              <option value="">ุงุฎุชุฑ ุงููุฏูู...</option>
            </select>
          </div>
        </div>
      </div>

      <button type="submit" class="btn btn-primary w-100">๐พ ุญูุธ ุงูุชูููู</button>
    </form>
  </div>

  <!-- Toasts -->
  <div class="toast-container">
    <div id="successToast" class="toast align-items-center text-bg-success border-0" role="alert">
      <div class="d-flex"><div class="toast-body">โ ุชู ุญูุธ ุงูุชูููู ุจูุฌุงุญ</div><button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button></div>
    </div>
    <div id="errorToast" class="toast align-items-center text-bg-danger border-0" role="alert">
      <div class="d-flex"><div class="toast-body">โ ุญุฏุซ ุฎุทุฃ ุฃุซูุงุก ุงูุญูุธ</div><button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button></div>
    </div>
  </div>

  <!-- ููุชุจุงุช -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
  <script src="https://cdn.quilljs.com/1.3.6/quill.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/tom-select/dist/js/tom-select.complete.min.js"></script>
  <script>
    const quill = new Quill('#editor', { theme: 'snow' });

    const successToast = new bootstrap.Toast(document.getElementById('successToast'));
    const errorToast = new bootstrap.Toast(document.getElementById('errorToast'));

    // ุฌูุจ ุงููููุงุช ูู ูุงุนุฏุฉ ุงูุจูุงูุงุช
    async function loadColleges() {
      try {
        const res = await axios.get('/api/colleges');
        const select = document.getElementById('collegeSelect');
        res.data.forEach(c => {
          const opt = document.createElement('option');
          opt.value = c.name;
          opt.textContent = c.name;
          select.appendChild(opt);
        });
      } catch (err) {
        console.error("ุฎุทุฃ ูู ุฌูุจ ุงููููุงุช:", err);
      }
    }
    loadColleges();

    // ุฌูุจ ุงููุฏูููู ูู ูุงุนุฏุฉ ุงูุจูุงูุงุช
    async function loadAuditors() {
      try {
        const res = await axios.get('/api/auditors');
        const select = document.getElementById('auditorSelect');
        res.data.forEach(a => {
          const opt = document.createElement('option');
          opt.value = a.name;
          opt.textContent = a.name;
          select.appendChild(opt);
        });
      } catch (err) {
        console.error("ุฎุทุฃ ูู ุฌูุจ ุงููุฏูููู:", err);
      }
    }
    loadAuditors();

    // ุชููุฆุฉ Tom Select ูุญูู ุงุณู ุงููุฌูุฉ
    let committeeTS = new TomSelect('#committeeSelect', {
      valueField: 'name',
      labelField: 'name',
      searchField: 'name',
      create: true,
      persist: false,
      maxItems: 1,
      placeholder: 'ุงูุชุจ ููุจุญุซ ุฃู ุฃุถู ุงุณููุง ุฌุฏูุฏูุง',
      load: function (query, callback) {
        const q = encodeURIComponent(query || '');
        fetch(`/api/committee-names?q=${q}`)
          .then(res => res.json())
          .then(list => callback(list))
          .catch(() => callback());
      },
      createFilter: function(input){ return !!input.trim(); }
    });

    // ุงูุชุฃูุฏ ูู ุฃู ุงููุฏุฎูุงุช ุชุจูู ุจูู 0 ู 1
    function clampScoreInput(el) {
      const min = 0;
      const max = 1;
      let v = parseFloat(el.value);
      if (isNaN(v)) return;
      if (v < min) v = min;
      if (v > max) v = max;
      el.value = v;
    }

    // ุญุณุงุจ ุฏุฑุฌุฉ ุงูุชููุฑ ุชููุงุฆููุง
    function recomputeAvailability() {
      let sum = 0;
      document.querySelectorAll('.score').forEach(i => {
        const val = parseFloat(i.value);
        if (!isNaN(val)) sum += val;
      });
      document.getElementById('availability_score').value = sum;
    }

    document.querySelectorAll('.score').forEach(input => {
      input.addEventListener('input', () => {
        clampScoreInput(input);
        recomputeAvailability();
      });
      input.addEventListener('change', () => {
        clampScoreInput(input);
        recomputeAvailability();
      });
    });

    // Checkbox ููุชุนุจุฆุฉ ุงูุชููุงุฆูุฉ ุจุงููููุฉ 1
    const fillOnesCheckbox = document.getElementById('fillOnes');
    if (fillOnesCheckbox) {
      fillOnesCheckbox.addEventListener('change', (e) => {
        const v = e.target.checked ? 1 : '';
        document.querySelectorAll('.score').forEach(i => {
          i.value = v;
          clampScoreInput(i);
        });
        recomputeAvailability();
      });
    }

    // ุฅุฑุณุงู ุงููููุฐุฌ
    document.getElementById("committeeForm").addEventListener("submit", async function(e){
      e.preventDefault();
      document.getElementById("notesInput").value = quill.root.innerHTML;

      const formData = new FormData(this);
      const data = Object.fromEntries(formData.entries());

      try {
        const res = await axios.post('/api/committees', data);
        if(res.status === 201){
          successToast.show();
          this.reset();
          quill.setContents([]);
          document.getElementById('availability_score').value = 0;
          if (fillOnesCheckbox && fillOnesCheckbox.checked) fillOnesCheckbox.checked = false;
          if (committeeTS) committeeTS.clear();
        }
      } catch (err) {
        console.error(err);
        errorToast.show();
      }
    });

    // ุชููุฆุฉ ุฃูููุฉ
    recomputeAvailability();
  </script>
</body>
</html>
