<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8">
  <title>ูุชุงุฆุฌ ุชูููู ุงููุฌุงู</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.rtl.min.css">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css">
  <style>
    body{background:#f8f9fa;font-family:'Segoe UI',sans-serif}
    .container-fluid{margin-top:30px}
    table{background:#fff;border-radius:10px;overflow:hidden;font-size:14px;width:100%;margin:auto}
    th{text-align:center;vertical-align:middle;background:#f8f9fa;color:#000}
    td{text-align:center;vertical-align:middle}
    .highlight{background:#d4edda!important;transition:background-color 1s ease}
    .hidden-col{display:none!important}
    .filters{margin-bottom:20px;text-align:center}
    .sticky-header{background:#f8f9fa;padding-top:10px}
    #evaluationsTableWrapper thead th{position:sticky;top:0;z-index:99;background:#f8f9fa;color:#000}

    /* ุฃุนูุฏุฉ ุงูุชุงุฑูุฎ (ุงุชุฌุงู ูุณุงุฑ ูููููู) */
    #evaluationsTableWrapper th.date-col,
    #evaluationsTableWrapper td.date-col{
      direction:ltr;text-align:center;width:110px;max-width:110px
    }

    /* ูุณุงุญุงุช ูุนูููุงุช ุฃุนูู ุงูุฌุฏูู (ุจุงูุฃุณูุฏ ููุง ุทููุจ) */
    #completionRateContainer,#selectedVisitsContainer{font-weight:bold;margin:5px 0;font-size:18px;color:#000;min-height:24px}
    #infoContainer{font-weight:bold;margin:15px 0;font-size:18px;color:#000;text-align:center}

    /* ููุงุญุธุงุช: ูุง ูุธูุฑ ุนูู ุงูุดุงุดุฉ/ุงูุทุจุงุนุฉ */
    .notes-screen{display:inline-block}
    .print-notes{display:none;text-align:start}

    /* ุชุฃุซูุฑ Hover ุนูู ุตููู ุงูุฌุฏูู โ ุงุณุชูุฏุงู ุงูุฎูุงูุง */
    #evaluationsTableWrapper tbody tr > * {
      transition: background-color .2s ease, box-shadow .2s ease;
    }
    #evaluationsTableWrapper tbody tr:hover > * {
      background-color:#f1f7ff !important;
      box-shadow: inset 0 0 0 9999px rgba(13,110,253,.06);
    }

    /* ุนูุงุตุฑ ูุง ุชูุทุจุน */
    .no-print{}
    @media print{
      body{background:#fff}
      .no-print,.toast-container,.modal{display:none!important}
      .container-fluid{max-width:none;width:100%}
      .print-header{display:block;margin-bottom:10px}
      .notes-screen{display:none!important}
      .print-notes{display:block!important;white-space:normal}
      thead{display:table-header-group}
      button,select,input{display:none!important}
    }

    /* ุญุงูุฉ "ุบูุฑ ูุชููุฑ" */
    #notAvailable{
      min-height:60vh; display:none;
      align-items:center; justify-content:center; text-align:center;
    }
  </style>
</head>
<body>
  <!-- ุฑุณุงูุฉ ุงููุชุงุฆุฌ ุบูุฑ ูุชููุฑุฉ -->
  <div id="notAvailable" class="container d-flex">
    <div class="mx-auto">
      <div class="display-6 mb-2">ุงููุชุงุฆุฌ ุบูุฑ ูุชููุฑุฉ ุญุงูููุง</div>
      <p class="text-muted mb-0">ูุฑุฌู ุงูุนูุฏุฉ ูุงุญููุง.</p>
    </div>
  </div>

  <!-- ูุญุชูู ุงูุตูุญุฉ ุงูุญูููู -->
  <div id="pageContent" class="container-fluid" style="display:none">
    <div class="sticky-header">
      <h3 class="text-center mb-4">ูุชุงุฆุฌ ุชูููู ุงููุฌุงู</h3>

      <!-- ุงูููุงุชุฑ -->
      <div class="filters row justify-content-center no-print">
        <div class="col-md-3 mb-2 text-center">
          <label class="form-label ุฏ-block">ุงููููุฉ</label>
          <select id="collegeFilter" class="form-select">
            <option value="">ุฌููุน ุงููููุงุช</option>
          </select>
        </div>
        <div class="col-md-3 mb-2 text-center">
          <label class="form-label d-block">ุงูุจุญุซ ุจุฅุณู ุงููุฌูุฉ</label>
          <input type="text" id="committeeSearch" class="form-control" placeholder="ุงูุชุจ ููุจุญุซ...">
        </div>
      </div>

      <!-- ุฃุฏูุงุช ุจุณูุทุฉ + ุทุจุงุนุฉ/ุชุญุฏูุซ -->
      <div class="row mb-3 justify-content-center no-print">
        <div class="col-md-8 d-flex align-items-center justify-content-center gap-4">
          <div class="form-check">
            <input class="form-check-input simple-toggle" type="checkbox" id="toggle_college" checked>
            <label class="form-check-label" for="toggle_college">ุฅุธูุงุฑ ุงููููุฉ</label>
          </div>
          <div class="form-check">
            <input class="form-check-input simple-toggle" type="checkbox" id="toggle_date">
            <label class="form-check-label" for="toggle_date">ุฅุธูุงุฑ ุชุงุฑูุฎ ุงูุชุฏููู</label>
          </div>
          <button class="btn btn-secondary" id="printBtn" title="ุทุจุงุนุฉ"><i class="bi bi-printer"></i></button>
          <button class="btn btn-info" id="reloadBtn" title="ุฅุนุงุฏุฉ ุชุญููู ุงูุฅุนุฏุงุฏุงุช ูุงูุฌุฏูู"><i class="bi bi-arrow-repeat"></i></button>
        </div>
      </div>

      <!-- ุฑุฃุณ ุงูุทุจุงุนุฉ (ุณููููุฃ ุฏููุงูููููุง) -->
      <div id="infoContainer" class="print-header">
        <div id="semesterInfo">โ</div>
        <div id="selectedVisitsContainer">โ</div>
        <div id="completionRateContainer">โ</div>
        <div id="committeesCountContainer">โ</div>
      </div>
    </div>

    <table class="table table-bordered table-striped table-responsive" id="evaluationsTableWrapper">
      <thead>
        <tr>
          <th>#</th>
          <th class="col-college">ุงููููุฉ</th>
          <th>ุงุณู ุงููุฌูุฉ</th>
          <th class="date-col hidden-col">ุชุงุฑูุฎ ุงูุชุฏููู</th>
          <th class="col-formation_decision">ูุฑุงุฑ ุงูุชุดููู</th>
          <th class="col-work_plan">ุฎุทุฉ ุงูุนูู</th>
          <th class="col-performance_indicators">ูุคุดุฑุงุช ุงูุฃุฏุงุก</th>
          <th class="col-meetings">ุนุฏุฏ ุงูุงุฌุชูุงุนุงุช</th>
          <th class="col-consistency">ุงูุชูุงูู ุจูู ุงูุฏุนูุงุช ูุงูุงุฌุชูุงุนุงุช</th>
          <th class="col-coverage_books">ูุชุจ ุงูุชุบุทูุฉ</th>
          <th class="col-report1">ุชูุฑูุฑ ุฅูุฌุงุฒ 1</th>
          <th class="col-report2">ุชูุฑูุฑ ุฅูุฌุงุฒ 2</th>
          <th class="col-report3">ุชูุฑูุฑ ุฅูุฌุงุฒ 3</th>
          <th class="col-statistical_analysis">ุงูุชุญููู ุงูุฅุญุตุงุฆู</th>
          <th id="availabilityHeader">ุฏุฑุฌุฉ ุงูุชููุฑ ูู (9)</th>
          <th>ุงูููุงุญุธุงุช</th>
        </tr>
      </thead>
      <tbody id="committeesTable">
        <tr><td colspan="16" class="text-center">ุฌุงุฑู ุงูุชุญููู...</td></tr>
      </tbody>
    </table>
  </div>

  <!-- Modal ุงูููุงุญุธุงุช ููุดุงุดุฉ ููุท -->
  <div class="modal fade no-print" id="notesModal" tabindex="-1">
    <div class="modal-dialog modal-lg"><div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">๐ ุงูููุงุญุธุงุช</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body" id="notesContent"></div>
    </div></div>
  </div>

  <!-- Toasts -->
  <div class="toast-container position-fixed top-0 start-50 translate-middle-x p-3 no-print">
    <div id="toastSuccess" class="toast align-items-center text-bg-success border-0 mb-2" role="alert">
      <div class="d-flex"><div class="toast-body">โ ุงูุนูููุฉ ูุฌุญุช</div>
        <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button>
      </div>
    </div>
    <div id="toastError" class="toast align-items-center text-bg-danger border-0 mb-2" role="alert">
      <div class="d-flex"><div class="toast-body">โ ุญุฏุซ ุฎุทุฃ</div>
        <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button>
      </div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
  <script>
    /* ===== ุชูุณุชุงุช ===== */
    const toastSuccess = new bootstrap.Toast(document.getElementById('toastSuccess'));
    const toastError   = new bootstrap.Toast(document.getElementById('toastError'));
    const showSuccess  = (m='โ ุงูุนูููุฉ ูุฌุญุช')=>{ document.querySelector('#toastSuccess .toast-body').innerText=m; toastSuccess.show(); };
    const showError    = (m='โ ุญุฏุซ ุฎุทุฃ')     =>{ document.querySelector('#toastError .toast-body').innerText=m; toastError.show();   };

    /* ===== ุฃุนูุงู ุงูุญุงูุฉ ===== */
    let savedVisibleColumns = [];  // ูู ุงูุฅุนุฏุงุฏุงุช
    let lastCollege = '';          // ูู ุงูููุชุฑ ุงูุญุงูู
    let settingsCache = null;      // ูุฎุฒู ุงูุฅุนุฏุงุฏุงุช ููุทุจุงุนุฉ
    let PUBLISH_RESULTS = false;   // ุงูุญูู ุงูุฐู ูุชุญูู ุจู ูู /api/settings

    const availabilityFields = ["formation_decision","work_plan","performance_indicators","meetings","consistency","coverage_books","report1","report2","report3","statistical_analysis"];

    /* ===== ุชุญููู ุงูููุงุฆู ===== */
    async function loadOptions(){
      try{
        const { data } = await axios.get('/api/colleges');
        const collegeFilter = document.getElementById('collegeFilter');
        (data||[]).forEach(c=>{
          const opt=document.createElement('option');
          opt.value=c.name; opt.textContent=c.name;
          collegeFilter.appendChild(opt);
        });
      }catch(e){ /* ุตุงูุช */ }
    }

    /* ===== Sanitizer ุจุณูุท ููููุงุญุธุงุช ููุทุจุงุนุฉ ===== */
    function sanitizeNotes(html=''){
      try{
        const allowed=['P','UL','OL','LI','B','STRONG','I','EM','U','BR'];
        const tmp=document.createElement('div'); tmp.innerHTML = html;
        const walker=document.createTreeWalker(tmp, NodeFilter.SHOW_ELEMENT, null);
        const toRemove=[];
        while(walker.nextNode()){
          const el=walker.currentNode;
          if(!allowed.includes(el.tagName)) toRemove.push(el);
          // ุฅุฒุงูุฉ ุงูุฎุตุงุฆุต ุงูุฎุทุฑุฉ
          for(const a of Array.from(el.attributes||[])){
            const name=a.name.toLowerCase();
            if(name.startsWith('on') || name==='style') el.removeAttribute(a.name);
          }
        }
        toRemove.forEach(n=>n.replaceWith(document.createTextNode(n.textContent||'')));
        return tmp.innerHTML.trim() || 'โ';
      }catch{return 'โ'}
    }

    /* ===== ุชุญุฏูุซ ุนููุงู ุงูุชููุฑ ===== */
    function updateAvailabilityHeader(){
      const n=savedVisibleColumns.length;
      document.getElementById('availabilityHeader').innerText=`ุฏุฑุฌุฉ ุงูุชููุฑ ูู (${n})`;
    }

    /* ===== ุญุณุงุจ ุฏุฑุฌุฉ ุงูุชููุฑ ููุตู ===== */
    function updateAvailability(row){
      let sum=0;
      availabilityFields.forEach(f=>{
        const cell=row.querySelector(`[data-field="${f}"]`);
        if(cell && !cell.classList.contains('hidden-col')){
          sum += parseFloat(cell.innerText)||0;
        }
      });
      const target=row.querySelector('.availability-cell');
      if(target){
        target.innerText=sum.toFixed(2);
        target.classList.add('highlight');
        setTimeout(()=>target.classList.remove('highlight'),800);
      }
    }

    /* ===== ูุณุจุฉ ุงูุงูุชูุงู + ุนุฏุฏ ุงููุฌุงู ===== */
    function updateCompletionAndCounts(){
      const rows=[...document.querySelectorAll('#committeesTable tr')].filter(r=>r.style.display!=='none');
      let total=0;
      rows.forEach(r=>{ total += parseFloat(r.querySelector('.availability-cell')?.innerText)||0; });
      const denom = rows.length * savedVisibleColumns.length;
      const pct = denom>0 ? ((total/denom)*100).toFixed(2) : '0.00';

      const completionDiv=document.getElementById('completionRateContainer');
      const countDiv=document.getElementById('committeesCountContainer');
      const lc = lastCollege || 'ุฌููุน ุงููููุงุช';
      if(lc && lc!=='ุฌููุน ุงููููุงุช'){
        completionDiv.innerHTML = `ูุณุจุฉ ุงูุงูุชูุงู ููููุฉ ${lc} = ${pct}%`;
        countDiv.innerHTML      = `ุนุฏุฏ ูุฌุงู ูููุฉ ${lc} = ${rows.length}`;
      }else{
        completionDiv.innerHTML = `ูุณุจุฉ ุงูุงูุชูุงู ูุฌููุน ุงููููุงุช = ${pct}%`;
        countDiv.innerHTML      = `ุนุฏุฏ ูุฌุงู ุฌููุน ุงููููุงุช = ${rows.length}`;
      }
    }

    /* ===== ุชุทุจูู ุฑุคูุฉ ุงูุฃุนูุฏุฉ ===== */
    function applyColumnVisibility(){
      // ุงููููุฉ
      const showCollege=document.getElementById('toggle_college').checked;
      document.querySelectorAll('.col-college').forEach(el=>el.classList.toggle('hidden-col',!showCollege));
      // ุงูุชุงุฑูุฎ
      const showDate=document.getElementById('toggle_date').checked;
      document.querySelectorAll('.date-col').forEach(el=>el.classList.toggle('hidden-col',!showDate));
      // ุงูุญููู ุงูุนุฏุฏูุฉ ุญุณุจ ุงูุฅุนุฏุงุฏุงุช
      availabilityFields.forEach(f=>{
        const show = savedVisibleColumns.includes(f);
        document.querySelectorAll(`[data-field="${f}"]`).forEach(td=>td.classList.toggle('hidden-col', !show));
        const th=document.querySelector(`.col-${f}`);
        if(th) th.classList.toggle('hidden-col', !show);
      });

      document.querySelectorAll('#committeesTable tr').forEach(updateAvailability);
      updateAvailabilityHeader();
      updateCompletionAndCounts();
    }

    document.querySelectorAll('.simple-toggle').forEach(cb=>{
      cb.addEventListener('change', applyColumnVisibility);
    });

    /* ===== ุงูุจุญุซ ุจุงุณู ุงููุฌูุฉ ===== */
    function applyCommitteeSearch(){
      const term=document.getElementById('committeeSearch').value.trim().toLowerCase();
      document.querySelectorAll('#committeesTable tr').forEach(row=>{
        const name=row.cells[2]?.innerText.trim().toLowerCase()||'';
        row.style.display = name.includes(term)? '': 'none';
      });
      updateCompletionAndCounts();
    }
    document.getElementById('committeeSearch').addEventListener('input', applyCommitteeSearch);

    /* ===== ุชุญููู ุงูุฅุนุฏุงุฏุงุช (ุชุดูู publishResults) ===== */
    async function loadSettings(){
      const semesterEl=document.getElementById('semesterInfo');
      const visitsEl  =document.getElementById('selectedVisitsContainer');

      try{
        const {data} = await axios.get('/api/settings');
        settingsCache = data || {};
        // ูุชุบูุฑ ุงูุชุญูู ุจุงููุดุฑ
        PUBLISH_RESULTS = !!settingsCache.publishResults;

        // ุฅู ูู ููู ุงููุดุฑ ููุนูู => ุฅุธูุงุฑ ุงูุฑุณุงูุฉ ููุท ูุฅููุงู ูู ุดูุก
        if(!PUBLISH_RESULTS){
          document.getElementById('pageContent').style.display='none';
          document.getElementById('notAvailable').style.display='flex';
          return false;
        }

        // ููุนูู => ุฅุธูุงุฑ ุงูุตูุญุฉ ูุงูุงุณุชูุฑุงุฑ
        document.getElementById('notAvailable').style.display='none';
        document.getElementById('pageContent').style.display='block';

        savedVisibleColumns = settingsCache.visibleColumns || [];

        // ุณุทุฑ ุงููุตู/ุงูุนุงู
        const t = settingsCache.term || 'โ';
        const ay= settingsCache.academicYear || 'โ';
        semesterEl.textContent = `${t} - ${ay}`;

        // ุงูุฒูุงุฑุงุช ุฃุนูู ุงูุฌุฏูู
        const visits = Array.isArray(settingsCache.selectedVisits) && settingsCache.selectedVisits.length
          ? settingsCache.selectedVisits.join(' | ')
          : 'ูู ูุชู ุงุฎุชูุงุฑ ุฃู ุฒูุงุฑุฉ';
        visitsEl.textContent = `ุงูุฒูุงุฑุงุช: ${visits}`;

        return true;
      }catch(e){
        // ูู ุญุงูุฉ ุงูุฎุทุฃ ูุชุตุฑู ูุฃู ุงููุดุฑ ุบูุฑ ููุนูู (ุฃูุซุฑ ุฃูุงููุง)
        document.getElementById('pageContent').style.display='none';
        document.getElementById('notAvailable').style.display='flex';
        return false;
      }
    }

    /* ===== ุชุญููู ุฌุฏูู ุงููุฌุงู ===== */
    async function loadCommittees(){
      try{
        const college=document.getElementById('collegeFilter').value;
        lastCollege = college || 'ุฌููุน ุงููููุงุช';
        let url='/api/committees';
        const params=[];
        if(college) params.push('college='+encodeURIComponent(college));
        if(params.length) url+='?'+params.join('&');

        const res=await axios.get(url);
        const tbody=document.getElementById('committeesTable');
        tbody.innerHTML='';

        const arr=Array.isArray(res.data)?res.data:[];
        if(!arr.length){
          tbody.innerHTML=`<tr><td colspan="16" class="text-center">ูุง ุชูุฌุฏ ุจูุงูุงุช</td></tr>`;
          updateAvailabilityHeader();
          document.getElementById('completionRateContainer').textContent='';
          document.getElementById('committeesCountContainer').textContent='';
          return;
        }

        // ุชุฑุชูุจ ุงูุชุฑุงุถู ุญุณุจ ุงููููุฉ
        arr.sort((a,b)=>(a.college||'').localeCompare(b.college||'','ar'));

        // ุฑุณู ุงูุตููู
        arr.forEach((c,idx)=>{
          const tr=document.createElement('tr');
          const dateTxt = c.audit_date ? new Date(c.audit_date).toLocaleDateString('ar-EG'): '-';
          const notesHtml = (c.notes||'').trim();
          const hasNotes  = !!notesHtml && notesHtml!=='<p><br></p>' && notesHtml!=='<br>';

          tr.innerHTML = `
            <td>${idx+1}</td>
            <td class="col-college">${c.college??''}</td>
            <td>${c.committee_name??''}</td>
            <td class="date-col hidden-col">${dateTxt}</td>
            <td data-field="formation_decision">${c.formation_decision ?? 0}</td>
            <td data-field="work_plan">${c.work_plan ?? 0}</td>
            <td data-field="performance_indicators">${c.performance_indicators ?? 0}</td>
            <td data-field="meetings">${c.meetings ?? 0}</td>
            <td data-field="consistency">${c.consistency ?? 0}</td>
            <td data-field="coverage_books">${c.coverage_books ?? 0}</td>
            <td data-field="report1">${c.report1 ?? 0}</td>
            <td data-field="report2">${c.report2 ?? 0}</td>
            <td data-field="report3">${c.report3 ?? 0}</td>
            <td data-field="statistical_analysis">${c.statistical_analysis ?? 0}</td>
            <td class="availability-cell">${c.availability_score ?? 0}</td>
            <td>
              <span class="notes-screen">
                ${
                  hasNotes
                  ? `<button class="btn btn-sm btn-info" title="ุนุฑุถ ุงูููุงุญุธุงุช" data-notes="1">๐</button>`
                  : '<span class="text-muted">ูุง ุชูุฌุฏ ููุงุญุธุงุช</span>'
                }
              </span>
              <div class="print-notes">${hasNotes ? sanitizeNotes(notesHtml) : 'โ'}</div>
            </td>
          `;
          // ุฒุฑ ุนุฑุถ ุงูููุงุญุธุงุช (ุดุงุดุฉ ููุท)
          const btn = tr.querySelector('[data-notes]');
          if(btn){
            btn.addEventListener('click',()=>{
              document.getElementById('notesContent').innerHTML = notesHtml || '<i>ูุง ุชูุฌุฏ ููุงุญุธุงุช</i>';
              new bootstrap.Modal(document.getElementById('notesModal')).show();
            });
          }
          document.getElementById('committeesTable').appendChild(tr);
          updateAvailability(tr);
        });

        // ุชุทุจูู ุฑุคูุฉ ุงูุฃุนูุฏุฉ (ุญุณุจ ุงูุฅุนุฏุงุฏุงุช ุงูุญุงููุฉ ูุงูุชุจุฏููุงุช)
        applyColumnVisibility();
        // ุชุทุจูู ุงูุจุญุซ ุงูุญุงูู
        applyCommitteeSearch();
      }catch(err){
        console.error(err);
        showError('โ ูุดู ุชุญููู ุงูุจูุงูุงุช');
        const tbody=document.getElementById('committeesTable');
        tbody.innerHTML=`<tr><td colspan="16" class="text-center text-danger">ูุดู ุงูุฌูุจ</td></tr>`;
      }
    }

    /* ===== ุทุจุงุนุฉ ===== */
    document.getElementById('printBtn').addEventListener('click', ()=> {
      updateCompletionAndCounts();
      window.print();
    });

    /* ===== ุฃุญุฏุงุซ ุนุงูุฉ ===== */
    document.getElementById('collegeFilter').addEventListener('change', async ()=>{
      if(!PUBLISH_RESULTS) return;
      await loadCommittees();
    });
    document.getElementById('reloadBtn').addEventListener('click', async ()=>{
      const ok = await loadSettings();
      if(ok){ // ููุท ุฅุฐุง ุงููุดุฑ ููุนูู
        await loadOptions(); // ูููู ุฅุนุงุฏุฉ ุชุญููู ุงูููุงุฆู ุฃูุถูุง ุนูุฏ ุงูุฑุบุจุฉ
        await loadCommittees();
      }
    });

    /* ===== ุชุดุบูู ุฃููู =====
       1) ูุฑุงุกุฉ ุงูุฅุนุฏุงุฏุงุช ูุชุญุฏูุฏ publishResults
       2) ุฅุฐุง ููุนูู: ูุญููู ุงูููุงุฆู ุซู ุงูุฌุฏูู
    */
    (async function init(){
      const ok = await loadSettings();
      if(!ok) return;
      await loadOptions();
      await loadCommittees();
    })();
  </script>
</body>
</html>
