<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8">
  <title>Ù†ØªØ§Ø¦Ø¬ ØªÙ‚ÙŠÙŠÙ… Ø§Ù„Ù„Ø¬Ø§Ù†</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.rtl.min.css">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css">
  <style>
    body{background:#f8f9fa;font-family:'Segoe UI',sans-serif}
    .container-fluid{margin-top:30px}
    table{background:#fff;border-radius:10px;overflow:hidden;font-size:14px;width:100%;margin:auto}
    th{text-align:center;vertical-align:middle;background:#f8f9fa;color:#000}
    td{text-align:center;vertical-align:middle}
    .highlight{background:#d4edda!important;transition:background-color 1s ease}
    .hidden-col{display:none!important}
    .filters{margin-bottom:20px;text-align:center}
    .sticky-header{background:#f8f9fa;padding-top:10px}
    #evaluationsTableWrapper thead th{position:sticky;top:0;z-index:99;background:#f8f9fa;color:#000}

    /* Ø£Ø¹Ù…Ø¯Ø© Ø§Ù„ØªØ§Ø±ÙŠØ® (Ø§ØªØ¬Ø§Ù‡ ÙŠØ³Ø§Ø± Ù„Ù„ÙŠÙ…ÙŠÙ†) */
    #evaluationsTableWrapper th.date-col,
    #evaluationsTableWrapper td.date-col{
      direction:ltr;text-align:center;width:110px;max-width:110px
    }

    /* Ù…Ø³Ø§Ø­Ø§Øª Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø£Ø¹Ù„Ù‰ Ø§Ù„Ø¬Ø¯ÙˆÙ„ (Ø¨Ø§Ù„Ø£Ø³ÙˆØ¯ ÙƒÙ…Ø§ Ø·ÙÙ„Ø¨) */
    #completionRateContainer,#selectedVisitsContainer{font-weight:bold;margin:5px 0;font-size:18px;color:#000;min-height:24px}
    #infoContainer{font-weight:bold;margin:15px 0;font-size:18px;color:#000;text-align:center}

    /* Ù…Ù„Ø§Ø­Ø¸Ø§Øª: Ù…Ø§ ÙŠØ¸Ù‡Ø± Ø¹Ù„Ù‰ Ø§Ù„Ø´Ø§Ø´Ø©/Ø§Ù„Ø·Ø¨Ø§Ø¹Ø© */
    .notes-screen{display:inline-block}
    .print-notes{display:none;text-align:start}

    /* ØªØ£Ø«ÙŠØ± Hover Ø¹Ù„Ù‰ ØµÙÙˆÙ Ø§Ù„Ø¬Ø¯ÙˆÙ„ â€” Ø§Ø³ØªÙ‡Ø¯Ø§Ù Ø§Ù„Ø®Ù„Ø§ÙŠØ§ */
    #evaluationsTableWrapper tbody tr > * {
      transition: background-color .2s ease, box-shadow .2s ease;
    }
    #evaluationsTableWrapper tbody tr:hover > * {
      background-color:#f1f7ff !important;
      box-shadow: inset 0 0 0 9999px rgba(13,110,253,.06);
    }

    /* Ø¹Ù†Ø§ØµØ± Ù„Ø§ ØªÙØ·Ø¨Ø¹ */
    .no-print{}
    @media print{
      body{background:#fff}
      .no-print,.toast-container,.modal{display:none!important}
      .container-fluid{max-width:none;width:100%}
      .print-header{display:block;margin-bottom:10px}
      .notes-screen{display:none!important}
      .print-notes{display:block!important;white-space:normal}
      thead{display:table-header-group}
      button,select,input{display:none!important}
    }

    /* Ø­Ø§Ù„Ø© "ØºÙŠØ± Ù…ØªÙˆÙØ±" */
    #notAvailable{
      min-height:60vh; display:none;
      align-items:center; justify-content:center; text-align:center;
    }
  </style>
</head>
<body>
  <!-- Ø±Ø³Ø§Ù„Ø© Ø§Ù„Ù†ØªØ§Ø¦Ø¬ ØºÙŠØ± Ù…ØªÙˆÙØ±Ø© -->
  <div id="notAvailable" class="container d-flex">
    <div class="mx-auto">
      <div class="display-6 mb-2">Ø§Ù„Ù†ØªØ§Ø¦Ø¬ ØºÙŠØ± Ù…ØªÙˆÙØ±Ø© Ø­Ø§Ù„ÙŠÙ‹Ø§</div>
      <p class="text-muted mb-0">ÙŠØ±Ø¬Ù‰ Ø§Ù„Ø¹ÙˆØ¯Ø© Ù„Ø§Ø­Ù‚Ù‹Ø§.</p>
    </div>
  </div>

  <!-- Ù…Ø­ØªÙˆÙ‰ Ø§Ù„ØµÙØ­Ø© Ø§Ù„Ø­Ù‚ÙŠÙ‚ÙŠ -->
  <div id="pageContent" class="container-fluid" style="display:none">
    <div class="sticky-header">
      <h3 class="text-center mb-4">Ù†ØªØ§Ø¦Ø¬ ØªÙ‚ÙŠÙŠÙ… Ø§Ù„Ù„Ø¬Ø§Ù†</h3>

      <!-- Ø§Ù„ÙÙ„Ø§ØªØ± -->
      <div class="filters row justify-content-center no-print">
        <div class="col-md-3 mb-2 text-center">
          <label class="form-label Ø¯-block">Ø§Ù„ÙƒÙ„ÙŠØ©</label>
          <select id="collegeFilter" class="form-select">
            <option value="">Ø¬Ù…ÙŠØ¹ Ø§Ù„ÙƒÙ„ÙŠØ§Øª</option>
          </select>
        </div>
        <div class="col-md-3 mb-2 text-center">
          <label class="form-label d-block">Ø§Ù„Ø¨Ø­Ø« Ø¨Ø¥Ø³Ù… Ø§Ù„Ù„Ø¬Ù†Ø©</label>
          <input type="text" id="committeeSearch" class="form-control" placeholder="Ø§ÙƒØªØ¨ Ù„Ù„Ø¨Ø­Ø«...">
        </div>
      </div>

      <!-- Ø£Ø¯ÙˆØ§Øª Ø¨Ø³ÙŠØ·Ø© + Ø·Ø¨Ø§Ø¹Ø©/ØªØ­Ø¯ÙŠØ« -->
      <div class="row mb-3 justify-content-center no-print">
        <div class="col-md-8 d-flex align-items-center justify-content-center gap-4">
          <div class="form-check">
            <input class="form-check-input simple-toggle" type="checkbox" id="toggle_college" checked>
            <label class="form-check-label" for="toggle_college">Ø¥Ø¸Ù‡Ø§Ø± Ø§Ù„ÙƒÙ„ÙŠØ©</label>
          </div>
          <div class="form-check">
            <input class="form-check-input simple-toggle" type="checkbox" id="toggle_date">
            <label class="form-check-label" for="toggle_date">Ø¥Ø¸Ù‡Ø§Ø± ØªØ§Ø±ÙŠØ® Ø§Ù„ØªØ¯Ù‚ÙŠÙ‚</label>
          </div>
          <button class="btn btn-secondary" id="printBtn" title="Ø·Ø¨Ø§Ø¹Ø©"><i class="bi bi-printer"></i></button>
          <button class="btn btn-info" id="reloadBtn" title="Ø¥Ø¹Ø§Ø¯Ø© ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª ÙˆØ§Ù„Ø¬Ø¯ÙˆÙ„"><i class="bi bi-arrow-repeat"></i></button>
        </div>
      </div>

      <!-- Ø±Ø£Ø³ Ø§Ù„Ø·Ø¨Ø§Ø¹Ø© (Ø³ÙÙŠÙ…Ù„Ø£ Ø¯ÙŠÙ†Ø§Ù…ÙŠÙƒÙŠÙ‹Ø§) -->
      <div id="infoContainer" class="print-header">
        <div id="semesterInfo">â€”</div>
        <div id="selectedVisitsContainer">â€”</div>
        <div id="completionRateContainer">â€”</div>
        <div id="committeesCountContainer">â€”</div>
      </div>
    </div>

    <table class="table table-bordered table-striped table-responsive" id="evaluationsTableWrapper">
      <thead>
        <tr>
          <th>#</th>
          <th class="col-college">Ø§Ù„ÙƒÙ„ÙŠØ©</th>
          <th>Ø§Ø³Ù… Ø§Ù„Ù„Ø¬Ù†Ø©</th>
          <th class="date-col hidden-col">ØªØ§Ø±ÙŠØ® Ø§Ù„ØªØ¯Ù‚ÙŠÙ‚</th>
          <th class="col-formation_decision">Ù‚Ø±Ø§Ø± Ø§Ù„ØªØ´ÙƒÙŠÙ„</th>
          <th class="col-work_plan">Ø®Ø·Ø© Ø§Ù„Ø¹Ù…Ù„</th>
          <th class="col-performance_indicators">Ù…Ø¤Ø´Ø±Ø§Øª Ø§Ù„Ø£Ø¯Ø§Ø¡</th>
          <th class="col-meetings">Ø¹Ø¯Ø¯ Ø§Ù„Ø§Ø¬ØªÙ…Ø§Ø¹Ø§Øª</th>
          <th class="col-consistency">Ø§Ù„ØªÙˆØ§ÙÙ‚ Ø¨ÙŠÙ† Ø§Ù„Ø¯Ø¹ÙˆØ§Øª ÙˆØ§Ù„Ø§Ø¬ØªÙ…Ø§Ø¹Ø§Øª</th>
          <th class="col-coverage_books">ÙƒØªØ¨ Ø§Ù„ØªØºØ·ÙŠØ©</th>
          <th class="col-report1">ØªÙ‚Ø±ÙŠØ± Ø¥Ù†Ø¬Ø§Ø² 1</th>
          <th class="col-report2">ØªÙ‚Ø±ÙŠØ± Ø¥Ù†Ø¬Ø§Ø² 2</th>
          <th class="col-report3">ØªÙ‚Ø±ÙŠØ± Ø¥Ù†Ø¬Ø§Ø² 3</th>
          <th class="col-statistical_analysis">Ø§Ù„ØªØ­Ù„ÙŠÙ„ Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠ</th>
          <th id="availabilityHeader">Ø¯Ø±Ø¬Ø© Ø§Ù„ØªÙˆÙØ± Ù…Ù† (9)</th>
          <th>Ø§Ù„Ù…Ù„Ø§Ø­Ø¸Ø§Øª</th>
        </tr>
      </thead>
      <tbody id="committeesTable">
        <tr><td colspan="16" class="text-center">Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...</td></tr>
      </tbody>
    </table>
  </div>

  <!-- Modal Ø§Ù„Ù…Ù„Ø§Ø­Ø¸Ø§Øª Ù„Ù„Ø´Ø§Ø´Ø© ÙÙ‚Ø· -->
  <div class="modal fade no-print" id="notesModal" tabindex="-1">
    <div class="modal-dialog modal-lg"><div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">ğŸ“ Ø§Ù„Ù…Ù„Ø§Ø­Ø¸Ø§Øª</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body" id="notesContent"></div>
    </div></div>
  </div>

  <!-- Toasts -->
  <div class="toast-container position-fixed top-0 start-50 translate-middle-x p-3 no-print">
    <div id="toastSuccess" class="toast align-items-center text-bg-success border-0 mb-2" role="alert">
      <div class="d-flex"><div class="toast-body">âœ… Ø§Ù„Ø¹Ù…Ù„ÙŠØ© Ù†Ø¬Ø­Øª</div>
        <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button>
      </div>
    </div>
    <div id="toastError" class="toast align-items-center text-bg-danger border-0 mb-2" role="alert">
      <div class="d-flex"><div class="toast-body">âŒ Ø­Ø¯Ø« Ø®Ø·Ø£</div>
        <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button>
      </div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
  <script>
    /* ===== ØªÙˆØ³ØªØ§Øª ===== */
    const toastSuccess = new bootstrap.Toast(document.getElementById('toastSuccess'));
    const toastError   = new bootstrap.Toast(document.getElementById('toastError'));
    const showSuccess  = (m='âœ… Ø§Ù„Ø¹Ù…Ù„ÙŠØ© Ù†Ø¬Ø­Øª')=>{ document.querySelector('#toastSuccess .toast-body').innerText=m; toastSuccess.show(); };
    const showError    = (m='âŒ Ø­Ø¯Ø« Ø®Ø·Ø£')     =>{ document.querySelector('#toastError .toast-body').innerText=m; toastError.show();   };

    /* ===== Ø£Ø¹Ù„Ø§Ù… Ø§Ù„Ø­Ø§Ù„Ø© ===== */
    let savedVisibleColumns = [];  // Ù…Ù† Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª
    let lastCollege = '';          // Ù…Ù† Ø§Ù„ÙÙ„ØªØ± Ø§Ù„Ø­Ø§Ù„ÙŠ
    let settingsCache = null;      // Ù†Ø®Ø²Ù† Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ù„Ù„Ø·Ø¨Ø§Ø¹Ø©
    let PUBLISH_RESULTS = false;   // Ø§Ù„Ø­Ù‚Ù„ Ø§Ù„Ø°ÙŠ Ù†ØªØ­ÙƒÙ… Ø¨Ù‡ Ù…Ù† /api/settings

    const availabilityFields = ["formation_decision","work_plan","performance_indicators","meetings","consistency","coverage_books","report1","report2","report3","statistical_analysis"];

    /* ===== ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù‚ÙˆØ§Ø¦Ù… ===== */
    async function loadOptions(){
      try{
        const { data } = await axios.get('/api/colleges');
        const collegeFilter = document.getElementById('collegeFilter');
        (data||[]).forEach(c=>{
          const opt=document.createElement('option');
          opt.value=c.name; opt.textContent=c.name;
          collegeFilter.appendChild(opt);
        });
      }catch(e){ /* ØµØ§Ù…Øª */ }
    }

    /* ===== Sanitizer Ø¨Ø³ÙŠØ· Ù„Ù„Ù…Ù„Ø§Ø­Ø¸Ø§Øª Ù„Ù„Ø·Ø¨Ø§Ø¹Ø© ===== */
    function sanitizeNotes(html=''){
      try{
        const allowed=['P','UL','OL','LI','B','STRONG','I','EM','U','BR'];
        const tmp=document.createElement('div'); tmp.innerHTML = html;
        const walker=document.createTreeWalker(tmp, NodeFilter.SHOW_ELEMENT, null);
        const toRemove=[];
        while(walker.nextNode()){
          const el=walker.currentNode;
          if(!allowed.includes(el.tagName)) toRemove.push(el);
          // Ø¥Ø²Ø§Ù„Ø© Ø§Ù„Ø®ØµØ§Ø¦Øµ Ø§Ù„Ø®Ø·Ø±Ø©
          for(const a of Array.from(el.attributes||[])){
            const name=a.name.toLowerCase();
            if(name.startsWith('on') || name==='style') el.removeAttribute(a.name);
          }
        }
        toRemove.forEach(n=>n.replaceWith(document.createTextNode(n.textContent||'')));
        return tmp.innerHTML.trim() || 'â€”';
      }catch{return 'â€”'}
    }

    /* ===== ØªØ­Ø¯ÙŠØ« Ø¹Ù†ÙˆØ§Ù† Ø§Ù„ØªÙˆÙØ± ===== */
    function updateAvailabilityHeader(){
      const n=savedVisibleColumns.length;
      document.getElementById('availabilityHeader').innerText=`Ø¯Ø±Ø¬Ø© Ø§Ù„ØªÙˆÙØ± Ù…Ù† (${n})`;
    }

    /* ===== Ø­Ø³Ø§Ø¨ Ø¯Ø±Ø¬Ø© Ø§Ù„ØªÙˆÙØ± Ù„Ù„ØµÙ ===== */
    function updateAvailability(row){
      let sum=0;
      availabilityFields.forEach(f=>{
        const cell=row.querySelector(`[data-field="${f}"]`);
        if(cell && !cell.classList.contains('hidden-col')){
          sum += parseFloat(cell.innerText)||0;
        }
      });
      const target=row.querySelector('.availability-cell');
      if(target){
        target.innerText=sum.toFixed(2);
        target.classList.add('highlight');
        setTimeout(()=>target.classList.remove('highlight'),800);
      }
    }

    /* ===== Ù†Ø³Ø¨Ø© Ø§Ù„Ø§ÙƒØªÙ…Ø§Ù„ + Ø¹Ø¯Ø¯ Ø§Ù„Ù„Ø¬Ø§Ù† ===== */
    function updateCompletionAndCounts(){
      const rows=[...document.querySelectorAll('#committeesTable tr')].filter(r=>r.style.display!=='none');
      let total=0;
      rows.forEach(r=>{ total += parseFloat(r.querySelector('.availability-cell')?.innerText)||0; });
      const denom = rows.length * savedVisibleColumns.length;
      const pct = denom>0 ? ((total/denom)*100).toFixed(2) : '0.00';

      const completionDiv=document.getElementById('completionRateContainer');
      const countDiv=document.getElementById('committeesCountContainer');
      const lc = lastCollege || 'Ø¬Ù…ÙŠØ¹ Ø§Ù„ÙƒÙ„ÙŠØ§Øª';
      if(lc && lc!=='Ø¬Ù…ÙŠØ¹ Ø§Ù„ÙƒÙ„ÙŠØ§Øª'){
        completionDiv.innerHTML = `Ù†Ø³Ø¨Ø© Ø§Ù„Ø§ÙƒØªÙ…Ø§Ù„ Ù„ÙƒÙ„ÙŠØ© ${lc} = ${pct}%`;
        countDiv.innerHTML      = `Ø¹Ø¯Ø¯ Ù„Ø¬Ø§Ù† ÙƒÙ„ÙŠØ© ${lc} = ${rows.length}`;
      }else{
        completionDiv.innerHTML = `Ù†Ø³Ø¨Ø© Ø§Ù„Ø§ÙƒØªÙ…Ø§Ù„ Ù„Ø¬Ù…ÙŠØ¹ Ø§Ù„ÙƒÙ„ÙŠØ§Øª = ${pct}%`;
        countDiv.innerHTML      = `Ø¹Ø¯Ø¯ Ù„Ø¬Ø§Ù† Ø¬Ù…ÙŠØ¹ Ø§Ù„ÙƒÙ„ÙŠØ§Øª = ${rows.length}`;
      }
    }

    /* ===== ØªØ·Ø¨ÙŠÙ‚ Ø±Ø¤ÙŠØ© Ø§Ù„Ø£Ø¹Ù…Ø¯Ø© ===== */
    function applyColumnVisibility(){
      // Ø§Ù„ÙƒÙ„ÙŠØ©
      const showCollege=document.getElementById('toggle_college').checked;
      document.querySelectorAll('.col-college').forEach(el=>el.classList.toggle('hidden-col',!showCollege));
      // Ø§Ù„ØªØ§Ø±ÙŠØ®
      const showDate=document.getElementById('toggle_date').checked;
      document.querySelectorAll('.date-col').forEach(el=>el.classList.toggle('hidden-col',!showDate));
      // Ø§Ù„Ø­Ù‚ÙˆÙ„ Ø§Ù„Ø¹Ø¯Ø¯ÙŠØ© Ø­Ø³Ø¨ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª
      availabilityFields.forEach(f=>{
        const show = savedVisibleColumns.includes(f);
        document.querySelectorAll(`[data-field="${f}"]`).forEach(td=>td.classList.toggle('hidden-col', !show));
        const th=document.querySelector(`.col-${f}`);
        if(th) th.classList.toggle('hidden-col', !show);
      });

      document.querySelectorAll('#committeesTable tr').forEach(updateAvailability);
      updateAvailabilityHeader();
      updateCompletionAndCounts();
    }

    document.querySelectorAll('.simple-toggle').forEach(cb=>{
      cb.addEventListener('change', applyColumnVisibility);
    });

    /* ===== Ø§Ù„Ø¨Ø­Ø« Ø¨Ø§Ø³Ù… Ø§Ù„Ù„Ø¬Ù†Ø© ===== */
    function applyCommitteeSearch(){
      const term=document.getElementById('committeeSearch').value.trim().toLowerCase();
      document.querySelectorAll('#committeesTable tr').forEach(row=>{
        const name=row.cells[2]?.innerText.trim().toLowerCase()||'';
        row.style.display = name.includes(term)? '': 'none';
      });
      updateCompletionAndCounts();
    }
    document.getElementById('committeeSearch').addEventListener('input', applyCommitteeSearch);

    /* ===== ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª (ØªØ´Ù…Ù„ publishResults) ===== */
    async function loadSettings(){
      const semesterEl=document.getElementById('semesterInfo');
      const visitsEl  =document.getElementById('selectedVisitsContainer');

      try{
        const {data} = await axios.get('/api/settings');
        settingsCache = data || {};
        // Ù…ØªØºÙŠØ± Ø§Ù„ØªØ­ÙƒÙ… Ø¨Ø§Ù„Ù†Ø´Ø±
        PUBLISH_RESULTS = !!settingsCache.publishResults;

        // Ø¥Ù† Ù„Ù… ÙŠÙƒÙ† Ø§Ù„Ù†Ø´Ø± Ù…ÙØ¹Ù‘Ù„ => Ø¥Ø¸Ù‡Ø§Ø± Ø§Ù„Ø±Ø³Ø§Ù„Ø© ÙÙ‚Ø· ÙˆØ¥ÙŠÙ‚Ø§Ù ÙƒÙ„ Ø´ÙŠØ¡
        if(!PUBLISH_RESULTS){
          document.getElementById('pageContent').style.display='none';
          document.getElementById('notAvailable').style.display='flex';
          return false;
        }

        // Ù…ÙØ¹Ù‘Ù„ => Ø¥Ø¸Ù‡Ø§Ø± Ø§Ù„ØµÙØ­Ø© ÙˆØ§Ù„Ø§Ø³ØªÙ…Ø±Ø§Ø±
        document.getElementById('notAvailable').style.display='none';
        document.getElementById('pageContent').style.display='block';

        savedVisibleColumns = settingsCache.visibleColumns || [];

        // Ø³Ø·Ø± Ø§Ù„ÙØµÙ„/Ø§Ù„Ø¹Ø§Ù…
        const t = settingsCache.term || 'â€”';
        const ay= settingsCache.academicYear || 'â€”';
        semesterEl.textContent = `${t} - ${ay}`;

        // Ø§Ù„Ø²ÙŠØ§Ø±Ø§Øª Ø£Ø¹Ù„Ù‰ Ø§Ù„Ø¬Ø¯ÙˆÙ„
        const visits = Array.isArray(settingsCache.selectedVisits) && settingsCache.selectedVisits.length
          ? settingsCache.selectedVisits.join(' | ')
          : 'Ù„Ù… ÙŠØªÙ… Ø§Ø®ØªÙŠØ§Ø± Ø£ÙŠ Ø²ÙŠØ§Ø±Ø©';
        visitsEl.textContent = `Ø§Ù„Ø²ÙŠØ§Ø±Ø§Øª: ${visits}`;

        return true;
      }catch(e){
        // ÙÙŠ Ø­Ø§Ù„Ø© Ø§Ù„Ø®Ø·Ø£ Ù†ØªØµØ±Ù ÙƒØ£Ù† Ø§Ù„Ù†Ø´Ø± ØºÙŠØ± Ù…ÙØ¹Ù‘Ù„ (Ø£ÙƒØ«Ø± Ø£Ù…Ø§Ù†Ù‹Ø§)
        document.getElementById('pageContent').style.display='none';
        document.getElementById('notAvailable').style.display='flex';
        return false;
      }
    }

    /* ===== ØªØ­Ù…ÙŠÙ„ Ø¬Ø¯ÙˆÙ„ Ø§Ù„Ù„Ø¬Ø§Ù† ===== */
    async function loadCommittees(){
      try{
        const college=document.getElementById('collegeFilter').value;
        lastCollege = college || 'Ø¬Ù…ÙŠØ¹ Ø§Ù„ÙƒÙ„ÙŠØ§Øª';
        let url='/api/committees';
        const params=[];
        if(college) params.push('college='+encodeURIComponent(college));
        if(params.length) url+='?'+params.join('&');

        const res=await axios.get(url);
        const tbody=document.getElementById('committeesTable');
        tbody.innerHTML='';

        const arr=Array.isArray(res.data)?res.data:[];
        if(!arr.length){
          tbody.innerHTML=`<tr><td colspan="16" class="text-center">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª</td></tr>`;
          updateAvailabilityHeader();
          document.getElementById('completionRateContainer').textContent='';
          document.getElementById('committeesCountContainer').textContent='';
          return;
        }

        // ØªØ±ØªÙŠØ¨ Ø§ÙØªØ±Ø§Ø¶ÙŠ Ø­Ø³Ø¨ Ø§Ù„ÙƒÙ„ÙŠØ©
        arr.sort((a,b)=>(a.college||'').localeCompare(b.college||'','ar'));

        // Ø±Ø³Ù… Ø§Ù„ØµÙÙˆÙ
        arr.forEach((c,idx)=>{
          const tr=document.createElement('tr');
          const dateTxt = c.audit_date ? new Date(c.audit_date).toLocaleDateString('ar-EG'): '-';
          const notesHtml = (c.notes||'').trim();
          const hasNotes  = !!notesHtml && notesHtml!=='<p><br></p>' && notesHtml!=='<br>';

          tr.innerHTML = `
            <td>${idx+1}</td>
            <td class="col-college">${c.college??''}</td>
            <td>${c.committee_name??''}</td>
            <td class="date-col hidden-col">${dateTxt}</td>
            <td data-field="formation_decision">${c.formation_decision ?? 0}</td>
            <td data-field="work_plan">${c.work_plan ?? 0}</td>
            <td data-field="performance_indicators">${c.performance_indicators ?? 0}</td>
            <td data-field="meetings">${c.meetings ?? 0}</td>
            <td data-field="consistency">${c.consistency ?? 0}</td>
            <td data-field="coverage_books">${c.coverage_books ?? 0}</td>
            <td data-field="report1">${c.report1 ?? 0}</td>
            <td data-field="report2">${c.report2 ?? 0}</td>
            <td data-field="report3">${c.report3 ?? 0}</td>
            <td data-field="statistical_analysis">${c.statistical_analysis ?? 0}</td>
            <td class="availability-cell">${c.availability_score ?? 0}</td>
            <td>
              <span class="notes-screen">
                ${
                  hasNotes
                  ? `<button class="btn btn-sm btn-info" title="Ø¹Ø±Ø¶ Ø§Ù„Ù…Ù„Ø§Ø­Ø¸Ø§Øª" data-notes="1">ğŸ”</button>`
                  : '<span class="text-muted">Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ù„Ø§Ø­Ø¸Ø§Øª</span>'
                }
              </span>
              <div class="print-notes">${hasNotes ? sanitizeNotes(notesHtml) : 'â€”'}</div>
            </td>
          `;
          // Ø²Ø± Ø¹Ø±Ø¶ Ø§Ù„Ù…Ù„Ø§Ø­Ø¸Ø§Øª (Ø´Ø§Ø´Ø© ÙÙ‚Ø·)
          const btn = tr.querySelector('[data-notes]');
          if(btn){
            btn.addEventListener('click',()=>{
              document.getElementById('notesContent').innerHTML = notesHtml || '<i>Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ù„Ø§Ø­Ø¸Ø§Øª</i>';
              new bootstrap.Modal(document.getElementById('notesModal')).show();
            });
          }
          document.getElementById('committeesTable').appendChild(tr);
          updateAvailability(tr);
        });

        // ØªØ·Ø¨ÙŠÙ‚ Ø±Ø¤ÙŠØ© Ø§Ù„Ø£Ø¹Ù…Ø¯Ø© (Ø­Ø³Ø¨ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ø­Ø§Ù„ÙŠØ© ÙˆØ§Ù„ØªØ¨Ø¯ÙŠÙ„Ø§Øª)
        applyColumnVisibility();
        // ØªØ·Ø¨ÙŠÙ‚ Ø§Ù„Ø¨Ø­Ø« Ø§Ù„Ø­Ø§Ù„ÙŠ
        applyCommitteeSearch();
      }catch(err){
        console.error(err);
        showError('âŒ ÙØ´Ù„ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª');
        const tbody=document.getElementById('committeesTable');
        tbody.innerHTML=`<tr><td colspan="16" class="text-center text-danger">ÙØ´Ù„ Ø§Ù„Ø¬Ù„Ø¨</td></tr>`;
      }
    }

    /* ===== Ø·Ø¨Ø§Ø¹Ø© ===== */
    document.getElementById('printBtn').addEventListener('click', ()=> {
      updateCompletionAndCounts();
      window.print();
    });

    /* ===== Ø£Ø­Ø¯Ø§Ø« Ø¹Ø§Ù…Ø© ===== */
    document.getElementById('collegeFilter').addEventListener('change', async ()=>{
      if(!PUBLISH_RESULTS) return;
      await loadCommittees();
    });
    document.getElementById('reloadBtn').addEventListener('click', async ()=>{
      const ok = await loadSettings();
      if(ok){ // ÙÙ‚Ø· Ø¥Ø°Ø§ Ø§Ù„Ù†Ø´Ø± Ù…ÙØ¹Ù‘Ù„
        await loadOptions(); // ÙŠÙ…ÙƒÙ† Ø¥Ø¹Ø§Ø¯Ø© ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù‚ÙˆØ§Ø¦Ù… Ø£ÙŠØ¶Ù‹Ø§ Ø¹Ù†Ø¯ Ø§Ù„Ø±ØºØ¨Ø©
        await loadCommittees();
      }
    });

    /* ===== ØªØ´ØºÙŠÙ„ Ø£ÙˆÙ„ÙŠ =====
       1) Ù‚Ø±Ø§Ø¡Ø© Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ù„ØªØ­Ø¯ÙŠØ¯ publishResults
       2) Ø¥Ø°Ø§ Ù…ÙØ¹Ù‘Ù„: Ù†Ø­Ù…Ù‘Ù„ Ø§Ù„Ù‚ÙˆØ§Ø¦Ù… Ø«Ù… Ø§Ù„Ø¬Ø¯ÙˆÙ„
    */
    (async function init(){
      const ok = await loadSettings();
      if(!ok) return;
      await loadOptions();
      await loadCommittees();
    })();
  </script>
</body>
</html>
