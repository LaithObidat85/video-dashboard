<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8">
  <title>Ø¥Ø¯Ø®Ø§Ù„ ØªÙ‚ÙŠÙŠÙ… Ù„Ø¬Ù†Ø©</title>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.rtl.min.css">
  <link href="https://cdn.quilljs.com/1.3.6/quill.snow.css" rel="stylesheet">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/tom-select/dist/css/tom-select.bootstrap5.min.css">
  <style>
    body { background-color: #f8f9fa; font-family: 'Segoe UI', sans-serif; }
    .form-container { max-width: 800px; margin: 40px auto; background: #fff; padding: 25px; border-radius: 12px; box-shadow: 0 4px 12px rgba(0,0,0,0.1); }
    .form-section { margin-bottom: 20px; padding: 15px; border: 1px solid #dee2e6; border-radius: 10px; background: #fdfdfd; }
    .form-section h6 { margin-bottom: 15px; font-weight: bold; color: #0d6efd; }
    .toast-container { position: fixed; top: 20px; left: 20px; z-index: 2000; }
    #editor { height: 150px; background: #fff; }
  </style>
</head>
<body>
  <div class="form-container">
    <h4 class="mb-4 text-center">ğŸ“ Ø¥Ø¯Ø®Ø§Ù„ ØªÙ‚ÙŠÙŠÙ… Ù„Ø¬Ù†Ø©</h4>
    <form id="committeeForm">

      <!-- Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù„Ø¬Ù†Ø© -->
      <div class="form-section">
        <h6>Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù„Ø¬Ù†Ø©</h6>
        <div class="mb-3">
          <label class="form-label">Ø§Ù„ÙƒÙ„ÙŠØ©</label>
          <select class="form-select" name="college" id="collegeSelect" required>
            <option value="">Ø§Ø®ØªØ± Ø§Ù„ÙƒÙ„ÙŠØ©...</option>
          </select>
        </div>
        <div class="mb-3">
          <label class="form-label" for="committeeSelect">Ø§Ø³Ù… Ø§Ù„Ù„Ø¬Ù†Ø©</label>
          <select class="form-select" name="committee_name" id="committeeSelect" required placeholder="Ø§ÙƒØªØ¨ Ù„Ù„Ø¨Ø­Ø« Ø£Ùˆ Ø£Ø¶Ù Ø§Ø³Ù…Ù‹Ø§ Ø¬Ø¯ÙŠØ¯Ù‹Ø§"></select>
        </div>
      </div>

      <!-- Ø¹Ù†Ø§ØµØ± Ø§Ù„ØªÙ‚ÙŠÙŠÙ… (Ø¨Ù‡ÙŠØ¦Ø© Ø¬Ø¯ÙˆÙ„) -->
      <div class="form-section">
        <h6 class="d-flex align-items-center justify-content-between">
          Ø§Ù„ØªÙ‚ÙŠÙŠÙ… Ø§Ù„ØªÙØµÙŠÙ„ÙŠ
          <div class="form-check form-switch">
            <input class="form-check-input" type="checkbox" id="fillOnes">
            <label class="form-check-label" for="fillOnes">ØªØ¹Ø¨Ø¦Ø© ØªÙ„Ù‚Ø§Ø¦ÙŠØ© Ø¨Ø§Ù„Ø±Ù‚Ù… 1</label>
          </div>
        </h6>

        <div class="table-responsive">
          <table class="table table-bordered align-middle mb-0">
            <thead class="table-light">
              <tr>
                <th style="width:70%">Ø§Ù„Ø¨Ù†Ø¯</th>
                <th style="width:30%">Ø§Ù„Ø¯Ø±Ø¬Ø©</th>
              </tr>
            </thead>
            <tbody>
              <tr>
                <td><label for="formation_decision">Ù‚Ø±Ø§Ø± Ø§Ù„ØªØ´ÙƒÙŠÙ„</label></td>
                <td><input type="number" step="0.25" min="0" max="1" class="form-control score" name="formation_decision" id="formation_decision" placeholder="0"></td>
              </tr>
              <tr>
                <td><label for="work_plan">Ø®Ø·Ø© Ø¹Ù…Ù„ Ø§Ù„Ù„Ø¬Ù†Ø©</label></td>
                <td><input type="number" step="0.25" min="0" max="1" class="form-control score" name="work_plan" id="work_plan" placeholder="0"></td>
              </tr>
              <tr>
                <td><label for="performance_indicators">Ù…Ø¤Ø´Ø±Ø§Øª Ø£Ø¯Ø§Ø¡ Ø®Ø·Ø© Ø¹Ù…Ù„ Ø§Ù„Ù„Ø¬Ù†Ø© Ù‚Ø§Ø¨Ù„Ø© Ù„Ù„Ù‚ÙŠØ§Ø³</label></td>
                <td><input type="number" step="0.25" min="0" max="1" class="form-control score" name="performance_indicators" id="performance_indicators" placeholder="0"></td>
              </tr>
              <tr>
                <td><label for="meetings">Ø¹Ø¯Ø¯ Ø§Ù„Ø§Ø¬ØªÙ…Ø§Ø¹Ø§Øª</label></td>
                <td><input type="number" step="0.25" min="0" max="1" class="form-control score" name="meetings" id="meetings" placeholder="0"></td>
              </tr>
              <tr>
                <td><label for="consistency">Ø§Ù„ØªÙˆØ§ÙÙ‚ Ø¨ÙŠÙ† Ø§Ù„Ø¯Ø¹ÙˆØ§Øª ÙˆØ§Ù„Ø§Ø¬ØªÙ…Ø§Ø¹Ø§Øª</label></td>
                <td><input type="number" step="0.25" min="0" max="1" class="form-control score" name="consistency" id="consistency" placeholder="0"></td>
              </tr>
              <tr>
                <td><label for="coverage_books">ÙƒØªØ¨ Ø§Ù„ØªØºØ·ÙŠØ©</label></td>
                <td><input type="number" step="0.25" min="0" max="1" class="form-control score" name="coverage_books" id="coverage_books" placeholder="0"></td>
              </tr>
              <tr>
                <td><label for="report1">ØªÙ‚Ø±ÙŠØ± Ø¥Ù†Ø¬Ø§Ø² 1</label></td>
                <td><input type="number" step="0.25" min="0" max="1" class="form-control score" name="report1" id="report1" placeholder="0"></td>
              </tr>
              <tr>
                <td><label for="report2">ØªÙ‚Ø±ÙŠØ± Ø¥Ù†Ø¬Ø§Ø² 2</label></td>
                <td><input type="number" step="0.25" min="0" max="1" class="form-control score" name="report2" id="report2" placeholder="0"></td>
              </tr>
              <tr>
                <td><label for="report3">ØªÙ‚Ø±ÙŠØ± Ø¥Ù†Ø¬Ø§Ø² 3</label></td>
                <td><input type="number" step="0.25" min="0" max="1" class="form-control score" name="report3" id="report3" placeholder="0"></td>
              </tr>
              <tr>
                <td><label for="statistical_analysis">ØªÙ‚ÙŠÙŠÙ… Ø£Ø¯Ø§Ø¡ Ø§Ù„Ù„Ø¬Ù†Ø© (Ø§Ù„ØªØ­Ù„ÙŠÙ„ Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠ)</label></td>
                <td><input type="number" step="0.25" min="0" max="1" class="form-control score" name="statistical_analysis" id="statistical_analysis" placeholder="0"></td>
              </tr>
            </tbody>
          </table>
        </div>
      </div>

      <!-- Ø¯Ø±Ø¬Ø© Ø§Ù„ØªÙˆÙØ± ÙˆØ§Ù„Ù…Ù„Ø§Ø­Ø¸Ø§Øª -->
      <div class="form-section">
        <h6>Ø§Ù„Ù†ØªØ§Ø¦Ø¬ Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠØ©</h6>
        <div class="mb-3">
          <label class="form-label">Ø¯Ø±Ø¬Ø© Ø§Ù„ØªÙˆÙØ± (ØªÙØ­Ø³Ø¨ ØªÙ„Ù‚Ø§Ø¦ÙŠÙ‹Ø§)</label>
          <input type="number" class="form-control" id="availability_score" name="availability_score" readonly>
        </div>
        <div class="mb-3">
          <label class="form-label">Ù…Ù„Ø§Ø­Ø¸Ø§Øª</label>
          <div id="editor"></div>
          <input type="hidden" name="notes" id="notesInput">
        </div>
        <div class="row">
          <div class="col-md-6 mb-3"><label class="form-label">ØªØ§Ø±ÙŠØ® Ø§Ù„ØªØ¯Ù‚ÙŠÙ‚</label><input type="date" class="form-control" name="audit_date"></div>
          <div class="col-md-6 mb-3">
            <label class="form-label">Ø§Ø³Ù… Ø§Ù„Ù…Ø¯Ù‚Ù‚</label>
            <select class="form-select" name="auditor_name" id="auditorSelect" required>
              <option value="">Ø§Ø®ØªØ± Ø§Ù„Ù…Ø¯Ù‚Ù‚...</option>
            </select>
          </div>
        </div>
      </div>

      <button type="submit" class="btn btn-primary w-100">ğŸ’¾ Ø­ÙØ¸ Ø§Ù„ØªÙ‚ÙŠÙŠÙ…</button>
    </form>
  </div>

  <!-- Toasts -->
  <div class="toast-container">
    <div id="successToast" class="toast align-items-center text-bg-success border-0" role="alert">
      <div class="d-flex"><div class="toast-body">âœ… ØªÙ… Ø­ÙØ¸ Ø§Ù„ØªÙ‚ÙŠÙŠÙ… Ø¨Ù†Ø¬Ø§Ø­</div><button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button></div>
    </div>
    <div id="errorToast" class="toast align-items-center text-bg-danger border-0" role="alert">
      <div class="d-flex"><div class="toast-body">âŒ Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„Ø­ÙØ¸</div><button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button></div>
    </div>
  </div>

  <!-- Ù…ÙƒØªØ¨Ø§Øª -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
  <script src="https://cdn.quilljs.com/1.3.6/quill.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/tom-select/dist/js/tom-select.complete.min.js"></script>
  <script>
    const quill = new Quill('#editor', { theme: 'snow' });

    const successToast = new bootstrap.Toast(document.getElementById('successToast'));
    const errorToast = new bootstrap.Toast(document.getElementById('errorToast'));

    // Ø¬Ù„Ø¨ Ø§Ù„ÙƒÙ„ÙŠØ§Øª Ù…Ù† Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
    async function loadColleges() {
      try {
        const res = await axios.get('/api/colleges');
        const select = document.getElementById('collegeSelect');
        res.data.forEach(c => {
          const opt = document.createElement('option');
          opt.value = c.name;
          opt.textContent = c.name;
          select.appendChild(opt);
        });
      } catch (err) {
        console.error("Ø®Ø·Ø£ ÙÙŠ Ø¬Ù„Ø¨ Ø§Ù„ÙƒÙ„ÙŠØ§Øª:", err);
      }
    }
    loadColleges();

    // Ø¬Ù„Ø¨ Ø§Ù„Ù…Ø¯Ù‚Ù‚ÙŠÙ† Ù…Ù† Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
    async function loadAuditors() {
      try {
        const res = await axios.get('/api/auditors');
        const select = document.getElementById('auditorSelect');
        res.data.forEach(a => {
          const opt = document.createElement('option');
          opt.value = a.name;
          opt.textContent = a.name;
          select.appendChild(opt);
        });
      } catch (err) {
        console.error("Ø®Ø·Ø£ ÙÙŠ Ø¬Ù„Ø¨ Ø§Ù„Ù…Ø¯Ù‚Ù‚ÙŠÙ†:", err);
      }
    }
    loadAuditors();

    // ØªÙ‡ÙŠØ¦Ø© Tom Select Ù„Ø­Ù‚Ù„ Ø§Ø³Ù… Ø§Ù„Ù„Ø¬Ù†Ø©
    let committeeTS = new TomSelect('#committeeSelect', {
      valueField: 'name',
      labelField: 'name',
      searchField: 'name',
      create: true,
      persist: false,
      maxItems: 1,
      placeholder: 'Ø§ÙƒØªØ¨ Ù„Ù„Ø¨Ø­Ø« Ø£Ùˆ Ø£Ø¶Ù Ø§Ø³Ù…Ù‹Ø§ Ø¬Ø¯ÙŠØ¯Ù‹Ø§',
      load: function (query, callback) {
        const q = encodeURIComponent(query || '');
        fetch(`/api/committee-names?q=${q}`)
          .then(res => res.json())
          .then(list => callback(list))
          .catch(() => callback());
      },
      createFilter: function(input){ return !!input.trim(); }
    });

    // Ø§Ù„ØªØ£ÙƒØ¯ Ù…Ù† Ø£Ù† Ø§Ù„Ù…Ø¯Ø®Ù„Ø§Øª ØªØ¨Ù‚Ù‰ Ø¨ÙŠÙ† 0 Ùˆ 1
    function clampScoreInput(el) {
      const min = 0;
      const max = 1;
      let v = parseFloat(el.value);
      if (isNaN(v)) return;
      if (v < min) v = min;
      if (v > max) v = max;
      el.value = v;
    }

    // Ø­Ø³Ø§Ø¨ Ø¯Ø±Ø¬Ø© Ø§Ù„ØªÙˆÙØ± ØªÙ„Ù‚Ø§Ø¦ÙŠÙ‹Ø§
    function recomputeAvailability() {
      let sum = 0;
      document.querySelectorAll('.score').forEach(i => {
        const val = parseFloat(i.value);
        if (!isNaN(val)) sum += val;
      });
      document.getElementById('availability_score').value = sum;
    }

    document.querySelectorAll('.score').forEach(input => {
      input.addEventListener('input', () => {
        clampScoreInput(input);
        recomputeAvailability();
      });
      input.addEventListener('change', () => {
        clampScoreInput(input);
        recomputeAvailability();
      });
    });

    // Checkbox Ù„Ù„ØªØ¹Ø¨Ø¦Ø© Ø§Ù„ØªÙ„Ù‚Ø§Ø¦ÙŠØ© Ø¨Ø§Ù„Ù‚ÙŠÙ…Ø© 1
    const fillOnesCheckbox = document.getElementById('fillOnes');
    if (fillOnesCheckbox) {
      fillOnesCheckbox.addEventListener('change', (e) => {
        const v = e.target.checked ? 1 : '';
        document.querySelectorAll('.score').forEach(i => {
          i.value = v;
          clampScoreInput(i);
        });
        recomputeAvailability();
      });
    }

    // Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ù†Ù…ÙˆØ°Ø¬
    document.getElementById("committeeForm").addEventListener("submit", async function(e){
      e.preventDefault();
      document.getElementById("notesInput").value = quill.root.innerHTML;

      const formData = new FormData(this);
      const data = Object.fromEntries(formData.entries());

      try {
        const res = await axios.post('/api/committees', data);
        if(res.status === 201){
          successToast.show();
          this.reset();
          quill.setContents([]);
          document.getElementById('availability_score').value = 0;
          if (fillOnesCheckbox && fillOnesCheckbox.checked) fillOnesCheckbox.checked = false;
          if (committeeTS) committeeTS.clear();
        }
      } catch (err) {
        console.error(err);
        errorToast.show();
      }
    });

    // ØªÙ‡ÙŠØ¦Ø© Ø£ÙˆÙ„ÙŠØ©
    recomputeAvailability();
  </script>
</body>
</html>
