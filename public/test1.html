<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <title>Ø¹Ø±Ø¶ Ø±ÙˆØ§Ø¨Ø· Ù…Ù„ÙØ§Øª Ø§Ù„Ù„Ø¬Ø§Ù†</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <link rel="icon" type="image/png" href="https://www.dropbox.com/scl/fi/f283e4rvv5cf9x12a1cic/my-website-logo.png?rlkey=yia776im7klypy27af32m0scy&e=1&st=vhaprvzh&dl=1">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.rtl.min.css">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css">
  <style>
    body{background:#f8f9fa;font-family:'Segoe UI',sans-serif}
    .container{margin-top:32px;max-width:1400px}
    .filter-card{position:sticky;top:12px;z-index:5}
    .user-chip{display:inline-flex;align-items:center;gap:.25rem;font-size:1rem!important;padding:.375rem .75rem!important;border-radius:.375rem;font-weight:700!important}
    .muted{color:#6c757d}
    .results-header{display:flex;flex-wrap:wrap;gap:.75rem;align-items:center;justify-content:space-between}
    .counter-badge{font-weight:700}
    .section-card .card-header{background:#f1f3f5}
    .link-row{display:flex;gap:.5rem;align-items:center;justify-content:space-between;border:1px solid #e9ecef;border-radius:.5rem;padding:.5rem;background:#fff}
    .link-title{white-space:nowrap;overflow:hidden;text-overflow:ellipsis;max-width:60ch}
    .empty-hint{border:1px dashed #ced4da;border-radius:.5rem;padding:1rem;background:#fff}
    .skeleton{position:relative;overflow:hidden;background-color:#e9ecef;border-radius:.5rem}
    .skeleton::after{content:"";position:absolute;inset:0;transform:translateX(-100%);background:linear-gradient(90deg,transparent,rgba(255,255,255,.35),transparent);animation:shimmer 1.2s infinite}
    @keyframes shimmer{100%{transform:translateX(100%)}}
    .toast-container{position:fixed;top:20px;left:50%;transform:translateX(-50%);z-index:2000}
    .disabled-cover{pointer-events:none;opacity:.65}
  </style>
</head>
<body>
  <div class="container">
    <!-- Header -->
    <div class="d-flex flex-wrap justify-content-between align-items-center mb-3 gap-2">
      <h4 class="mb-0"><i class="bi bi-collection"></i> Ø¹Ø±Ø¶ Ø±ÙˆØ§Ø¨Ø· Ù…Ù„ÙØ§Øª Ø§Ù„Ù„Ø¬Ø§Ù†</h4>
      <div class="d-flex align-items-center gap-2">
        <span id="userInfo" class="user-chip badge bg-light text-dark border">
          <i class="bi bi-person"></i>
          <span id="userUsername">â€”</span>
          <span class="mx-1">â€”</span>
          <span id="userFullName">â€”</span>
          <span class="ms-2 badge bg-secondary" id="userRole">â€”</span>
        </span>
        <a class="btn btn-outline-primary" id="homeBtn" href="/committees-home.html">
          <i class="bi bi-grid"></i> Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ…
        </a>
        <button id="logoutBtn" class="btn btn-danger">
          <i class="bi bi-box-arrow-right"></i> Ø®Ø±ÙˆØ¬
        </button>
      </div>
    </div>

    <div class="row g-4">
      <!-- Filters -->
      <div class="col-lg-4 col-xl-3">
        <div class="card filter-card">
          <div class="card-body">
            <div class="d-flex justify-content-between align-items-center mb-2">
              <h6 class="mb-0">Ø§Ù„Ù…Ø±Ø´Ù‘Ø­Ø§Øª</h6>
              <span id="liveCount" class="badge text-bg-secondary">â€”</span>
            </div>

            <div class="mb-3">
              <label class="form-label">Ø§Ù„ÙƒÙ„ÙŠØ© <span class="text-danger">*</span></label>
              <select id="collegeSelect" class="form-select">
                <option value="">â€” Ø§Ø®ØªØ± Ø§Ù„ÙƒÙ„ÙŠØ© â€”</option>
              </select>
            </div>

            <div class="mb-3">
              <label class="form-label">Ø§Ù„Ø¹Ø§Ù… Ø§Ù„Ø¬Ø§Ù…Ø¹ÙŠ <span class="text-danger">*</span></label>
              <input id="academicYearInput" type="text" class="form-control" placeholder="2024/2025 Ø£Ùˆ 2024-2025">
              <div class="form-text">ØµÙŠØºØ©: 20xx/20yy Ø£Ùˆ 20xx-20yy</div>
            </div>

            <div class="mb-3">
              <label class="form-label">Ø§Ù„ÙØµÙ„ Ø§Ù„Ø¯Ø±Ø§Ø³ÙŠ <span class="text-danger">*</span></label>
              <select id="termSelect" class="form-select" disabled>
                <option value="">â€” Ø§Ø®ØªØ± Ø§Ù„ÙØµÙ„ â€”</option>
              </select>
              <div class="form-text" id="termHint">Ø§Ø®ØªØ± Ø§Ù„Ø¹Ø§Ù… Ù„Ø¹Ø±Ø¶ Ø§Ù„ÙØµÙˆÙ„ Ø§Ù„Ù…ØªØ§Ø­Ø©</div>
            </div>

            <div class="mb-3">
              <label class="form-label">Ø§Ù„Ù„Ø¬Ù†Ø© <span class="text-danger">*</span></label>
              <select id="committeeSelect" class="form-select" disabled>
                <option value="">â€” Ø§Ø®ØªØ± Ø§Ù„Ù„Ø¬Ù†Ø© â€”</option>
              </select>
              <div class="form-text" id="committeeHint">Ø§Ø®ØªØ± Ø§Ù„ÙƒÙ„ÙŠØ© Ù„Ø¹Ø±Ø¶ Ù„Ø¬Ø§Ù†Ù‡Ø§</div>
            </div>

            <hr>
            <div class="mb-2">
              <label class="form-label">Ø·Ø±ÙŠÙ‚Ø© ÙØªØ­ Ø§Ù„Ø±ÙˆØ§Ø¨Ø·</label>
              <div class="form-check">
                <input class="form-check-input" type="radio" name="openMode" id="modePopup" value="popup">
                <label class="form-check-label" for="modePopup">Ù†Ø§ÙØ°Ø© Ù…Ù†Ø¨Ø«Ù‚Ø© (Pop-up)</label>
              </div>
              <div class="form-check">
                <input class="form-check-input" type="radio" name="openMode" id="modeTab" value="tab">
                <label class="form-check-label" for="modeTab">ØªØ¨ÙˆÙŠØ¨ Ø¬Ø¯ÙŠØ¯ (New Tab)</label>
              </div>
              <div class="form-text">Ø³ÙŠØªÙ… Ø­ÙØ¸ Ø§Ù„ØªÙØ¶ÙŠÙ„ ØªÙ„Ù‚Ø§Ø¦ÙŠÙ‹Ø§ Ù„Ù‡Ø°Ø§ Ø§Ù„Ø¬Ù‡Ø§Ø².</div>
            </div>

            <div class="d-grid gap-2 mt-3">
              <button id="applyBtn" class="btn btn-success disabled-cover"><i class="bi bi-eye"></i> Ø¹Ø±Ø¶ Ø§Ù„Ù†ØªØ§Ø¦Ø¬</button>
              <button id="resetFiltersBtn" class="btn btn-outline-secondary"><i class="bi bi-arrow-counterclockwise"></i> ØªÙØ±ÙŠØº Ø§Ù„Ù…Ø±Ø´Ù‘Ø­Ø§Øª</button>
            </div>
          </div>
        </div>
      </div>

      <!-- Results -->
      <div class="col-lg-8 col-xl-9">
        <div class="card">
          <div class="card-body">
            <div class="results-header mb-3">
              <div class="d-flex align-items-center gap-2">
                <h6 class="mb-0">Ø§Ù„Ù†ØªØ§Ø¦Ø¬</h6>
                <span id="summaryChip" class="badge bg-light text-dark border">â€”</span>
              </div>
              <div class="d-flex align-items-center gap-2">
                <input id="quickFilter" type="search" class="form-control form-control-sm" placeholder="ØªØµÙÙŠØ© Ø³Ø±ÙŠØ¹Ø© Ù„Ù„Ø¹Ù†Ø§ÙˆÙŠÙ† â€¦" style="max-width:260px" disabled>
                <button id="openAllBtn" class="btn btn-outline-primary btn-sm disabled-cover"><i class="bi bi-box-arrow-up-right"></i> ÙØªØ­ Ø§Ù„ÙƒÙ„</button>
              </div>
            </div>

            <div id="placeholder">
              <div class="skeleton mb-2" style="height:44px;"></div>
              <div class="skeleton mb-2" style="height:140px;"></div>
              <div class="skeleton" style="height:240px;"></div>
            </div>

            <div id="noData" class="empty-hint d-none">
              Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ø­ÙÙˆØ¸Ø© Ù„Ù‡Ø°Ø§ Ø§Ù„ØªØ±Ø´ÙŠØ­. Ø¬Ø±Ù‘Ø¨ ØªØºÙŠÙŠØ± Ø§Ù„Ù…Ø±Ø´Ù‘Ø­Ø§Øª.
            </div>

            <div id="results" class="vstack gap-3 d-none">
              <!-- Core Docs -->
              <div class="card section-card">
                <div class="card-header d-flex align-items-center justify-content-between">
                  <span><i class="bi bi-file-earmark-text"></i> Ø§Ù„Ù…Ø³ØªÙ†Ø¯Ø§Øª Ø§Ù„Ø£Ø³Ø§Ø³ÙŠØ©</span>
                </div>
                <div class="card-body vstack gap-2" id="coreSection"></div>
              </div>

              <!-- Invitations -->
              <div class="card section-card">
                <div class="card-header d-flex align-items-center justify-content-between">
                  <span><i class="bi bi-envelope-paper"></i> Ø¯Ø¹ÙˆØ§Øª Ø§Ù„Ø§Ø¬ØªÙ…Ø§Ø¹</span>
                  <span id="badgeInv" class="badge text-bg-secondary">0</span>
                </div>
                <div class="card-body vstack gap-2" id="invSection"></div>
              </div>

              <!-- Minutes -->
              <div class="card section-card">
                <div class="card-header d-flex align-items-center justify-content-between">
                  <span><i class="bi bi-journal-text"></i> Ù…Ø­Ø§Ø¶Ø± Ø§Ù„Ø§Ø¬ØªÙ…Ø§Ø¹</span>
                  <span id="badgeMin" class="badge text-bg-secondary">0</span>
                </div>
                <div class="card-body vstack gap-2" id="minSection"></div>
              </div>

              <!-- Coverage -->
              <div class="card section-card">
                <div class="card-header d-flex align-items-center justify-content-between">
                  <span><i class="bi bi-mailbox2"></i> ÙƒØªØ¨ Ø§Ù„ØªØºØ·ÙŠØ©</span>
                  <span id="badgeCov" class="badge text-bg-secondary">0</span>
                </div>
                <div class="card-body vstack gap-2" id="covSection"></div>
              </div>

              <!-- Reports & Stats -->
              <div class="card section-card">
                <div class="card-header"><i class="bi bi-graph-up"></i> Ø§Ù„ØªÙ‚Ø§Ø±ÙŠØ± ÙˆØ§Ù„ØªØ­Ù„ÙŠÙ„</div>
                <div class="card-body vstack gap-2" id="repSection"></div>
              </div>
            </div>

          </div>
        </div>
      </div>
    </div>

    <!-- Toasts -->
    <div class="toast-container">
      <div id="toastInfo" class="toast align-items-center text-bg-primary border-0 mb-2" role="alert">
        <div class="d-flex"><div class="toast-body">â„¹ï¸ ØªÙ…</div><button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button></div>
      </div>
      <div id="toastSuccess" class="toast align-items-center text-bg-success border-0 mb-2" role="alert">
        <div class="d-flex"><div class="toast-body">âœ… ØªÙ…</div><button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button></div>
      </div>
      <div id="toastError" class="toast align-items-center text-bg-danger border-0 mb-2" role="alert">
        <div class="d-flex"><div class="toast-body">âŒ Ø­Ø¯Ø« Ø®Ø·Ø£</div><button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button></div>
      </div>
    </div>
  </div>

  <!-- Bootstrap JS -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

  <script>
    /* ====== Ø¨ÙŠØ¦Ø© Ù…ÙˆØ­Ø¯Ø© (Ù…Ø«Ù„ ØµÙØ­ØªÙƒ Ø§Ù„Ø³Ø§Ø¨Ù‚Ø©) ====== */
    const RENDER_BASE='https://vdash-qkyv.onrender.com';
    const host=location.hostname;
    const isGithub=host.endsWith('github.io');
    const isLocal=host==='localhost'||host==='127.0.0.1';
    const API_BASE=isGithub?RENDER_BASE:(isLocal?'http://localhost:3000':'');
    const go=(path)=>isGithub?(RENDER_BASE+path):path;

    const apiFetch=(path,opts={})=>fetch(`${API_BASE}${path}`,{credentials:'include',...opts});
    const toastInfo   = new bootstrap.Toast(document.getElementById('toastInfo'));
    const toastOk     = new bootstrap.Toast(document.getElementById('toastSuccess'));
    const toastError  = new bootstrap.Toast(document.getElementById('toastError'));

    /* ====== Ø­Ø§Ù„Ø© Ø§Ù„ØµÙØ­Ø© ====== */
    const state = {
      user:null,
      filters:{
        college:'',
        academicYear:'',
        term:'',
        committee_name:''
      },
      openMode: localStorage.getItem('cmts.openMode') || 'tab', // 'popup' | 'tab'
      currentItem:null, // Ø¹Ù†ØµØ± CommitteeFiles
      listsCache: {
        terms: [],        // Ø§Ù„ÙØµÙˆÙ„ Ø§Ù„Ù…ØªØ§Ø­Ø© Ø­Ø³Ø¨ (college+year)
        committees: []    // Ø§Ù„Ù„Ø¬Ø§Ù† Ø§Ù„Ù…ØªØ§Ø­Ø© Ø­Ø³Ø¨ (college)
      }
    };

    /* ====== Ø£Ø¯ÙˆØ§Øª ====== */
    const yearRx = /^(20\d{2})[\/-](20\d{2})$/;
    function validateAcademicYear(s){ const m=String(s||'').trim().match(yearRx); if(!m) return false; return (parseInt(m[2],10)-parseInt(m[1],10))===1; }
    function setSummaryChip(){
      const {college,academicYear,term,committee_name}=state.filters;
      const parts=[college||'â€”', committee_name||'â€”', academicYear||'â€”', term||'â€”'];
      document.getElementById('summaryChip').textContent = parts.join(' Â· ');
    }
    function enableApplyIfReady(){
      const ready = state.filters.college && state.filters.academicYear && state.filters.term && state.filters.committee_name;
      document.getElementById('applyBtn').classList.toggle('disabled-cover', !ready);
      document.getElementById('quickFilter').disabled = !state.currentItem;
      document.getElementById('openAllBtn').classList.toggle('disabled-cover', !state.currentItem);
    }
    function updateLiveCount(v){ document.getElementById('liveCount').textContent = (v==null?'â€”':v); }
    function showPlaceholder(flag){
      document.getElementById('placeholder').classList.toggle('d-none', !flag);
      document.getElementById('results').classList.toggle('d-none', flag);
      document.getElementById('noData').classList.add('d-none');
    }
    function showNoData(){ document.getElementById('placeholder').classList.add('d-none'); document.getElementById('results').classList.add('d-none'); document.getElementById('noData').classList.remove('d-none'); }
    function showResults(){ document.getElementById('placeholder').classList.add('d-none'); document.getElementById('noData').classList.add('d-none'); document.getElementById('results').classList.remove('d-none'); }

    /* ====== ÙØªØ­ Ø§Ù„Ø±ÙˆØ§Ø¨Ø· Ø­Ø³Ø¨ Ø§Ù„ØªÙØ¶ÙŠÙ„ ====== */
    function openLink(url){
      if(!url) return;
      const mode = state.openMode;
      if(mode==='popup'){
        const w = window.open(url, 'cmtsPopup', 'width=1100,height=700,noopener,noreferrer');
        if(!w) alert('ÙŠØ¨Ø¯Ùˆ Ø£Ù† Ø§Ù„Ù…ØªØµÙØ­ Ù…Ù†Ø¹ Ø§Ù„Ù†Ø§ÙØ°Ø© Ø§Ù„Ù…Ù†Ø¨Ø«Ù‚Ø©. Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø§Ù„Ø³Ù…Ø§Ø­ Ù…Ø¤Ù‚ØªÙ‹Ø§.');
      }else{
        window.open(url, '_blank', 'noopener,noreferrer');
      }
    }
    function copyLink(url){
      navigator.clipboard.writeText(url).then(()=>{
        document.querySelector('#toastSuccess .toast-body').textContent='ğŸ”— ØªÙ… Ù†Ø³Ø® Ø§Ù„Ø±Ø§Ø¨Ø·';
        toastOk.show();
      }).catch(()=>{ toastError.show(); });
    }

    /* ====== Ø¹Ø±Ø¶ Ø§Ù„ÙƒØ±ÙˆØª ====== */
    function clearSections(){
      ['coreSection','invSection','minSection','covSection','repSection'].forEach(id=>document.getElementById(id).innerHTML='');
      ['badgeInv','badgeMin','badgeCov'].forEach(id=>document.getElementById(id).textContent='0');
    }

    function renderUrlRow(container,{title,value}, fallbackTitle){
      const row=document.createElement('div');
      row.className='link-row';
      const safeTitle = (title && title.trim()) ? title.trim() : fallbackTitle;
      row.innerHTML = `
        <div class="d-flex align-items-center gap-2 flex-grow-1">
          <i class="bi bi-link-45deg"></i>
          <div class="link-title"><b>${safeTitle}</b><div class="small text-muted">${value}</div></div>
        </div>
        <div class="d-flex align-items-center gap-1">
          <button class="btn btn-outline-primary btn-sm" data-act="open"><i class="bi bi-box-arrow-up-right"></i> ÙØªØ­</button>
          <button class="btn btn-outline-secondary btn-sm" data-act="copy"><i class="bi bi-clipboard"></i></button>
        </div>
      `;
      row.querySelector('[data-act="open"]').addEventListener('click',()=>openLink(value));
      row.querySelector('[data-act="copy"]').addEventListener('click',()=>copyLink(value));
      container.appendChild(row);
    }

    function applyQuickFilter(){
      const q = document.getElementById('quickFilter').value.trim();
      const rx = q ? new RegExp(q.replace(/[.*+?^${}()|[\\]\\\\]/g,'\\\\$&'),'i') : null;

      ['invSection','minSection','covSection','coreSection','repSection'].forEach(id=>{
        const box = document.getElementById(id);
        Array.from(box.children).forEach(row=>{
          if(!rx){ row.style.display=''; return; }
          const text = row.textContent || '';
          row.style.display = rx.test(text) ? '' : 'none';
        });
      });
    }

    function renderItem(item){
      clearSections();
      if(!item){ showNoData(); return; }

      // Core
      const coreBox=document.getElementById('coreSection');
      if(item.formation_decision?.value) renderUrlRow(coreBox, item.formation_decision, 'Ù‚Ø±Ø§Ø± Ø§Ù„ØªØ´ÙƒÙŠÙ„');
      if(item.work_plan?.value)         renderUrlRow(coreBox, item.work_plan, 'Ø®Ø·Ø© Ø§Ù„Ø¹Ù…Ù„');
      if(coreBox.children.length===0){ coreBox.innerHTML='<div class="empty-hint">Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ø³ØªÙ†Ø¯Ø§Øª Ø£Ø³Ø§Ø³ÙŠØ© Ù…Ø­ÙÙˆØ¸Ø©</div>'; }

      // Invitations
      const invBox=document.getElementById('invSection');
      (item.invitations||[]).forEach((x,i)=> renderUrlRow(invBox,x,`Ø¯Ø¹ÙˆØ© #${i+1}`));
      document.getElementById('badgeInv').textContent = (item.invitations||[]).length;
      if((item.invitations||[]).length===0){ invBox.innerHTML='<div class="empty-hint">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¯Ø¹ÙˆØ§Øª Ù…Ø­ÙÙˆØ¸Ø©</div>'; }

      // Minutes
      const minBox=document.getElementById('minSection');
      (item.minutes||[]).forEach((x,i)=> renderUrlRow(minBox,x,`Ù…Ø­Ø¶Ø± #${i+1}`));
      document.getElementById('badgeMin').textContent = (item.minutes||[]).length;
      if((item.minutes||[]).length===0){ minBox.innerHTML='<div class="empty-hint">Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ø­Ø§Ø¶Ø± Ù…Ø­ÙÙˆØ¸Ø©</div>'; }

      // Coverage
      const covBox=document.getElementById('covSection');
      (item.coverage_letters||[]).forEach((x,i)=> renderUrlRow(covBox,x,`ÙƒØªØ§Ø¨ ØªØºØ·ÙŠØ© #${i+1}`));
      document.getElementById('badgeCov').textContent = (item.coverage_letters||[]).length;
      if((item.coverage_letters||[]).length===0){ covBox.innerHTML='<div class="empty-hint">Ù„Ø§ ØªÙˆØ¬Ø¯ ÙƒØªØ¨ ØªØºØ·ÙŠØ© Ù…Ø­ÙÙˆØ¸Ø©</div>'; }

      // Reports & SA
      const repBox=document.getElementById('repSection');
      if(item.report1?.value) renderUrlRow(repBox, item.report1, 'ØªÙ‚Ø±ÙŠØ± Ø¥Ù†Ø¬Ø§Ø² 1');
      if(item.report2?.value) renderUrlRow(repBox, item.report2, 'ØªÙ‚Ø±ÙŠØ± Ø¥Ù†Ø¬Ø§Ø² 2');
      if(item.report3?.value) renderUrlRow(repBox, item.report3, 'ØªÙ‚Ø±ÙŠØ± Ø¥Ù†Ø¬Ø§Ø² 3');
      if(item.statistical_analysis?.value) renderUrlRow(repBox, item.statistical_analysis, 'Ø§Ù„ØªØ­Ù„ÙŠÙ„ Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠ');
      if(repBox.children.length===0){ repBox.innerHTML='<div class="empty-hint">Ù„Ø§ ØªÙˆØ¬Ø¯ ØªÙ‚Ø§Ø±ÙŠØ± Ø£Ùˆ ØªØ­Ù„ÙŠÙ„ Ø¥Ø­ØµØ§Ø¦ÙŠ Ù…Ø­ÙÙˆØ¸</div>'; }

      showResults();
      enableApplyIfReady();
      applyQuickFilter();
    }

    /* ====== Ø¬Ù„Ø¨ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª ====== */
    function normalizeName(item){ if(typeof item==='string') return item; return item?.name||item?.committee_name||item?.college||''; }

    async function loadColleges(){
      try{
        const r=await apiFetch('/api/colleges');
        const js=await r.json().catch(()=>[]);
        const sel=document.getElementById('collegeSelect');
        sel.innerHTML='<option value="">â€” Ø§Ø®ØªØ± Ø§Ù„ÙƒÙ„ÙŠØ© â€”</option>';
        (js||[]).forEach(c=>{
          const n=normalizeName(c); if(!n) return;
          const o=document.createElement('option'); o.value=o.textContent=n; sel.appendChild(o);
        });
      }catch{}
    }

    // Ø§Ø¬Ù„Ø¨ DISTINCT committees Ù„ÙƒÙ„ÙŠØ© Ù…Ø­Ø¯Ø¯Ø© Ø¹Ø¨Ø± ØªÙ…Ø´ÙŠØ· ØµÙØ­Ø§Øª committees-files
    async function fetchDistinctCommitteesByCollege(college){
      const set=new Set();
      let page=1, limit=50, guard=0;
      do{
        const r=await apiFetch(`/api/committees-files?college=${encodeURIComponent(college)}&page=${page}&limit=${limit}`);
        const j=await r.json().catch(()=>({data:[],meta:{hasMore:false}}));
        (j.data||[]).forEach(x=>{ if(x.committee_name) set.add(x.committee_name); });
        page++; guard++; if(guard>50) break; // Ø­Ø¯ Ø£Ù…Ø§Ù†
        if(!j.meta?.hasMore) break;
      }while(true);
      return Array.from(set).sort((a,b)=>a.localeCompare(b,'ar',{sensitivity:'base'}));
    }

    // Ø§Ø¬Ù„Ø¨ DISTINCT terms Ù„ÙƒÙ„ÙŠØ© + Ø¹Ø§Ù… Ù…Ø­Ø¯Ø¯ÙŠÙ†
    async function fetchDistinctTerms(college, academicYear){
      const set=new Set();
      let page=1, limit=50, guard=0;
      do{
        const r=await apiFetch(`/api/committees-files?college=${encodeURIComponent(college)}&academicYear=${encodeURIComponent(academicYear)}&page=${page}&limit=${limit}`);
        const j=await r.json().catch(()=>({data:[],meta:{hasMore:false}}));
        (j.data||[]).forEach(x=>{ if(x.term) set.add(x.term); });
        page++; guard++; if(guard>50) break;
        if(!j.meta?.hasMore) break;
      }while(true);
      const arr = Array.from(set);
      // ØªØ±ØªÙŠØ¨ Ø«Ø§Ø¨Øª Ù„Ù„ÙØµÙˆÙ„ Ø¥Ù† ÙˆÙØ¬Ø¯Øª
      const order = {'Ø§Ù„ÙØµÙ„ Ø§Ù„Ø£ÙˆÙ„':1,'Ø§Ù„ÙØµÙ„ Ø§Ù„Ø«Ø§Ù†ÙŠ':2,'Ø§Ù„ÙØµÙ„ Ø§Ù„ØµÙŠÙÙŠ':3};
      arr.sort((a,b)=>(order[a]||9)-(order[b]||9));
      return arr;
    }

    async function countForFilters(){
      const {college,academicYear,term,committee_name}=state.filters;
      // Ø¹Ø¯Ù‘Ø§Ø¯ ØªÙ‚Ø±ÙŠØ¨ÙŠ: Ù†Ø³ØªØ¹Ù„Ù… Ø¨Ù†ÙØ³ Ø§Ù„ÙÙ„Ø§ØªØ± Ù„ÙƒÙ† Ù†Ø·Ù„Ø¨ 1 Ø¹Ù†ØµØ± ÙÙ‚Ø· ÙˆÙ†Ù‚Ø±Ø£ total
      const r=await apiFetch(`/api/committees-files?college=${encodeURIComponent(college||'')}&academicYear=${encodeURIComponent(academicYear||'')}&term=${encodeURIComponent(term||'')}&committee_name=${encodeURIComponent(committee_name||'')}&page=1&limit=1`);
      const j=await r.json().catch(()=>({meta:{total:0}}));
      updateLiveCount(j.meta?.total ?? 0);
    }

    async function fetchSingleItem(){
      const {college,academicYear,term,committee_name}=state.filters;
      showPlaceholder(true);
      try{
        const r=await apiFetch(`/api/committees-files?college=${encodeURIComponent(college)}&committee_name=${encodeURIComponent(committee_name)}&academicYear=${encodeURIComponent(academicYear)}&term=${encodeURIComponent(term)}&page=1&limit=1`);
        const j=await r.json();
        const item=(j.data&&j.data[0])||null;
        state.currentItem=item;
        renderItem(item);
        if(!item){ showNoData(); }
      }catch(e){
        state.currentItem=null; showNoData(); toastError.show();
      }
    }

    /* ====== ØªÙ‡ÙŠØ¦Ø© ÙˆØªØ­ÙƒÙ… Ø§Ù„Ù…Ø±Ø´Ù‘Ø­Ø§Øª ====== */
    function persistFilters(){
      localStorage.setItem('cmts.view.filters', JSON.stringify(state.filters));
      // Ø­Ø¯Ù‘Ø« Ø§Ù„Ø¹Ù†ÙˆØ§Ù† Ù„Ø³Ù‡ÙˆÙ„Ø© Ø§Ù„Ù…Ø´Ø§Ø±ÙƒØ©
      const p=new URLSearchParams(state.filters).toString();
      const url=`${location.pathname}?${p}`;
      history.replaceState({},'',url);
    }
    function restoreFilters(){
      const fromUrl = Object.fromEntries((new URLSearchParams(location.search)).entries());
      const fromLS = JSON.parse(localStorage.getItem('cmts.view.filters')||'{}');
      const base = {college:'',academicYear:'',term:'',committee_name:''};
      state.filters = Object.assign(base, fromLS, fromUrl);
    }
    function hydrateFilterControls(){
      document.getElementById('collegeSelect').value = state.filters.college||'';
      document.getElementById('academicYearInput').value = state.filters.academicYear||'';
      // Ø¨Ø§Ù‚ÙŠ Ø§Ù„Ø¹Ù†Ø§ØµØ± ØªÙÙØ¹Ù‘Ù„ Ù„Ø§Ø­Ù‚Ù‹Ø§ Ø¨Ø¹Ø¯ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù‚ÙˆØ§Ø¦Ù…
    }
    function setUserInfo(u){
      const username=u?.username||(u?.email?u.email.split('@')[0]:'â€”');
      document.getElementById('userUsername').textContent=username;
      document.getElementById('userFullName').textContent=u?.name||'â€”';
      document.getElementById('userRole').textContent=u?.role||'â€”';
    }

    function toggleTermSelect(enabled, options=[]){
      const sel=document.getElementById('termSelect');
      sel.disabled=!enabled;
      sel.innerHTML='<option value="">â€” Ø§Ø®ØªØ± Ø§Ù„ÙØµÙ„ â€”</option>';
      options.forEach(t=>{
        const o=document.createElement('option'); o.value=o.textContent=t; sel.appendChild(o);
      });
      document.getElementById('termHint').textContent = enabled ? 'Ø§Ø®ØªØ± Ø§Ù„ÙØµÙ„ Ø§Ù„Ø¯Ø±Ø§Ø³ÙŠ' : 'Ø§Ø®ØªØ± Ø§Ù„Ø¹Ø§Ù… Ù„Ø¹Ø±Ø¶ Ø§Ù„ÙØµÙˆÙ„ Ø§Ù„Ù…ØªØ§Ø­Ø©';
    }

    function toggleCommitteeSelect(enabled, options=[]){
      const sel=document.getElementById('committeeSelect');
      sel.disabled=!enabled;
      sel.innerHTML='<option value="">â€” Ø§Ø®ØªØ± Ø§Ù„Ù„Ø¬Ù†Ø© â€”</option>';
      options.forEach(n=>{
        const o=document.createElement('option'); o.value=o.textContent=n; sel.appendChild(o);
      });
      document.getElementById('committeeHint').textContent = enabled ? 'Ø§Ø®ØªØ± Ø§Ù„Ù„Ø¬Ù†Ø©' : 'Ø§Ø®ØªØ± Ø§Ù„ÙƒÙ„ÙŠØ© Ù„Ø¹Ø±Ø¶ Ù„Ø¬Ø§Ù†Ù‡Ø§';
    }

    /* ====== Ø£Ø­Ø¯Ø§Ø« Ø§Ù„ÙˆØ§Ø¬Ù‡Ø© ====== */
    document.getElementById('homeBtn').href=go('/committees-home.html');
    document.getElementById('logoutBtn').addEventListener('click', async ()=>{
      try{
        const r=await apiFetch('/auth/committees/logout',{method:'POST',headers:{'Content-Type':'application/json'}});
        if(r.ok){ toastOk.show(); setTimeout(()=>location.href=go('/committees-login.html'),600); }
        else toastError.show();
      }catch{ toastError.show(); }
    });

    document.getElementById('collegeSelect').addEventListener('change', async (e)=>{
      state.filters.college=e.target.value;
      state.filters.committee_name=''; // Ø¥Ø¹Ø§Ø¯Ø© Ø¶Ø¨Ø·
      setSummaryChip(); persistFilters(); enableApplyIfReady(); updateLiveCount(null);

      // Ø­Ù…Ù‘Ù„ Ù„Ø¬Ø§Ù† Ø§Ù„ÙƒÙ„ÙŠØ©
      if(state.filters.college){
        toggleCommitteeSelect(true, []);
        const committees = await fetchDistinctCommitteesByCollege(state.filters.college);
        state.listsCache.committees=committees;
        toggleCommitteeSelect(true, committees);
        // Ø¥Ù† ÙƒØ§Ù† Ø¹Ù†Ø¯Ù†Ø§ Ù‚ÙŠÙ…Ø© Ù…Ø­ÙÙˆØ¸Ø© Ù‚Ø¯ÙŠÙ…Ø©
        if(committees.includes(state.filters.committee_name)){
          document.getElementById('committeeSelect').value = state.filters.committee_name;
        }
      }else{
        toggleCommitteeSelect(false, []);
      }
      await countForFilters();
    });

    // Ø§Ù„Ø¹Ø§Ù… â†’ ØªÙ…ÙƒÙŠÙ† Ø§Ù„ÙØµÙ„ Ø¨Ù†Ø§Ø¡Ù‹ Ø¹Ù„Ù‰ Ø§Ù„Ù…ØªØ§Ø­
    const ayInput=document.getElementById('academicYearInput');
    let ayDebounce=null;
    ayInput.addEventListener('input', ()=>{
      if(ayDebounce) clearTimeout(ayDebounce);
      ayDebounce=setTimeout(async ()=>{
        const v=ayInput.value.trim();
        state.filters.academicYear = validateAcademicYear(v) ? v : '';
        if(!state.filters.academicYear){ ayInput.classList.add('is-invalid'); }
        else ayInput.classList.remove('is-invalid');

        state.filters.term=''; setSummaryChip(); persistFilters(); enableApplyIfReady(); updateLiveCount(null);

        if(state.filters.college && state.filters.academicYear){
          const terms = await fetchDistinctTerms(state.filters.college, state.filters.academicYear);
          state.listsCache.terms=terms;
          toggleTermSelect(true, terms);
        }else{
          toggleTermSelect(false, []);
        }
        await countForFilters();
      }, 300);
    });

    document.getElementById('termSelect').addEventListener('change', async (e)=>{
      state.filters.term=e.target.value;
      setSummaryChip(); persistFilters(); enableApplyIfReady();
      await countForFilters();
    });

    document.getElementById('committeeSelect').addEventListener('change', async (e)=>{
      state.filters.committee_name=e.target.value;
      setSummaryChip(); persistFilters(); enableApplyIfReady();
      await countForFilters();
    });

    document.getElementById('applyBtn').addEventListener('click', async ()=>{
      if(!(state.filters.college && state.filters.academicYear && state.filters.term && state.filters.committee_name)){
        document.querySelector('#toastInfo .toast-body').textContent='Ø£ÙƒÙ…Ù„ Ø§Ù„Ù…Ø±Ø´Ù‘Ø­Ø§Øª Ø£ÙˆÙ„Ù‹Ø§';
        toastInfo.show(); return;
      }
      await fetchSingleItem();
    });

    document.getElementById('resetFiltersBtn').addEventListener('click', ()=>{
      state.filters={college:'',academicYear:'',term:'',committee_name:''};
      persistFilters();
      document.getElementById('collegeSelect').value='';
      document.getElementById('academicYearInput').value='';
      toggleTermSelect(false, []);
      toggleCommitteeSelect(false, []);
      setSummaryChip();
      enableApplyIfReady();
      showPlaceholder(true);
      updateLiveCount(null);
      state.currentItem=null;
      document.getElementById('quickFilter').value='';
    });

    document.getElementById('quickFilter').addEventListener('input', ()=>{
      applyQuickFilter();
    });

    document.getElementsByName('openMode').forEach(r=>{
      r.addEventListener('change', (e)=>{
        state.openMode=e.target.value;
        localStorage.setItem('cmts.openMode', state.openMode);
        document.querySelector('#toastSuccess .toast-body').textContent='ØªÙ… Ø­ÙØ¸ ØªÙØ¶ÙŠÙ„ ÙØªØ­ Ø§Ù„Ø±ÙˆØ§Ø¨Ø·';
        toastOk.show();
      });
    });

    document.getElementById('openAllBtn').addEventListener('click', ()=>{
      if(!state.currentItem) return;
      const groups = [
        ...(state.currentItem.invitations||[]),
        ...(state.currentItem.minutes||[]),
        ...(state.currentItem.coverage_letters||[])
      ];
      const singles = [
        state.currentItem.formation_decision,
        state.currentItem.work_plan,
        state.currentItem.report1,
        state.currentItem.report2,
        state.currentItem.report3,
        state.currentItem.statistical_analysis
      ].filter(Boolean);

      const all = [
        ...singles.map(x=>x.value),
        ...groups.filter(x=>x?.value).map(x=>x.value)
      ].slice(0,20); // Ø­Ø¯ Ù…Ø¹Ù‚ÙˆÙ„ Ù„ØªØ¬Ù†Ø¨ Ø­Ø¸Ø± Ø§Ù„Ù†ÙˆØ§ÙØ°

      if(all.length===0){
        document.querySelector('#toastInfo .toast-body').textContent='Ù„Ø§ ØªÙˆØ¬Ø¯ Ø±ÙˆØ§Ø¨Ø· Ù„ÙØªØ­Ù‡Ø§';
        toastInfo.show(); return;
      }
      // ØªØ­Ø°ÙŠØ± Ø¨Ø³ÙŠØ·
      if(state.openMode==='popup'){
        alert('Ù‚Ø¯ ÙŠÙ…Ù†Ø¹ Ø§Ù„Ù…ØªØµÙØ­ ÙØªØ­ Ø¹Ø¯Ø© Ù†ÙˆØ§ÙØ° Ù…Ù†Ø¨Ø«Ù‚Ø© Ø¯ÙØ¹Ø© ÙˆØ§Ø­Ø¯Ø©. Ø¥Ù† Ù„Ù… ØªÙÙØªØ­ØŒ Ø¨Ø¯Ù‘Ù„ Ø¥Ù„Ù‰ "ØªØ¨ÙˆÙŠØ¨ Ø¬Ø¯ÙŠØ¯".');
      }
      all.forEach(u=>openLink(u));
    });

    /* ====== Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„ØµÙ„Ø§Ø­ÙŠØ§Øª ====== */
    async function ensureAuth(){
      const r=await apiFetch('/auth/committees/me');
      const j=await r.json();
      if(!j?.authenticated){
        location.href=go('/committees-login.html?next='+encodeURIComponent('/committees-files-view.html')); throw 0;
      }
      // Ù…Ø³Ù…ÙˆØ­ ÙÙ‚Ø· user Ùˆ admin
      const role = j.user?.role;
      if(role!=='admin' && role!=='user'){
        alert('ğŸš« Ù„Ø§ ØªÙ…Ù„Ùƒ ØµÙ„Ø§Ø­ÙŠØ© Ø¹Ø±Ø¶ Ù‡Ø°Ù‡ Ø§Ù„ØµÙØ­Ø© (Ù…Ø³Ù…ÙˆØ­ ÙÙ‚Ø·: admin Ùˆ user). Ø³ÙŠØªÙ… ØªØ­ÙˆÙŠÙ„Ùƒ Ù„Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ….');
        location.href=go('/committees-home.html'); throw 0;
      }
      state.user=j.user; setUserInfo(j.user);
    }

    /* ====== Ø¨Ø¯Ø¡ Ø§Ù„ØªØ´ØºÙŠÙ„ ====== */
    (async function init(){
      document.getElementById('homeBtn').href=go('/committees-home.html');

      // ÙˆØ¶Ø¹ Ø§Ù„ØªÙØ¶ÙŠÙ„
      if(state.openMode==='popup') document.getElementById('modePopup').checked=true;
      else document.getElementById('modeTab').checked=true;

      try{
        await ensureAuth();
        await loadColleges();
        restoreFilters();
        hydrateFilterControls();
        setSummaryChip();

        // Ø­Ù…Ù‘Ù„ Ù‚ÙˆØ§Ø¦Ù… Ù…ØªÙ‚Ø¯Ù…Ø© (Ø¥Ù† ÙƒØ§Ù†Øª Ø§Ù„Ù…Ø±Ø´Ù‘Ø­Ø§Øª Ù…Ø­ÙÙˆØ¸Ø©)
        if(state.filters.college){
          const committees = await fetchDistinctCommitteesByCollege(state.filters.college);
          state.listsCache.committees=committees;
          toggleCommitteeSelect(true, committees);
          if(state.filters.committee_name && committees.includes(state.filters.committee_name)){
            document.getElementById('committeeSelect').value=state.filters.committee_name;
          }
        }else{
          toggleCommitteeSelect(false, []);
        }

        if(state.filters.college && state.filters.academicYear && validateAcademicYear(state.filters.academicYear)){
          document.getElementById('academicYearInput').classList.remove('is-invalid');
          const terms = await fetchDistinctTerms(state.filters.college, state.filters.academicYear);
          state.listsCache.terms=terms;
          toggleTermSelect(true, terms);
          if(state.filters.term && terms.includes(state.filters.term)){
            document.getElementById('termSelect').value=state.filters.term;
          }
        }else{
          toggleTermSelect(false, []);
        }

        enableApplyIfReady();
        await countForFilters();

        // Ù„Ùˆ ÙƒÙ„ Ø§Ù„Ù…Ø±Ø´Ù‘Ø­Ø§Øª Ù…ÙƒØªÙ…Ù„Ø© Ø¨Ø¹Ø¯ Ø§Ù„Ø§Ø³ØªØ±Ø¬Ø§Ø¹ØŒ Ø§Ø¹Ø±Ø¶ Ù…Ø¨Ø§Ø´Ø±Ø©
        if(state.filters.college && state.filters.academicYear && state.filters.term && state.filters.committee_name){
          await fetchSingleItem();
        }else{
          showPlaceholder(true);
        }
      }catch(e){}
    })();
  </script>
</body>
</html>
