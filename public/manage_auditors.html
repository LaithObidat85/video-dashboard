<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <title>Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ø¯Ù‚Ù‚ÙŠÙ† - Ù†Ø¸Ø§Ù… Ø§Ù„Ù„Ø¬Ø§Ù†</title>
  <link rel="icon" type="image/png" href="https://www.dropbox.com/scl/fi/f283e4rvv5cf9x12a1cic/my-website-logo.png?rlkey=yia776im7klypy27af32m0scy&e=1&st=vhaprvzh&dl=1">
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.rtl.min.css">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css">
  <style>
    body{background:#f8f9fa;font-family:'Segoe UI',sans-serif}
    .container{max-width:1000px;margin-top:40px}
    .card{border-radius:16px;box-shadow:0 6px 18px rgba(0,0,0,.06)}

    /* Ø´Ø§Ø±Ø© Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… */
    .user-chip{
      display:inline-flex;align-items:center;gap:.25rem;
      font-size:1rem!important;padding:.375rem .75rem!important;
      line-height:1.5!important;border-radius:.375rem;font-weight:700!important;
    }
    .user-chip.badge #userRole{font-weight:500!important;}

    /* Ø³ÙƒÙ„ØªÙˆÙ† */
    .skeleton{position:relative;overflow:hidden;background:linear-gradient(90deg,#eee 25%,#f5f5f5 37%,#eee 63%);background-size:400% 100%;animation:shimmer 1.2s infinite}
    @keyframes shimmer{0%{background-position:100% 0}100%{background-position:-100% 0}}

    /* ØªÙˆØ³Øª ØªØ£ÙƒÙŠØ¯ */
    .toast-container{z-index:2000}
    .row-highlight{animation:flash .8s ease}
    @keyframes flash{0%{background:#fff3cd}100%{background:transparent}}

    /* Ø¬Ø¯ÙˆÙ„ Ø«Ø§Ø¨Øª Ø§Ù„Ø±Ø£Ø³ */
    .table-responsive{max-height:520px;overflow:auto}
    thead th{position:sticky;top:0;background:#fff;z-index:1}

    /* Ø¨Ø·Ø§Ù‚Ø§Øª Ø§Ù„Ø¥Ø­ØµØ§Ø¡Ø§Øª */
    .stat-card{border-radius:14px;border:1px solid #e9ecef;background:#fff;padding:14px 16px}
    .stat-label{color:#6c757d;font-size:.9rem}
    .stat-value{font-weight:700;font-size:1.25rem}
    .stat-sub{color:#6c757d;font-size:.85rem}
  </style>
</head>
<body>
  <div class="container">
    <!-- Header -->
    <div class="d-flex flex-wrap justify-content-between align-items-center mb-4 gap-2">
      <div class="d-flex align-items-center gap-2">
        <h3 class="mb-0">Ø¥Ø¯Ø§Ø±Ø© Ø£Ø³Ù…Ø§Ø¡ Ø§Ù„Ù…Ø¯Ù‚Ù‚ÙŠÙ†</h3>
      </div>
      <div class="d-flex align-items-center gap-2">
        <span id="userInfo" class="user-chip badge bg-light text-dark border">
          <i class="bi bi-person"></i>
          <span id="userUsername">â€”</span>
          <span class="mx-1">â€”</span>
          <span id="userFullName">â€”</span>
          <span class="ms-2 badge bg-secondary" id="userRole">â€”</span>
        </span>
        <a class="btn btn-outline-primary" id="homeBtn" href="/committees-home.html">
          <i class="bi bi-grid"></i> Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ…
        </a>
        <button id="logoutBtn" class="btn btn-danger">
          <i class="bi bi-box-arrow-right"></i> Ø®Ø±ÙˆØ¬
        </button>
      </div>
    </div>

    <!-- Ø¥Ø­ØµØ§Ø¡Ø§Øª ØµØºÙŠØ±Ø© -->
    <div class="mb-3">
      <div class="row g-3">
        <div class="col-md-4">
          <div class="stat-card">
            <div class="stat-label">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…Ø¯Ù‚Ù‚ÙŠÙ†</div>
            <div class="stat-value" id="statTotal">
              <span class="skeleton" style="display:inline-block;width:60px;height:20px;border-radius:6px;"></span>
            </div>
            <div class="stat-sub">Ø§Ù„Ù…Ø¹Ø±ÙˆØ¶Ø© Ø¶Ù…Ù† Ø§Ù„Ù†Ø¸Ø§Ù…</div>
          </div>
        </div>
        <div class="col-md-8">
          <div class="stat-card">
            <div class="stat-label">Ø¢Ø®Ø± ØªØºÙŠÙŠØ± Ø¹Ù„Ù‰ Ø£Ø³Ù…Ø§Ø¡ Ø§Ù„Ù…Ø¯Ù‚Ù‚ÙŠÙ†</div>
            <div class="stat-value" id="statLastChange">
              <span class="skeleton" style="display:inline-block;width:200px;height:20px;border-radius:6px;"></span>
            </div>
            <div class="stat-sub" id="statLastChangeSub">â€”</div>
          </div>
        </div>
      </div>
    </div>

    <!-- Ø¥Ø¶Ø§ÙØ© Ù…Ø¯Ù‚Ù‚ (Ù‚Ø§Ø¨Ù„Ø© Ù„Ù„Ø·ÙŠ) -->
    <div class="card mb-4">
      <div class="card-header p-0">
        <button
          type="button"
          class="btn btn-link w-100 text-start p-3 d-flex justify-content-between align-items-center"
          data-bs-toggle="collapse" data-bs-target="#addCollapse"
          aria-expanded="false" aria-controls="addCollapse"
        >
          <span class="fw-semibold">Ø¥Ø¶Ø§ÙØ© Ù…Ø¯Ù‚Ù‚ Ø¬Ø¯ÙŠØ¯</span>
          <i class="bi bi-plus-lg" id="addToggleIcon"></i>
        </button>
      </div>
      <div id="addCollapse" class="collapse">
        <div class="card-body">
          <form id="addForm" class="row g-3">
            <div class="col-md-9">
              <label class="form-label">Ø§Ø³Ù… Ø§Ù„Ù…Ø¯Ù‚Ù‚</label>
              <input type="text" class="form-control" name="name" id="auditorName" placeholder="Ø£Ø¯Ø®Ù„ Ø§Ø³Ù… Ø§Ù„Ù…Ø¯Ù‚Ù‚" required>
              <div id="dupHint" class="form-text text-danger"></div>
            </div>
            <div class="col-md-3 d-flex align-items-end">
              <button class="btn btn-primary w-100" id="addBtn">
                <i class="bi bi-check2-circle"></i> Ø¥Ø¶Ø§ÙØ©
              </button>
            </div>
          </form>
        </div>
      </div>
    </div>

    <!-- Ø£Ø¯ÙˆØ§Øª Ø£Ø¹Ù„Ù‰ Ø§Ù„Ø¬Ø¯ÙˆÙ„ -->
    <div class="card mb-3">
      <div class="card-body d-flex flex-wrap align-items-end" style="gap:.5rem;">
        <div>
          <label class="form-label">Ø¨Ø­Ø«</label>
          <input type="text" id="q" class="form-control" placeholder="Ø§Ø¨Ø­Ø« Ø¨Ø§Ù„Ø§Ø³Ù…">
        </div>
        <div>
          <label class="form-label">Ø§Ù„ØªØ±ØªÙŠØ¨</label>
          <select id="sort" class="form-select">
            <option value="name">Ø§Ù„Ø§Ø³Ù… (Ø£-ÙŠ)</option>
            <option value="-name">Ø§Ù„Ø§Ø³Ù… (ÙŠ-Ø£)</option>
          </select>
        </div>
        <div>
          <label class="form-label">Ù„ÙƒÙ„ ØµÙØ­Ø©</label>
          <select id="limit" class="form-select">
            <option>10</option><option selected>20</option><option>50</option>
          </select>
        </div>
        <div class="ms-auto d-flex gap-2">
          <button class="btn btn-outline-secondary" id="btnExport"><i class="bi bi-filetype-csv"></i> ØªØµØ¯ÙŠØ± CSV</button>
          <button class="btn btn-outline-secondary" id="btnReload"><i class="bi bi-arrow-repeat"></i> ØªØ­Ø¯ÙŠØ«</button>
        </div>
      </div>
    </div>

    <!-- Ø§Ù„Ø¬Ø¯ÙˆÙ„ -->
    <div class="card">
      <div class="card-body">
        <div class="table-responsive">
          <table class="table table-hover align-middle">
            <thead class="table-light">
              <tr>
                <th style="width:64px">#</th>
                <th>Ø§Ø³Ù… Ø§Ù„Ù…Ø¯Ù‚Ù‚</th>
                <th style="width:160px">Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª</th>
              </tr>
            </thead>
            <tbody id="auditorsTbody">
              <tr><td colspan="3">
                <div class="skeleton" style="height:18px;margin:8px 0;"></div>
                <div class="skeleton" style="height:18px;margin:8px 0;"></div>
                <div class="skeleton" style="height:18px;margin:8px 0;"></div>
              </td></tr>
            </tbody>
          </table>
        </div>

        <div class="d-flex justify-content-between align-items-center mt-3">
          <div class="text-muted">Ø§Ù„ØµÙØ­Ø© <span id="pageNum">1</span></div>
          <div class="btn-group">
            <button class="btn btn-outline-secondary btn-sm" id="prevPage"><i class="bi bi-chevron-right"></i> Ø§Ù„Ø³Ø§Ø¨Ù‚</button>
            <button class="btn btn-outline-secondary btn-sm" id="nextPage">Ø§Ù„ØªØ§Ù„ÙŠ <i class="bi bi-chevron-left"></i></button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Toasts -->
  <div class="toast-container position-fixed top-0 start-50 translate-middle-x p-3">
    <div id="toastSuccess" class="toast align-items-center text-bg-success border-0 mb-2" role="alert" aria-live="assertive" aria-atomic="true">
      <div class="d-flex">
        <div class="toast-body">âœ… ØªÙ… Ø§Ù„ØªÙ†ÙÙŠØ° Ø¨Ù†Ø¬Ø§Ø­</div>
        <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button>
      </div>
    </div>
    <div id="toastError" class="toast align-items-center text-bg-danger border-0 mb-2" role="alert" aria-live="assertive" aria-atomic="true">
      <div class="d-flex">
        <div class="toast-body">âŒ Ø­Ø¯Ø« Ø®Ø·Ø£</div>
        <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button>
      </div>
    </div>
    <div id="toastInfo" class="toast align-items-center text-bg-primary border-0 mb-2" role="status" aria-live="polite">
      <div class="d-flex">
        <div class="toast-body">â„¹ï¸ Ù…Ø¹Ù„ÙˆÙ…Ø§Øª</div>
        <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button>
      </div>
    </div>

    <!-- Toast: ØªØ£ÙƒÙŠØ¯ -->
    <div id="toastConfirm" class="toast text-bg-warning border-0 mb-2" role="alert" aria-live="assertive" aria-atomic="true">
      <div class="d-flex align-items-start">
        <div class="toast-body">
          <div id="toastConfirmMsg">Ù‡Ù„ ØªØ±ÙŠØ¯ Ø§Ù„Ù…ØªØ§Ø¨Ø¹Ø©ØŸ</div>
          <div class="mt-2 pt-2 border-top d-flex gap-2">
            <button type="button" class="btn btn-danger btn-sm" id="toastConfirmYes">ØªØ£ÙƒÙŠØ¯</button>
            <button type="button" class="btn btn-light btn-sm" id="toastConfirmNo" data-bs-dismiss="toast">Ø¥Ù„ØºØ§Ø¡</button>
          </div>
        </div>
        <button type="button" class="btn-close btn-close-white m-2" data-bs-dismiss="toast"></button>
      </div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  <script>
    /* ===== Ø£Ø³Ø§Ø³ Ø§Ù„Ø¨ÙŠØ¦Ø© ===== */
    const RENDER_BASE = 'https://vdash-qkyv.onrender.com';
    const host = location.hostname;
    const isGithub = host.endsWith('github.io');
    const isLocal  = host === 'localhost' || host === '127.0.0.1';
    const API_BASE = isGithub ? RENDER_BASE : (isLocal ? 'http://localhost:3000' : '');
    const go = (path) => isGithub ? (RENDER_BASE + path) : path;

    /* ===== Toasts ===== */
    const TSuccess = new bootstrap.Toast(document.getElementById('toastSuccess'));
    const TError   = new bootstrap.Toast(document.getElementById('toastError'));
    const TInfo    = new bootstrap.Toast(document.getElementById('toastInfo'));
    const TConfirmEl = document.getElementById('toastConfirm');
    const TConfirm  = new bootstrap.Toast(TConfirmEl, { autohide:false });
    const setToast = (el,msg)=>{ el._element.querySelector('.toast-body').innerText = msg; };
    const showSuccess = (m)=>{ setToast(TSuccess,m); TSuccess.show(); };
    const showError   = (m)=>{ setToast(TError,m);   TError.show();   };
    const showInfo    = (m)=>{ setToast(TInfo,m);    TInfo.show();    };

    function confirmToast({message='Ù‡Ù„ ØªØ±ÙŠØ¯ Ø§Ù„Ù…ØªØ§Ø¨Ø¹Ø©ØŸ',confirmText='ØªØ£ÙƒÙŠØ¯',cancelText='Ø¥Ù„ØºØ§Ø¡'}={}){
      return new Promise((resolve)=>{
        TConfirmEl.querySelector('#toastConfirmMsg').textContent = message;
        const yes = TConfirmEl.querySelector('#toastConfirmYes');
        const no  = TConfirmEl.querySelector('#toastConfirmNo');
        const onYes = ()=>{ cleanup(); TConfirm.hide(); resolve(true); };
        const onNo  = ()=>{ cleanup(); resolve(false); };
        const onHidden = ()=>{ cleanup(); resolve(false); };
        function cleanup(){
          yes.removeEventListener('click',onYes);
          no.removeEventListener('click',onNo);
          TConfirmEl.removeEventListener('hidden.bs.toast',onHidden);
        }
        yes.textContent = confirmText; no.textContent = cancelText;
        yes.addEventListener('click',onYes,{once:true});
        no.addEventListener('click',onNo,{once:true});
        TConfirmEl.addEventListener('hidden.bs.toast',onHidden,{once:true});
        TConfirm.show();
      });
    }

    /* ===== auth + Ø´Ø§Ø±Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… ===== */
    const apiFetch = (path, opts={}) => fetch(`${API_BASE}${path}`, { credentials:'include', ...opts });

    function renderUser(user){
      const username = user?.username || (user?.email? user.email.split('@')[0] : 'â€”');
      document.getElementById('userUsername').textContent = username;
      document.getElementById('userFullName').textContent = user?.name || 'â€”';
      document.getElementById('userRole').textContent     = user?.role || 'â€”';
    }
    async function ensureAdmin(){
      try{
        const r = await apiFetch('/auth/committees/me');
        const j = await r.json();
        if(!j?.authenticated){
          const next = encodeURIComponent('/auditors-manage.html');
          location.href = go(`/committees-login.html?next=${next}`);
          throw 0;
        }
        if((j.user?.role||'').toLowerCase()!=='admin'){
          showError('âŒ Ù‡Ø°Ù‡ Ø§Ù„ØµÙØ­Ø© Ù„Ù„Ù…Ø´Ø±ÙÙŠÙ† ÙÙ‚Ø·');
          setTimeout(()=>location.href=go('/committees-home.html'),900);
          throw 0;
        }
        renderUser(j.user);
        return j.user;
      }catch{ throw 0; }
    }
    document.getElementById('homeBtn').href = go('/committees-home.html');
    document.getElementById('logoutBtn').addEventListener('click', async ()=>{
      try{
        const r = await apiFetch('/auth/committees/logout',{method:'POST',headers:{'Content-Type':'application/json'}});
        if(r.ok){ showSuccess('âœ… ØªÙ… ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬'); setTimeout(()=>location.href=go('/committees-login.html'),700); }
        else    { showError('âŒ ØªØ¹Ø°Ø± ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬'); }
      }catch{ showError('âŒ Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø§ØªØµØ§Ù„'); }
    });

    /* ===== ØªØ¨Ø¯ÙŠÙ„ Ø²Ø± +/â€“ ÙÙŠ Ù†Ù…ÙˆØ°Ø¬ Ø§Ù„Ø¥Ø¶Ø§ÙØ© ===== */
    const addCollapseEl = document.getElementById('addCollapse');
    const addToggleIcon = document.getElementById('addToggleIcon');
    addCollapseEl.addEventListener('show.bs.collapse', ()=> addToggleIcon.className='bi bi-dash-lg');
    addCollapseEl.addEventListener('hide.bs.collapse', ()=> addToggleIcon.className='bi bi-plus-lg');

    /* ===== Ø­Ø§Ù„Ø© Ø§Ù„ØµÙØ­Ø© ===== */
    const state = { items: [], page:1, limit:20, sort:'name', q:'' };
    const tbody = document.getElementById('auditorsTbody');

    /* ===== Ø£Ø¯ÙˆØ§Øª Ø¹Ø§Ù…Ø© ===== */
    function debounce(fn, ms){ let t; return (...a)=>{ clearTimeout(t); t=setTimeout(()=>fn(...a), ms); }; }
    function esc(s){ return String(s??'').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;'); }

    /* ===== Ø§Ù„Ø¥Ø­ØµØ§Ø¡Ø§Øª ===== */
    function updateTotalStat(n){
      document.getElementById('statTotal').textContent = n;
    }
    function updateLastChangeStat({whenText='â€”', action='â€”', who='â€”'}={}){
      document.getElementById('statLastChange').textContent = whenText;
      document.getElementById('statLastChangeSub').textContent = `Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡: ${action} â€” Ø¨ÙˆØ§Ø³Ø·Ø©: ${who}`;
    }
    async function fetchLastAuditorChange(){
      try{
        const params = new URLSearchParams({ model:'Auditor', page:1, limit:1 });
        const r = await apiFetch('/api/audit-logs?'+params.toString());
        if(!r.ok) throw 0;
        const data = await r.json();
        const last = data?.items?.[0];
        if(!last){ updateLastChangeStat({ whenText:'â€”', action:'â€”', who:'â€”' }); return; }
        const when = last.createdAt ? new Date(last.createdAt) : null;
        const whenText = when ? when.toLocaleString('ar-EG') : 'â€”';
        const who = last.user?.name || last.user?.username || 'ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙ';
        updateLastChangeStat({ whenText, action:last.action || 'â€”', who });
      }catch{
        updateLastChangeStat({ whenText:'â€”', action:'â€”', who:'â€”' });
      }
    }

    /* ===== Ø±Ø³Ù… Ø§Ù„ØµÙÙˆÙ ===== */
    function renderRows(rows, offset=0){
      if(!Array.isArray(rows) || rows.length===0){
        tbody.innerHTML = `<tr class="text-center text-muted"><td colspan="3">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª</td></tr>`;
        return;
      }
      tbody.innerHTML = rows.map((a,i)=>`
        <tr data-id="${a._id||a.id}">
          <td>${offset + i + 1}</td>
          <td>
            <input class="form-control form-control-sm inline-name" data-id="${a._id||a.id}" value="${esc(a.name)}" placeholder="â€”">
          </td>
          <td>
            <button class="btn btn-sm btn-outline-danger delBtn" data-id="${a._id||a.id}" data-name="${esc(a.name)}">
              <i class="bi bi-trash3"></i>
            </button>
          </td>
        </tr>
      `).join('');
    }

    /* ===== ØªØ­Ù…ÙŠÙ„ (Ù…Ø¹ Ø¨Ø­Ø«/ØªØ±ØªÙŠØ¨/ØªØ±Ù‚ÙŠÙ…) ===== */
    async function fetchAuditors(){
      // Ø³ÙƒÙ„ØªÙˆÙ†
      tbody.innerHTML = `<tr><td colspan="3">
        <div class="skeleton" style="height:18px;margin:8px 0;"></div>
        <div class="skeleton" style="height:18px;margin:8px 0;"></div>
        <div class="skeleton" style="height:18px;margin:8px 0;"></div>
      </td></tr>`;

      try{
        const r = await apiFetch('/api/auditors');
        if(r.status===401 || r.status===403){
          showError('âŒ Ø§Ù†ØªÙ‡Øª Ø§Ù„Ø¬Ù„Ø³Ø© Ø£Ùˆ Ù„Ø§ ØªÙ…Ù„Ùƒ ØµÙ„Ø§Ø­ÙŠØ©');
          setTimeout(()=>location.href=go('/committees-login.html'),900);
          return;
        }
        if(!r.ok) throw new Error('HTTP '+r.status);
        const arr = await r.json();

        // Ø¥Ø­ØµØ§Ø¡ Ø§Ù„Ø¹Ø¯Ø¯ Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ
        updateTotalStat(Array.isArray(arr) ? arr.length : 0);

        // ÙÙ„ØªØ±Ø©/ØªØ±ØªÙŠØ¨/ØªÙ‚Ø³ÙŠÙ… ØµÙØ­Ø§Øª
        let items = arr;
        if(state.q){
          const rx = new RegExp(state.q.replace(/[.*+?^${}()|[\]\\]/g,'\\$&'), 'i');
          items = items.filter(x => rx.test(x.name||''));
        }
        items.sort((a,b)=>{
          const A=(a.name||'').toLocaleLowerCase('ar');
          const B=(b.name||'').toLocaleLowerCase('ar');
          if(state.sort==='name')   return A.localeCompare(B,'ar');
          if(state.sort==='-name')  return B.localeCompare(A,'ar');
          return 0;
        });

        state.items = items;
        const start = (state.page-1)*state.limit;
        const pageItems = items.slice(start, start+state.limit);
        renderRows(pageItems, start);
        document.getElementById('pageNum').textContent = state.page;

        // Ø¢Ø®Ø± ØªØºÙŠÙŠØ±
        fetchLastAuditorChange();
      }catch(e){
        tbody.innerHTML = `<tr class="text-center text-danger"><td colspan="3">ÙØ´Ù„ Ø¬Ù„Ø¨ Ø§Ù„Ù…Ø¯Ù‚Ù‚ÙŠÙ†</td></tr>`;
        console.error('fetchAuditors error:', e);
        updateTotalStat('â€”');
        updateLastChangeStat({ whenText:'â€”', action:'â€”', who:'â€”' });
      }
    }

    /* ===== Ø¥Ø¶Ø§ÙØ© Ù…Ø¯Ù‚Ù‚ ===== */
    const addForm = document.getElementById('addForm');
    const addBtn  = document.getElementById('addBtn');
    const nameInput = document.getElementById('auditorName');
    const dupHint = document.getElementById('dupHint');

    const checkDup = debounce(()=>{
      const v = nameInput.value.trim().toLocaleLowerCase();
      if(!v){ dupHint.textContent=''; return; }
      const hit = state.items.some(x => (x.name||'').toLocaleLowerCase()===v);
      dupHint.textContent = hit ? 'âš ï¸ Ø§Ù„Ø§Ø³Ù… Ù…ÙˆØ¬ÙˆØ¯ Ù…Ø³Ø¨Ù‚Ù‹Ø§' : '';
    }, 300);
    nameInput.addEventListener('input', checkDup);

    addForm.addEventListener('submit', async (e)=>{
      e.preventDefault();
      const v = nameInput.value.trim();
      if(!v){ showError('âš ï¸ Ø£Ø¯Ø®Ù„ Ø§Ø³Ù… Ø§Ù„Ù…Ø¯Ù‚Ù‚'); return; }
      addBtn.disabled = true;
      try{
        const r = await apiFetch('/api/auditors', {
          method:'POST', headers:{'Content-Type':'application/json'},
          body: JSON.stringify({ name: v })
        });
        const data = await r.json().catch(()=> ({}));
        if(!r.ok) throw new Error(data?.message || 'ÙØ´Ù„ Ø§Ù„Ø¥Ø¶Ø§ÙØ©');
        showSuccess('âœ… ØªÙ…Øª Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù…Ø¯Ù‚Ù‚');
        addForm.reset(); dupHint.textContent='';
        state.page = 1;
        await fetchAuditors();
      }catch(err){
        showError('âŒ '+(err.message||'Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¥Ø¶Ø§ÙØ©'));
      }finally{
        addBtn.disabled = false;
      }
    });

    /* ===== ØªØ¹Ø¯ÙŠÙ„ Ø§Ø³Ù… (ØªØ­Ø±ÙŠØ± ÙÙˆØ±ÙŠ) ===== */
    async function updateAuditor(id, name){
      try{
        const r = await apiFetch(`/api/auditors/${id}`, {
          method:'PUT', headers:{'Content-Type':'application/json'},
          body: JSON.stringify({ name })
        });
        const data = await r.json().catch(()=> ({}));
        if(!r.ok) throw new Error(data?.message || 'ÙØ´Ù„ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„');
        showSuccess('âœ… ØªÙ… Ø§Ù„ØªØ¹Ø¯ÙŠÙ„');
        const row = tbody.querySelector(`tr[data-id="${id}"]`);
        row?.classList.add('row-highlight'); setTimeout(()=>row?.classList.remove('row-highlight'),600);
        fetchLastAuditorChange();
      }catch(err){
        showError('âŒ '+(err.message||'ÙØ´Ù„ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„'));
        fetchAuditors();
      }
    }

    /* ===== Ø­Ø°Ù Ù…Ø¯Ù‚Ù‚ ===== */
    async function deleteAuditor(id, name){
      const ok = await confirmToast({ message:`Ø³ÙŠØªÙ… Ø­Ø°Ù Ø§Ù„Ù…Ø¯Ù‚Ù‚: ${name}\nÙ„Ø§ ÙŠÙ…ÙƒÙ† Ø§Ù„ØªØ±Ø§Ø¬Ø¹.`, confirmText:'Ù†Ø¹Ù…ØŒ Ø§Ø­Ø°Ù', cancelText:'Ø¥Ù„ØºØ§Ø¡' });
      if(!ok){ showInfo('ØªÙ… Ø§Ù„Ø¥Ù„ØºØ§Ø¡'); return; }
      try{
        const r = await apiFetch(`/api/auditors/${id}`, { method:'DELETE' });
        const data = await r.json().catch(()=> ({}));
        if(!r.ok) throw new Error(data?.message || 'ÙØ´Ù„ Ø§Ù„Ø­Ø°Ù');
        showSuccess('ğŸ—‘ï¸ ØªÙ… Ø§Ù„Ø­Ø°Ù');
        await fetchAuditors();
      }catch(err){
        showError('âŒ '+(err.message||'ÙØ´Ù„ Ø§Ù„Ø­Ø°Ù'));
      }
    }

    /* ===== ØªØµØ¯ÙŠØ± CSV Ù„Ù…Ø§ Ù‡Ùˆ Ù…Ø¹Ø±ÙˆØ¶ ÙÙŠ Ø§Ù„ØµÙØ­Ø© Ø§Ù„Ø­Ø§Ù„ÙŠØ© ===== */
    function exportCSV(){
      const start = (state.page-1)*state.limit;
      const pageItems = state.items.slice(start, start+state.limit);
      const header = ['name'];
      const toCSV = s => `"${String(s??'').replace(/"/g,'""')}"`;
      const lines = [header.join(',')].concat(pageItems.map(r => [r.name].map(toCSV).join(',')));
      const blob = new Blob([lines.join('\n')], {type:'text/csv;charset=utf-8;'});
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a'); a.href = url; a.download = 'auditors.csv'; a.click();
      URL.revokeObjectURL(url);
    }

    /* ===== Ø£Ø­Ø¯Ø§Ø« Ø§Ù„ÙˆØ§Ø¬Ù‡Ø© ===== */
    document.getElementById('btnReload').addEventListener('click', ()=>{ state.page=1; fetchAuditors(); });
    document.getElementById('btnExport').addEventListener('click', exportCSV);

    document.getElementById('q').addEventListener('input', debounce(()=>{ state.page=1; state.q=document.getElementById('q').value.trim(); fetchAuditors(); }, 300));
    document.getElementById('sort').addEventListener('change', ()=>{ state.page=1; state.sort=document.getElementById('sort').value; fetchAuditors(); });
    document.getElementById('limit').addEventListener('change', ()=>{ state.page=1; state.limit=parseInt(document.getElementById('limit').value,10)||20; fetchAuditors(); });

    document.getElementById('prevPage').addEventListener('click', ()=>{ if(state.page>1){ state.page--; fetchAuditors(); } });
    document.getElementById('nextPage').addEventListener('click', ()=>{ 
      const maxPage = Math.max(1, Math.ceil(state.items.length / state.limit));
      if(state.page < maxPage){ state.page++; fetchAuditors(); }
    });

    const tbodyEl = document.getElementById('auditorsTbody');
    tbodyEl.addEventListener('click', (e)=>{
      const btn = e.target.closest('button');
      if(!btn) return;
      if(btn.classList.contains('delBtn')){
        deleteAuditor(btn.dataset.id, btn.dataset.name);
      }
    });
    tbodyEl.addEventListener('keydown', (e)=>{
      const t = e.target;
      if(t.classList.contains('inline-name') && e.key==='Enter'){
        e.preventDefault();
        t.blur();
      }
    });
    tbodyEl.addEventListener('blur', (e)=>{
      const t = e.target;
      if(t.classList.contains('inline-name')){
        const id = t.dataset.id;
        const val = t.value.trim();
        if(!val){ showError('âš ï¸ Ø£Ø¯Ø®Ù„ Ø§Ø³Ù…Ù‹Ø§ ØµØ§Ù„Ø­Ù‹Ø§'); fetchAuditors(); return; }
        updateAuditor(id, val);
      }
    }, true);

    /* ===== ØªØ´ØºÙŠÙ„ ===== */
    (async function init(){
      try{
        await ensureAdmin();
        document.getElementById('homeBtn').href = go('/committees-home.html');
        await fetchAuditors();
      }catch(e){ /* Ø§Ù„ØªØ­ÙˆÙŠÙ„ ØªÙ… Ù…Ø³Ø¨Ù‚Ù‹Ø§ Ø¹Ù†Ø¯ Ø§Ù„Ø­Ø§Ø¬Ø© */ }
    })();
  </script>
</body>
</html>
