<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8">
  <title>محرر الفيديو</title>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.rtl.min.css">
  <script src="https://cdn.ckeditor.com/ckeditor5/41.1.0/super-build/ckeditor.js"></script>
</head>
<body>
<div class="container mt-4">
  <h3>تعديل الفيديو</h3>
  <input type="hidden" id="videoId">
  <label>العنوان</label>
  <input type="text" id="title" class="form-control mb-3">
  <label>الوصف</label>
  <textarea id="description"></textarea>
  <label class="mt-3">رابط الفيديو</label>
  <input type="text" id="url" class="form-control mb-3">
  <label>القسم</label>
  <input type="text" id="department" class="form-control mb-3">
  <button class="btn btn-primary" onclick="saveVideo()">حفظ</button>
</div>

<script>
const API_BASE = 'https://video-dashboard-backend.onrender.com';
let descEditor;

document.addEventListener('DOMContentLoaded', () => {
  const videoData = JSON.parse(localStorage.getItem('videoToEdit'));
  if (!videoData) {
    alert('لا توجد بيانات فيديو للتعديل');
    window.close();
    return;
  }
  document.getElementById('videoId').value = videoData._id;
  document.getElementById('title').value = videoData.title;
  document.getElementById('url').value = videoData.url;
  document.getElementById('department').value = videoData.department || '';

  CKEDITOR.ClassicEditor.create(document.querySelector('#description'), {
    toolbar: ['bold', 'italic', 'link', 'insertImage', 'insertTable', 'bulletedList', 'numberedList', '|', 'undo', 'redo'],
    link: { addTargetToExternalLinks: true }
  }).then(editor => {
    descEditor = editor;
    descEditor.setData(videoData.description || '');
  });
});

async function saveVideo() {
  const id = document.getElementById('videoId').value;
  const updated = {
    title: document.getElementById('title').value,
    description: descEditor.getData(),
    url: document.getElementById('url').value,
    department: document.getElementById('department').value
  };
  await fetch(`${API_BASE}/api/videos/${id}`, {
    method: 'PUT',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify(updated)
  });
  alert('✅ تم حفظ التعديلات بنجاح');
  window.close();
}
</script>
</body>
</html>
