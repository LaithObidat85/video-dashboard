<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8">
  <title>Ù…Ø­Ø±Ø± Ø§Ù„ÙÙŠØ¯ÙŠÙˆ</title>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.rtl.min.css">
  <script src="https://cdn.ckeditor.com/ckeditor5/41.1.0/super-build/ckeditor.js"></script>
</head>
<body>
<div class="container mt-4">
  <h3>ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„ÙÙŠØ¯ÙŠÙˆ</h3>
  <input type="hidden" id="videoId">

  <label class="mt-2">Ø§Ù„Ø¹Ù†ÙˆØ§Ù†</label>
  <input type="text" id="title" class="form-control mb-3">

  <label>Ø§Ù„ÙˆØµÙ</label>
  <textarea id="description"></textarea>

  <label class="mt-3">Ø±Ø§Ø¨Ø· Ø§Ù„ÙÙŠØ¯ÙŠÙˆ</label>
  <input type="text" id="url" class="form-control mb-3">

  <label>Ø§Ù„Ù‚Ø³Ù…</label>
  <input type="text" id="department" class="form-control mb-3">

  <button class="btn btn-primary" onclick="saveVideo()">Ø­ÙØ¸</button>
</div>

<script>
const API_BASE = 'https://video-dashboard-backend.onrender.com';
let descEditor;

// ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø¹Ù†Ø¯ Ø§ÙƒØªÙ…Ø§Ù„ ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØµÙØ­Ø© Ø¨Ø§Ù„ÙƒØ§Ù…Ù„
window.addEventListener('load', () => {
  const videoData = JSON.parse(localStorage.getItem('videoToEdit'));
  if (!videoData) {
    alert('Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª ÙÙŠØ¯ÙŠÙˆ Ù„Ù„ØªØ¹Ø¯ÙŠÙ„');
    window.close();
    return;
  }

  console.log("âœ… ØªÙ… ØªØ­Ù…ÙŠÙ„ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„ÙÙŠØ¯ÙŠÙˆ:", videoData);

  // ØªØ¹Ø¨Ø¦Ø© Ø§Ù„Ø­Ù‚ÙˆÙ„
  document.getElementById('videoId').value = videoData._id;
  document.getElementById('title').value = videoData.title;
  document.getElementById('url').value = videoData.url;
  document.getElementById('department').value = videoData.department || '';

  // Ø§Ù†ØªØ¸Ø§Ø± Ø¹Ù†ØµØ± Ø§Ù„ÙˆØµÙ Ù‚Ø¨Ù„ Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ù…Ø­Ø±Ø±
  const checkTextarea = setInterval(() => {
    const textarea = document.querySelector('#description');
    if (textarea) {
      clearInterval(checkTextarea);
      console.log("ğŸ–Šï¸ Ø¨Ø¯Ø¡ Ø¥Ù†Ø´Ø§Ø¡ CKEditor...");

      CKEDITOR.ClassicEditor.create(textarea, {
        toolbar: ['bold', 'italic', 'link', 'insertImage', 'insertTable', 'bulletedList', 'numberedList', '|', 'undo', 'redo'],
        link: { addTargetToExternalLinks: true }
      }).then(editor => {
        descEditor = editor;
        descEditor.setData(videoData.description || '');
        console.log("âœ… ØªÙ… ØªÙ‡ÙŠØ¦Ø© CKEditor Ø¨Ù†Ø¬Ø§Ø­");
      }).catch(error => {
        console.error("âŒ Ø®Ø·Ø£ ÙÙŠ ØªÙ‡ÙŠØ¦Ø© CKEditor:", error);
      });
    }
  }, 100);
});

async function saveVideo() {
  const id = document.getElementById('videoId').value;
  const updated = {
    title: document.getElementById('title').value,
    description: descEditor.getData(),
    url: document.getElementById('url').value,
    department: document.getElementById('department').value
  };

  console.log("ğŸ“¤ Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø¥Ù„Ù‰ Ø§Ù„Ø®Ø§Ø¯Ù…:", updated);

  await fetch(`${API_BASE}/api/videos/${id}`, {
    method: 'PUT',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify(updated)
  });

  alert('âœ… ØªÙ… Ø­ÙØ¸ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„Ø§Øª Ø¨Ù†Ø¬Ø§Ø­');
  window.close();
}
</script>
</body>
</html>
