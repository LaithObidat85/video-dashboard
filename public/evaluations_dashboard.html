<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8">
  <title>نتائج تقييم اللجان</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />

  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.rtl.min.css">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css">

  <!-- نفعل حالة التحميل مبكرًا -->
  <script>document.documentElement.classList.add('app-loading');</script>

  <style>
    /* ================= شاشة التحميل ================= */
    #appLoader{
      position:fixed; inset:0; display:flex; align-items:center; justify-content:center;
      gap:.75rem; background:#ffffff; z-index:3000; font-weight:700; color:#333;
    }
    html.app-ready #appLoader{ display:none; }
    /* أخفِ المحتوى أثناء التحميل فقط */
    html.app-loading #pageContent,
    html.app-loading #notAvailable,
    html.app-loading .toast-container{ display:none !important; }

    /* ================= أساسيات ================= */
    body{background:#f8f9fa;font-family:'Segoe UI',sans-serif}
    .container-fluid{margin-top:30px}

    /* مهم: لا نستخدم overflow:hidden على الجدول حتى لا يكسر sticky */
    table{
      background:#fff;
      border-radius:10px;
      overflow:visible;            /* كان hidden */
      font-size:14px;
      width:100%;
      margin:auto
    }

    th,td{text-align:center;vertical-align:middle}
    th{background:#f8f9fa;color:#000;font-weight:700}

    /* منع تكسّر الحروف العربية في عناوين الأعمدة */
    #evaluationsTableWrapper thead th{
      white-space: normal;
      word-break: keep-all;
      overflow-wrap: anywhere;
      writing-mode: horizontal-tb; text-orientation: mixed;
    }

    .highlight{background:#d4edda!important;transition:background-color 1s ease}
    .hidden-col{display:none!important}
    .filters{margin-bottom:20px;text-align:center}
    .sticky-header{background:#f8f9fa;padding-top:10px}

    /* ===== ترويسة لاصقة + ارتفاع أكبر (مطابق لصفحة الإدارة) ===== */
    #evaluationsTableWrapper thead{
      position:sticky; top:0; z-index:99; background:#f8f9fa;
    }
    #evaluationsTableWrapper thead th{
      position:sticky; top:0; z-index:100; background:#f8f9fa; color:#000;
      box-shadow:0 1px 0 rgba(0,0,0,.06);
      padding-block: 1rem;           /* ↑ ارتفاع أكبر للرأس على الشاشة */
      line-height:1.25;
    }

    /* احتياطي في حال استخدمت .table-responsive لاحقًا */
    .table-responsive{ overflow:visible !important; }

    /* أعمدة التاريخ (اتجاه يسار لليمين) */
    #evaluationsTableWrapper th.date-col,
    #evaluationsTableWrapper td.date-col{
      direction:ltr;text-align:center;width:110px;max-width:110px
    }

    /* مساحات معلومات أعلى الجدول */
    #completionRateContainer,#selectedVisitsContainer{font-weight:bold;margin:5px 0;font-size:18px;color:#000;min-height:24px}
    #infoContainer{font-weight:bold;margin:15px 0;font-size:18px;color:#000;text-align:center}

    /* ملاحظات: ما يظهر على الشاشة/الطباعة */
    .notes-screen{display:inline-block}
    .print-notes{display:none;text-align:start}

    /* تأثير Hover على صفوف الجدول */
    #evaluationsTableWrapper tbody tr > * {transition: background-color .2s ease, box-shadow .2s ease;}
    #evaluationsTableWrapper tbody tr:hover > * {
      background-color:#f1f7ff !important; box-shadow: inset 0 0 0 9999px rgba(13,110,253,.06);
    }

    /* رسالة "غير متوفر" */
    #notAvailable{min-height:60vh; align-items:center; justify-content:center; text-align:center;}

    /* ==== نسب عرض للأعمدة (شاشة + طباعة) ==== */
    th.col-idx, td.col-idx{width:3.5%}
    th.col-college, td.col-college{width:9%}
    th.col-committee, td.col-committee{width:20%}            /* اسم اللجنة */
    th.col-date, td.col-date{width:8%}
    th.col-consistency, td.col-consistency{width:13%}        /* التوافق بين الدعوات والاجتماعات (شاشة) */
    th.col-notes, td[col-notes]{width:22%}                   /* الملاحظات (شاشة) */
    /* الحقول الرقمية – نجعلها أضيق */
    th.col-num, td.col-num{width:5%}

    /* عناصر سطور العنوان القابلة للفصل في الطباعة */
    .hline{display:inline}
    .hline + .hline::before{content:" ";} /* مسافة بين الكلمات على الشاشة */

    /* ================= الطباعة ================= */
    @media print{
      @page{ size: A4 landscape; margin: 4mm; } /* هوامش صغيرة جدًا */

      html,body{background:#fff}
      .no-print,.toast-container,.modal{display:none!important}
      .container-fluid{margin-top:0; max-width:none; width:100%}
      .print-header{display:block;margin-bottom:6px}

      /* تخطيط ثابت ليلتزم بعروض الأعمدة */
      #evaluationsTableWrapper{ table-layout: fixed; width:100%; }
      #evaluationsTableWrapper thead th{
        padding-block: .65rem;     /* رأس أقل ارتفاعًا في الطباعة */
        font-size:12px;
      }
      #evaluationsTableWrapper th, #evaluationsTableWrapper td{
        font-size:12px; padding:.35rem .25rem; line-height:1.25;
        white-space:normal; overflow-wrap:anywhere; word-break:keep-all;
        writing-mode: horizontal-tb !important; text-orientation: mixed !important;
      }

      /* تفكيك العناوين إلى أسطر */
      .hline{display:block}        /* كل جزء بسطر مستقل في الطباعة */
      .hline + .hline::before{content:""}

      /* ضبط نسب الأعمدة للطباعة (تقليل التوافق والملاحظات قليلاً) */
      th.col-committee, td.col-committee{width:20%}
      th.col-consistency, td.col-consistency{width:11.5%}  /* كانت ~13% */
      th.col-notes, td[col-notes]{width:20%}               /* كانت ~22% */
      th.col-num, td.col-num{width:5%}
      th.col-college, td.col-college{width:9%}
      th.col-date, td.col-date{width:8%}
      th.col-idx, td.col-idx{width:3.5%}

      /* رأس الجدول يتكرر */
      thead{display:table-header-group}

      /* حاول منع انقسام الصف الواحد بين صفحتين */
      tr{ page-break-inside: avoid; break-inside: avoid; }

      /* إظهار محتوى الملاحظات للطباعة */
      .notes-screen{display:none!important}
      .print-notes{display:block!important;white-space:normal}
    }
  </style>
</head>
<body>

  <!-- شاشة "جاري التحميل..." -->
  <div id="appLoader" aria-live="polite">
    <div class="spinner-border" role="status" aria-hidden="true"></div>
    <span>جاري التحميل…</span>
  </div>

  <!-- رسالة النتائج غير متوفرة -->
  <div id="notAvailable" class="container d-none">
    <div class="mx-auto">
      <div class="display-6 mb-2">نتائج تقييم لجان الكليات غير متوفرة حاليًا</div>
      <p class="text-muted mb-0">يرجى العودة لاحقًا.</p>
    </div>
  </div>

  <!-- محتوى الصفحة الحقيقي -->
  <div id="pageContent" class="container-fluid d-none">
    <div class="sticky-header">
      <h3 class="text-center mb-4">نتائج تقييم اللجان</h3>

      <!-- الفلاتر -->
      <div class="filters row justify-content-center no-print">
        <div class="col-md-3 mb-2 text-center">
          <label class="form-label d-block">الكلية</label> <!-- تم تصحيح d-block -->
          <select id="collegeFilter" class="form-select">
            <option value="">جميع الكليات</option>
          </select>
        </div>
        <div class="col-md-3 mb-2 text-center">
          <label class="form-label d-block">البحث بإسم اللجنة</label>
          <input type="text" id="committeeSearch" class="form-control" placeholder="اكتب للبحث...">
        </div>
      </div>

      <!-- أدوات بسيطة + طباعة/تحديث -->
      <div class="row mb-3 justify-content-center no-print">
        <div class="col-md-8 d-flex align-items-center justify-content-center gap-4">
          <div class="form-check">
            <input class="form-check-input simple-toggle" type="checkbox" id="toggle_college" checked>
            <label class="form-check-label" for="toggle_college">إظهار الكلية</label>
          </div>
          <div class="form-check">
            <input class="form-check-input simple-toggle" type="checkbox" id="toggle_date">
            <label class="form-check-label" for="toggle_date">إظهار تاريخ التدقيق</label>
          </div>
          <button class="btn btn-secondary" id="printBtn" title="طباعة"><i class="bi bi-printer"></i></button>
          <button class="btn btn-info" id="reloadBtn" title="إعادة تحميل الإعدادات والجدول"><i class="bi bi-arrow-repeat"></i></button>
        </div>
      </div>

      <!-- رأس الطباعة -->
      <div id="infoContainer" class="print-header">
        <div id="semesterInfo">—</div>
        <div id="selectedVisitsContainer">—</div>
        <div id="completionRateContainer">—</div>
        <div id="committeesCountContainer">—</div>
      </div>
    </div>

    <table class="table table-bordered table-striped" id="evaluationsTableWrapper">
      <thead>
        <tr>
          <th class="col-idx">#</th>
          <th class="col-college">الكلية</th>
          <th class="col-committee">اسم اللجنة</th>
          <th class="date-col col-date hidden-col">تاريخ التدقيق</th>

          <th class="col-num col-formation_decision">
            <span class="hline">قرار</span><span class="hline">التشكيل</span>
          </th>
          <th class="col-num col-work_plan">
            <span class="hline">خطة</span><span class="hline">العمل</span>
          </th>
          <th class="col-num col-performance_indicators">
            <span class="hline">مؤشرات</span><span class="hline">الأداء</span>
          </th>
          <th class="col-num col-meetings">
            <span class="hline">عدد</span><span class="hline">الاجتماعات</span>
          </th>
          <th class="col-consistency">
            <span class="hline">التوافق بين</span><span class="hline">الدعوات</span><span class="hline">والاجتماعات</span>
          </th>
          <th class="col-num col-coverage_books">
            <span class="hline">كتب</span><span class="hline">التغطية</span>
          </th>
          <th class="col-num col-report1">تقرير إنجاز 1</th>
          <th class="col-num col-report2">تقرير إنجاز 2</th>
          <th class="col-num col-report3">تقرير إنجاز 3</th>
          <th class="col-num col-statistical_analysis">
            <span class="hline">التحليل</span><span class="hline">الإحصائي</span>
          </th>

          <!-- سنملؤه ديناميكياً بنفس البنية متعددة الأسطر -->
          <th id="availabilityHeader" class="col-num"></th>
          <th class="col-notes">الملاحظات</th>
        </tr>
      </thead>
      <tbody id="committeesTable">
        <tr><td colspan="16" class="text-center">جاري التحميل...</td></tr>
      </tbody>
    </table>
  </div>

  <!-- Modal الملاحظات للشاشة فقط -->
  <div class="modal fade no-print" id="notesModal" tabindex="-1">
    <div class="modal-dialog modal-lg"><div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">📝 الملاحظات</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body" id="notesContent"></div>
    </div></div>
  </div>

  <!-- Toasts -->
  <div class="toast-container position-fixed top-0 start-50 translate-middle-x p-3 no-print">
    <div id="toastSuccess" class="toast align-items-center text-bg-success border-0 mb-2" role="alert">
      <div class="d-flex"><div class="toast-body">✅ العملية نجحت</div>
        <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button>
      </div>
    </div>
    <div id="toastError" class="toast align-items-center text-bg-danger border-0 mb-2" role="alert">
      <div class="d-flex"><div class="toast-body">❌ حدث خطأ</div>
        <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button>
      </div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
  <script>
    /* ===== سجلات أخطاء عامة للمساعدة في التشخيص ===== */
    window.addEventListener('error', e => console.error('WindowError:', e.message, e.filename, e.lineno));
    window.addEventListener('unhandledrejection', e => console.error('PromiseRejection:', e.reason));

    /* ===== توستات ===== */
    const toastSuccess = new bootstrap.Toast(document.getElementById('toastSuccess'));
    const toastError   = new bootstrap.Toast(document.getElementById('toastError'));
    const showSuccess  = (m='✅ العملية نجحت')=>{ document.querySelector('#toastSuccess .toast-body').innerText=m; toastSuccess.show(); };
    const showError    = (m='❌ حدث خطأ')     =>{ document.querySelector('#toastError .toast-body').innerText=m; toastError.show();   };

    /* ===== أعلام الحالة ===== */
    let savedVisibleColumns = [];  // من الإعدادات
    let lastCollege = '';          // من الفلتر الحالي
    let settingsCache = null;      // نخزن الإعدادات للطباعة
    let PUBLISH_RESULTS = false;   // الحقل الذي نتحكم به من /api/settings

    const availabilityFields = ["formation_decision","work_plan","performance_indicators","meetings","consistency","coverage_books","report1","report2","report3","statistical_analysis"];

    /* ===== تحميل القوائم ===== */
    async function loadOptions(){
      try{
        const { data } = await axios.get('/api/colleges');
        const collegeFilter = document.getElementById('collegeFilter');
        // امسح الخيارات (عدا "جميع الكليات") عند إعادة التحميل
        collegeFilter.querySelectorAll('option:not(:first-child)').forEach(o=>o.remove());
        (data||[]).forEach(c=>{
          const opt=document.createElement('option');
          opt.value=c.name; opt.textContent=c.name;
          collegeFilter.appendChild(opt);
        });
      }catch(e){ console.warn('loadOptions error', e); }
    }

    /* ===== Sanitizer للملاحظات (للشاشة والطباعة) ===== */
    function sanitizeNotes(html=''){
      try{
        const allowed=['P','UL','OL','LI','B','STRONG','I','EM','U','BR'];
        const tmp=document.createElement('div'); tmp.innerHTML = html;
        const walker=document.createTreeWalker(tmp, NodeFilter.SHOW_ELEMENT, null);
        const toRemove=[];
        while(walker.nextNode()){
          const el=walker.currentNode;
          if(!allowed.includes(el.tagName)) toRemove.push(el);
          for(const a of Array.from(el.attributes||[])){
            const name=a.name.toLowerCase();
            if(name.startsWith('on') || name==='style') el.removeAttribute(a.name);
          }
        }
        toRemove.forEach(n=>n.replaceWith(document.createTextNode(n.textContent||'')));
        return tmp.innerHTML.trim() || '—';
      }catch{return '—'}
    }

    /* ===== تعيين عنوان "درجة التوفر" متعدد الأسطر مع رقم ديناميكي ===== */
    function renderAvailabilityHeader(n){
      const h = document.getElementById('availabilityHeader');
      h.innerHTML = `
        <span class="hline">درجة</span>
        <span class="hline">التوفر</span>
        <span class="hline">من</span>
        <span class="hline">(${n})</span>
      `;
    }

    /* ===== تحديث عنوان التوفر ===== */
    function updateAvailabilityHeader(){
      const n=savedVisibleColumns.length;
      renderAvailabilityHeader(n);
    }

    /* ===== حساب درجة التوفر للصف ===== */
    function updateAvailability(row){
      let sum=0;
      availabilityFields.forEach(f=>{
        const cell=row.querySelector(\`[data-field="\${f}"]\`);
        if(cell && !cell.classList.contains('hidden-col')){
          sum += parseFloat(cell.innerText)||0;
        }
      });
      const target=row.querySelector('.availability-cell');
      if(target){
        target.innerText=sum.toFixed(2);
        target.classList.add('highlight');
        setTimeout(()=>target.classList.remove('highlight'),800);
      }
    }

    /* ===== نسبة الاكتمال + عدد اللجان ===== */
    function updateCompletionAndCounts(){
      const rows=[...document.querySelectorAll('#committeesTable tr')].filter(r=>r.style.display!=='none');
      let total=0;
      rows.forEach(r=>{ total += parseFloat(r.querySelector('.availability-cell')?.innerText)||0; });
      const denom = rows.length * savedVisibleColumns.length;
      const pct = denom>0 ? ((total/denom)*100).toFixed(2) : '0.00';

      const completionDiv=document.getElementById('completionRateContainer');
      const countDiv=document.getElementById('committeesCountContainer');
      const lc = lastCollege || 'جميع الكليات';
      if(lc && lc!=='جميع الكليات'){
        completionDiv.innerHTML = \`نسبة الاكتمال لكلية \${lc} = \${pct}%\`;
        countDiv.innerHTML      = \`عدد لجان كلية \${lc} = \${rows.length}\`;
      }else{
        completionDiv.innerHTML = \`نسبة الاكتمال لجميع الكليات = \${pct}%\`;
        countDiv.innerHTML      = \`عدد لجان جميع الكليات = \${rows.length}\`;
      }
    }

    /* ===== تطبيق رؤية الأعمدة ===== */
    function applyColumnVisibility(){
      const showCollege=document.getElementById('toggle_college').checked;
      document.querySelectorAll('.col-college, td.col-college').forEach(el=>el.classList.toggle('hidden-col',!showCollege));

      const showDate=document.getElementById('toggle_date').checked;
      document.querySelectorAll('.date-col').forEach(el=>el.classList.toggle('hidden-col',!showDate));

      availabilityFields.forEach(f=>{
        const show = savedVisibleColumns.includes(f);
        document.querySelectorAll(\`[data-field="\${f}"]\`).forEach(td=>td.classList.toggle('hidden-col', !show));
        const th=document.querySelector(\`.col-\${f}\`);
        if(th) th.classList.toggle('hidden-col', !show);
      });

      // إخفاء/إظهار عمود الملاحظات لو لم توجد أعمدة رقمية ظاهرة
      const hideNotes = savedVisibleColumns.length === 0;
      const notesHeader = document.querySelector('#evaluationsTableWrapper th.col-notes');
      if (notesHeader) notesHeader.classList.toggle('hidden-col', hideNotes);
      document.querySelectorAll('#evaluationsTableWrapper td[data-notes-col], #evaluationsTableWrapper td[col-notes]').forEach(td=>{
        td.classList.toggle('hidden-col', hideNotes);
      });

      document.querySelectorAll('#committeesTable tr').forEach(updateAvailability);
      updateAvailabilityHeader();
      updateCompletionAndCounts();
    }

    document.querySelectorAll('.simple-toggle').forEach(cb=>{
      cb.addEventListener('change', applyColumnVisibility);
    });

    /* ===== البحث باسم اللجنة ===== */
    function applyCommitteeSearch(){
      const term=document.getElementById('committeeSearch').value.trim().toLowerCase();
      document.querySelectorAll('#committeesTable tr').forEach(row=>{
        const name=row.querySelector('td.col-committee')?.innerText.trim().toLowerCase()||'';
        row.style.display = name.includes(term)? '': 'none';
      });
      updateCompletionAndCounts();
    }
    document.getElementById('committeeSearch').addEventListener('input', applyCommitteeSearch);

    /* ===== تحميل الإعدادات ===== */
    async function loadSettings(){
      const semesterEl=document.getElementById('semesterInfo');
      const visitsEl  =document.getElementById('selectedVisitsContainer');
      const na = document.getElementById('notAvailable');
      const pc = document.getElementById('pageContent');

      try{
        const {data} = await axios.get('/api/settings');
        settingsCache = data || {};
        PUBLISH_RESULTS = !!settingsCache.publishResults;

        if(!PUBLISH_RESULTS){
          na.classList.remove('d-none'); na.classList.add('d-flex');
          pc.classList.add('d-none');
          return false;
        }

        // مفعّل => إظهار الصفحة وإخفاء الرسالة
        na.classList.add('d-none'); na.classList.remove('d-flex');
        pc.classList.remove('d-none');

        savedVisibleColumns = settingsCache.visibleColumns || [];

        const t = settingsCache.term || '—';
        const ay= settingsCache.academicYear || '—';
        semesterEl.textContent = \`\${t} - \${ay}\`;

        const visits = Array.isArray(settingsCache.selectedVisits) && settingsCache.selectedVisits.length
          ? settingsCache.selectedVisits.join(' | ')
          : 'لم يتم اختيار أي زيارة';
        visitsEl.textContent = \`الزيارات: \${visits}\`;

        return true;
      }catch(e){
        console.warn('loadSettings error', e);
        // في حالة الخطأ نتصرف كأن النشر غير مفعّل (أكثر أمانًا)
        na.classList.remove('d-none'); na.classList.add('d-flex');
        pc.classList.add('d-none');
        return false;
      }
    }

    /* ===== تحميل جدول اللجان ===== */
    async function loadCommittees(){
      try{
        const college=document.getElementById('collegeFilter').value;
        lastCollege = college || 'جميع الكليات';
        let url='/api/committees';
        const params=[];
        if(college) params.push('college='+encodeURIComponent(college));
        if(params.length) url+='?'+params.join('&');

        const res=await axios.get(url);
        const tbody=document.getElementById('committeesTable');
        tbody.innerHTML='';

        const arr=Array.isArray(res.data)?res.data:[];
        if(!arr.length){
          tbody.innerHTML=`<tr><td colspan="16" class="text-center">لا توجد بيانات</td></tr>`;
          updateAvailabilityHeader();
          document.getElementById('completionRateContainer').textContent='';
          document.getElementById('committeesCountContainer').textContent='';
          return;
        }

        // ترتيب افتراضي حسب الكلية
        arr.sort((a,b)=>(a.college||'').localeCompare(b.college||'','ar'));

        // رسم الصفوف
        arr.forEach((c,idx)=>{
          const tr=document.createElement('tr');
          const dateTxt = c.audit_date ? new Date(c.audit_date).toLocaleDateString('ar-EG'): '-';
          const notesHtml = (c.notes||'').trim();
          const hasNotes  = !!notesHtml && notesHtml!=='<p><br></p>' && notesHtml!=='<br>';

          tr.innerHTML = `
            <td class="col-idx">${idx+1}</td>
            <td class="col-college">${c.college??''}</td>
            <td class="col-committee">${c.committee_name??''}</td>
            <td class="date-col col-date hidden-col">${dateTxt}</td>
            <td class="col-num" data-field="formation_decision">${c.formation_decision ?? 0}</td>
            <td class="col-num" data-field="work_plan">${c.work_plan ?? 0}</td>
            <td class="col-num" data-field="performance_indicators">${c.performance_indicators ?? 0}</td>
            <td class="col-num" data-field="meetings">${c.meetings ?? 0}</td>
            <td class="col-consistency" data-field="consistency">${c.consistency ?? 0}</td>
            <td class="col-num" data-field="coverage_books">${c.coverage_books ?? 0}</td>
            <td class="col-num" data-field="report1">${c.report1 ?? 0}</td>
            <td class="col-num" data-field="report2">${c.report2 ?? 0}</td>
            <td class="col-num" data-field="report3">${c.report3 ?? 0}</td>
            <td class="col-num" data-field="statistical_analysis">${c.statistical_analysis ?? 0}</td>
            <td class="col-num availability-cell">${c.availability_score ?? 0}</td>
            <td col-notes data-notes-col>
              <span class="notes-screen">
                ${ hasNotes ? `<button class="btn btn-sm btn-info" title="عرض الملاحظات" data-notes="1">🔍</button>` : '<span class="text-muted">لا توجد ملاحظات</span>' }
              </span>
              <div class="print-notes">${hasNotes ? sanitizeNotes(notesHtml) : '—'}</div>
            </td>
          `;
          // زر عرض الملاحظات (شاشة فقط) — مُعقّم
          const btn = tr.querySelector('[data-notes]');
          if(btn){
            btn.addEventListener('click',()=>{
              document.getElementById('notesContent').innerHTML = hasNotes ? sanitizeNotes(notesHtml) : '<i>لا توجد ملاحظات</i>';
              new bootstrap.Modal(document.getElementById('notesModal')).show();
            });
          }
          document.getElementById('committeesTable').appendChild(tr);
          updateAvailability(tr);
        });

        applyColumnVisibility();
        applyCommitteeSearch();
      }catch(err){
        console.error('loadCommittees error', err);
        showError('❌ فشل تحميل البيانات');
        const tbody=document.getElementById('committeesTable');
        tbody.innerHTML=`<tr><td colspan="16" class="text-center text-danger">فشل الجلب</td></tr>`;
      }
    }

    /* ===== طباعة ===== */
    document.getElementById('printBtn').addEventListener('click', ()=> {
      updateCompletionAndCounts();
      window.print();
    });

    /* ===== أحداث عامة ===== */
    document.getElementById('collegeFilter').addEventListener('change', async ()=>{
      if(!PUBLISH_RESULTS) return;
      await loadCommittees();
    });
    document.getElementById('reloadBtn').addEventListener('click', async ()=>{
      const ok = await loadSettings();
      if(ok){
        await loadOptions();
        await loadCommittees();
      }
    });

    /* ===== تشغيل أولي مع شاشة التحميل ===== */
    (async function init(){
      try{
        const ok = await loadSettings();
        if(ok){
          await loadOptions();
          await loadCommittees();
        }
        // جهّز عنوان "درجة التوفر" حتى قبل الجلب الأول
        updateAvailabilityHeader();
      }catch(e){
        console.error('init error:', e);
      }finally{
        // إنهاء شاشة التحميل بغضّ النظر عن الحالة
        document.documentElement.classList.remove('app-loading');
        document.documentElement.classList.add('app-ready');
      }
    })();
  </script>
</body>
</html>
