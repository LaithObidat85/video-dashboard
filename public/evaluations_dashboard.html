<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8">
  <title>لوحة متابعة التقييمات</title>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.rtl.min.css">
  <style>
    body { background-color: #f8f9fa; font-family: 'Segoe UI', sans-serif; }
    .container { margin-top: 30px; }
    table { background: #fff; border-radius: 10px; overflow: hidden; font-size: 14px; }
    th { background-color: #0d6efd; color: #fff; text-align: center; }
    td { text-align: center; vertical-align: middle; }
        /* تحديد عرض عمود الملاحظات (العمود 17) */
    #evaluationsTableWrapper th:nth-child(17),
    #evaluationsTableWrapper td:nth-child(17) {
      width: 400px;
      max-width: 400px;
      white-space: normal;
      word-wrap: break-word;
    }

    .filters { margin-bottom: 20px; }
    #completionRateContainer {
      text-align: center;
      font-weight: bold;
      margin: 15px 0;
      font-size: 18px;
      color: #0d6efd;
    }

    /* ✅ الطباعة */
    @media print {
      body * { visibility: hidden; }
      #printHeader, #printHeader * ,
      #evaluationsTableWrapper, #evaluationsTableWrapper * {
        visibility: visible;
      }
      #printHeader {
        display: block !important;
        text-align: center;
        margin-bottom: 20px;
        position: absolute;
        top: 20px;
        left: 0;
        width: 100%;
      }
      #evaluationsTableWrapper {
        position: absolute;
        left: 0; 
        top: 150px;
        width: 100%;
      }
    }

   /* إخفاء عمود اسم المدقق */
.hide-auditor th:nth-child(4),
.hide-auditor td:nth-child(4) {
  display: none;
}

/* إخفاء عمود تاريخ التدقيق */
.hide-date th:nth-child(5),
.hide-date td:nth-child(5) {
  display: none;
}

/* إخفاء عمود الكلية */
.hide-college th:nth-child(2),
.hide-college td:nth-child(2) {
  display: none;
}
    

    #printHeader { display: none; }

    /* زر الطباعة أعلى اليسار */
    .print-btn {
      position: absolute;
      top: 10px;
      left: 15px;
    }
  </style>
</head>
<body>
  <div class="container position-relative">
    <button class="btn btn-secondary print-btn" onclick="printTable()">🖨️</button>
    <h3 class="text-center mb-4">📊 لوحة متابعة التقييمات</h3>

    <!-- الفلاتر -->
    <div class="filters row">
      <div class="col-md-6 mb-2">
        <label class="form-label">الكلية</label>
        <select id="collegeFilter" class="form-select">
          <option value="">جميع الكليات</option>
        </select>
      </div>
      <div class="col-md-6 mb-2">
        <label class="form-label">اسم المدقق</label>
        <select id="auditorFilter" class="form-select">
          <option value="">جميع المدققين</option>
        </select>
      </div>
    </div>

  <!-- خيارات الإخفاء داخل كارد -->
<div class="card mb-3">
  <div class="card-body d-flex justify-content-center align-items-center gap-3">
    <div class="form-check">
      <input class="form-check-input" type="checkbox" id="hideAuditorCheckbox">
      <label class="form-check-label ms-2" for="hideAuditorCheckbox">إخفاء اسم المدقق</label>
    </div>
    <span>|</span>
    <div class="form-check">
      <input class="form-check-input" type="checkbox" id="hideDateCheckbox">
      <label class="form-check-label ms-2" for="hideDateCheckbox">إخفاء تاريخ التدقيق</label>
    </div>
    <span>|</span>
    <div class="form-check">
      <input class="form-check-input" type="checkbox" id="hideCollegeCheckbox">
      <label class="form-check-label ms-2" for="hideCollegeCheckbox">إخفاء الكلية</label>
    </div>
  </div>
</div>

    

    <!-- نسبة الاكتمال -->
    <div id="completionRateContainer"></div>

    <!-- هيدر للطباعة -->
    <div id="printHeader"></div>

    <!-- الجدول -->
    <table class="table table-bordered table-striped" id="evaluationsTableWrapper">
      <thead>
        <tr>
          <th>#</th>
          <th>الكلية</th>
          <th>اسم اللجنة</th>
          <th>اسم المدقق</th>
          <th>تاريخ التدقيق</th>
          <th>قرار التشكيل</th>
          <th>خطة العمل</th>
          <th>مؤشرات الأداء</th>
          <th>عدد الاجتماعات</th>
          <th>التوافق بين الدعوات والاجتماعات</th>
          <th>كتب التغطية</th>
          <th>تقرير إنجاز 1</th>
          <th>تقرير إنجاز 2</th>
          <th>تقرير إنجاز 3</th>
          <th>التحليل الإحصائي</th>
          <th>درجة التوفر</th>
          <th>الملاحظات</th>
        </tr>
      </thead>
      <tbody id="evaluationsTable">
        <tr><td colspan="17" class="text-center">جاري التحميل...</td></tr>
      </tbody>
    </table>
  </div>

  <!-- Toasts -->
  <div class="toast-container position-fixed top-0 start-50 translate-middle-x p-3">
    <div id="toastSuccess" class="toast align-items-center text-bg-success border-0 mb-2">
      <div class="d-flex">
        <div class="toast-body">✅ العملية نجحت</div>
        <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button>
      </div>
    </div>
    <div id="toastError" class="toast align-items-center text-bg-danger border-0 mb-2">
      <div class="d-flex">
        <div class="toast-body">❌ حدث خطأ</div>
        <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button>
      </div>
    </div>
  </div>

  <!-- مكتبات -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>

  <script>
    const toastSuccess = new bootstrap.Toast(document.getElementById('toastSuccess'));
    const toastError = new bootstrap.Toast(document.getElementById('toastError'));

    function showSuccess(msg="✅ العملية نجحت") {
      document.querySelector("#toastSuccess .toast-body").innerText = msg;
      toastSuccess.show();
    }
    function showError(msg="❌ حدث خطأ") {
      document.querySelector("#toastError .toast-body").innerText = msg;
      toastError.show();
    }

    let lastCompletionRate = null;
    let lastCollegeName = "جميع الكليات";
    let lastCommitteesCount = 0;

    async function loadFilters() {
      try {
        const colleges = await axios.get('/api/colleges');
        const collegeSelect = document.getElementById('collegeFilter');
        colleges.data.forEach(c => {
          const opt = document.createElement('option');
          opt.value = c.name;
          opt.textContent = c.name;
          collegeSelect.appendChild(opt);
        });

        const auditors = await axios.get('/api/auditors');
        const auditorSelect = document.getElementById('auditorFilter');
        auditors.data.forEach(a => {
          const opt = document.createElement('option');
          opt.value = a.name;
          opt.textContent = a.name;
          auditorSelect.appendChild(opt);
        });
      } catch (err) {
        console.error("خطأ في جلب الفلاتر:", err);
        showError("❌ فشل تحميل الفلاتر");
      }
    }

    async function loadEvaluations() {
      try {
        const college = document.getElementById('collegeFilter').value;
        const auditor = document.getElementById('auditorFilter').value;
        lastCollegeName = college || "جميع الكليات";

        let url = '/api/committees';
        const params = [];
        if (college) params.push(`college=${encodeURIComponent(college)}`);
        if (auditor) params.push(`auditor_name=${encodeURIComponent(auditor)}`);
        if (params.length > 0) url += '?' + params.join('&');

        const res = await axios.get(url);
        const tbody = document.getElementById('evaluationsTable');
        tbody.innerHTML = "";

        if (res.data.length === 0) {
          tbody.innerHTML = `<tr><td colspan="17" class="text-center">لا توجد تقييمات</td></tr>`;
          document.getElementById("completionRateContainer").innerHTML = "";
          lastCompletionRate = null;
          lastCommitteesCount = 0;
          return;
        }

        // ترتيب اللجان حسب الكلية
        res.data.sort((a, b) => (a.college || "").localeCompare(b.college || "", "ar"));

        let totalAvailability = 0;
        res.data.forEach((ev, index) => {
          totalAvailability += ev.availability_score ?? 0;
          const tr = document.createElement('tr');
          tr.innerHTML = `
            <td>${index + 1}</td>
            <td>${ev.college || '-'}</td>
            <td>${ev.committee_name || '-'}</td>
            <td>${ev.auditor_name || '-'}</td>
            <td>${ev.audit_date ? new Date(ev.audit_date).toLocaleDateString('ar-EG') : '-'}</td>
            <td>${ev.formation_decision ?? 0}</td>
            <td>${ev.work_plan ?? 0}</td>
            <td>${ev.performance_indicators ?? 0}</td>
            <td>${ev.meetings ?? 0}</td>
            <td>${ev.consistency ?? 0}</td>
            <td>${ev.coverage_books ?? 0}</td>
            <td>${ev.report1 ?? 0}</td>
            <td>${ev.report2 ?? 0}</td>
            <td>${ev.report3 ?? 0}</td>
            <td>${ev.statistical_analysis ?? 0}</td>
            <td>${ev.availability_score ?? 0}</td>
            <td>${ev.notes && ev.notes.trim() !== "" ? ev.notes : '<span class="text-muted">لا توجد ملاحظات</span>'}</td>
          `;
          tbody.appendChild(tr);
        });

        const completionDiv = document.getElementById("completionRateContainer");
        const numCommittees = res.data.length;
        lastCommitteesCount = numCommittees;
        const denominator = numCommittees * 9;
        const completionRate = ((totalAvailability / denominator) * 100).toFixed(2);

        if (college) {
          completionDiv.innerHTML = `📌 نسبة الاكتمال لكلية ${college} = ${completionRate}%<br>
                                     📋 عدد لجان كلية ${college} = ${numCommittees}`;
        } else {
          completionDiv.innerHTML = `📌 نسبة الاكتمال لجميع الكليات = ${completionRate}%<br>
                                     📋 عدد لجان جميع الكليات = ${numCommittees}`;
        }

        lastCompletionRate = completionRate;

      } catch (err) {
        console.error("خطأ في جلب التقييمات:", err);
        showError("❌ فشل تحميل التقييمات");
      }
    }

    // 🔹 Print (عنوان + نسبة اكتمال + عدد اللجان)
    function printTable() {
      const headerDiv = document.getElementById("printHeader");
      if (lastCollegeName === "جميع الكليات") {
        headerDiv.innerHTML = `<h4>📊 نتائج تقييم اللجان - جميع الكليات</h4>` +
                              (lastCompletionRate ? `<p>📌 نسبة الاكتمال لجميع الكليات = ${lastCompletionRate}%</p>` : "") +
                              `<p>📋 عدد لجان جميع الكليات = ${lastCommitteesCount}</p>`;
      } else {
        headerDiv.innerHTML = `<h4>📊 نتائج تقييم اللجان - ${lastCollegeName}</h4>` +
                              (lastCompletionRate ? `<p>📌 نسبة الاكتمال لكلية ${lastCollegeName} = ${lastCompletionRate}%</p>` : "") +
                              `<p>📋 عدد لجان كلية ${lastCollegeName} = ${lastCommitteesCount}</p>`;
      }
      window.print();
      headerDiv.innerHTML = "";
    }

    // ✅ التحكم في إخفاء/إظهار عمود اسم المدقق
    document.getElementById('hideAuditorCheckbox').addEventListener('change', function () {
      const table = document.getElementById('evaluationsTableWrapper');
      if (this.checked) {
        table.classList.add('hide-auditor');
      } else {
        table.classList.remove('hide-auditor');
      }
    });

    // ✅ إخفاء/إظهار تاريخ التدقيق
document.getElementById('hideDateCheckbox').addEventListener('change', function () {
  document.getElementById('evaluationsTableWrapper').classList.toggle('hide-date', this.checked);
});

// ✅ إخفاء/إظهار الكلية
document.getElementById('hideCollegeCheckbox').addEventListener('change', function () {
  document.getElementById('evaluationsTableWrapper').classList.toggle('hide-college', this.checked);
});


    loadFilters().then(loadEvaluations);
    document.getElementById('collegeFilter').addEventListener('change', loadEvaluations);
    document.getElementById('auditorFilter').addEventListener('change', loadEvaluations);
  </script>
</body>
</html>
