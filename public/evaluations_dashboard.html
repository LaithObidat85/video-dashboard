<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8">
  <title>Ù†ØªØ§Ø¦Ø¬ ØªÙ‚ÙŠÙŠÙ… Ø§Ù„Ù„Ø¬Ø§Ù†</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />

  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.rtl.min.css">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css">

  <!-- Ù†ÙØ¹Ù„ Ø­Ø§Ù„Ø© Ø§Ù„ØªØ­Ù…ÙŠÙ„ Ù…Ø¨ÙƒØ±Ù‹Ø§ -->
  <script>document.documentElement.classList.add('app-loading');</script>

  <style>
    /* ================= Ø´Ø§Ø´Ø© Ø§Ù„ØªØ­Ù…ÙŠÙ„ ================= */
    #appLoader{
      position:fixed; inset:0; display:flex; align-items:center; justify-content:center;
      gap:.75rem; background:#ffffff; z-index:3000; font-weight:700; color:#333;
    }
    html.app-ready #appLoader{ display:none; }
    /* Ø£Ø®ÙÙ Ø§Ù„Ù…Ø­ØªÙˆÙ‰ Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„ØªØ­Ù…ÙŠÙ„ ÙÙ‚Ø· */
    html.app-loading #pageContent,
    html.app-loading #notAvailable,
    html.app-loading .toast-container{ display:none !important; }

    /* ================= Ø£Ø³Ø§Ø³ÙŠØ§Øª ================= */
    body{background:#f8f9fa;font-family:'Segoe UI',sans-serif}
    .container-fluid{margin-top:30px}

    /* Ù…Ù‡Ù…: Ù„Ø§ Ù†Ø³ØªØ®Ø¯Ù… overflow:hidden Ø¹Ù„Ù‰ Ø§Ù„Ø¬Ø¯ÙˆÙ„ Ø­ØªÙ‰ Ù„Ø§ ÙŠÙƒØ³Ø± sticky */
    table{
      background:#fff;
      border-radius:10px;
      overflow:visible;            /* ÙƒØ§Ù† hidden */
      font-size:14px;
      width:100%;
      margin:auto
    }

    th,td{text-align:center;vertical-align:middle}
    th{background:#f8f9fa;color:#000;font-weight:700}

    /* Ù…Ù†Ø¹ ØªÙƒØ³Ù‘Ø± Ø§Ù„Ø­Ø±ÙˆÙ Ø§Ù„Ø¹Ø±Ø¨ÙŠØ© ÙÙŠ Ø¹Ù†Ø§ÙˆÙŠÙ† Ø§Ù„Ø£Ø¹Ù…Ø¯Ø© */
    #evaluationsTableWrapper thead th{
      white-space: normal;
      word-break: keep-all;
      overflow-wrap: anywhere;
      writing-mode: horizontal-tb; text-orientation: mixed;
    }

    .highlight{background:#d4edda!important;transition:background-color 1s ease}
    .hidden-col{display:none!important}
    .filters{margin-bottom:20px;text-align:center}
    .sticky-header{background:#f8f9fa;padding-top:10px}

    /* ===== ØªØ±ÙˆÙŠØ³Ø© Ù„Ø§ØµÙ‚Ø© + Ø§Ø±ØªÙØ§Ø¹ Ø£ÙƒØ¨Ø± (Ù…Ø·Ø§Ø¨Ù‚ Ù„ØµÙØ­Ø© Ø§Ù„Ø¥Ø¯Ø§Ø±Ø©) ===== */
    #evaluationsTableWrapper thead{
      position:sticky; top:0; z-index:99; background:#f8f9fa;
    }
    #evaluationsTableWrapper thead th{
      position:sticky; top:0; z-index:100; background:#f8f9fa; color:#000;
      box-shadow:0 1px 0 rgba(0,0,0,.06);
      padding-block: 1rem;           /* â†‘ Ø§Ø±ØªÙØ§Ø¹ Ø£ÙƒØ¨Ø± Ù„Ù„Ø±Ø£Ø³ Ø¹Ù„Ù‰ Ø§Ù„Ø´Ø§Ø´Ø© */
      line-height:1.25;
    }

    /* Ø§Ø­ØªÙŠØ§Ø·ÙŠ ÙÙŠ Ø­Ø§Ù„ Ø§Ø³ØªØ®Ø¯Ù…Øª .table-responsive Ù„Ø§Ø­Ù‚Ù‹Ø§ */
    .table-responsive{ overflow:visible !important; }

    /* Ø£Ø¹Ù…Ø¯Ø© Ø§Ù„ØªØ§Ø±ÙŠØ® (Ø§ØªØ¬Ø§Ù‡ ÙŠØ³Ø§Ø± Ù„Ù„ÙŠÙ…ÙŠÙ†) */
    #evaluationsTableWrapper th.date-col,
    #evaluationsTableWrapper td.date-col{
      direction:ltr;text-align:center;width:110px;max-width:110px
    }

    /* Ù…Ø³Ø§Ø­Ø§Øª Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø£Ø¹Ù„Ù‰ Ø§Ù„Ø¬Ø¯ÙˆÙ„ */
    #completionRateContainer,#selectedVisitsContainer{font-weight:bold;margin:5px 0;font-size:18px;color:#000;min-height:24px}
    #infoContainer{font-weight:bold;margin:15px 0;font-size:18px;color:#000;text-align:center}

    /* Ù…Ù„Ø§Ø­Ø¸Ø§Øª: Ù…Ø§ ÙŠØ¸Ù‡Ø± Ø¹Ù„Ù‰ Ø§Ù„Ø´Ø§Ø´Ø©/Ø§Ù„Ø·Ø¨Ø§Ø¹Ø© */
    .notes-screen{display:inline-block}
    .print-notes{display:none;text-align:start}

    /* ØªØ£Ø«ÙŠØ± Hover Ø¹Ù„Ù‰ ØµÙÙˆÙ Ø§Ù„Ø¬Ø¯ÙˆÙ„ */
    #evaluationsTableWrapper tbody tr > * {transition: background-color .2s ease, box-shadow .2s ease;}
    #evaluationsTableWrapper tbody tr:hover > * {
      background-color:#f1f7ff !important; box-shadow: inset 0 0 0 9999px rgba(13,110,253,.06);
    }

    /* Ø±Ø³Ø§Ù„Ø© "ØºÙŠØ± Ù…ØªÙˆÙØ±" */
    #notAvailable{min-height:60vh; align-items:center; justify-content:center; text-align:center;}

    /* ==== Ù†Ø³Ø¨ Ø¹Ø±Ø¶ Ù„Ù„Ø£Ø¹Ù…Ø¯Ø© (Ø´Ø§Ø´Ø© + Ø·Ø¨Ø§Ø¹Ø©) ==== */
    th.col-idx, td.col-idx{width:3.5%}
    th.col-college, td.col-college{width:9%}
    th.col-committee, td.col-committee{width:20%}            /* Ø§Ø³Ù… Ø§Ù„Ù„Ø¬Ù†Ø© */
    th.col-date, td.col-date{width:8%}
    th.col-consistency, td.col-consistency{width:13%}        /* Ø§Ù„ØªÙˆØ§ÙÙ‚ Ø¨ÙŠÙ† Ø§Ù„Ø¯Ø¹ÙˆØ§Øª ÙˆØ§Ù„Ø§Ø¬ØªÙ…Ø§Ø¹Ø§Øª (Ø´Ø§Ø´Ø©) */
    th.col-notes, td[col-notes]{width:22%}                   /* Ø§Ù„Ù…Ù„Ø§Ø­Ø¸Ø§Øª (Ø´Ø§Ø´Ø©) */
    /* Ø§Ù„Ø­Ù‚ÙˆÙ„ Ø§Ù„Ø±Ù‚Ù…ÙŠØ© â€“ Ù†Ø¬Ø¹Ù„Ù‡Ø§ Ø£Ø¶ÙŠÙ‚ */
    th.col-num, td.col-num{width:5%}

    /* Ø¹Ù†Ø§ØµØ± Ø³Ø·ÙˆØ± Ø§Ù„Ø¹Ù†ÙˆØ§Ù† Ø§Ù„Ù‚Ø§Ø¨Ù„Ø© Ù„Ù„ÙØµÙ„ ÙÙŠ Ø§Ù„Ø·Ø¨Ø§Ø¹Ø© */
    .hline{display:inline}
    .hline + .hline::before{content:" ";} /* Ù…Ø³Ø§ÙØ© Ø¨ÙŠÙ† Ø§Ù„ÙƒÙ„Ù…Ø§Øª Ø¹Ù„Ù‰ Ø§Ù„Ø´Ø§Ø´Ø© */

    /* ================= Ø§Ù„Ø·Ø¨Ø§Ø¹Ø© ================= */
    @media print{
      @page{ size: A4 landscape; margin: 4mm; } /* Ù‡ÙˆØ§Ù…Ø´ ØµØºÙŠØ±Ø© Ø¬Ø¯Ù‹Ø§ */

      html,body{background:#fff}
      .no-print,.toast-container,.modal{display:none!important}
      .container-fluid{margin-top:0; max-width:none; width:100%}
      .print-header{display:block;margin-bottom:6px}

      /* ØªØ®Ø·ÙŠØ· Ø«Ø§Ø¨Øª Ù„ÙŠÙ„ØªØ²Ù… Ø¨Ø¹Ø±ÙˆØ¶ Ø§Ù„Ø£Ø¹Ù…Ø¯Ø© */
      #evaluationsTableWrapper{ table-layout: fixed; width:100%; }
      #evaluationsTableWrapper thead th{
        padding-block: .65rem;     /* Ø±Ø£Ø³ Ø£Ù‚Ù„ Ø§Ø±ØªÙØ§Ø¹Ù‹Ø§ ÙÙŠ Ø§Ù„Ø·Ø¨Ø§Ø¹Ø© */
        font-size:12px;
      }
      #evaluationsTableWrapper th, #evaluationsTableWrapper td{
        font-size:12px; padding:.35rem .25rem; line-height:1.25;
        white-space:normal; overflow-wrap:anywhere; word-break:keep-all;
        writing-mode: horizontal-tb !important; text-orientation: mixed !important;
      }

      /* ØªÙÙƒÙŠÙƒ Ø§Ù„Ø¹Ù†Ø§ÙˆÙŠÙ† Ø¥Ù„Ù‰ Ø£Ø³Ø·Ø± */
      .hline{display:block}        /* ÙƒÙ„ Ø¬Ø²Ø¡ Ø¨Ø³Ø·Ø± Ù…Ø³ØªÙ‚Ù„ ÙÙŠ Ø§Ù„Ø·Ø¨Ø§Ø¹Ø© */
      .hline + .hline::before{content:""}

      /* Ø¶Ø¨Ø· Ù†Ø³Ø¨ Ø§Ù„Ø£Ø¹Ù…Ø¯Ø© Ù„Ù„Ø·Ø¨Ø§Ø¹Ø© (ØªÙ‚Ù„ÙŠÙ„ Ø§Ù„ØªÙˆØ§ÙÙ‚ ÙˆØ§Ù„Ù…Ù„Ø§Ø­Ø¸Ø§Øª Ù‚Ù„ÙŠÙ„Ø§Ù‹) */
      th.col-committee, td.col-committee{width:20%}
      th.col-consistency, td.col-consistency{width:11.5%}  /* ÙƒØ§Ù†Øª ~13% */
      th.col-notes, td[col-notes]{width:20%}               /* ÙƒØ§Ù†Øª ~22% */
      th.col-num, td.col-num{width:5%}
      th.col-college, td.col-college{width:9%}
      th.col-date, td.col-date{width:8%}
      th.col-idx, td.col-idx{width:3.5%}

      /* Ø±Ø£Ø³ Ø§Ù„Ø¬Ø¯ÙˆÙ„ ÙŠØªÙƒØ±Ø± */
      thead{display:table-header-group}

      /* Ø­Ø§ÙˆÙ„ Ù…Ù†Ø¹ Ø§Ù†Ù‚Ø³Ø§Ù… Ø§Ù„ØµÙ Ø§Ù„ÙˆØ§Ø­Ø¯ Ø¨ÙŠÙ† ØµÙØ­ØªÙŠÙ† */
      tr{ page-break-inside: avoid; break-inside: avoid; }

      /* Ø¥Ø¸Ù‡Ø§Ø± Ù…Ø­ØªÙˆÙ‰ Ø§Ù„Ù…Ù„Ø§Ø­Ø¸Ø§Øª Ù„Ù„Ø·Ø¨Ø§Ø¹Ø© */
      .notes-screen{display:none!important}
      .print-notes{display:block!important;white-space:normal}
    }
  </style>
</head>
<body>

  <!-- Ø´Ø§Ø´Ø© "Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„..." -->
  <div id="appLoader" aria-live="polite">
    <div class="spinner-border" role="status" aria-hidden="true"></div>
    <span>Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„â€¦</span>
  </div>

  <!-- Ø±Ø³Ø§Ù„Ø© Ø§Ù„Ù†ØªØ§Ø¦Ø¬ ØºÙŠØ± Ù…ØªÙˆÙØ±Ø© -->
  <div id="notAvailable" class="container d-none">
    <div class="mx-auto">
      <div class="display-6 mb-2">Ù†ØªØ§Ø¦Ø¬ ØªÙ‚ÙŠÙŠÙ… Ù„Ø¬Ø§Ù† Ø§Ù„ÙƒÙ„ÙŠØ§Øª ØºÙŠØ± Ù…ØªÙˆÙØ±Ø© Ø­Ø§Ù„ÙŠÙ‹Ø§</div>
      <p class="text-muted mb-0">ÙŠØ±Ø¬Ù‰ Ø§Ù„Ø¹ÙˆØ¯Ø© Ù„Ø§Ø­Ù‚Ù‹Ø§.</p>
    </div>
  </div>

  <!-- Ù…Ø­ØªÙˆÙ‰ Ø§Ù„ØµÙØ­Ø© Ø§Ù„Ø­Ù‚ÙŠÙ‚ÙŠ -->
  <div id="pageContent" class="container-fluid d-none">
    <div class="sticky-header">
      <h3 class="text-center mb-4">Ù†ØªØ§Ø¦Ø¬ ØªÙ‚ÙŠÙŠÙ… Ø§Ù„Ù„Ø¬Ø§Ù†</h3>

      <!-- Ø§Ù„ÙÙ„Ø§ØªØ± -->
      <div class="filters row justify-content-center no-print">
        <div class="col-md-3 mb-2 text-center">
          <label class="form-label d-block">Ø§Ù„ÙƒÙ„ÙŠØ©</label> <!-- ØªÙ… ØªØµØ­ÙŠØ­ d-block -->
          <select id="collegeFilter" class="form-select">
            <option value="">Ø¬Ù…ÙŠØ¹ Ø§Ù„ÙƒÙ„ÙŠØ§Øª</option>
          </select>
        </div>
        <div class="col-md-3 mb-2 text-center">
          <label class="form-label d-block">Ø§Ù„Ø¨Ø­Ø« Ø¨Ø¥Ø³Ù… Ø§Ù„Ù„Ø¬Ù†Ø©</label>
          <input type="text" id="committeeSearch" class="form-control" placeholder="Ø§ÙƒØªØ¨ Ù„Ù„Ø¨Ø­Ø«...">
        </div>
      </div>

      <!-- Ø£Ø¯ÙˆØ§Øª Ø¨Ø³ÙŠØ·Ø© + Ø·Ø¨Ø§Ø¹Ø©/ØªØ­Ø¯ÙŠØ« -->
      <div class="row mb-3 justify-content-center no-print">
        <div class="col-md-8 d-flex align-items-center justify-content-center gap-4">
          <div class="form-check">
            <input class="form-check-input simple-toggle" type="checkbox" id="toggle_college" checked>
            <label class="form-check-label" for="toggle_college">Ø¥Ø¸Ù‡Ø§Ø± Ø§Ù„ÙƒÙ„ÙŠØ©</label>
          </div>
          <div class="form-check">
            <input class="form-check-input simple-toggle" type="checkbox" id="toggle_date">
            <label class="form-check-label" for="toggle_date">Ø¥Ø¸Ù‡Ø§Ø± ØªØ§Ø±ÙŠØ® Ø§Ù„ØªØ¯Ù‚ÙŠÙ‚</label>
          </div>
          <button class="btn btn-secondary" id="printBtn" title="Ø·Ø¨Ø§Ø¹Ø©"><i class="bi bi-printer"></i></button>
          <button class="btn btn-info" id="reloadBtn" title="Ø¥Ø¹Ø§Ø¯Ø© ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª ÙˆØ§Ù„Ø¬Ø¯ÙˆÙ„"><i class="bi bi-arrow-repeat"></i></button>
        </div>
      </div>

      <!-- Ø±Ø£Ø³ Ø§Ù„Ø·Ø¨Ø§Ø¹Ø© -->
      <div id="infoContainer" class="print-header">
        <div id="semesterInfo">â€”</div>
        <div id="selectedVisitsContainer">â€”</div>
        <div id="completionRateContainer">â€”</div>
        <div id="committeesCountContainer">â€”</div>
      </div>
    </div>

    <table class="table table-bordered table-striped" id="evaluationsTableWrapper">
      <thead>
        <tr>
          <th class="col-idx">#</th>
          <th class="col-college">Ø§Ù„ÙƒÙ„ÙŠØ©</th>
          <th class="col-committee">Ø§Ø³Ù… Ø§Ù„Ù„Ø¬Ù†Ø©</th>
          <th class="date-col col-date hidden-col">ØªØ§Ø±ÙŠØ® Ø§Ù„ØªØ¯Ù‚ÙŠÙ‚</th>

          <th class="col-num col-formation_decision">
            <span class="hline">Ù‚Ø±Ø§Ø±</span><span class="hline">Ø§Ù„ØªØ´ÙƒÙŠÙ„</span>
          </th>
          <th class="col-num col-work_plan">
            <span class="hline">Ø®Ø·Ø©</span><span class="hline">Ø§Ù„Ø¹Ù…Ù„</span>
          </th>
          <th class="col-num col-performance_indicators">
            <span class="hline">Ù…Ø¤Ø´Ø±Ø§Øª</span><span class="hline">Ø§Ù„Ø£Ø¯Ø§Ø¡</span>
          </th>
          <th class="col-num col-meetings">
            <span class="hline">Ø¹Ø¯Ø¯</span><span class="hline">Ø§Ù„Ø§Ø¬ØªÙ…Ø§Ø¹Ø§Øª</span>
          </th>
          <th class="col-consistency">
            <span class="hline">Ø§Ù„ØªÙˆØ§ÙÙ‚ Ø¨ÙŠÙ†</span><span class="hline">Ø§Ù„Ø¯Ø¹ÙˆØ§Øª</span><span class="hline">ÙˆØ§Ù„Ø§Ø¬ØªÙ…Ø§Ø¹Ø§Øª</span>
          </th>
          <th class="col-num col-coverage_books">
            <span class="hline">ÙƒØªØ¨</span><span class="hline">Ø§Ù„ØªØºØ·ÙŠØ©</span>
          </th>
          <th class="col-num col-report1">ØªÙ‚Ø±ÙŠØ± Ø¥Ù†Ø¬Ø§Ø² 1</th>
          <th class="col-num col-report2">ØªÙ‚Ø±ÙŠØ± Ø¥Ù†Ø¬Ø§Ø² 2</th>
          <th class="col-num col-report3">ØªÙ‚Ø±ÙŠØ± Ø¥Ù†Ø¬Ø§Ø² 3</th>
          <th class="col-num col-statistical_analysis">
            <span class="hline">Ø§Ù„ØªØ­Ù„ÙŠÙ„</span><span class="hline">Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠ</span>
          </th>

          <!-- Ø³Ù†Ù…Ù„Ø¤Ù‡ Ø¯ÙŠÙ†Ø§Ù…ÙŠÙƒÙŠØ§Ù‹ Ø¨Ù†ÙØ³ Ø§Ù„Ø¨Ù†ÙŠØ© Ù…ØªØ¹Ø¯Ø¯Ø© Ø§Ù„Ø£Ø³Ø·Ø± -->
          <th id="availabilityHeader" class="col-num"></th>
          <th class="col-notes">Ø§Ù„Ù…Ù„Ø§Ø­Ø¸Ø§Øª</th>
        </tr>
      </thead>
      <tbody id="committeesTable">
        <tr><td colspan="16" class="text-center">Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...</td></tr>
      </tbody>
    </table>
  </div>

  <!-- Modal Ø§Ù„Ù…Ù„Ø§Ø­Ø¸Ø§Øª Ù„Ù„Ø´Ø§Ø´Ø© ÙÙ‚Ø· -->
  <div class="modal fade no-print" id="notesModal" tabindex="-1">
    <div class="modal-dialog modal-lg"><div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">ğŸ“ Ø§Ù„Ù…Ù„Ø§Ø­Ø¸Ø§Øª</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body" id="notesContent"></div>
    </div></div>
  </div>

  <!-- Toasts -->
  <div class="toast-container position-fixed top-0 start-50 translate-middle-x p-3 no-print">
    <div id="toastSuccess" class="toast align-items-center text-bg-success border-0 mb-2" role="alert">
      <div class="d-flex"><div class="toast-body">âœ… Ø§Ù„Ø¹Ù…Ù„ÙŠØ© Ù†Ø¬Ø­Øª</div>
        <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button>
      </div>
    </div>
    <div id="toastError" class="toast align-items-center text-bg-danger border-0 mb-2" role="alert">
      <div class="d-flex"><div class="toast-body">âŒ Ø­Ø¯Ø« Ø®Ø·Ø£</div>
        <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button>
      </div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
  <script>
    /* ===== Ø³Ø¬Ù„Ø§Øª Ø£Ø®Ø·Ø§Ø¡ Ø¹Ø§Ù…Ø© Ù„Ù„Ù…Ø³Ø§Ø¹Ø¯Ø© ÙÙŠ Ø§Ù„ØªØ´Ø®ÙŠØµ ===== */
    window.addEventListener('error', e => console.error('WindowError:', e.message, e.filename, e.lineno));
    window.addEventListener('unhandledrejection', e => console.error('PromiseRejection:', e.reason));

    /* ===== ØªÙˆØ³ØªØ§Øª ===== */
    const toastSuccess = new bootstrap.Toast(document.getElementById('toastSuccess'));
    const toastError   = new bootstrap.Toast(document.getElementById('toastError'));
    const showSuccess  = (m='âœ… Ø§Ù„Ø¹Ù…Ù„ÙŠØ© Ù†Ø¬Ø­Øª')=>{ document.querySelector('#toastSuccess .toast-body').innerText=m; toastSuccess.show(); };
    const showError    = (m='âŒ Ø­Ø¯Ø« Ø®Ø·Ø£')     =>{ document.querySelector('#toastError .toast-body').innerText=m; toastError.show();   };

    /* ===== Ø£Ø¹Ù„Ø§Ù… Ø§Ù„Ø­Ø§Ù„Ø© ===== */
    let savedVisibleColumns = [];  // Ù…Ù† Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª
    let lastCollege = '';          // Ù…Ù† Ø§Ù„ÙÙ„ØªØ± Ø§Ù„Ø­Ø§Ù„ÙŠ
    let settingsCache = null;      // Ù†Ø®Ø²Ù† Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ù„Ù„Ø·Ø¨Ø§Ø¹Ø©
    let PUBLISH_RESULTS = false;   // Ø§Ù„Ø­Ù‚Ù„ Ø§Ù„Ø°ÙŠ Ù†ØªØ­ÙƒÙ… Ø¨Ù‡ Ù…Ù† /api/settings

    const availabilityFields = ["formation_decision","work_plan","performance_indicators","meetings","consistency","coverage_books","report1","report2","report3","statistical_analysis"];

    /* ===== ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù‚ÙˆØ§Ø¦Ù… ===== */
    async function loadOptions(){
      try{
        const { data } = await axios.get('/api/colleges');
        const collegeFilter = document.getElementById('collegeFilter');
        // Ø§Ù…Ø³Ø­ Ø§Ù„Ø®ÙŠØ§Ø±Ø§Øª (Ø¹Ø¯Ø§ "Ø¬Ù…ÙŠØ¹ Ø§Ù„ÙƒÙ„ÙŠØ§Øª") Ø¹Ù†Ø¯ Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„ØªØ­Ù…ÙŠÙ„
        collegeFilter.querySelectorAll('option:not(:first-child)').forEach(o=>o.remove());
        (data||[]).forEach(c=>{
          const opt=document.createElement('option');
          opt.value=c.name; opt.textContent=c.name;
          collegeFilter.appendChild(opt);
        });
      }catch(e){ console.warn('loadOptions error', e); }
    }

    /* ===== Sanitizer Ù„Ù„Ù…Ù„Ø§Ø­Ø¸Ø§Øª (Ù„Ù„Ø´Ø§Ø´Ø© ÙˆØ§Ù„Ø·Ø¨Ø§Ø¹Ø©) ===== */
    function sanitizeNotes(html=''){
      try{
        const allowed=['P','UL','OL','LI','B','STRONG','I','EM','U','BR'];
        const tmp=document.createElement('div'); tmp.innerHTML = html;
        const walker=document.createTreeWalker(tmp, NodeFilter.SHOW_ELEMENT, null);
        const toRemove=[];
        while(walker.nextNode()){
          const el=walker.currentNode;
          if(!allowed.includes(el.tagName)) toRemove.push(el);
          for(const a of Array.from(el.attributes||[])){
            const name=a.name.toLowerCase();
            if(name.startsWith('on') || name==='style') el.removeAttribute(a.name);
          }
        }
        toRemove.forEach(n=>n.replaceWith(document.createTextNode(n.textContent||'')));
        return tmp.innerHTML.trim() || 'â€”';
      }catch{return 'â€”'}
    }

    /* ===== ØªØ¹ÙŠÙŠÙ† Ø¹Ù†ÙˆØ§Ù† "Ø¯Ø±Ø¬Ø© Ø§Ù„ØªÙˆÙØ±" Ù…ØªØ¹Ø¯Ø¯ Ø§Ù„Ø£Ø³Ø·Ø± Ù…Ø¹ Ø±Ù‚Ù… Ø¯ÙŠÙ†Ø§Ù…ÙŠÙƒÙŠ ===== */
    function renderAvailabilityHeader(n){
      const h = document.getElementById('availabilityHeader');
      h.innerHTML = `
        <span class="hline">Ø¯Ø±Ø¬Ø©</span>
        <span class="hline">Ø§Ù„ØªÙˆÙØ±</span>
        <span class="hline">Ù…Ù†</span>
        <span class="hline">(${n})</span>
      `;
    }

    /* ===== ØªØ­Ø¯ÙŠØ« Ø¹Ù†ÙˆØ§Ù† Ø§Ù„ØªÙˆÙØ± ===== */
    function updateAvailabilityHeader(){
      const n=savedVisibleColumns.length;
      renderAvailabilityHeader(n);
    }

    /* ===== Ø­Ø³Ø§Ø¨ Ø¯Ø±Ø¬Ø© Ø§Ù„ØªÙˆÙØ± Ù„Ù„ØµÙ ===== */
    function updateAvailability(row){
      let sum=0;
      availabilityFields.forEach(f=>{
        const cell=row.querySelector(\`[data-field="\${f}"]\`);
        if(cell && !cell.classList.contains('hidden-col')){
          sum += parseFloat(cell.innerText)||0;
        }
      });
      const target=row.querySelector('.availability-cell');
      if(target){
        target.innerText=sum.toFixed(2);
        target.classList.add('highlight');
        setTimeout(()=>target.classList.remove('highlight'),800);
      }
    }

    /* ===== Ù†Ø³Ø¨Ø© Ø§Ù„Ø§ÙƒØªÙ…Ø§Ù„ + Ø¹Ø¯Ø¯ Ø§Ù„Ù„Ø¬Ø§Ù† ===== */
    function updateCompletionAndCounts(){
      const rows=[...document.querySelectorAll('#committeesTable tr')].filter(r=>r.style.display!=='none');
      let total=0;
      rows.forEach(r=>{ total += parseFloat(r.querySelector('.availability-cell')?.innerText)||0; });
      const denom = rows.length * savedVisibleColumns.length;
      const pct = denom>0 ? ((total/denom)*100).toFixed(2) : '0.00';

      const completionDiv=document.getElementById('completionRateContainer');
      const countDiv=document.getElementById('committeesCountContainer');
      const lc = lastCollege || 'Ø¬Ù…ÙŠØ¹ Ø§Ù„ÙƒÙ„ÙŠØ§Øª';
      if(lc && lc!=='Ø¬Ù…ÙŠØ¹ Ø§Ù„ÙƒÙ„ÙŠØ§Øª'){
        completionDiv.innerHTML = \`Ù†Ø³Ø¨Ø© Ø§Ù„Ø§ÙƒØªÙ…Ø§Ù„ Ù„ÙƒÙ„ÙŠØ© \${lc} = \${pct}%\`;
        countDiv.innerHTML      = \`Ø¹Ø¯Ø¯ Ù„Ø¬Ø§Ù† ÙƒÙ„ÙŠØ© \${lc} = \${rows.length}\`;
      }else{
        completionDiv.innerHTML = \`Ù†Ø³Ø¨Ø© Ø§Ù„Ø§ÙƒØªÙ…Ø§Ù„ Ù„Ø¬Ù…ÙŠØ¹ Ø§Ù„ÙƒÙ„ÙŠØ§Øª = \${pct}%\`;
        countDiv.innerHTML      = \`Ø¹Ø¯Ø¯ Ù„Ø¬Ø§Ù† Ø¬Ù…ÙŠØ¹ Ø§Ù„ÙƒÙ„ÙŠØ§Øª = \${rows.length}\`;
      }
    }

    /* ===== ØªØ·Ø¨ÙŠÙ‚ Ø±Ø¤ÙŠØ© Ø§Ù„Ø£Ø¹Ù…Ø¯Ø© ===== */
    function applyColumnVisibility(){
      const showCollege=document.getElementById('toggle_college').checked;
      document.querySelectorAll('.col-college, td.col-college').forEach(el=>el.classList.toggle('hidden-col',!showCollege));

      const showDate=document.getElementById('toggle_date').checked;
      document.querySelectorAll('.date-col').forEach(el=>el.classList.toggle('hidden-col',!showDate));

      availabilityFields.forEach(f=>{
        const show = savedVisibleColumns.includes(f);
        document.querySelectorAll(\`[data-field="\${f}"]\`).forEach(td=>td.classList.toggle('hidden-col', !show));
        const th=document.querySelector(\`.col-\${f}\`);
        if(th) th.classList.toggle('hidden-col', !show);
      });

      // Ø¥Ø®ÙØ§Ø¡/Ø¥Ø¸Ù‡Ø§Ø± Ø¹Ù…ÙˆØ¯ Ø§Ù„Ù…Ù„Ø§Ø­Ø¸Ø§Øª Ù„Ùˆ Ù„Ù… ØªÙˆØ¬Ø¯ Ø£Ø¹Ù…Ø¯Ø© Ø±Ù‚Ù…ÙŠØ© Ø¸Ø§Ù‡Ø±Ø©
      const hideNotes = savedVisibleColumns.length === 0;
      const notesHeader = document.querySelector('#evaluationsTableWrapper th.col-notes');
      if (notesHeader) notesHeader.classList.toggle('hidden-col', hideNotes);
      document.querySelectorAll('#evaluationsTableWrapper td[data-notes-col], #evaluationsTableWrapper td[col-notes]').forEach(td=>{
        td.classList.toggle('hidden-col', hideNotes);
      });

      document.querySelectorAll('#committeesTable tr').forEach(updateAvailability);
      updateAvailabilityHeader();
      updateCompletionAndCounts();
    }

    document.querySelectorAll('.simple-toggle').forEach(cb=>{
      cb.addEventListener('change', applyColumnVisibility);
    });

    /* ===== Ø§Ù„Ø¨Ø­Ø« Ø¨Ø§Ø³Ù… Ø§Ù„Ù„Ø¬Ù†Ø© ===== */
    function applyCommitteeSearch(){
      const term=document.getElementById('committeeSearch').value.trim().toLowerCase();
      document.querySelectorAll('#committeesTable tr').forEach(row=>{
        const name=row.querySelector('td.col-committee')?.innerText.trim().toLowerCase()||'';
        row.style.display = name.includes(term)? '': 'none';
      });
      updateCompletionAndCounts();
    }
    document.getElementById('committeeSearch').addEventListener('input', applyCommitteeSearch);

    /* ===== ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª ===== */
    async function loadSettings(){
      const semesterEl=document.getElementById('semesterInfo');
      const visitsEl  =document.getElementById('selectedVisitsContainer');
      const na = document.getElementById('notAvailable');
      const pc = document.getElementById('pageContent');

      try{
        const {data} = await axios.get('/api/settings');
        settingsCache = data || {};
        PUBLISH_RESULTS = !!settingsCache.publishResults;

        if(!PUBLISH_RESULTS){
          na.classList.remove('d-none'); na.classList.add('d-flex');
          pc.classList.add('d-none');
          return false;
        }

        // Ù…ÙØ¹Ù‘Ù„ => Ø¥Ø¸Ù‡Ø§Ø± Ø§Ù„ØµÙØ­Ø© ÙˆØ¥Ø®ÙØ§Ø¡ Ø§Ù„Ø±Ø³Ø§Ù„Ø©
        na.classList.add('d-none'); na.classList.remove('d-flex');
        pc.classList.remove('d-none');

        savedVisibleColumns = settingsCache.visibleColumns || [];

        const t = settingsCache.term || 'â€”';
        const ay= settingsCache.academicYear || 'â€”';
        semesterEl.textContent = \`\${t} - \${ay}\`;

        const visits = Array.isArray(settingsCache.selectedVisits) && settingsCache.selectedVisits.length
          ? settingsCache.selectedVisits.join(' | ')
          : 'Ù„Ù… ÙŠØªÙ… Ø§Ø®ØªÙŠØ§Ø± Ø£ÙŠ Ø²ÙŠØ§Ø±Ø©';
        visitsEl.textContent = \`Ø§Ù„Ø²ÙŠØ§Ø±Ø§Øª: \${visits}\`;

        return true;
      }catch(e){
        console.warn('loadSettings error', e);
        // ÙÙŠ Ø­Ø§Ù„Ø© Ø§Ù„Ø®Ø·Ø£ Ù†ØªØµØ±Ù ÙƒØ£Ù† Ø§Ù„Ù†Ø´Ø± ØºÙŠØ± Ù…ÙØ¹Ù‘Ù„ (Ø£ÙƒØ«Ø± Ø£Ù…Ø§Ù†Ù‹Ø§)
        na.classList.remove('d-none'); na.classList.add('d-flex');
        pc.classList.add('d-none');
        return false;
      }
    }

    /* ===== ØªØ­Ù…ÙŠÙ„ Ø¬Ø¯ÙˆÙ„ Ø§Ù„Ù„Ø¬Ø§Ù† ===== */
    async function loadCommittees(){
      try{
        const college=document.getElementById('collegeFilter').value;
        lastCollege = college || 'Ø¬Ù…ÙŠØ¹ Ø§Ù„ÙƒÙ„ÙŠØ§Øª';
        let url='/api/committees';
        const params=[];
        if(college) params.push('college='+encodeURIComponent(college));
        if(params.length) url+='?'+params.join('&');

        const res=await axios.get(url);
        const tbody=document.getElementById('committeesTable');
        tbody.innerHTML='';

        const arr=Array.isArray(res.data)?res.data:[];
        if(!arr.length){
          tbody.innerHTML=`<tr><td colspan="16" class="text-center">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª</td></tr>`;
          updateAvailabilityHeader();
          document.getElementById('completionRateContainer').textContent='';
          document.getElementById('committeesCountContainer').textContent='';
          return;
        }

        // ØªØ±ØªÙŠØ¨ Ø§ÙØªØ±Ø§Ø¶ÙŠ Ø­Ø³Ø¨ Ø§Ù„ÙƒÙ„ÙŠØ©
        arr.sort((a,b)=>(a.college||'').localeCompare(b.college||'','ar'));

        // Ø±Ø³Ù… Ø§Ù„ØµÙÙˆÙ
        arr.forEach((c,idx)=>{
          const tr=document.createElement('tr');
          const dateTxt = c.audit_date ? new Date(c.audit_date).toLocaleDateString('ar-EG'): '-';
          const notesHtml = (c.notes||'').trim();
          const hasNotes  = !!notesHtml && notesHtml!=='<p><br></p>' && notesHtml!=='<br>';

          tr.innerHTML = `
            <td class="col-idx">${idx+1}</td>
            <td class="col-college">${c.college??''}</td>
            <td class="col-committee">${c.committee_name??''}</td>
            <td class="date-col col-date hidden-col">${dateTxt}</td>
            <td class="col-num" data-field="formation_decision">${c.formation_decision ?? 0}</td>
            <td class="col-num" data-field="work_plan">${c.work_plan ?? 0}</td>
            <td class="col-num" data-field="performance_indicators">${c.performance_indicators ?? 0}</td>
            <td class="col-num" data-field="meetings">${c.meetings ?? 0}</td>
            <td class="col-consistency" data-field="consistency">${c.consistency ?? 0}</td>
            <td class="col-num" data-field="coverage_books">${c.coverage_books ?? 0}</td>
            <td class="col-num" data-field="report1">${c.report1 ?? 0}</td>
            <td class="col-num" data-field="report2">${c.report2 ?? 0}</td>
            <td class="col-num" data-field="report3">${c.report3 ?? 0}</td>
            <td class="col-num" data-field="statistical_analysis">${c.statistical_analysis ?? 0}</td>
            <td class="col-num availability-cell">${c.availability_score ?? 0}</td>
            <td col-notes data-notes-col>
              <span class="notes-screen">
                ${ hasNotes ? `<button class="btn btn-sm btn-info" title="Ø¹Ø±Ø¶ Ø§Ù„Ù…Ù„Ø§Ø­Ø¸Ø§Øª" data-notes="1">ğŸ”</button>` : '<span class="text-muted">Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ù„Ø§Ø­Ø¸Ø§Øª</span>' }
              </span>
              <div class="print-notes">${hasNotes ? sanitizeNotes(notesHtml) : 'â€”'}</div>
            </td>
          `;
          // Ø²Ø± Ø¹Ø±Ø¶ Ø§Ù„Ù…Ù„Ø§Ø­Ø¸Ø§Øª (Ø´Ø§Ø´Ø© ÙÙ‚Ø·) â€” Ù…ÙØ¹Ù‚Ù‘Ù…
          const btn = tr.querySelector('[data-notes]');
          if(btn){
            btn.addEventListener('click',()=>{
              document.getElementById('notesContent').innerHTML = hasNotes ? sanitizeNotes(notesHtml) : '<i>Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ù„Ø§Ø­Ø¸Ø§Øª</i>';
              new bootstrap.Modal(document.getElementById('notesModal')).show();
            });
          }
          document.getElementById('committeesTable').appendChild(tr);
          updateAvailability(tr);
        });

        applyColumnVisibility();
        applyCommitteeSearch();
      }catch(err){
        console.error('loadCommittees error', err);
        showError('âŒ ÙØ´Ù„ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª');
        const tbody=document.getElementById('committeesTable');
        tbody.innerHTML=`<tr><td colspan="16" class="text-center text-danger">ÙØ´Ù„ Ø§Ù„Ø¬Ù„Ø¨</td></tr>`;
      }
    }

    /* ===== Ø·Ø¨Ø§Ø¹Ø© ===== */
    document.getElementById('printBtn').addEventListener('click', ()=> {
      updateCompletionAndCounts();
      window.print();
    });

    /* ===== Ø£Ø­Ø¯Ø§Ø« Ø¹Ø§Ù…Ø© ===== */
    document.getElementById('collegeFilter').addEventListener('change', async ()=>{
      if(!PUBLISH_RESULTS) return;
      await loadCommittees();
    });
    document.getElementById('reloadBtn').addEventListener('click', async ()=>{
      const ok = await loadSettings();
      if(ok){
        await loadOptions();
        await loadCommittees();
      }
    });

    /* ===== ØªØ´ØºÙŠÙ„ Ø£ÙˆÙ„ÙŠ Ù…Ø¹ Ø´Ø§Ø´Ø© Ø§Ù„ØªØ­Ù…ÙŠÙ„ ===== */
    (async function init(){
      try{
        const ok = await loadSettings();
        if(ok){
          await loadOptions();
          await loadCommittees();
        }
        // Ø¬Ù‡Ù‘Ø² Ø¹Ù†ÙˆØ§Ù† "Ø¯Ø±Ø¬Ø© Ø§Ù„ØªÙˆÙØ±" Ø­ØªÙ‰ Ù‚Ø¨Ù„ Ø§Ù„Ø¬Ù„Ø¨ Ø§Ù„Ø£ÙˆÙ„
        updateAvailabilityHeader();
      }catch(e){
        console.error('init error:', e);
      }finally{
        // Ø¥Ù†Ù‡Ø§Ø¡ Ø´Ø§Ø´Ø© Ø§Ù„ØªØ­Ù…ÙŠÙ„ Ø¨ØºØ¶Ù‘ Ø§Ù„Ù†Ø¸Ø± Ø¹Ù† Ø§Ù„Ø­Ø§Ù„Ø©
        document.documentElement.classList.remove('app-loading');
        document.documentElement.classList.add('app-ready');
      }
    })();
  </script>
</body>
</html>
