<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8">
  <title>Ù„ÙˆØ­Ø© Ù…ØªØ§Ø¨Ø¹Ø© Ø§Ù„ØªÙ‚ÙŠÙŠÙ…Ø§Øª</title>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.rtl.min.css">
  <style>
    body { background-color: #f8f9fa; font-family: 'Segoe UI', sans-serif; }
    .container { margin-top: 30px; }
    table { background: #fff; border-radius: 10px; overflow: hidden; }
    th { background-color: #0d6efd; color: #fff; }
    .filters { margin-bottom: 20px; }
    .export-buttons { margin: 20px 0; }

    /* âœ… Ø¹Ù†Ø¯ Ø§Ù„Ø·Ø¨Ø§Ø¹Ø© ÙÙ‚Ø· ÙŠØ¸Ù‡Ø± Ø§Ù„Ø¬Ø¯ÙˆÙ„ */
    @media print {
      body * {
        visibility: hidden;
      }
      #evaluationsTableWrapper, #evaluationsTableWrapper * {
        visibility: visible;
      }
      #evaluationsTableWrapper {
        position: absolute;
        left: 0;
        top: 0;
        width: 100%;
      }
    }
  </style>
</head>
<body>
  <div class="container">
    <h3 class="text-center mb-4">ğŸ“Š Ù„ÙˆØ­Ø© Ù…ØªØ§Ø¨Ø¹Ø© Ø§Ù„ØªÙ‚ÙŠÙŠÙ…Ø§Øª</h3>

    <!-- Ø§Ù„ÙÙ„Ø§ØªØ± -->
    <div class="filters row">
      <div class="col-md-6 mb-2">
        <label class="form-label">Ø§Ù„ÙƒÙ„ÙŠØ©</label>
        <select id="collegeFilter" class="form-select">
          <option value="">Ø¬Ù…ÙŠØ¹ Ø§Ù„ÙƒÙ„ÙŠØ§Øª</option>
        </select>
      </div>
      <div class="col-md-6 mb-2">
        <label class="form-label">Ø§Ø³Ù… Ø§Ù„Ù…Ø¯Ù‚Ù‚</label>
        <select id="auditorFilter" class="form-select">
          <option value="">Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù…Ø¯Ù‚Ù‚ÙŠÙ†</option>
        </select>
      </div>
    </div>

    <!-- Ø£Ø²Ø±Ø§Ø± Ø§Ù„ØªØµØ¯ÙŠØ± -->
    <div class="export-buttons text-center">
      <button class="btn btn-success" onclick="exportToExcel()">ğŸ“¥ ØªØµØ¯ÙŠØ± Excel</button>
      <button class="btn btn-danger" onclick="exportToPDF()">ğŸ“„ ØªØµØ¯ÙŠØ± PDF</button>
      <button class="btn btn-secondary" onclick="printTable()">ğŸ–¨ï¸ Ø·Ø¨Ø§Ø¹Ø©</button>
    </div>

    <!-- Ø§Ù„Ø¬Ø¯ÙˆÙ„ -->
    <table class="table table-bordered table-striped" id="evaluationsTableWrapper">
      <thead>
        <tr>
          <th>#</th>
          <th>Ø§Ù„ÙƒÙ„ÙŠØ©</th>
          <th>Ø§Ø³Ù… Ø§Ù„Ù„Ø¬Ù†Ø©</th>
          <th>Ø§Ø³Ù… Ø§Ù„Ù…Ø¯Ù‚Ù‚</th>
          <th>ØªØ§Ø±ÙŠØ® Ø§Ù„ØªØ¯Ù‚ÙŠÙ‚</th>
          <th>Ø¯Ø±Ø¬Ø© Ø§Ù„ØªÙˆÙØ±</th>
          <th>Ù…Ù„Ø§Ø­Ø¸Ø§Øª</th>
        </tr>
      </thead>
      <tbody id="evaluationsTable">
        <tr><td colspan="7" class="text-center">Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...</td></tr>
      </tbody>
    </table>
  </div>

  <!-- Ù…ÙƒØªØ¨Ø§Øª -->
  <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/xlsx/dist/xlsx.full.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.23/jspdf.plugin.autotable.min.js"></script>

  <!-- Ø®Ø· Amiri Ù…Ø¯Ù…Ø¬ Base64 (Ù…Ù† Ù…Ø³ØªÙˆØ¯Ø¹Ùƒ) -->
  <script src="https://cdn.jsdelivr.net/gh/LaithObidat85/video-dashboard/public/fonts/amiri.js"></script>

  <script>
    async function loadFilters() {
      try {
        // Ø¬Ù„Ø¨ Ø§Ù„ÙƒÙ„ÙŠØ§Øª
        const colleges = await axios.get('/api/colleges');
        const collegeSelect = document.getElementById('collegeFilter');
        colleges.data.forEach(c => {
          const opt = document.createElement('option');
          opt.value = c.name;
          opt.textContent = c.name;
          collegeSelect.appendChild(opt);
        });

        // Ø¬Ù„Ø¨ Ø§Ù„Ù…Ø¯Ù‚Ù‚ÙŠÙ†
        const auditors = await axios.get('/api/auditors');
        const auditorSelect = document.getElementById('auditorFilter');
        auditors.data.forEach(a => {
          const opt = document.createElement('option');
          opt.value = a.name;
          opt.textContent = a.name;
          auditorSelect.appendChild(opt);
        });
      } catch (err) {
        console.error("Ø®Ø·Ø£ ÙÙŠ Ø¬Ù„Ø¨ Ø§Ù„ÙÙ„Ø§ØªØ±:", err);
      }
    }

    async function loadEvaluations() {
      try {
        const college = document.getElementById('collegeFilter').value;
        const auditor = document.getElementById('auditorFilter').value;

        let url = '/api/committees';
        const params = [];
        if (college) params.push(`college=${encodeURIComponent(college)}`);
        if (auditor) params.push(`auditor_name=${encodeURIComponent(auditor)}`);
        if (params.length > 0) url += '?' + params.join('&');

        const res = await axios.get(url);
        const tbody = document.getElementById('evaluationsTable');
        tbody.innerHTML = "";

        if (res.data.length === 0) {
          tbody.innerHTML = `<tr><td colspan="7" class="text-center">Ù„Ø§ ØªÙˆØ¬Ø¯ ØªÙ‚ÙŠÙŠÙ…Ø§Øª</td></tr>`;
          return;
        }

        res.data.forEach((ev, index) => {
          const tr = document.createElement('tr');
          tr.innerHTML = `
            <td>${index + 1}</td>
            <td>${ev.college || '-'}</td>
            <td>${ev.committee_name || '-'}</td>
            <td>${ev.auditor_name || '-'}</td>
            <td>${ev.audit_date ? new Date(ev.audit_date).toLocaleDateString('ar-EG') : '-'}</td>
            <td>${ev.availability_score ?? 0}</td>
            <td>${ev.notes || '-'}</td>
          `;
          tbody.appendChild(tr);
        });
      } catch (err) {
        console.error("Ø®Ø·Ø£ ÙÙŠ Ø¬Ù„Ø¨ Ø§Ù„ØªÙ‚ÙŠÙŠÙ…Ø§Øª:", err);
      }
    }

    // ğŸ”¹ Excel
    function exportToExcel() {
      const table = document.getElementById("evaluationsTableWrapper");
      const wb = XLSX.utils.table_to_book(table, { sheet: "Ø§Ù„ØªÙ‚ÙŠÙŠÙ…Ø§Øª" });
      XLSX.writeFile(wb, "Ø§Ù„ØªÙ‚ÙŠÙŠÙ…Ø§Øª.xlsx", { bookType: "xlsx", bookSST: true });
    }

    // ğŸ”¹ PDF (RTL)
    function exportToPDF() {
      const { jsPDF } = window.jspdf;
      const doc = new jsPDF({ orientation: 'landscape' });

      // Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø®Ø· Ø§Ù„Ø¹Ø±Ø¨ÙŠ
      doc.addFileToVFS("Amiri-Regular.ttf", amiriBase64);
      doc.addFont("Amiri-Regular.ttf", "Amiri", "normal");
      doc.setFont("Amiri");

      doc.text("ğŸ“Š ØªÙ‚Ø±ÙŠØ± Ø§Ù„ØªÙ‚ÙŠÙŠÙ…Ø§Øª", 140, 20, { align: "center" });

      // Ø§Ø³ØªØ®Ø±Ø§Ø¬ Ø§Ù„Ø£Ø¹Ù…Ø¯Ø© ÙˆØ§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø¨Ù†ÙØ³ ØªØ±ØªÙŠØ¨ RTL
      const headers = [];
      document.querySelectorAll("#evaluationsTableWrapper thead tr th").forEach(th => {
        headers.push(th.innerText);
      });

      const data = [];
      document.querySelectorAll("#evaluationsTableWrapper tbody tr").forEach(tr => {
        const row = [];
        tr.querySelectorAll("td").forEach(td => row.push(td.innerText));
        data.push(row);
      });

      // Ø¹ÙƒØ³ ØªØ±ØªÙŠØ¨ Ø§Ù„Ø£Ø¹Ù…Ø¯Ø© Ù„Ù„Ù€ RTL
      const rtlHeaders = headers.reverse();
      const rtlData = data.map(r => r.reverse());

      doc.autoTable({
        head: [rtlHeaders],
        body: rtlData,
        startY: 30,
        styles: { font: "Amiri", fontStyle: "normal", halign: "right" },
        headStyles: { fillColor: [13, 110, 253] }
      });

      doc.save("Ø§Ù„ØªÙ‚ÙŠÙŠÙ…Ø§Øª.pdf");
    }

    // ğŸ”¹ Print (Ø§Ù„Ø¬Ø¯ÙˆÙ„ ÙÙ‚Ø·)
    function printTable() {
      window.print();
    }

    // ØªØ­Ù…ÙŠÙ„ Ø§Ù„ÙÙ„Ø§ØªØ± ÙˆØ§Ù„ØªÙ‚ÙŠÙŠÙ…Ø§Øª Ø¹Ù†Ø¯ ÙØªØ­ Ø§Ù„ØµÙØ­Ø©
    loadFilters().then(loadEvaluations);

    // Ø¥Ø¹Ø§Ø¯Ø© ØªØ­Ù…ÙŠÙ„ Ø¹Ù†Ø¯ ØªØºÙŠÙŠØ± Ø§Ù„ÙÙ„Ø§ØªØ±
    document.getElementById('collegeFilter').addEventListener('change', loadEvaluations);
    document.getElementById('auditorFilter').addEventListener('change', loadEvaluations);
  </script>
</body>
</html>
