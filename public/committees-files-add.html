<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <title>Ø¥Ø¶Ø§ÙØ© Ø±ÙˆØ§Ø¨Ø· Ù…Ù„ÙØ§Øª Ø§Ù„Ù„Ø¬Ø§Ù† - Ù†Ø¸Ø§Ù… Ø§Ù„Ù„Ø¬Ø§Ù†</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <link rel="icon" type="image/png" href="https://www.dropbox.com/scl/fi/f283e4rvv5cf9x12a1cic/my-website-logo.png?rlkey=yia776im7klypy27af32m0scy&e=1&dl=1">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.rtl.min.css">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css">
  <style>
    body{background:#f8f9fa;font-family:'Segoe UI',sans-serif}
    .container{margin-top:40px;max-width:98vw}
    .user-chip{display:inline-flex;align-items:center;gap:.25rem;font-size:1rem!important;padding:.375rem .75rem!important;line-height:1.5!important;border-radius:.375rem;font-weight:700!important}
    .user-chip.badge #userRole{font-weight:500!important}
    .muted{color:#6c757d}
    .toast-container{position:fixed;top:20px;left:50%;transform:translateX(-50%);z-index:2000}
    .required-asterisk{color:#dc3545;margin-inline-start:.25rem}
    .disabled-cover{pointer-events:none;opacity:.65}
    .nav-tabs .nav-link{border-radius:.5rem .5rem 0 0}
    .tab-pane{background:#fff;border:1px solid #dee2e6;border-top:0;border-radius:0 0 .5rem .5rem;padding:1rem}
    .list-row{display:flex;gap:.5rem;align-items:center;background:#fff;border:1px solid #e9ecef;border-radius:.5rem;padding:.5rem}
    .list-row .index{width:2rem;text-align:center;color:#6c757d}
    .list-row .actions .btn{padding:.25rem .5rem}
    .sticky-panel{position:sticky;top:12px}
    .counter-badge{font-weight:700}
    .gdrive-status{display:flex;align-items:center;gap:.5rem}
    .gdrive-status .badge{font-size:.85rem}
    .hint-restricted{display:flex;align-items:center;gap:.5rem}
    .small-badge{font-size:.8rem}

    /* ØªÙØ¹ÙŠÙ„ Ø£ÙŠÙ‚ÙˆÙ†Ø© Ø§Ù„Ø±Ø§Ø¨Ø· Ø¯ÙˆÙ† ØªØºÙŠÙŠØ± Ø´ÙƒÙ„Ù‡Ø§ */
    .input-group-text.link-opener{cursor:default; opacity:.5; transition:opacity .15s}
    .input-group-text.link-opener.active{cursor:pointer; opacity:1}
  </style>
</head>
<body>
  <div class="container">
    <!-- Header -->
    <div class="d-flex flex-wrap justify-content-between align-items-center mb-2 gap-2">
      <h4 class="mb-0">Ø¥Ø¶Ø§ÙØ© Ø±ÙˆØ§Ø¨Ø· Ù…Ù„ÙØ§Øª Ø§Ù„Ù„Ø¬Ø§Ù†</h4>
      <div class="d-flex align-items-center gap-2">
        <span id="userInfo" class="user-chip badge bg-light text-dark border">
          <i class="bi bi-person"></i>
          <span id="userUsername">â€”</span>
          <span class="mx-1">â€”</span>
          <span id="userFullName">â€”</span>
          <span class="ms-2 badge bg-secondary" id="userRole">â€”</span>
        </span>
        <a class="btn btn-outline-primary" id="homeBtn" href="/committees-home.html">
          <i class="bi bi-grid"></i> Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ…
        </a>
        <button id="logoutBtn" class="btn btn-danger">
          <i class="bi bi-box-arrow-right"></i> Ø®Ø±ÙˆØ¬
        </button>
      </div>
    </div>

    <!-- Ø´Ø±ÙŠØ· Ø­Ø§Ù„Ø© Ø§Ù„ØªØ¹ÙŠÙŠÙ† -->
    <div id="assignmentBanner" class="alert alert-info py-2 px-3 d-none" role="alert">
      <div class="d-flex flex-wrap justify-content-between align-items-center gap-2">
        <div class="hint-restricted">
          <i class="bi bi-shield-lock"></i>
          <div>
            <div class="fw-bold">Ø§Ù„ÙˆØµÙˆÙ„ Ù…Ù‚ÙŠÙ‘ÙØ¯ Ø­Ø³Ø¨ Ø§Ù„ØªØ¹ÙŠÙŠÙ†Ø§Øª</div>
            <div class="small text-muted">Ù„Ø§ ÙŠÙ…ÙƒÙ†Ùƒ Ø§Ù„Ø§Ø®ØªÙŠØ§Ø± Ø¥Ù„Ø§ Ù…Ù† Ø§Ù„ÙƒÙ„ÙŠØ§Øª ÙˆØ§Ù„Ù„Ø¬Ø§Ù† Ø§Ù„Ù…Ø¹ÙŠÙ†Ø© Ù„Ùƒ.</div>
          </div>
        </div>
        <div class="d-flex align-items-center gap-2">
          <button id="showAssignmentsBtn" class="btn btn-sm btn-outline-dark">
            <i class="bi bi-card-list"></i> Ø¹Ø±Ø¶ ØªØ¹ÙŠÙŠÙ†Ø§ØªÙŠ
          </button>
          <span id="assignCountBadge" class="badge text-bg-secondary small-badge">0</span>
        </div>
      </div>
    </div>

    <!-- Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„ÙƒÙ„ÙŠØ©/Ø§Ù„Ù„Ø¬Ù†Ø© + Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ø¹Ø§Ù…/Ø§Ù„ÙØµÙ„ + Ø§ØªØµØ§Ù„ Drive -->
    <div class="card mb-3">
      <div class="card-body row g-3">
        <div class="col-md-3">
          <label class="form-label">Ø§Ù„ÙƒÙ„ÙŠØ© <span class="required-asterisk">*</span></label>
          <select id="collegeSelect" class="form-select">
            <option value="">â€” Ø§Ø®ØªØ± Ø§Ù„ÙƒÙ„ÙŠØ© â€”</option>
          </select>
        </div>
        <div class="col-md-3">
          <label class="form-label">Ø§Ø³Ù… Ø§Ù„Ù„Ø¬Ù†Ø© <span class="required-asterisk">*</span></label>
          <select id="committeeSelect" class="form-select">
            <option value="">â€” Ø§Ø®ØªØ± Ø§Ù„Ù„Ø¬Ù†Ø© â€”</option>
          </select>
        </div>

        <!-- Ø§Ù„Ø¹Ø§Ù… Ø§Ù„Ø¬Ø§Ù…Ø¹ÙŠ (Ù…Ø±Ø¨Ø¹ Ù†Øµ) -->
        <div class="col-md-3">
          <label class="form-label">
            Ø§Ù„Ø¹Ø§Ù… Ø§Ù„Ø¬Ø§Ù…Ø¹ÙŠ <span class="required-asterisk">*</span>
          </label>
          <input id="academicYearInput" type="text" class="form-control" placeholder="2024/2025 Ø£Ùˆ 2024-2025" />
          <div class="form-text">ØµÙŠØºØ© Ù…Ù‚Ø¨ÙˆÙ„Ø©: 20xx/20yy Ø£Ùˆ 20xx-20yy (ÙˆÙŠÙÙØ¶Ù‘Ù„ Ø£Ù† ÙŠÙƒÙˆÙ† Ø§Ù„ÙØ±Ù‚ Ø³Ù†Ø© ÙˆØ§Ø­Ø¯Ø©).</div>
        </div>

        <!-- Ø§Ù„ÙØµÙ„ (Ù‚Ø§Ø¦Ù…Ø© Ù…Ù†Ø³Ø¯Ù„Ø©) -->
        <div class="col-md-3">
          <label class="form-label">
            Ø§Ù„ÙØµÙ„ Ø§Ù„Ø¯Ø±Ø§Ø³ÙŠ <span class="required-asterisk">*</span>
          </label>
          <select id="termSelect" class="form-select">
            <option value="">â€” Ø§Ø®ØªØ± Ø§Ù„ÙØµÙ„ â€”</option>
            <option value="Ø§Ù„ÙØµÙ„ Ø§Ù„Ø£ÙˆÙ„">Ø§Ù„ÙØµÙ„ Ø§Ù„Ø£ÙˆÙ„</option>
            <option value="Ø§Ù„ÙØµÙ„ Ø§Ù„Ø«Ø§Ù†ÙŠ">Ø§Ù„ÙØµÙ„ Ø§Ù„Ø«Ø§Ù†ÙŠ</option>
            <option value="Ø§Ù„ÙØµÙ„ Ø§Ù„ØµÙŠÙÙŠ">Ø§Ù„ÙØµÙ„ Ø§Ù„ØµÙŠÙÙŠ</option>
          </select>
        </div>

        <div class="col-12">
          <label class="form-label">Google Drive</label>
          <div class="d-flex gap-2 gdrive-status">
            <button id="gdriveConnectBtn" class="btn btn-outline-success">
              <i class="bi bi-google"></i> Ø§ØªØµØ§Ù„ Google Drive
            </button>
            <span id="gdriveState" class="badge text-bg-secondary">ØºÙŠØ± Ù…ØªØµÙ„</span>
            <button id="gdriveDisconnectBtn" class="btn btn-outline-secondary btn-sm d-none">ÙØµÙ„</button>
          </div>
          <div class="form-text">Ø§Ù„Ø§ØªØµØ§Ù„ ÙŠÙ…Ù†Ø­ ØµÙ„Ø§Ø­ÙŠØ© <code>drive.readonly</code> Ù„Ø§Ø®ØªÙŠØ§Ø± Ù…Ù„ÙØ§Øª Ù…ÙˆØ¬ÙˆØ¯Ø© Ø¯ÙˆÙ† Ø±ÙØ¹.</div>
        </div>
      </div>
    </div>

    <div class="row g-4">
      <!-- Ø§Ù„ÙŠØ³Ø§Ø±: Ø§Ù„ØªØ¨ÙˆÙŠØ¨Ø§Øª -->
      <div class="col-lg-9">
        <!-- Tabs -->
        <ul class="nav nav-tabs mb-0" id="filesTabs" role="tablist">
          <li class="nav-item" role="presentation">
            <button class="nav-link active" id="core-tab" data-bs-toggle="tab" data-bs-target="#core" type="button" role="tab" aria-controls="core" aria-selected="true">
              Ø§Ù„Ù…Ø³ØªÙ†Ø¯Ø§Øª Ø§Ù„Ø£Ø³Ø§Ø³ÙŠØ©
            </button>
          </li>
          <li class="nav-item" role="presentation">
            <button class="nav-link" id="inv-tab" data-bs-toggle="tab" data-bs-target="#inv" type="button" role="tab" aria-controls="inv" aria-selected="false">
              Ø¯Ø¹ÙˆØ§Øª Ø§Ù„Ø§Ø¬ØªÙ…Ø§Ø¹ <span class="badge bg-secondary ms-1" id="badgeInv">0</span>
            </button>
          </li>
          <li class="nav-item" role="presentation">
            <button class="nav-link" id="min-tab" data-bs-toggle="tab" data-bs-target="#min" type="button" role="tab" aria-controls="min" aria-selected="false">
              Ù…Ø­Ø§Ø¶Ø± Ø§Ù„Ø§Ø¬ØªÙ…Ø§Ø¹ <span class="badge bg-secondary ms-1" id="badgeMin">0</span>
            </button>
          </li>
          <li class="nav-item" role="presentation">
            <button class="nav-link" id="cov-tab" data-bs-toggle="tab" data-bs-target="#cov" type="button" role="tab" aria-controls="cov" aria-selected="false">
              ÙƒØªØ¨ Ø§Ù„ØªØºØ·ÙŠØ© <span class="badge bg-secondary ms-1" id="badgeCov">0</span>
            </button>
          </li>
          <li class="nav-item" role="presentation">
            <button class="nav-link" id="rep-tab" data-bs-toggle="tab" data-bs-target="#rep" type="button" role="tab" aria-controls="rep" aria-selected="false">
              Ø§Ù„ØªÙ‚Ø§Ø±ÙŠØ± ÙˆØ§Ù„ØªØ­Ù„ÙŠÙ„
            </button>
          </li>
        </ul>

        <div class="tab-content">
          <!-- Ø§Ù„Ù…Ø³ØªÙ†Ø¯Ø§Øª Ø§Ù„Ø£Ø³Ø§Ø³ÙŠØ© -->
          <div class="tab-pane fade show active" id="core" role="tabpanel" aria-labelledby="core-tab" tabindex="0">
            <div class="row g-3">
              <div class="col-md-6">
                <label class="form-label">Ø±Ø§Ø¨Ø· Ù‚Ø±Ø§Ø± Ø§Ù„ØªØ´ÙƒÙŠÙ„</label>
                <div class="input-group">
                  <span class="input-group-text link-opener" title="Ø§ÙØªØ­ Ø§Ù„Ø±Ø§Ø¨Ø·"><i class="bi bi-link-45deg"></i></span>
                  <input id="fdUrl" type="url" class="form-control" placeholder="https://drive.google.com/...">
                  <button class="btn btn-outline-primary" data-pick="fdUrl"><i class="bi bi-folder2-open"></i> Ù…Ù† Drive</button>
                </div>
                <div id="fdHint" class="form-text">Ø§Ø®ØªØ± Ù…Ù„ÙÙ‹Ø§ Ù…ÙˆØ¬ÙˆØ¯Ù‹Ø§ Ù…Ù† Google Drive Ø£Ùˆ Ø£Ù„ØµÙ‚ Ø§Ù„Ø±Ø§Ø¨Ø· ÙŠØ¯ÙˆÙŠÙ‹Ø§.</div>
              </div>
              <div class="col-md-6">
                <label class="form-label">Ø±Ø§Ø¨Ø· Ø®Ø·Ø© Ø§Ù„Ø¹Ù…Ù„</label>
                <div class="input-group">
                  <span class="input-group-text link-opener" title="Ø§ÙØªØ­ Ø§Ù„Ø±Ø§Ø¨Ø·"><i class="bi bi-link-45deg"></i></span>
                  <input id="wpUrl" type="url" class="form-control" placeholder="https://drive.google.com/...">
                  <button class="btn btn-outline-primary" data-pick="wpUrl"><i class="bi bi-folder2-open"></i> Ù…Ù† Drive</button>
                </div>
              </div>
            </div>
          </div>

          <!-- Ø§Ù„Ø¯Ø¹ÙˆØ§Øª (Ù…ØªØ¹Ø¯Ø¯) -->
          <div class="tab-pane fade" id="inv" role="tabpanel" aria-labelledby="inv-tab" tabindex="0">
            <div class="d-flex justify-content-between align-items-center mb-2">
              <h6 class="mb-0">Ø±ÙˆØ§Ø¨Ø· Ø¯Ø¹ÙˆØ§Øª Ø§Ù„Ø§Ø¬ØªÙ…Ø§Ø¹</h6>
              <button id="addInvitationBtn" class="btn btn-sm btn-primary"><i class="bi bi-plus-circle"></i> Ø¥Ø¶Ø§ÙØ© Ø¯Ø¹ÙˆØ©</button>
            </div>
            <div id="invitationsList" class="vstack gap-2"></div>
          </div>

          <!-- Ø§Ù„Ù…Ø­Ø§Ø¶Ø± (Ù…ØªØ¹Ø¯Ø¯) -->
          <div class="tab-pane fade" id="min" role="tabpanel" aria-labelledby="min-tab" tabindex="0">
            <div class="d-flex justify-content-between align-items-center mb-2">
              <h6 class="mb-0">Ø±ÙˆØ§Ø¨Ø· Ù…Ø­Ø§Ø¶Ø± Ø§Ù„Ø§Ø¬ØªÙ…Ø§Ø¹</h6>
              <button id="addMinuteBtn" class="btn btn-sm btn-primary"><i class="bi bi-plus-circle"></i> Ø¥Ø¶Ø§ÙØ© Ù…Ø­Ø¶Ø±</button>
            </div>
            <div id="minutesList" class="vstack gap-2"></div>
          </div>

          <!-- ÙƒØªØ¨ Ø§Ù„ØªØºØ·ÙŠØ© (Ù…ØªØ¹Ø¯Ø¯) -->
          <div class="tab-pane fade" id="cov" role="tabpanel" aria-labelledby="cov-tab" tabindex="0">
            <div class="d-flex justify-content-between align-items-center mb-2">
              <h6 class="mb-0">Ø±ÙˆØ§Ø¨Ø· ÙƒØªØ¨ Ø§Ù„ØªØºØ·ÙŠØ©</h6>
              <button id="addCoverageBtn" class="btn btn-sm btn-primary"><i class="bi bi-plus-circle"></i> Ø¥Ø¶Ø§ÙØ© ÙƒØªØ§Ø¨ ØªØºØ·ÙŠØ©</button>
            </div>
            <div id="coverageList" class="vstack gap-2"></div>
          </div>

          <!-- Ø§Ù„ØªÙ‚Ø§Ø±ÙŠØ± ÙˆØ§Ù„ØªØ­Ù„ÙŠÙ„ (Ù…ÙØ±Ø¯Ø©) -->
          <div class="tab-pane fade" id="rep" role="tabpanel" aria-labelledby="rep-tab" tabindex="0">
            <div class="row g-3">
              <div class="col-md-6">
                <label class="form-label">Ø±Ø§Ø¨Ø· ØªÙ‚Ø±ÙŠØ± Ø¥Ù†Ø¬Ø§Ø² 1</label>
                <div class="input-group">
                  <span class="input-group-text link-opener" title="Ø§ÙØªØ­ Ø§Ù„Ø±Ø§Ø¨Ø·"><i class="bi bi-link-45deg"></i></span>
                  <input id="r1Url" type="url" class="form-control" placeholder="https://drive.google.com/...">
                  <button class="btn btn-outline-primary" data-pick="r1Url"><i class="bi bi-folder2-open"></i> Ù…Ù† Drive</button>
                </div>
              </div>
              <div class="col-md-6">
                <label class="form-label">Ø±Ø§Ø¨Ø· ØªÙ‚Ø±ÙŠØ± Ø¥Ù†Ø¬Ø§Ø² 2</label>
                <div class="input-group">
                  <span class="input-group-text link-opener" title="Ø§ÙØªØ­ Ø§Ù„Ø±Ø§Ø¨Ø·"><i class="bi bi-link-45deg"></i></span>
                  <input id="r2Url" type="url" class="form-control" placeholder="https://drive.google.com/...">
                  <button class="btn btn-outline-primary" data-pick="r2Url"><i class="bi bi-folder2-open"></i> Ù…Ù† Drive</button>
                </div>
              </div>
              <div class="col-md-6">
                <label class="form-label">Ø±Ø§Ø¨Ø· ØªÙ‚Ø±ÙŠØ± Ø¥Ù†Ø¬Ø§Ø² 3</label>
                <div class="input-group">
                  <span class="input-group-text link-opener" title="Ø§ÙØªØ­ Ø§Ù„Ø±Ø§Ø¨Ø·"><i class="bi bi-link-45deg"></i></span>
                  <input id="r3Url" type="url" class="form-control" placeholder="https://drive.google.com/...">
                  <button class="btn btn-outline-primary" data-pick="r3Url"><i class="bi bi-folder2-open"></i> Ù…Ù† Drive</button>
                </div>
              </div>
              <div class="col-md-6">
                <label class="form-label">Ø±Ø§Ø¨Ø· Ø§Ù„ØªØ­Ù„ÙŠÙ„ Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠ</label>
                <div class="input-group">
                  <span class="input-group-text link-opener" title="Ø§ÙØªØ­ Ø§Ù„Ø±Ø§Ø¨Ø·"><i class="bi bi-link-45deg"></i></span>
                  <input id="saUrl" type="url" class="form-control" placeholder="https://drive.google.com/...">
                  <button class="btn btn-outline-primary" data-pick="saUrl"><i class="bi bi-folder2-open"></i> Ù…Ù† Drive</button>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª -->
        <div class="card mt-3 mb-5">
          <div class="card-body d-flex flex-wrap gap-2">
            <button id="saveBtn" class="btn btn-success"><i class="bi bi-save"></i> Ø­ÙØ¸</button>
            <button id="resetBtn" class="btn btn-outline-secondary"><i class="bi bi-arrow-counterclockwise"></i> ØªÙØ±ÙŠØº</button>
            <a id="backBtn" class="btn btn-outline-primary" href="#"><i class="bi bi-arrow-right-circle"></i> Ø±Ø¬ÙˆØ¹</a>
          </div>
        </div>
      </div>

      <!-- Ø§Ù„ÙŠÙ…ÙŠÙ†: Ù…Ù„Ø®Øµ -->
      <div class="col-lg-3">
        <div class="sticky-panel">
          <div class="card">
            <div class="card-body">
              <h6 class="mb-3">Ù…Ù„Ø®Øµ Ø³Ø±ÙŠØ¹</h6>
              <div class="small mb-2">Ø§Ù„ÙƒÙ„ÙŠØ©: <b id="sumCollege">â€”</b></div>
              <div class="small mb-2">Ø§Ù„Ù„Ø¬Ù†Ø©: <b id="sumCommittee">â€”</b></div>
              <div class="small mb-2">Ø§Ù„Ø¹Ø§Ù… Ø§Ù„Ø¬Ø§Ù…Ø¹ÙŠ: <b id="sumAcademicYear">â€”</b></div>
              <div class="small mb-3">Ø§Ù„ÙØµÙ„: <b id="sumTerm">â€”</b></div>
              <ul class="list-unstyled small vstack gap-2">
                <li>Ù‚Ø±Ø§Ø± Ø§Ù„ØªØ´ÙƒÙŠÙ„: <span id="sumFD" class="counter-badge">â€”</span></li>
                <li>Ø®Ø·Ø© Ø§Ù„Ø¹Ù…Ù„: <span id="sumWP" class="counter-badge">â€”</span></li>
                <li>Ø§Ù„Ø¯Ø¹ÙˆØ§Øª: <span id="sumInv" class="counter-badge">0</span></li>
                <li>Ø§Ù„Ù…Ø­Ø§Ø¶Ø±: <span id="sumMin" class="counter-badge">0</span></li>
                <li>ÙƒØªØ¨ Ø§Ù„ØªØºØ·ÙŠØ©: <span id="sumCov" class="counter-badge">0</span></li>
                <li>ØªÙ‚Ø±ÙŠØ± 1: <span id="sumR1" class="counter-badge">â€”</span></li>
                <li>ØªÙ‚Ø±ÙŠØ± 2: <span id="sumR2" class="counter-badge">â€”</span></li>
                <li>ØªÙ‚Ø±ÙŠØ± 3: <span id="sumR3" class="counter-badge">â€”</span></li>
                <li>Ø§Ù„ØªØ­Ù„ÙŠÙ„ Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠ: <span id="sumSA" class="counter-badge">â€”</span></li>
              </ul>
              <hr>
              <div class="small muted">Ø³ÙŠØªÙ… Ø±Ø¨Ø· Ø§Ù„Ø­ÙØ¸ Ø¨Ù†Ù‡Ø§ÙŠØ§Øª Ø§Ù„Ø³ÙŠØ±ÙØ±.</div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Toasts -->
    <div class="toast-container" id="toasts"></div>
  </div>

  <!-- Modal: ØªØ¹ÙŠÙŠÙ†Ø§ØªÙŠ -->
  <div class="modal fade" id="assignmentsModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-scrollable">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title"><i class="bi bi-card-list me-1"></i> ØªØ¹ÙŠÙŠÙ†Ø§ØªÙŠ Ø§Ù„Ù…ØªØ§Ø­Ø©</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Ø¥ØºÙ„Ø§Ù‚"></button>
        </div>
        <div class="modal-body">
          <div id="assignmentsList" class="vstack gap-2">
            <div class="text-muted small">â€” Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª â€”</div>
          </div>
        </div>
        <div class="modal-footer">
          <button class="btn btn-secondary" data-bs-dismiss="modal">Ø¥ØºÙ„Ø§Ù‚</button>
        </div>
      </div>
    </div>
  </div>

  <!-- ====== Google: Ù…ÙØ§ØªÙŠØ­ + GIS ====== -->
  <script>
    window.GOOGLE_CLIENT_ID = '656975767411-lu47r57vrfmhrplrd11rdgbm34cqofsn.apps.googleusercontent.com';
    window.GOOGLE_API_KEY   = 'AIzaSyAaUEq7_7nbhj7Ch-7X0OWKyREUK8bH_EY';
    window.DRIVE_SCOPE = 'https://www.googleapis.com/auth/drive.readonly';

    window.googleAccessToken = null;
    window.gisTokenClient    = null;

    window.initGis = function () {
      if (!window.google || !google.accounts || !google.accounts.oauth2) return;
      window.gisTokenClient = google.accounts.oauth2.initTokenClient({
        client_id: window.GOOGLE_CLIENT_ID,
        scope: window.DRIVE_SCOPE,
        callback: (resp) => {
          if (resp && resp.access_token) {
            window.googleAccessToken = resp.access_token;
            if (typeof window.setGDriveState === 'function') window.setGDriveState(true);
          }
        }
      });
    };
  </script>

  <!-- Google APIs (Picker + GIS) -->
  <script src="https://accounts.google.com/gsi/client" async defer onload="initGis()"></script>
  <script src="https://apis.google.com/js/api.js" async defer></script>

  <!-- Bootstrap JS -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

  <!-- ====== ØªØ·Ø¨ÙŠÙ‚ Ø§Ù„ØµÙØ­Ø© ====== -->
  <script>
    /* ====== Ø¨ÙŠØ¦Ø© Ù…ÙˆØ­Ø¯Ø© ====== */
    const RENDER_BASE='https://vdash-qkyv.onrender.com';
    const host=location.hostname;
    const isGithub=host.endsWith('github.io');
    const isLocal=host==='localhost'||host==='127.0.0.1';
    const API_BASE=isGithub?RENDER_BASE:(isLocal?'http://localhost:3000':'');
    const go=(path)=>isGithub?(RENDER_BASE+path):path;

    const apiFetch=(path,opts={})=>fetch(`${API_BASE}${path}`,{credentials:'include',...opts});
    document.getElementById('homeBtn').href=go('/committees-home.html');
    document.getElementById('backBtn').href=go('/committees-home.html');

    /* ====== Ù†Ø¸Ø§Ù… Toast Ù…ÙˆØ­Ù‘Ø¯ ====== */
    function pushToast({type='info', title='', body='', autohide=true, delay=4000}={}){
      const container=document.getElementById('toasts');
      const id='t'+Math.random().toString(36).slice(2);
      const color=(
        type==='success' ? 'success' :
        type==='error'   ? 'danger'  :
        type==='warn'    ? 'warning' : 'info'
      );
      const html=`
        <div id="${id}" class="toast align-items-center text-bg-${color} border-0 mb-2" role="alert" aria-live="assertive" aria-atomic="true">
          <div class="d-flex">
            <div class="toast-body">
              ${title?`<div class="fw-bold mb-1">${title}</div>`:''}
              ${body}
            </div>
            <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button>
          </div>
        </div>`;
      container.insertAdjacentHTML('beforeend', html);
      const el=document.getElementById(id);
      const t=new bootstrap.Toast(el, {delay, autohide});
      t.show();
      el.addEventListener('hidden.bs.toast', ()=>el.remove());
      return t;
    }

    /* ====== Ø¬Ù„Ø³Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… ====== */
    let CURRENT_USER=null;
    function renderUser(u){
      const username=u?.username||(u?.email?u.email.split('@')[0]:'â€”');
      document.getElementById('userUsername').textContent=username;
      document.getElementById('userFullName').textContent=u?.name||'â€”';
      document.getElementById('userRole').textContent=u?.role||'â€”';
    }
    async function ensureAuth(){
      const r=await apiFetch('/auth/committees/me');
      const j=await r.json();
      if(!j?.authenticated){
        location.href=go('/committees-login.html?next='+encodeURIComponent('/committees-files-add.html'));throw 0;
      }
      if(j.user?.isActive===false){
        pushToast({type:'warn', title:'Ø­Ø³Ø§Ø¨ Ù…Ø¹Ø·Ù‘Ù„', body:'ğŸš« Ø­Ø³Ø§Ø¨Ùƒ Ù…Ø¹Ø·Ù‘Ù„. Ø³ÙŠØªÙ… ØªØ­ÙˆÙŠÙ„Ùƒ Ù„Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ….'});
        location.href=go('/committees-home.html'); throw 0;
      }
      CURRENT_USER=j.user; renderUser(j.user);
    }
    document.getElementById('logoutBtn').addEventListener('click',async()=>{
      try{
        const r=await apiFetch('/auth/committees/logout',{method:'POST',headers:{'Content-Type':'application/json'}});
        if(r.ok){ pushToast({type:'success', body:'ØªÙ… ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬'}); setTimeout(()=>location.href=go('/committees-login.html'),700); }
        else pushToast({type:'error', body:'ØªØ¹Ø°Ù‘Ø± ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬'});
      }catch{ pushToast({type:'error', body:'ØªØ¹Ø°Ù‘Ø± ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬'}); }
    });

    /* ====== Ù†Ù…ÙˆØ°Ø¬ Ø§Ù„Ø­Ø§Ù„Ø© Ø§Ù„Ø¹Ø§Ù…Ø© ====== */
    const state={
      college:'', committee_name:'',
      academicYear:'', term:'',
      formation_decision:null, work_plan:null,
      invitations:[], minutes:[], coverage_letters:[],
      report1:null, report2:null, report3:null, statistical_analysis:null
    };

    /* ====== ØªØ­Ù‚Ù‚ Ø§Ù„Ø¹Ø§Ù… Ø§Ù„Ø¬Ø§Ù…Ø¹ÙŠ ====== */
    const yearRx = /^(20\d{2})[\/-](20\d{2})$/;
    function validateAcademicYear(s){
      const m = String(s||'').trim().match(yearRx);
      if(!m) return { ok:false, msg:'ØµÙŠØºØ© Ø§Ù„Ø¹Ø§Ù… Ø§Ù„Ø¬Ø§Ù…Ø¹ÙŠ ØºÙŠØ± ØµØ­ÙŠØ­Ø©' };
      const y1 = parseInt(m[1],10), y2 = parseInt(m[2],10);
      if (y2 - y1 !== 1) return { ok:false, msg:'ÙŠØ¬Ø¨ Ø£Ù† ÙŠÙƒÙˆÙ† Ø§Ù„ÙØ±Ù‚ Ø³Ù†Ø© ÙˆØ§Ø­Ø¯Ø©' };
      return { ok:true, msg:'' };
    }

    function refreshSummary(){
      document.getElementById('sumCollege').textContent=state.college||'â€”';
      document.getElementById('sumCommittee').textContent=state.committee_name||'â€”';
      document.getElementById('sumAcademicYear').textContent=state.academicYear||'â€”';
      document.getElementById('sumTerm').textContent=state.term||'â€”';

      document.getElementById('sumFD').textContent=state.formation_decision? 'Ø±Ø§Ø¨Ø·' : 'â€”';
      document.getElementById('sumWP').textContent=state.work_plan? 'Ø±Ø§Ø¨Ø·' : 'â€”';
      document.getElementById('sumInv').textContent=state.invitations.length;
      document.getElementById('sumMin').textContent=state.minutes.length;
      document.getElementById('sumCov').textContent=state.coverage_letters.length;
      document.getElementById('sumR1').textContent=state.report1? 'Ø±Ø§Ø¨Ø·' : 'â€”';
      document.getElementById('sumR2').textContent=state.report2? 'Ø±Ø§Ø¨Ø·' : 'â€”';
      document.getElementById('sumR3').textContent=state.report3? 'Ø±Ø§Ø¨Ø·' : 'â€”';
      document.getElementById('sumSA').textContent=state.statistical_analysis? 'Ø±Ø§Ø¨Ø·' : 'â€”';
      document.getElementById('badgeInv').textContent=state.invitations.length;
      document.getElementById('badgeMin').textContent=state.minutes.length;
      document.getElementById('badgeCov').textContent=state.coverage_letters.length;
      toggleActions();
    }
    function toggleActions(){
      const disabled = !(state.college && state.committee_name && state.academicYear && state.term);
      document.getElementById('saveBtn').classList.toggle('disabled-cover',disabled);
    }

    /* ====== ØªØºÙŠÙŠØ±Ø§Øª Ø§Ù„Ø±Ø£Ø³ ====== */
    document.getElementById('collegeSelect').addEventListener('change',e=>{
      state.college=e.target.value;
      if (ASSIGNMENT_LOCK.enabled) populateCommitteeSelectRestricted(state.college);
      refreshSummary();schedulePrefillCheck();
    });
    document.getElementById('committeeSelect').addEventListener('change',e=>{
      state.committee_name=e.target.value;refreshSummary();schedulePrefillCheck();
    });
    document.getElementById('termSelect').addEventListener('change',e=>{
      state.term=e.target.value;refreshSummary();schedulePrefillCheck();
    });
    const ayInput = document.getElementById('academicYearInput');
    ayInput.addEventListener('input',()=>{
      const v = ayInput.value.trim();
      const {ok,msg} = validateAcademicYear(v);
      if (!v){ ayInput.classList.remove('is-invalid'); state.academicYear=''; refreshSummary(); return; }
      if (ok){ ayInput.classList.remove('is-invalid'); state.academicYear=v; schedulePrefillCheck(); }
      else   { ayInput.classList.add('is-invalid'); state.academicYear=''; pushToast({type:'warn', body:msg}); }
      refreshSummary();
    });

    /* ====== ÙØªØ­ Ø§Ù„Ø±ÙˆØ§Ø¨Ø· Ù…Ù† Ø£ÙŠÙ‚ÙˆÙ†Ø© Ø§Ù„Ø³Ù„Ø³Ù„Ø© (Ù„Ù„Ø­Ù‚ÙˆÙ„ Ø§Ù„ÙØ±Ø¯ÙŠØ© ÙˆØ§Ù„Ù‚ÙˆØ§Ø¦Ù…) ====== */
    function isValidUrl(u){ try{ new URL(u); return true; } catch{ return false; } }

    function activateLinkOpener(iconEl, getUrlFn){
      // Ø¶Ø¨Ø· Ø§Ù„Ø­Ø§Ù„Ø© Ø§Ù„Ø£ÙˆÙ„ÙŠØ©
      function refreshIcon(){
        const href = getUrlFn();
        const ok = !!href && isValidUrl(href);
        iconEl.classList.toggle('active', ok);
        if (ok){
          iconEl.setAttribute('title','Ø§ÙØªØ­ Ø§Ù„Ø±Ø§Ø¨Ø· ÙÙŠ ØªØ¨ÙˆÙŠØ¨ Ø¬Ø¯ÙŠØ¯');
        }else{
          iconEl.setAttribute('title','Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø±Ø§Ø¨Ø· ØµØ§Ù„Ø­');
        }
      }
      refreshIcon();

      // Ø§Ù„Ù†Ù‚Ø± Ù„ÙØªØ­ Ø§Ù„Ø±Ø§Ø¨Ø·
      iconEl.addEventListener('click', ()=>{
        const href = getUrlFn();
        if (href && isValidUrl(href)){
          window.open(href, '_blank', 'noopener');
        }
      });

      return { refreshIcon };
    }

    function wireSingleUrl(inputId, setter){
      const el=document.getElementById(inputId);
      const iconEl = el.parentElement.querySelector('.input-group-text.link-opener');
      const opener = activateLinkOpener(iconEl, ()=>el.value.trim());

      el.addEventListener('input',()=>{
        const v=el.value.trim();
        if(!v){ setter(null); el.classList.remove('is-invalid'); opener.refreshIcon(); refreshSummary(); return; }
        if(isValidUrl(v)){ setter({type:'url', value:v}); el.classList.remove('is-invalid'); }
        else{ setter(null); el.classList.add('is-invalid'); }
        opener.refreshIcon();
        refreshSummary();
      });
    }
    wireSingleUrl('fdUrl', (x)=>state.formation_decision=x);
    wireSingleUrl('wpUrl', (x)=>state.work_plan=x);
    wireSingleUrl('r1Url', (x)=>state.report1=x);
    wireSingleUrl('r2Url', (x)=>state.report2=x);
    wireSingleUrl('r3Url', (x)=>state.report3=x);
    wireSingleUrl('saUrl', (x)=>state.statistical_analysis=x);

    /* ====== Google Drive ====== */
    let pickerApiLoaded=false;
    function setGDriveState(connected, emailText=''){
      const badge=document.getElementById('gdriveState');
      const btnDisc=document.getElementById('gdriveDisconnectBtn');
      if(connected){
        badge.className='badge text-bg-success';
        badge.textContent= emailText ? ('Ù…ØªØµÙ„: ' + emailText) : 'Ù…ØªØµÙ„';
        btnDisc.classList.remove('d-none');
      }else{
        badge.className='badge text-bg-secondary';
        badge.textContent='ØºÙŠØ± Ù…ØªØµÙ„';
        btnDisc.classList.add('d-none');
      }
      document.querySelectorAll('[data-pick]').forEach(b=>{ b.disabled = !connected; });
    }
    window.setGDriveState = setGDriveState;

    function loadPickerApi(){
      return new Promise(res=>{
        if(pickerApiLoaded) return res();
        gapi.load('picker', ()=>{ pickerApiLoaded=true; res(); });
      });
    }
    async function ensureDriveToken(){
      if (window.googleAccessToken) return true;
      if (!window.gisTokenClient) window.initGis();
      return new Promise(resolve=>{
        window.gisTokenClient.requestAccessToken({ prompt: 'consent' });
        const t=setInterval(()=>{ if(window.googleAccessToken){ clearInterval(t); resolve(true); } },200);
        setTimeout(()=>{ clearInterval(t); resolve(!!window.googleAccessToken); },10000);
      });
    }
    async function fetchWebViewLink(fileId){
      const r = await fetch(`https://www.googleapis.com/drive/v3/files/${fileId}?fields=webViewLink`, {
        headers: { Authorization: 'Bearer ' + window.googleAccessToken }
      });
      const j = await r.json();
      return j.webViewLink || `https://drive.google.com/file/d/${fileId}/view`;
    }
    async function openDrivePicker(onPicked){
      const ok = await ensureDriveToken();
      if(!ok){ pushToast({type:'error', body:'ØªØ¹Ø°Ø± Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ù€ Google Drive'}); return; }
      await loadPickerApi();
      const viewDocs = new google.picker.DocsView().setIncludeFolders(true).setSelectFolderEnabled(false);
      const picker = new google.picker.PickerBuilder()
        .setOAuthToken(window.googleAccessToken)
        .setDeveloperKey(window.GOOGLE_API_KEY)
        .addView(viewDocs)
        .setOrigin(window.location.origin)
        .setLocale('ar')
        .setSize(880,520)
        .setCallback(async (data)=>{
          if(data.action === google.picker.Action.PICKED && data.docs && data.docs.length){
            const file = data.docs[0];
            try{
              const link = await fetchWebViewLink(file.id);
              onPicked(link, file);
            }catch(e){
              console.error(e); pushToast({type:'error', body:'ØªØ¹Ø°Ø± Ø¬Ù„Ø¨ Ø±Ø§Ø¨Ø· Ø§Ù„Ø¹Ø±Ø¶ Ù„Ù„Ù…Ù„Ù'});
            }
          }
        }).build();
      picker.setVisible(true);
    }
    document.getElementById('gdriveConnectBtn').addEventListener('click', async ()=>{
      const ok = await ensureDriveToken(); setGDriveState(ok);
    });
    document.getElementById('gdriveDisconnectBtn').addEventListener('click', ()=>{
      window.googleAccessToken = null; setGDriveState(false);
    });
    document.querySelectorAll('[data-pick]').forEach(btn=>{
      btn.addEventListener('click', ()=>{
        const targetId = btn.getAttribute('data-pick');
        const inputEl = document.getElementById(targetId);
        openDrivePicker((link)=>{ inputEl.value = link; inputEl.dispatchEvent(new Event('input')); });
      });
    });

    /* ====== Ø§Ù„Ù‚ÙˆØ§Ø¦Ù… Ø§Ù„Ù…ØªØ¹Ø¯Ø¯Ø© ====== */
    function addMultiUrlRow(listEl, arrRef, initialItem = null, options = {}){
      // options.baseTitle: Ù†Øµ Ø§Ù„Ø£Ø³Ø§Ø³ Ù„Ù„Ø¹Ù†Ø§ÙˆÙŠÙ† Ø§Ù„Ø§ÙØªØ±Ø§Ø¶ÙŠØ© (Ø¯Ø¹ÙˆØ©/Ù…Ø­Ø¶Ø±/ÙƒØªØ§Ø¨ ØªØºØ·ÙŠØ©)
      const row=document.createElement('div');
      row.className='list-row';
      row.innerHTML=`
        <span class="index">#</span>
        <div class="flex-grow-1">
          <div class="input-group">
            <span class="input-group-text link-opener" title="Ø§ÙØªØ­ Ø§Ù„Ø±Ø§Ø¨Ø·"><i class="bi bi-link-45deg"></i></span>
            <input type="url" class="form-control url-input" placeholder="https://drive.google.com/...">
            <button class="btn btn-outline-primary btn-drive-row" type="button"><i class="bi bi-folder2-open"></i></button>
          </div>
          <div class="form-text">Ø§ÙƒØªØ¨ Ø¹Ù†ÙˆØ§Ù†Ù‹Ø§ Ø§Ø®ØªÙŠØ§Ø±ÙŠÙ‹Ø§ ÙÙŠ Ø§Ù„Ø­Ù‚Ù„ Ø§Ù„ØªØ§Ù„ÙŠ.</div>
          <input type="text" class="form-control form-control-sm mt-1 title-input" placeholder="Ø¹Ù†ÙˆØ§Ù† Ø§Ø®ØªÙŠØ§Ø±ÙŠ">
        </div>
        <div class="actions ms-2">
          <button class="btn btn-outline-danger" type="button"><i class="bi bi-trash"></i></button>
        </div>
      `;
      const idxSpan=row.querySelector('.index');
      const urlInput=row.querySelector('.url-input');
      const titleInput=row.querySelector('.title-input');
      const delBtn=row.querySelector('.actions .btn');
      const driveBtn=row.querySelector('.btn-drive-row');
      const iconEl = row.querySelector('.input-group-text.link-opener');

      const item={ value:(initialItem&&initialItem.value)?initialItem.value:'', title:(initialItem&&initialItem.title)?initialItem.title:'' };
      arrRef.push(item);

      function refreshIndex(){ idxSpan.textContent = (Array.from(listEl.children).indexOf(row)+1); }

      // Ø§Ù„Ø¹Ù†ÙˆØ§Ù† Ø§Ù„Ø§ÙØªØ±Ø§Ø¶ÙŠ Ø§Ù„Ù…Ø±Ù‚Ù‘Ù… Ø¹Ù†Ø¯ Ø§Ù„Ø¥Ø¶Ø§ÙØ© Ø§Ù„ÙŠØ¯ÙˆÙŠØ© ÙÙ‚Ø· (Ù„ÙŠØ³ Ø¹Ù†Ø¯ Ø§Ù„ØªØ­Ù…ÙŠÙ„ Ù…Ù† Ø§Ù„Ù‚Ø§Ø¹Ø¯Ø©)
      if (!initialItem && options.baseTitle){
        const nextIndex = (listEl.children.length || 0) + 1;
        titleInput.value = `${options.baseTitle} ${nextIndex}`;
        item.title = titleInput.value;
      } else {
        if(item.title){ titleInput.value=item.title; }
      }

      if(item.value){ urlInput.value=item.value; }

      // Ù…ÙØ¹Ù‘Ù„ ÙØªØ­ Ø§Ù„Ø±Ø§Ø¨Ø· Ø¹Ù„Ù‰ Ø§Ù„Ø£ÙŠÙ‚ÙˆÙ†Ø©
      const opener = activateLinkOpener(iconEl, ()=>urlInput.value.trim());

      urlInput.addEventListener('input',()=>{
        const v=urlInput.value.trim();
        if(isValidUrl(v)){ item.value=v; urlInput.classList.remove('is-invalid'); }
        else{ item.value=''; if(v) urlInput.classList.add('is-invalid'); else urlInput.classList.remove('is-invalid'); }
        opener.refreshIcon();
        refreshSummary();
      });
      titleInput.addEventListener('input',()=>{ item.title=titleInput.value.trim(); });

      delBtn.addEventListener('click',()=>{
        const i=arrRef.indexOf(item);
        if(i>=0) arrRef.splice(i,1);
        row.remove();
        Array.from(listEl.children).forEach(refreshIndex);
        refreshSummary();
      });

      driveBtn.addEventListener('click', ()=>{
        openDrivePicker((link)=>{ urlInput.value = link; urlInput.dispatchEvent(new Event('input')); });
      });

      listEl.appendChild(row);
      Array.from(listEl.children).forEach(refreshIndex);
      refreshSummary();
    }
    document.getElementById('addInvitationBtn').addEventListener('click',()=>addMultiUrlRow(document.getElementById('invitationsList'), state.invitations, null, { baseTitle: 'Ø¯Ø¹ÙˆØ©' }));
    document.getElementById('addMinuteBtn').addEventListener('click',()=>addMultiUrlRow(document.getElementById('minutesList'), state.minutes, null, { baseTitle: 'Ù…Ø­Ø¶Ø±' }));
    document.getElementById('addCoverageBtn').addEventListener('click',()=>addMultiUrlRow(document.getElementById('coverageList'), state.coverage_letters, null, { baseTitle: 'ÙƒØªØ§Ø¨ ØªØºØ·ÙŠØ©' }));

    /* ====== Helpers Ù„Ù„ØªÙ‡ÙŠØ¦Ø© Ù…Ù† Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª ====== */
    function setSingleInputAndState(inputId, stateKey, urlObj){
      const el=document.getElementById(inputId);
      if(urlObj && urlObj.value){
        el.value = urlObj.value;
        el.classList.remove('is-invalid');
        state[stateKey] = { type:'url', value:urlObj.value, title: urlObj.title || '' };
      } else {
        el.value = '';
        state[stateKey] = null;
      }
      el.dispatchEvent(new Event('input'));
    }
    function rebuildMultiList(listElId, arrRef, items){
      const listEl = document.getElementById(listElId);
      listEl.innerHTML = '';
      arrRef.length = 0;
      if (Array.isArray(items) && items.length){
        items.forEach(it => addMultiUrlRow(listEl, arrRef, it)); // Ù„Ø§ Ù†Ù…Ø±Ù‘Ø± baseTitle Ø¹Ù†Ø¯ Ø§Ù„ØªÙ‡ÙŠØ¦Ø© Ù…Ù† Ø§Ù„Ù‚Ø§Ø¹Ø¯Ø©
      }
      refreshSummary();
    }

    /* ====== ØªÙ‚ÙŠÙŠØ¯ Ø§Ù„ØµÙØ­Ø© Ø¨Ø­Ø³Ø¨ ØªØ¹ÙŠÙŠÙ†Ø§Øª Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… ====== */
    const ASSIGNMENT_LOCK = {
      enabled: false,
      pairs: [],
      collegesSet: new Set(),
      byCollege: new Map(),
      singleLocked: false,
      fetchError: null
    };

    async function fetchMyAssignments(){
      try{
        const r = await apiFetch('/api/committee-assignments/mine');
        if (r.ok) return await r.json();
        if (r.status !== 404 && r.status !== 403) return [];
      }catch{}
      try{
        const r = await apiFetch('/api/committee-assignments?userId=me');
        if (r.ok) return await r.json();
        if (r.status !== 404 && r.status !== 403) return [];
      }catch{}
      try{
        const myId = CURRENT_USER?.id || CURRENT_USER?._id;
        if (myId){
          const r = await apiFetch(`/api/committee-assignments?userId=${encodeURIComponent(myId)}`);
          if (r.ok) return await r.json();
          ASSIGNMENT_LOCK.fetchError = { status:r.status, message:'Ù„Ø§ ÙŠÙ…ÙƒÙ† Ù‚Ø±Ø§Ø¡Ø© ØªØ¹ÙŠÙŠÙ†Ø§Øª Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… (403/404)' };
        }else{
          ASSIGNMENT_LOCK.fetchError = { status:0, message:'Ù„Ø§ ÙŠØªÙˆÙØ± Ù…Ø¹Ø±Ù Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… ÙÙŠ Ø¬Ù„Ø³Ø© Ø§Ù„Ø¯Ø®ÙˆÙ„' };
        }
      }catch(e){
        ASSIGNMENT_LOCK.fetchError = { status:0, message:'ÙØ´Ù„ Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø¬Ù„Ø¨ Ø§Ù„ØªØ¹ÙŠÙŠÙ†Ø§Øª' };
      }
      return [];
    }

    function buildAssignmentIndex(){
      ASSIGNMENT_LOCK.collegesSet.clear();
      ASSIGNMENT_LOCK.byCollege.clear();
      (ASSIGNMENT_LOCK.pairs||[]).forEach(a=>{
        const c=(a.college||'').trim();
        const n=(a.committee_name||'').trim();
        if(!c||!n) return;
        ASSIGNMENT_LOCK.collegesSet.add(c);
        if(!ASSIGNMENT_LOCK.byCollege.has(c)) ASSIGNMENT_LOCK.byCollege.set(c,new Set());
        ASSIGNMENT_LOCK.byCollege.get(c).add(n);
      });
      ASSIGNMENT_LOCK.singleLocked = (ASSIGNMENT_LOCK.pairs.length === 1);
      const banner = document.getElementById('assignmentBanner');
      const badge  = document.getElementById('assignCountBadge');
      if (ASSIGNMENT_LOCK.enabled){
        banner.classList.remove('d-none');
        badge.textContent = String(ASSIGNMENT_LOCK.pairs.length||0);
      }else{
        banner.classList.add('d-none');
      }
      const list = document.getElementById('assignmentsList');
      list.innerHTML = '';
      if (!ASSIGNMENT_LOCK.pairs.length){
        list.innerHTML = '<div class="small text-muted">â€” Ù„Ø§ ØªÙˆØ¬Ø¯ ØªØ¹ÙŠÙŠÙ†Ø§Øª Ù„Ù‡Ø°Ø§ Ø§Ù„Ø­Ø³Ø§Ø¨ â€”</div>';
      }else{
        const grouped = {};
        ASSIGNMENT_LOCK.pairs.forEach(a=>{
          const c=a.college||'â€”'; const n=a.committee_name||'â€”';
          if(!grouped[c]) grouped[c]=[];
          grouped[c].push({n, note:(a.note||'')});
        });
        Object.keys(grouped).sort().forEach(c=>{
          const card=document.createElement('div');
          card.className='card';
          const ul = grouped[c].map((x)=>`<li><b>${x.n}</b>${x.note?` <span class="text-muted">â€” ${x.note}</span>`:''}</li>`).join('');
          card.innerHTML = `
            <div class="card-body">
              <div class="fw-bold mb-1">${c}</div>
              <ul class="mb-0 small">${ul}</ul>
            </div>`;
          list.appendChild(card);
        });
      }
    }

    function lockOrUnlockSelectors(){
      const collegeSel = document.getElementById('collegeSelect');
      const committeeSel = document.getElementById('committeeSelect');

      if (!ASSIGNMENT_LOCK.enabled){
        collegeSel.disabled = false;
        committeeSel.disabled = false;
        return;
      }
      if (ASSIGNMENT_LOCK.singleLocked && ASSIGNMENT_LOCK.pairs.length === 1){
        const only = ASSIGNMENT_LOCK.pairs[0];
        state.college = only.college;
        state.committee_name = only.committee_name;
        fillSelectOptions(collegeSel, [only.college], 'â€” Ø§Ø®ØªØ± Ø§Ù„ÙƒÙ„ÙŠØ© â€”');
        fillSelectOptions(committeeSel, [only.committee_name], 'â€” Ø§Ø®ØªØ± Ø§Ù„Ù„Ø¬Ù†Ø© â€”');
        collegeSel.value = only.college;
        committeeSel.value = only.committee_name;
        collegeSel.disabled = true;
        committeeSel.disabled = true;
        refreshSummary();
        return;
      }
      collegeSel.disabled = false;
      committeeSel.disabled = false;
    }

    /* ====== ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù‚ÙˆØ§Ø¦Ù… (ÙƒÙ„ÙŠØ©/Ù„Ø¬Ù†Ø©) ====== */
    function normalizeName(item){ if(typeof item==='string') return item; return item?.name||item?.committee_name||item?.college||''; }

    function fillSelectOptions(sel, items, placeholder){
      const current = sel.value;
      sel.innerHTML = `<option value="">${placeholder}</option>`;
      (items||[]).forEach(v=>{
        const o=document.createElement('option'); o.value=v; o.textContent=v; sel.appendChild(o);
      });
      if (items.includes(current)) sel.value = current;
    }

    async function loadDatalists(){
      const [cR,mR]=await Promise.all([
        apiFetch('/api/colleges'),
        apiFetch('/api/committee-names?q=').catch(()=>apiFetch('/api/committees-master'))
      ]);
      const colleges=(await cR.json().catch(()=>[]))||[];
      const committees=(await mR.json().catch(()=>[]))||[];
      const allCollegeNames = (colleges||[]).map(normalizeName).filter(Boolean);
      const allCommitteeNames = (committees||[]).map(normalizeName).filter(Boolean);

      if (!ASSIGNMENT_LOCK.enabled){
        fillSelectOptions(document.getElementById('collegeSelect'), allCollegeNames, 'â€” Ø§Ø®ØªØ± Ø§Ù„ÙƒÙ„ÙŠØ© â€”');
        fillSelectOptions(document.getElementById('committeeSelect'), allCommitteeNames, 'â€” Ø§Ø®ØªØ± Ø§Ù„Ù„Ø¬Ù†Ø© â€”');
        return;
      }
      const allowedColleges = Array.from(ASSIGNMENT_LOCK.collegesSet);
      fillSelectOptions(document.getElementById('collegeSelect'), allowedColleges, 'â€” Ø§Ø®ØªØ± Ø§Ù„ÙƒÙ„ÙŠØ© â€”');
      populateCommitteeSelectRestricted(document.getElementById('collegeSelect').value);
    }

    function populateCommitteeSelectRestricted(selectedCollege){
      const committeeSel=document.getElementById('committeeSelect');
      let committeesAllowed = [];
      if (selectedCollege && ASSIGNMENT_LOCK.byCollege.has(selectedCollege)){
        committeesAllowed = Array.from(ASSIGNMENT_LOCK.byCollege.get(selectedCollege));
      }
      fillSelectOptions(committeeSel, committeesAllowed, 'â€” Ø§Ø®ØªØ± Ø§Ù„Ù„Ø¬Ù†Ø© â€”');
      if (!committeesAllowed.includes(state.committee_name)){
        state.committee_name = '';
        committeeSel.value = '';
        refreshSummary();
      }
    }

    /* ====== Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§ÙØªØ±Ø§Ø¶ÙŠØ© Ù„Ù„Ø¹Ø§Ù…/Ø§Ù„ÙØµÙ„ ====== */
    async function loadDefaultsFromSettings(){
      try{
        const r=await apiFetch('/api/settings');
        const s=await r.json();
        if (s?.academicYear) {
          document.getElementById('academicYearInput').value=s.academicYear;
          state.academicYear=s.academicYear.trim();
        }
        if (s?.term) {
          document.getElementById('termSelect').value=s.term;
          state.term=s.term;
        }
      }catch{}
      refreshSummary();
      await new Promise(r=>setTimeout(r,0));
      schedulePrefillCheck();
    }

    /* ====== ØªÙØ±ÙŠØº Ø´Ø§Ù…Ù„ ====== */
    function clearAllFormInputs(){
      ['fdUrl','wpUrl','r1Url','r2Url','r3Url','saUrl'].forEach(id=>{
        const el=document.getElementById(id);
        el.value=''; el.classList.remove('is-invalid');
        el.dispatchEvent(new Event('input')); // Ù„ØªØ­Ø¯ÙŠØ« Ø­Ø§Ù„Ø© Ø£ÙŠÙ‚ÙˆÙ†Ø© Ø§Ù„Ø±Ø§Ø¨Ø·
      });
      state.formation_decision=null;
      state.work_plan=null;
      state.report1=null; state.report2=null; state.report3=null;
      state.statistical_analysis=null;

      const lists=[{elId:'invitationsList', arr:state.invitations},{elId:'minutesList', arr:state.minutes},{elId:'coverageList', arr:state.coverage_letters}];
      lists.forEach(({elId,arr})=>{
        arr.length=0; document.getElementById(elId).innerHTML='';
      });

      refreshSummary();
    }

    /* ====== Ø§Ù„ØªÙ‡ÙŠØ¦Ø© Ù…Ù† Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª ====== */
    let prefillReqCounter = 0;
    let LAST_PREFILL_KEY = '';

    async function tryPrefillFromDB(){
      const ayOk = state.academicYear && validateAcademicYear(state.academicYear).ok;
      if(!(state.college && state.committee_name && state.term && ayOk)) return;

      if (ASSIGNMENT_LOCK.enabled) {
        const okCollege = ASSIGNMENT_LOCK.collegesSet.has(state.college);
        const okComm    = ASSIGNMENT_LOCK.byCollege.get(state.college)?.has(state.committee_name);
        if (!okCollege || !okComm) {
          clearAllFormInputs();
          refreshSummary();
          return;
        }
      }

      const CURRENT_KEY = [state.college, state.committee_name, state.academicYear, state.term].join('||');

      if (CURRENT_KEY !== LAST_PREFILL_KEY) {
        clearAllFormInputs();
        refreshSummary();
        LAST_PREFILL_KEY = CURRENT_KEY;
      }

      const myReq = ++prefillReqCounter;
      const badge = document.getElementById('gdriveState');
      const oldBadgeText = badge.textContent;
      badge.textContent = 'Ø¬Ø§Ø±Ù Ø§Ù„ØªØ­Ù‚Ù‚...';

      try{
        const params = new URLSearchParams({
          college: state.college,
          committee_name: state.committee_name,
          academicYear: state.academicYear,
          term: state.term,
          limit: '1'
        });
        const r = await apiFetch(`/api/committees-files?${params.toString()}`, { method:'GET' });

        if (myReq !== prefillReqCounter) return;

        if (!r.ok) { badge.textContent = oldBadgeText; return; }

        const j = await r.json().catch(()=>null);
        const doc = j && Array.isArray(j.data) && j.data.length ? j.data[0] : null;

        if (doc){
          setSingleInputAndState('fdUrl', 'formation_decision', doc.formation_decision || null);
          setSingleInputAndState('wpUrl', 'work_plan', doc.work_plan || null);
          setSingleInputAndState('r1Url', 'report1', doc.report1 || null);
          setSingleInputAndState('r2Url', 'report2', doc.report2 || null);
          setSingleInputAndState('r3Url', 'report3', doc.report3 || null);
          setSingleInputAndState('saUrl', 'statistical_analysis', doc.statistical_analysis || null);

          rebuildMultiList('invitationsList', state.invitations, doc.invitations || []);
          rebuildMultiList('minutesList', state.minutes, doc.minutes || []);
          rebuildMultiList('coverageList', state.coverage_letters, doc.coverage_letters || []);

          pushToast({type:'success', body:'ØªÙ… ØªØ­Ù…ÙŠÙ„ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù„Ø¬Ù†Ø©.'});
        } else {
          clearAllFormInputs();
          pushToast({type:'info', body:'Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª Ù„Ù‡Ø°Ù‡ Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹Ø© â€“ ØªÙ… ØªÙØ±ÙŠØº Ø§Ù„Ø­Ù‚ÙˆÙ„.'});
        }

      }catch(e){
        console.error('Prefill error:', e);
        pushToast({type:'error', body:'ØªØ¹Ø°Ø± Ø¬Ù„Ø¨ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù„Ø¬Ù†Ø©.'});
      }finally{
        badge.textContent = oldBadgeText;
        refreshSummary();
      }
    }

    /* ====== Debounce ====== */
    let prefillTimer = null;
    function schedulePrefillCheck(){
      clearTimeout(prefillTimer);
      prefillTimer = setTimeout(tryPrefillFromDB, 300);
    }

    /* ====== Ø­ÙØ¸ ====== */
    function buildPayload(){
      return {
        college: state.college,
        committee_name: state.committee_name,
        academicYear: state.academicYear,
        term: state.term,
        formation_decision: state.formation_decision,
        work_plan: state.work_plan,
        invitations: state.invitations.filter(x=>x.value).map(x=>({ type:'url', value:x.value, title:x.title||'' })),
        minutes: state.minutes.filter(x=>x.value).map(x=>({ type:'url', value:x.value, title:x.title||'' })),
        coverage_letters: state.coverage_letters.filter(x=>x.value).map(x=>({ type:'url', value:x.value, title:x.title||'' })),
        report1: state.report1, report2: state.report2, report3: state.report3,
        statistical_analysis: state.statistical_analysis
      };
    }

    function validateWithinAssignments(){
      if (!ASSIGNMENT_LOCK.enabled) return true;
      if (!ASSIGNMENT_LOCK.collegesSet.has(state.college)) return false;
      const set = ASSIGNMENT_LOCK.byCollege.get(state.college);
      if (!set || !set.has(state.committee_name)) return false;
      return true;
    }

    document.getElementById('saveBtn').addEventListener('click', async ()=>{
      try{
        if(!state.college || !state.committee_name){
          pushToast({type:'warn', body:'Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„ÙƒÙ„ÙŠØ© ÙˆØ§Ø³Ù… Ø§Ù„Ù„Ø¬Ù†Ø©'}); return;
        }
        if(!state.academicYear){
          pushToast({type:'warn', body:'Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø¥Ø¯Ø®Ø§Ù„ Ø§Ù„Ø¹Ø§Ù… Ø§Ù„Ø¬Ø§Ù…Ø¹ÙŠ'}); return;
        }
        const chk = validateAcademicYear(state.academicYear);
        if(!chk.ok){ ayInput.classList.add('is-invalid'); pushToast({type:'warn', body:chk.msg}); return; }
        if(!state.term){ pushToast({type:'warn', body:'Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„ÙØµÙ„ Ø§Ù„Ø¯Ø±Ø§Ø³ÙŠ'}); return; }
        if (!validateWithinAssignments()){
          pushToast({type:'error', body:'Ù„Ø§ ØªÙ…Ù„Ùƒ ØµÙ„Ø§Ø­ÙŠØ© Ø§Ù„Ø­ÙØ¸ Ù„Ù‡Ø°Ù‡ Ø§Ù„ÙƒÙ„ÙŠØ©/Ø§Ù„Ù„Ø¬Ù†Ø© ÙˆÙÙ‚ Ø§Ù„ØªØ¹ÙŠÙŠÙ†Ø§Øª.'}); return;
        }

        const singles=['formation_decision','work_plan','report1','report2','report3','statistical_analysis'];
        for(const k of singles){
          const v=state[k];
          if(v && (!v.value || !isValidUrl(v.value))){
            pushToast({type:'warn', body:'Ù‡Ù†Ø§Ùƒ Ø±Ø§Ø¨Ø· ØºÙŠØ± ØµØ§Ù„Ø­ ÙÙŠ: '+k}); return;
          }
        }

        const payload=buildPayload();
        const r = await fetch(`${API_BASE}/api/committees-files`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          credentials: 'include',
          body: JSON.stringify(payload)
        });

        if(!r.ok){
          const j=await r.json().catch(()=>({}));
          pushToast({type:'error', body:'ÙØ´Ù„ Ø§Ù„Ø­ÙØ¸: ' + (j.message || r.status)}); return;
        }

        pushToast({type:'success', body:'âœ… ØªÙ… Ø§Ù„Ø­ÙØ¸ Ø¨Ù†Ø¬Ø§Ø­'});
      }catch(e){ console.error(e); pushToast({type:'error', body:'Ø­Ø¯Ø« Ø®Ø·Ø£ ØºÙŠØ± Ù…ØªÙˆÙ‚Ø¹ Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„Ø­ÙØ¸'}); }
    });

    document.getElementById('resetBtn').addEventListener('click',()=>location.reload());

    // Ø²Ø± Ø¹Ø±Ø¶ Ø§Ù„ØªØ¹ÙŠÙŠÙ†Ø§Øª
    const assignmentsModal = new bootstrap.Modal('#assignmentsModal');
    document.getElementById('showAssignmentsBtn')?.addEventListener('click', ()=>assignmentsModal.show());

    /* ====== Ø¨Ø¯Ø¡ Ø§Ù„ØªØ´ØºÙŠÙ„ ====== */
    (async function init(){
      try{
        await ensureAuth();

        ASSIGNMENT_LOCK.enabled = (CURRENT_USER?.role === 'subuser-member');

        if (ASSIGNMENT_LOCK.enabled) {
          ASSIGNMENT_LOCK.pairs = await fetchMyAssignments();
          buildAssignmentIndex();

          if (ASSIGNMENT_LOCK.fetchError && !ASSIGNMENT_LOCK.pairs.length){
            pushToast({
              type:'error',
              title:'ØªØ¹Ø°Ø± Ø¬Ù„Ø¨ ØªØ¹ÙŠÙŠÙ†Ø§Øª Ù‡Ø°Ø§ Ø§Ù„Ø­Ø³Ø§Ø¨',
              body:`(${ASSIGNMENT_LOCK.fetchError.status||'â€”'}) ${ASSIGNMENT_LOCK.fetchError.message || ''}<br>ØªØ­Ù‚Ù‚ Ù…Ù† ÙˆØ¬ÙˆØ¯ Ø§Ù„Ù…Ø³Ø§Ø± <code>/api/committee-assignments/mine</code> Ø£Ùˆ Ø§Ù„Ø³Ù…Ø§Ø­ Ø¨Ø§Ù„Ø§Ø³ØªØ¹Ù„Ø§Ù… Ø§Ù„Ù…Ù‚ÙŠÙ‘ÙØ¯.`
            });
          } else if (!ASSIGNMENT_LOCK.pairs.length){
            pushToast({type:'warn', body:'Ù„Ø§ ØªÙˆØ¬Ø¯ ØªØ¹ÙŠÙŠÙ†Ø§Øª Ù„Ù‡Ø°Ø§ Ø§Ù„Ø­Ø³Ø§Ø¨. ØªÙˆØ§ØµÙ„ Ù…Ø¹ Ø§Ù„Ù…Ø´Ø±Ù.'});
          }
        }

        await loadDatalists();
        lockOrUnlockSelectors();

        await loadDefaultsFromSettings();
        refreshSummary();
        setGDriveState(false);
      }catch(e){
        console.error(e);
        pushToast({type:'error', body:'ØªØ¹Ø°Ø± ØªÙ‡ÙŠØ¦Ø© Ø§Ù„ØµÙØ­Ø©.'});
      }
    })();
  </script>
</body>
</html>
