<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <title>Ø³Ø¬Ù„ Ø§Ù„Ø¹Ù…Ù„ÙŠØ§Øª - Ù†Ø¸Ø§Ù… Ø§Ù„Ù„Ø¬Ø§Ù†</title>
  <link rel="icon" type="image/png" href="https://www.dropbox.com/scl/fi/f283e4rvv5cf9x12a1cic/my-website-logo.png?rlkey=yia776im7klypy27af32m0scy&e=1&st=vhaprvzh&dl=1">
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.rtl.min.css">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css">
  <style>
    body{background:#f8f9fa;font-family:'Segoe UI',sans-serif}
    .container{max-width:1200px;margin-top:40px}
    .card{border-radius:16px;box-shadow:0 6px 18px rgba(0,0,0,.06)}
    .user-chip{font-size:.9rem}

    /* Ø¨Ø·Ø§Ù‚Ø§Øª Ø§Ù„Ù…Ø­ØªÙˆÙ‰ ÙÙŠ Ø¹Ù…ÙˆØ¯ÙŠ "Ù‚Ø¨Ù„/Ø¨Ø¹Ø¯"  */
    .payload-card{
      background:#fff;border:1px solid #e9ecef;border-radius:12px;padding:10px;
      height:220px;overflow:auto
    }
    .payload-card dt{color:#6c757d;font-weight:600}
    .payload-card dd{margin-bottom:.5rem}
    .payload-json{
      direction:ltr;background:#f6f8fa;border-radius:8px;padding:8px;
      font-family:ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,"Liberation Mono","Courier New",monospace
    }

    .filters .form-control, .filters .form-select{min-width:160px}
    .minw-40{min-width:40px}
    .minw-60{min-width:60px}
    .minw-120{min-width:120px}

    /* Ù„Ø§ ØªÙƒØ³Ù‘Ø± Ø¹Ù†Ø§ÙˆÙŠÙ† Ø§Ù„Ø£Ø¹Ù…Ø¯Ø© */
    .table thead th{vertical-align:middle;white-space:nowrap}

    .sticky-actions{position:sticky;bottom:0;background:#fff;border-top:1px solid #e9ecef;padding:12px;border-radius:0 0 16px 16px}
    .count-badge{font-size:.85rem}

    /* Ø¥Ø¨Ø±Ø§Ø² Ø§Ù„Ø§Ø®ØªÙ„Ø§ÙØ§Øª */
    .diff-added{color:#198754;font-weight:600;background:rgba(25,135,84,.12);border-radius:6px;padding:2px 6px}
    .diff-removed{color:#dc3545;font-weight:600;background:rgba(220,53,69,.12);border-radius:6px;padding:2px 6px}

    /* ØªÙˆØ²ÙŠØ¹ Ø§Ù„Ø£Ø¹Ù…Ø¯Ø© */
    .col-user{width:16%}
    .col-before{width:34%}
    .col-after{width:34%}

    /* Ø§Ø¬Ø¨Ø± Ø§Ù„Ø¬Ø¯ÙˆÙ„ Ø§Ù„Ø£Ø³Ø§Ø³ÙŠ Ø¹Ù„Ù‰ ØªÙˆØ²ÙŠØ¹ Ø«Ø§Ø¨Øª Ø­ØªÙ‰ Ù„Ø§ â€œÙŠÙ†ÙØ´â€ Ø¨Ø³Ø¨Ø¨ Ø®Ù„ÙŠØ© ÙˆØ§Ø­Ø¯Ø© */
    .table { table-layout: fixed; }

    /* Ø§Ù„Ø¬Ø¯Ø§ÙˆÙ„ Ø¯Ø§Ø®Ù„ Ø¨Ø·Ø§Ù‚Ø© â€œØ§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù‚Ø¨Ù„/Ø¨Ø¹Ø¯â€ Ù„Ø§ ØªØªÙ…Ø¯Ø¯ Ø®Ø§Ø±Ø¬ Ø§Ù„Ø¨Ø·Ø§Ù‚Ø© */
    .payload-card .table{ table-layout: fixed; width:100%; }
    .payload-card .table th,
    .payload-card .table td{
      white-space: normal;
      word-break: break-word;       /* Chrome/Edge */
      overflow-wrap: anywhere;      /* Safari/Firefox */
    }

    /* ÙƒÙŠ Ù„Ø§ ØªØªØ¬Ø§ÙˆØ² Ø§Ù„Ø¨Ø§Ø¯Ø¬Ø§Øª Ø­Ø¯ÙˆØ¯ Ø§Ù„Ø®Ù„ÙŠØ© */
    .payload-card .badge { white-space: nowrap; }

    /* Ø³Ø§Ø¹Ø¯ Ø§Ù„Ù†ØµÙˆØµ Ø§Ù„Ù„Ø§ØªÙŠÙ†ÙŠØ©/Ø§Ù„Ø¥ÙŠÙ…ÙŠÙ„ Ø¹Ù„Ù‰ Ø§Ù„Ø§Ù†ÙƒØ³Ø§Ø± Ø¨Ø´ÙƒÙ„ ØµØ­ÙŠ */
    .payload-card { direction: rtl; }
    .payload-card .email,
    .payload-card code,
    .payload-card .payload-json {
      direction: ltr;
      unicode-bidi: plaintext;
      word-break: break-all;
    }

    /* Ø´Ø§Ø±Ø© "Ù„Ø§ ØªØºÙŠÙŠØ± ÙØ¹Ù„ÙŠ" */
    .nochange-note{
      border:1px solid rgba(13,110,253,.25);
      background:rgba(13,110,253,.06);
      color:#0d6efd;
      border-radius:10px;
      padding:4px 8px;
      font-size:.85rem;
    }
  </style>
</head>
<body>
  <div class="container">
    <!-- Header -->
    <div class="d-flex flex-wrap justify-content-between align-items-center mb-4 gap-2">
      <h3 class="mb-0">Ø³Ø¬Ù„ Ø§Ù„Ø¹Ù…Ù„ÙŠØ§Øª</h3>
      <div class="d-flex align-items-center gap-2">
        <span id="userInfo" class="user-chip badge bg-light text-dark border">
          <i class="bi bi-person"></i>
          <span id="userUsername">â€”</span>
          <span class="mx-1">â€”</span>
          <span id="userFullName">â€”</span>
          <span class="ms-2 badge bg-secondary" id="userRole">â€”</span>
        </span>
        <a id="homeLink" class="btn btn-outline-primary" href="#">
          <i class="bi bi-grid"></i> Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ…
        </a>
        <button id="logoutBtn" class="btn btn-danger">
          <i class="bi bi-box-arrow-right"></i> Ø®Ø±ÙˆØ¬
        </button>
      </div>
    </div>

    <!-- ÙÙ„Ø§ØªØ± -->
    <div class="card mb-3">
      <div class="card-body">
        <div class="filters d-flex flex-wrap align-items-end gap-2">
          <div>
            <label class="form-label">Ø§Ù„ØµÙØ­Ø©</label>
            <select id="fModel" class="form-select">
              <option value="">Ø§Ù„ÙƒÙ„</option>
              <option value="Evaluation">ØªÙ‚ÙŠÙŠÙ… Ø§Ù„Ù„Ø¬Ø§Ù†</option>
              <option value="College">Ø§Ù„ÙƒÙ„ÙŠØ§Øª</option>
              <option value="Auditor">Ø§Ù„Ù…Ø¯Ù‚Ù‚ÙˆÙ†</option>
              <option value="Committee">Ø£Ø³Ù…Ø§Ø¡ Ø§Ù„Ù„Ø¬Ø§Ù†</option>
              <option value="Settings">Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª</option>
              <option value="User">Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙˆÙ†</option>
            </select>
          </div>
          <div>
            <label class="form-label">Ø§Ù„Ø¹Ù…Ù„ÙŠØ©</label>
            <select id="fAction" class="form-select">
              <option value="">Ø§Ù„ÙƒÙ„</option>
              <option>create</option>
              <option>update</option>
              <option>delete</option>
            </select>
          </div>
          <div>
            <label class="form-label">Ø¨Ø­Ø« (Ø§Ø³Ù…/Ø¥ÙŠÙ…ÙŠÙ„/Ø§Ø³Ù… Ù…Ø³ØªØ®Ø¯Ù…)</label>
            <input id="fQuery" type="text" class="form-control" placeholder="Ù…Ø«Ù„: laith Ø£Ùˆ b01578">
          </div>
          <div>
            <label class="form-label">Ù…Ù† ØªØ§Ø±ÙŠØ®</label>
            <input id="fFrom" type="date" class="form-control">
          </div>
          <div>
            <label class="form-label">Ø¥Ù„Ù‰ ØªØ§Ø±ÙŠØ®</label>
            <input id="fTo" type="date" class="form-control">
          </div>
          <div class="ms-auto d-flex gap-2">
            <button id="btnSearch" class="btn btn-primary"><i class="bi bi-search"></i> Ø¨Ø­Ø«</button>
            <button id="btnClear" class="btn btn-outline-secondary"><i class="bi bi-x-circle"></i> ØªÙØ±ÙŠØº</button>
          </div>
        </div>
      </div>
    </div>

    <!-- Ø§Ù„Ø¬Ø¯ÙˆÙ„ -->
    <div class="card">
      <div class="card-body p-0">
        <div class="table-responsive">
          <table class="table table-hover align-middle mb-0">
            <thead class="table-light">
              <tr>
                <th class="minw-40 text-center">
                  <input class="form-check-input" type="checkbox" id="chkAll" title="ØªØ­Ø¯ÙŠØ¯/Ø¥Ù„ØºØ§Ø¡ ØªØ­Ø¯ÙŠØ¯ Ø§Ù„ÙƒÙ„">
                </th>
                <th class="minw-60">#</th>
                <th class="minw-120">Ø§Ù„ÙˆÙ‚Øª</th>
                <th>Ø§Ù„ØµÙØ­Ø©</th>
                <th>Ø§Ù„Ø¹Ù…Ù„ÙŠØ©</th>
                <th class="col-user">Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…</th>
                <th class="col-before">Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù‚Ø¨Ù„</th>
                <th class="col-after">Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø¨Ø¹Ø¯</th>
              </tr>
            </thead>
            <tbody id="logsTbody">
              <tr class="text-center text-muted"><td colspan="8">Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„â€¦</td></tr>
            </tbody>
          </table>
        </div>

        <!-- Ø´Ø±ÙŠØ· Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª -->
        <div class="sticky-actions d-flex flex-wrap justify-content-between align-items-center gap-2">
          <div class="d-flex flex-wrap gap-2">
            <button id="btnMore" class="btn btn-outline-secondary">
              <i class="bi bi-plus-circle"></i> ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ø²ÙŠØ¯
            </button>
            <button id="btnPurge" class="btn btn-outline-danger">
              <i class="bi bi-trash3"></i> Ø­Ø°Ù ÙƒÙ„ Ø§Ù„Ø³Ø¬Ù„Ø§Øª
            </button>
            <button id="btnPurgeRange" class="btn btn-outline-warning">
              <i class="bi bi-calendar-x"></i> Ø­Ø°Ù Ø­Ø³Ø¨ Ø§Ù„ØªØ§Ø±ÙŠØ®
            </button>
            <button id="btnDeleteSelected" class="btn btn-danger" disabled>
              <i class="bi bi-check2-square"></i> Ø­Ø°Ù Ø§Ù„Ø³Ø¬Ù„Ø§Øª Ø§Ù„Ù…Ø­Ø¯Ø¯Ø©
            </button>
          </div>
          <div>
            <span class="badge text-bg-light count-badge">
              Ø§Ù„Ù…Ø­Ø¯Ø¯: <span id="selectedCount">0</span>
            </span>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Toasts -->
  <div class="toast-container position-fixed top-0 start-50 translate-middle-x p-3" style="z-index:2000">
    <div id="toastSuccess" class="toast align-items-center text-bg-success border-0 mb-2" role="alert" aria-live="assertive" aria-atomic="true">
      <div class="d-flex">
        <div class="toast-body">âœ… ØªÙ… Ø§Ù„ØªÙ†ÙÙŠØ° Ø¨Ù†Ø¬Ø§Ø­</div>
        <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button>
      </div>
    </div>
    <div id="toastError" class="toast align-items-center text-bg-danger border-0 mb-2" role="alert" aria-live="assertive" aria-atomic="true">
      <div class="d-flex">
        <div class="toast-body">âŒ Ø­Ø¯Ø« Ø®Ø·Ø£</div>
        <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button>
      </div>
    </div>
    <div id="toastInfo" class="toast align-items-center text-bg-primary border-0 mb-2" role="status" aria-live="polite" aria-atomic="true">
      <div class="d-flex">
        <div class="toast-body">â„¹ï¸ Ù…Ø¹Ù„ÙˆÙ…Ø§Øª</div>
        <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button>
      </div>
    </div>
  </div>

  <!-- Modal ØªØ£ÙƒÙŠØ¯ -->
  <div class="modal fade" id="confirmModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
      <div class="modal-content">
        <div class="modal-header">
          <h5 id="confirmModalTitle" class="modal-title">ØªØ£ÙƒÙŠØ¯</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Ø¥ØºÙ„Ø§Ù‚"></button>
        </div>
        <div class="modal-body" id="confirmModalBody">Ù‡Ù„ ØªØ±ÙŠØ¯ Ø§Ù„Ù…ØªØ§Ø¨Ø¹Ø©ØŸ</div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Ø¥Ù„ØºØ§Ø¡</button>
          <button type="button" class="btn btn-danger" id="confirmModalConfirmBtn">ØªØ£ÙƒÙŠØ¯</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Scripts -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

  
  <script>
  // ========== Ø¥Ø¹Ø¯Ø§Ø¯ Ø§Ù„Ù…Ø³Ø§Ø±Ø§Øª ==========
  const API_BASE = location.hostname.endsWith('github.io') ? 'https://vdash-qkyv.onrender.com' : '';
  const api = (p)=> API_BASE + p;

  // Ø±Ø§Ø¨Ø· Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ…
  document.getElementById('homeLink').href = api('/committees-home.html');

  // ========== Toasts ==========
  const toastSuccess = new bootstrap.Toast(document.getElementById('toastSuccess'));
  const toastError   = new bootstrap.Toast(document.getElementById('toastError'));
  const toastInfo    = new bootstrap.Toast(document.getElementById('toastInfo'));
  const setToast = (t,msg)=> t._element.querySelector('.toast-body').innerText = msg;

  // ========== Modal confirm ==========
  const confirmModalEl = document.getElementById('confirmModal');
  const confirmModal   = new bootstrap.Modal(confirmModalEl);
  const confirmTitle   = document.getElementById('confirmModalTitle');
  const confirmBody    = document.getElementById('confirmModalBody');
  const confirmBtn     = document.getElementById('confirmModalConfirmBtn');
  const showConfirm = ({title='ØªØ£ÙƒÙŠØ¯',message='Ù‡Ù„ ØªØ±ÙŠØ¯ Ø§Ù„Ù…ØªØ§Ø¨Ø¹Ø©ØŸ',confirmText='ØªØ£ÙƒÙŠØ¯',confirmBtnClass='btn-danger'}={})=>{
    return new Promise(resolve=>{
      confirmTitle.textContent=title; confirmBody.textContent=message;
      confirmBtn.className='btn '+confirmBtnClass; confirmBtn.textContent=confirmText;
      let ok=false;
      const onConfirm=()=>{ ok=true; confirmModal.hide(); resolve(true); };
      const onHidden =()=>{ confirmModalEl.removeEventListener('hidden.bs.modal',onHidden); confirmBtn.removeEventListener('click',onConfirm); if(!ok) resolve(false); };
      confirmBtn.addEventListener('click',onConfirm,{once:true});
      confirmModalEl.addEventListener('hidden.bs.modal',onHidden,{once:true});
      confirmModal.show();
    });
  };

  // ========== Ø£Ø¯ÙˆØ§Øª Ø´Ø¨ÙƒØ© Ù‚ÙˆÙŠØ© ==========
  async function fetchJSON(url, options={}){
    const r = await fetch(url, { credentials:'include', headers:{'Accept':'application/json', ...(options.headers||{})}, ...options });
    const ctype = (r.headers.get('content-type')||'').toLowerCase();
    if(!ctype.includes('application/json')){
      return { __nonJSON__: true, status: r.status };
    }
    let data;
    try { data = await r.json(); }
    catch { return { __badJSON__: true, status: r.status }; }
    return { ok: r.ok, status: r.status, data };
  }

  // ========== Ù…ØµØ§Ø¯Ù‚Ø© ==========
  const normalizeUser = (u)=>{
    if(!u) return { name:'â€”', username:'â€”', email:'', role:'â€”' };
    if(typeof u==='string') return { name:u, username:u, email:'', role:'' };
    const username = u.username || (u.email ? u.email.split('@')[0] : (u.name||'â€”'));
    return { name:u.name||'â€”', username, email:u.email||'', role:u.role||'â€”' };
  };
  function renderUser(uRaw){
    const u = normalizeUser(uRaw);
    document.getElementById('userUsername').textContent = u.username;
    document.getElementById('userFullName').textContent = u.name;
    document.getElementById('userRole').textContent     = u.role;
  }
  async function ensureAdmin(){
    const meRes = await fetchJSON(api('/auth/committees/me'));
    if(meRes.__nonJSON__ || meRes.__badJSON__ || !meRes.ok){
      const rel = location.pathname + location.search + location.hash;
      location.href = api(`/committees-login.html?next=${encodeURIComponent(rel)}`);
      throw new Error('unauthenticated');
    }
    const me = meRes.data || {};
    if(!me.authenticated){
      const rel = location.pathname + location.search + location.hash;
      location.href = api(`/committees-login.html?next=${encodeURIComponent(rel)}`);
      throw new Error('unauthenticated');
    }
    const role = (me.user?.role||'').toLowerCase();
    if(role!=='admin'){
      setToast(toastError,'âŒ Ù‡Ø°Ù‡ Ø§Ù„ØµÙØ­Ø© Ù„Ù„Ù…Ø´Ø±ÙÙŠÙ† ÙÙ‚Ø·'); toastError.show();
      setTimeout(()=>location.href=api('/committees-home.html'),900);
      throw new Error('not-admin');
    }
    renderUser(me.user);
    return me.user;
  }
  async function logout(){
    try{
      const r = await fetch(api('/auth/committees/logout'),{ method:'POST', headers:{'Content-Type':'application/json'}, credentials:'include' });
      if(r.ok){ setToast(toastSuccess,'âœ… ØªÙ… ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬'); toastSuccess.show(); setTimeout(()=>location.href=api('/committees-login.html'),700); }
      else    { setToast(toastError,'âŒ ØªØ¹Ø°Ø± ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬'); toastError.show(); }
    }catch{ setToast(toastError,'âŒ Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø§ØªØµØ§Ù„'); toastError.show(); }
  }
  document.getElementById('logoutBtn').addEventListener('click', logout);

  // ========== Ù…Ø³Ø§Ø¹Ø¯Ø§Øª Ø¹Ø±Ø¶ ==========
  function modelToPage(m){ return ({Evaluation:'ØªÙ‚ÙŠÙŠÙ… Ø§Ù„Ù„Ø¬Ø§Ù†',College:'Ø§Ù„ÙƒÙ„ÙŠØ§Øª',Auditor:'Ø§Ù„Ù…Ø¯Ù‚Ù‚ÙˆÙ†',Committee:'Ø£Ø³Ù…Ø§Ø¡ Ø§Ù„Ù„Ø¬Ø§Ù†',Settings:'Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª',User:'Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙˆÙ†'})[m] || (m||'â€”'); }
  function badgeAction(a){ const cls = a==='delete'?'text-bg-danger':(a==='update'?'text-bg-warning':'text-bg-success'); return `<span class="badge ${cls}">${a||'â€”'}</span>`; }
  function fmtUser(uRaw){ const u=normalizeUser(uRaw); const email=u.email?` <span class="badge text-bg-light">${u.email}</span>`:''; const role=u.role?` <span class="badge text-bg-secondary">${u.role}</span>`:''; return `${u.name} <span class="badge text-bg-info">${u.username}</span>${email}${role}`; }

  // ==== diff helpers ====
  const colNameArMap={ committee_name:'Ø§Ø³Ù… Ø§Ù„Ù„Ø¬Ù†Ø©', college:'Ø§Ù„ÙƒÙ„ÙŠØ©', auditor_name:'Ø§Ù„Ù…Ø¯Ù‚Ù‚', createdAt:'ØªØ§Ø±ÙŠØ® Ø§Ù„Ø¥Ù†Ø´Ø§Ø¡', updatedAt:'ØªØ§Ø±ÙŠØ® Ø§Ù„ØªØ­Ø¯ÙŠØ«', notes:'Ù…Ù„Ø§Ø­Ø¸Ø§Øª', score:'Ø§Ù„Ù†ØªÙŠØ¬Ø©', work_plan:'Ø®Ø·Ø© Ø§Ù„Ø¹Ù…Ù„', performance_indicators:'Ù…Ø¤Ø´Ø±Ø§Øª Ø§Ù„Ø§Ø¯Ø§Ø¡', meetings:'Ø¹Ø¯Ø¯ Ø§Ù„Ø§Ø¬ØªÙ…Ø§Ø¹Ø§Øª', consistency:'Ø§Ù„ØªÙˆØ§ÙÙ‚ Ø¨ÙŠÙ† Ø§Ù„Ø¯Ø¹ÙˆØ§Øª ÙˆØ§Ù„Ø§Ø¬ØªÙ…Ø§Ø¹Ø§Øª', coverage_books:'ÙƒØªØ¨ Ø§Ù„ØªØºØ·ÙŠØ©', report1:'ØªÙ‚Ø±ÙŠØ± Ø¥Ù†Ø¬Ø§Ø² 1', report2:'ØªÙ‚Ø±ÙŠØ± Ø¥Ù†Ø¬Ø§Ø² 2', report3:'ØªÙ‚Ø±ÙŠØ± Ø¥Ù†Ø¬Ø§Ø² 3', statistical_analysis:'Ø§Ù„ØªØ­Ù„ÙŠÙ„ Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠ', name:'Ø§Ù„Ø§Ø³Ù…', username:'Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…', role:'Ø§Ù„Ø¯ÙˆØ±', email:'Ø§Ù„Ø¨Ø±ÙŠØ¯', isActive:'Ø§Ù„Ø­Ø§Ù„Ø©', formation_decision:'Ù‚Ø±Ø§Ø± Ø§Ù„ØªØ´ÙƒÙŠÙ„', formationDecision:'Ù‚Ø±Ø§Ø± Ø§Ù„ØªØ´ÙƒÙŠÙ„', decision:'Ù‚Ø±Ø§Ø± Ø§Ù„ØªØ´ÙƒÙŠÙ„', decision_number:'Ù‚Ø±Ø§Ø± Ø§Ù„ØªØ´ÙƒÙŠÙ„', decisionNumber:'Ù‚Ø±Ø§Ø± Ø§Ù„ØªØ´ÙƒÙŠÙ„', formation_no:'Ù‚Ø±Ø§Ø± Ø§Ù„ØªØ´ÙƒÙŠÙ„', formationNo:'Ù‚Ø±Ø§Ø± Ø§Ù„ØªØ´ÙƒÙŠÙ„' };
  const toArabicLabel=(k)=> colNameArMap[k]||k;
  const escapeHtml=(s)=> String(s).replace(/[&<>"']/g, m=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]));
  const normalizeValue=(v)=> v==null? '' : (v instanceof Date? v.toISOString() : (Array.isArray(v)||typeof v==='object')? JSON.stringify(v) : String(v));
  function computeDiffKeys(b,a){ const B=b||{},A=a||{}; const keys=new Set([...Object.keys(B),...Object.keys(A)]); const changed=new Set(); keys.forEach(k=>{ if(normalizeValue(B[k])!==normalizeValue(A[k])) changed.add(k); }); return changed; }
  const roleAr = (r)=> r==='admin'?'Ù…Ø¯ÙŠØ± (admin)':'Ù…Ø³ØªØ®Ø¯Ù… (user)';
  function kv(label,val,key,diff,mode){ if(val==null||val==='') return ''; const cls=diff&&diff.has(key)?(mode==='before'?'diff-removed':'diff-added'):''; return `<dt>${label}</dt><dd class="${cls}">${escapeHtml(val)}</dd>`; }
  function userActiveBadge(val,key,diff,mode){ const is=!!val; const base=is?'<span class="badge text-bg-success">Ù†Ø´Ø·</span>':'<span class="badge text-bg-danger">Ù…Ø¹Ø·Ù‘Ù„</span>'; const cls=diff&&diff.has(key)?(mode==='before'?'diff-removed':'diff-added'):''; return `<dt>Ø§Ù„Ø­Ø§Ù„Ø©</dt><dd class="${cls}">${base}</dd>`; }

  function renderCardFromObjectWithDiff(model,obj,diffKeys,mode,otherSide){
    if(!obj) return '<div class="payload-card text-muted">â€”</div>';
    let h='<div class="payload-card"><dl class="row mb-0">', d=obj, has=(k)=> d[k]!=null && d[k]!=='';    
    if(model==='Evaluation'){
      h+=kv('Ø§Ø³Ù… Ø§Ù„Ù„Ø¬Ù†Ø©',d.committee_name,'committee_name',diffKeys,mode)
        +kv('Ø§Ù„ÙƒÙ„ÙŠØ©',d.college,'college',diffKeys,mode)
        +kv('Ø§Ù„Ù…Ø¯Ù‚Ù‚',d.auditor_name,'auditor_name',diffKeys,mode)
        +kv('ØªØ§Ø±ÙŠØ® Ø§Ù„Ø¥Ù†Ø´Ø§Ø¡', d.createdAt?new Date(d.createdAt).toLocaleString('ar-EG'):'','createdAt',diffKeys,mode)
        +kv('Ø§Ù„Ù†ØªÙŠØ¬Ø©',d.score,'score',diffKeys,mode);
      const decisionKey=['formation_decision','formationDecision','decision','decision_number','decisionNumber','formation_no','formationNo'].find(k=>k in d);
      if(decisionKey) h+=kv('Ù‚Ø±Ø§Ø± Ø§Ù„ØªØ´ÙƒÙŠÙ„', d[decisionKey], decisionKey, diffKeys, mode);
      ['work_plan','performance_indicators','meetings','consistency','coverage_books','report1','report2','report3','statistical_analysis'].forEach(k=>{ if(has(k)) h+=kv(toArabicLabel(k),d[k],k,diffKeys,mode); });
    }else if(model==='College' || model==='Auditor' || model==='Committee'){
      const label = (model==='College') ? 'Ø§Ù„ÙƒÙ„ÙŠØ©' : (model==='Auditor' ? 'Ø§Ù„Ù…Ø¯Ù‚Ù‚' : 'Ø§Ø³Ù… Ø§Ù„Ù„Ø¬Ù†Ø©');
      h+=kv(label, d.name, 'name', diffKeys, mode);
    }else if(model==='Settings'){
      if(d.visibleColumns) h+=kv('Ø§Ù„Ø£Ø¹Ù…Ø¯Ø© Ø§Ù„Ù…Ø±Ø¦ÙŠØ©',(d.visibleColumns||[]).map(toArabicLabel).join('ØŒ '),'visibleColumns',diffKeys,mode);
      if(d.selectedVisits) h+=kv('Ø§Ù„Ø²ÙŠØ§Ø±Ø§Øª Ø§Ù„Ù…Ø­Ø¯Ø¯Ø©',(d.selectedVisits||[]).map(toArabicLabel).join('ØŒ '),'selectedVisits',diffKeys,mode);
    }else if(model==='User'){
      if(has('name'))h+=kv('Ø§Ù„Ø§Ø³Ù…',d.name,'name',diffKeys,mode);
      if(has('username'))h+=kv('Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…',d.username,'username',diffKeys,mode);
      if(has('email'))h+=kv('Ø§Ù„Ø¨Ø±ÙŠØ¯',d.email,'email',diffKeys,mode);
      if(has('role'))h+=kv('Ø§Ù„Ø¯ÙˆØ±',roleAr(d.role),'role',diffKeys,mode);
      if('isActive' in d) h+=userActiveBadge(d.isActive,'isActive',diffKeys,mode);
    }else{
      h+='</dl><div class="payload-json"><code>'+escapeHtml(JSON.stringify(obj,null,2))+'</code></div></div>'; 
      return h;
    }
    h+='</dl>'; 
    if(!/<dd[^>]*>/.test(h)){ h+='<div class="payload-json"><code>'+escapeHtml(JSON.stringify(obj,null,2))+'</code></div>'; } 
    h+='</div>'; 
    return h;
  }

  // ========== ÙƒØªÙ„Ø© Ø¹Ø±Ø¶ "Ø§Ù„ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ø¬Ù…Ø§Ø¹ÙŠ" ==========
  function synthesizeBulkAfter(p){
    if (!Array.isArray(p?.before)) return null;
    const action=p?.action;
    if (action==='activate')   return p.before.map(u=>({...u,isActive:true}));
    if (action==='deactivate') return p.before.map(u=>({...u,isActive:false}));
    if (action==='set-role')   return p.before.map(u=>({...u,role: p.role==='admin'?'admin':'user'}));
    if (action==='delete')     return p.before.map(u=>({...u,_deleted:true}));
    return null;
  }

  function renderBulkUsersList(p,mode){
    const listBefore=Array.isArray(p?.before)?p.before:[];
    const listAfter =Array.isArray(p?.after)?p.after:synthesizeBulkAfter(p);
    const action=p?.action;
    const idsCount=Array.isArray(p?.ids)?p.ids.length:0;

    if(listBefore.length===0){
      const actionAr = action==='set-role' ? `ØªØºÙŠÙŠØ± Ø§Ù„Ø¯ÙˆØ± Ø¥Ù„Ù‰ ${roleAr(p.role)}`
                    : action==='activate' ? 'ØªÙØ¹ÙŠÙ„ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ†'
                    : action==='deactivate' ? 'ØªØ¹Ø·ÙŠÙ„ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ†'
                    : (action || 'ØªØ¹Ø¯ÙŠÙ„ Ø¬Ù…Ø§Ø¹ÙŠ');
      return `<div class="payload-card"><dl class="row mb-0">
        <dt>Ø¹Ù…Ù„ÙŠØ© Ø¬Ù…Ø§Ø¹ÙŠØ©</dt><dd>${escapeHtml(actionAr)} (Ø¹Ø¯Ø¯: ${idsCount||'â€”'})</dd>
        <dt>Ù…Ù„Ø§Ø­Ø¸Ø©</dt><dd class="text-muted">Ù„ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ø£Ø³Ù…Ø§Ø¡ Ø³Ø¬Ù‘Ù„ Ø§Ù„Ø®Ø§Ø¯Ù… <code>payload.before</code> (ÙˆÙŠÙÙØ¶Ù‘Ù„ Ø£ÙŠØ¶Ù‹Ø§ <code>payload.after</code>).</dd>
      </dl></div>`;
    }

    let noChanges=false;
    if(listAfter && listAfter.length===listBefore.length){
      if(action==='activate' || action==='deactivate'){
        noChanges=listBefore.every((u,i)=> !!u.isActive === !!(listAfter[i]?.isActive));
      }else if(action==='set-role'){
        noChanges=listBefore.every((u,i)=> (u.role||'user') === ((listAfter[i]?.role)||'user'));
      }
    }

    const rows=listBefore.map((u,i)=>{
      const a=(listAfter && listAfter[i])||{};
      const U=normalizeUser(u);
      let cell='â€”';
      if(action==='activate' || action==='deactivate'){
        const is=(mode==='before')?!!u.isActive:!!a.isActive;
        cell = is ? '<span class="badge text-bg-success">Ù†Ø´Ø·</span>' : '<span class="badge text-bg-danger">Ù…Ø¹Ø·Ù‘Ù„</span>';
        if(mode==='after'){ cell=(is?'<span class="diff-added">Ù†Ø´Ø·</span>':'<span class="diff-removed">Ù…Ø¹Ø·Ù‘Ù„</span>')+` <span class="ms-1">${cell}</span>`; }
      }else if(action==='set-role'){
        const roleTxt = roleAr((mode==='before'?u.role:a.role));
        cell = mode==='after' ? `<span class="diff-added">${roleTxt}</span>` : `<span class="diff-removed">${roleTxt}</span>`;
      }else if(action==='delete'){
        cell = mode==='after' ? '<span class="badge text-bg-danger">ØªÙ… Ø§Ù„Ø­Ø°Ù</span>' : roleAr(u.role);
      }
      return `<tr>
        <td>${U.name} <span class="badge text-bg-info">${U.username}</span> ${U.email?`<span class="badge text-bg-light">${U.email}</span>`:''}</td>
        <td class="text-nowrap">${cell}</td>
      </tr>`;
    }).join('');

    const secondColTitle = (action==='set-role') ? 'Ø§Ù„Ø¯ÙˆØ±' : 'Ø§Ù„Ø­Ø§Ù„Ø©';
    const title=(mode==='before')?`${secondColTitle} Ù‚Ø¨Ù„`:`${secondColTitle} Ø¨Ø¹Ø¯`;
    const headerRight=(mode==='after')?`<div class="d-flex align-items-center gap-2">${noChanges?'<span class="nochange-note">Ù„Ø§ ØªØºÙŠÙŠØ± ÙØ¹Ù„ÙŠ</span>':''}<span class="badge text-bg-light">Ø¹Ø¯Ø¯: ${idsCount || listBefore.length}</span></div>`:'';
    const actionTitle=(action==='set-role')?('ØªØºÙŠÙŠØ± Ø§Ù„Ø¯ÙˆØ± â†’ '+roleAr(p.role)):(action==='activate'?'ØªÙØ¹ÙŠÙ„':(action==='deactivate'?'ØªØ¹Ø·ÙŠÙ„':(action||'â€”')));

    return `<div class="payload-card">
      <div class="d-flex justify-content-between align-items-center mb-2">
        <div>${mode==='after'?('<strong>Ø¹Ù…Ù„ÙŠØ© Ø¬Ù…Ø§Ø¹ÙŠØ©:</strong> '+actionTitle):''}</div>
        ${headerRight}
      </div>
      <div class="table-responsive">
        <table class="table table-sm mb-0">
          <thead class="table-light"><tr><th>Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…</th><th>${title}</th></tr></thead>
          <tbody>${rows}</tbody>
        </table>
      </div>
    </div>`;
  }

  // ========== before/after ==========
  function isBulkUserPayload(log){
    const p = log.payload || {};
    return log.model==='User' && (p.bulk || Array.isArray(p.before) || Array.isArray(p.after) || Array.isArray(p.ids));
  }

  function renderSettingsDiff(before,after,mode){
    const list=(arr)=> (Array.isArray(arr)&&arr.length)?arr.map(toArabicLabel).join('ØŒ '):'â€”';
    return `<div class="payload-card"><dl class="row mb-0"><dt>Ø§Ù„Ø£Ø¹Ù…Ø¯Ø© Ø§Ù„Ù…Ø±Ø¦ÙŠØ©</dt><dd>${list((mode==='before'?before:after)?.visibleColumns)}</dd><dt>Ø§Ù„Ø²ÙŠØ§Ø±Ø§Øª Ø§Ù„Ù…Ø­Ø¯Ø¯Ø©</dt><dd>${list((mode==='before'?before:after)?.selectedVisits)}</dd></dl></div>`;
  }

  function renderBeforeCell(log){
    const p=log.payload||{};
    if(log.model==='Settings'){
      if(log.action==='create') return '<div class="payload-card text-muted">ÙƒØ§Ù†Øª ÙØ§Ø±ØºØ©</div>';
      if(log.action==='delete') return renderSettingsDiff(p,{},'before');
      if(p.before&&p.after)     return renderSettingsDiff(p.before,p.after,'before');
      if(p.before)              return renderSettingsDiff(p.before,{},'before');
      return '<div class="payload-card text-muted">â€”</div>';
    }
    if(isBulkUserPayload(log)) return renderBulkUsersList(p,'before');
    if(log.action==='create') return '<div class="payload-card text-muted">ÙƒØ§Ù†Øª ÙØ§Ø±ØºØ©</div>';
    if(log.action==='delete'){ const ks=p?new Set(Object.keys(p)):new Set(); return renderCardFromObjectWithDiff(log.model,p,ks,'before',{}); }
    if(p.before&&p.after){ const diff=computeDiffKeys(p.before,p.after); return renderCardFromObjectWithDiff(log.model,p.before,diff,'before',p.after); }
    if(p.before){ return renderCardFromObjectWithDiff(log.model,p.before,null,'before',{}); }
    return '<div class="payload-card text-muted">â€”</div>';
  }

  function renderAfterCell(log){
    const p=log.payload||{};
    if(log.model==='Settings'){
      if(log.action==='delete') return '<div class="payload-card text-muted">ØªÙ… Ø§Ù„Ø­Ø°Ù</div>';
      if(log.action==='create') return renderSettingsDiff({},p,'after');
      if(p.before&&p.after)     return renderSettingsDiff(p.before,p.after,'after');
      if(p.after)               return renderSettingsDiff({},p.after,'after');
      return renderSettingsDiff({},p,'after');
    }
    if(isBulkUserPayload(log)) return renderBulkUsersList(p,'after');
    if(log.action==='delete')  return '<div class="payload-card text-muted">ØªÙ… Ø§Ù„Ø­Ø°Ù</div>';
    if(log.action==='create'){ const ks=p?new Set(Object.keys(p)):new Set(); return renderCardFromObjectWithDiff(log.model,p,ks,'after',{}); }
    if(p.after&&p.before){ const diff=computeDiffKeys(p.before,p.after); return renderCardFromObjectWithDiff(log.model,p.after,diff,'after',p.before); }
    if(p.after){ return renderCardFromObjectWithDiff(log.model,p.after,null,'after',{}); }
    return renderCardFromObjectWithDiff(log.model,p,null,'after',{});
  }

  // ========== ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø³Ø¬Ù„Ø§Øª ==========
  let page=1, limit=20, reachedEnd=false, rowCounterStart=1;
  const selectedIds=new Set();
  const updateSelectedCount=()=>{ document.getElementById('selectedCount').textContent=selectedIds.size; document.getElementById('btnDeleteSelected').disabled=selectedIds.size===0; };
  function buildQuery(){
    const m=document.getElementById('fModel').value.trim();
    const a=document.getElementById('fAction').value.trim();
    const q=document.getElementById('fQuery').value.trim();
    const f=document.getElementById('fFrom').value;
    const t=document.getElementById('fTo').value;
    const p=new URLSearchParams(); if(m)p.set('model',m); if(a)p.set('action',a); if(q)p.set('q',q); if(f)p.set('from',f); if(t)p.set('to',t);
    p.set('page',page); p.set('limit',limit); return p.toString();
  }
  async function loadLogs({append=false}={}){
    if(reachedEnd && append) return;
    const tbody=document.getElementById('logsTbody');
    if(!append){
      tbody.innerHTML = `<tr class="text-center text-muted"><td colspan="8">Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„â€¦</td></tr>`;
      rowCounterStart=(page-1)*limit + 1; selectedIds.clear(); updateSelectedCount(); document.getElementById('chkAll').checked=false;
    }
    const res = await fetchJSON(api('/api/audit-logs?')+buildQuery());
    if(res.__nonJSON__ || res.__badJSON__ || !res.ok){
      tbody.innerHTML = `<tr class="text-center text-danger"><td colspan="8">Ø§Ù†ØªÙ‡Øª Ø§Ù„Ø¬Ù„Ø³Ø© Ø£Ùˆ ØªØ¹Ø°Ù‘Ø± Ø§Ù„Ø§ØªØµØ§Ù„. ÙŠÙØ±Ø¬Ù‰ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„.</td></tr>`;
      setToast(toastError, 'ØªØ¹Ø°Ù‘Ø± Ø¬Ù„Ø¨ Ø§Ù„Ø³Ø¬Ù„Ø§Øª (Ø¬Ù„Ø³Ø© Ù…Ù†ØªÙ‡ÙŠØ©/ØªÙˆØ¬ÙŠÙ‡ HTML)'); toastError.show();
      setTimeout(()=>{
        const rel = location.pathname + location.search + location.hash;
        location.href = api(`/committees-login.html?next=${encodeURIComponent(rel)}`);
      }, 800);
      return;
    }
    const data = res.data;
    const items = Array.isArray(data) ? data : (data.items||[]);
    reachedEnd = Array.isArray(data) ? (items.length<limit) : (data.hasMore===false);
    if(!append) tbody.innerHTML='';
    if(items.length===0 && !append){ tbody.innerHTML = `<tr class="text-center text-muted"><td colspan="8">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø³Ø¬Ù„Ø§Øª</td></tr>`; return; }
    let n=rowCounterStart;
    items.forEach(log=>{
      const when = log.createdAt ? new Date(log.createdAt).toLocaleString('ar-EG') : 'â€”';
      const id   = log._id || log.id || '';
      const row  = document.createElement('tr');
      row.setAttribute('data-id',id);
      row.innerHTML = `
        <td class="text-center"><input class="form-check-input chkRow" type="checkbox" value="${id}" ${id?'':'disabled'} ${selectedIds.has(id)?'checked':''}></td>
        <td class="text-muted">${n++}</td>
        <td>${when}</td>
        <td>${modelToPage(log.model)}</td>
        <td>${badgeAction(log.action)}</td>
        <td class="col-user">${fmtUser(log.user)}</td>
        <td class="col-before">${renderBeforeCell(log)}</td>
        <td class="col-after">${renderAfterCell(log)}</td>`;
      tbody.appendChild(row);
    });
    rowCounterStart = n;
  }

  // ========== ØªØ­ÙƒÙ… Ø§Ù„Ø£Ø²Ø±Ø§Ø± ==========
  document.getElementById('btnSearch').addEventListener('click', ()=>{ page=1; reachedEnd=false; loadLogs({append:false}); });
  document.getElementById('btnClear').addEventListener('click', ()=>{ ['fModel','fAction','fQuery','fFrom','fTo'].forEach(id=>document.getElementById(id).value=''); page=1; reachedEnd=false; loadLogs({append:false}); });
  document.getElementById('btnMore').addEventListener('click', ()=>{ if(!reachedEnd){ page++; loadLogs({append:true}); } else { setToast(toastInfo,'Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ù…Ø²ÙŠØ¯ Ù…Ù† Ø§Ù„Ø³Ø¬Ù„Ø§Øª'); toastInfo.show(); }});
  document.getElementById('chkAll').addEventListener('change', (e)=>{ const chk=e.target.checked; document.querySelectorAll('#logsTbody .chkRow:not([disabled])').forEach(i=>{ i.checked=chk; const id=i.value; if(chk) selectedIds.add(id); else selectedIds.delete(id); }); updateSelectedCount(); });
  document.getElementById('logsTbody').addEventListener('change', (e)=>{ if(e.target.classList.contains('chkRow')){ const id=e.target.value; if(e.target.checked) selectedIds.add(id); else selectedIds.delete(id); const all=document.querySelectorAll('#logsTbody .chkRow:not([disabled])'); document.getElementById('chkAll').checked = all.length>0 && Array.from(all).every(x=>x.checked); updateSelectedCount(); }});
  document.getElementById('btnPurge').addEventListener('click', async ()=>{ const ok=await showConfirm({title:'ØªØ£ÙƒÙŠØ¯ Ø­Ø°Ù Ø§Ù„ÙƒÙ„',message:'Ø³ÙŠØªÙ… Ø­Ø°Ù Ø¬Ù…ÙŠØ¹ Ø³Ø¬Ù„Ø§Øª Ø§Ù„Ø¹Ù…Ù„ÙŠØ§ØªØŒ ÙˆÙ„Ø§ ÙŠÙ…ÙƒÙ† Ø§Ù„ØªØ±Ø§Ø¬Ø¹.',confirmText:'Ù†Ø¹Ù…ØŒ Ø§Ø­Ø°Ù Ø§Ù„ÙƒÙ„',confirmBtnClass:'btn-danger'}); if(!ok) return; const r=await fetch(api('/api/audit-logs'),{method:'DELETE',credentials:'include'}); if(r.ok){ setToast(toastSuccess,'ğŸ§¹ ØªÙ… Ø­Ø°Ù Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø³Ø¬Ù„Ø§Øª'); toastSuccess.show(); page=1; reachedEnd=false; loadLogs({append:false}); } else { setToast(toastError,'âŒ ÙØ´Ù„ Ø­Ø°Ù Ø§Ù„Ø³Ø¬Ù„Ø§Øª'); toastError.show(); }});
  document.getElementById('btnPurgeRange').addEventListener('click', async ()=>{ const f=fFrom.value, t=fTo.value; if(!f && !t){ setToast(toastInfo,'Ø­Ø¯Ù‘Ø¯ ØªØ§Ø±ÙŠØ® "Ù…Ù†" Ø£Ùˆ "Ø¥Ù„Ù‰"'); toastInfo.show(); return; } if(f && t && (new Date(f)>new Date(t))){ setToast(toastError,'âŒ Ù†Ø·Ø§Ù‚ Ø§Ù„ØªØ§Ø±ÙŠØ® ØºÙŠØ± ØµØ­ÙŠØ­'); toastError.show(); return; } const ok=await showConfirm({title:'ØªØ£ÙƒÙŠØ¯ Ø§Ù„Ø­Ø°Ù Ø­Ø³Ø¨ Ø§Ù„ØªØ§Ø±ÙŠØ®',message:`Ø³ÙŠØªÙ… Ø­Ø°Ù Ø¶Ù…Ù† Ø§Ù„Ù†Ø·Ø§Ù‚: ${f||'â€”'} â€” ${t||'â€”'}.`,confirmText:'Ø­Ø°Ù Ø¶Ù…Ù† Ø§Ù„Ù†Ø·Ø§Ù‚',confirmBtnClass:'btn-warning'}); if(!ok) return; const qs=new URLSearchParams(); if(f) qs.set('from',f); if(t) qs.set('to',t); const r=await fetch(api('/api/audit-logs?')+qs.toString(),{method:'DELETE',credentials:'include'}); if(r.ok){ setToast(toastSuccess,'ğŸ—‚ï¸ ØªÙ… Ø­Ø°Ù Ø§Ù„Ø³Ø¬Ù„Ø§Øª Ø¶Ù…Ù† Ø§Ù„Ù†Ø·Ø§Ù‚'); toastSuccess.show(); page=1; reachedEnd=false; loadLogs({append:false}); } else { setToast(toastError,'âŒ ÙØ´Ù„ ÙÙŠ Ø­Ø°Ù Ø§Ù„Ø³Ø¬Ù„Ø§Øª Ø¶Ù…Ù† Ø§Ù„Ù†Ø·Ø§Ù‚'); toastError.show(); }});
  document.getElementById('btnDeleteSelected').addEventListener('click', async ()=>{ const count=selectedIds.size; if(count===0){ setToast(toastInfo,'Ù„Ù… ÙŠØªÙ… ØªØ­Ø¯ÙŠØ¯ Ø£ÙŠ Ø³Ø¬Ù„Ø§Øª'); toastInfo.show(); return; } const ok=await showConfirm({title:'ØªØ£ÙƒÙŠØ¯ Ø­Ø°Ù Ø§Ù„Ù…Ø­Ø¯Ø¯',message:`Ø³ÙŠØªÙ… Ø­Ø°Ù ${count} Ù…Ù† Ø§Ù„Ø³Ø¬Ù„Ø§Øª Ø§Ù„Ù…Ø­Ø¯Ø¯Ø©.`,confirmText:'Ø­Ø°Ù Ø§Ù„Ù…Ø­Ø¯Ø¯',confirmBtnClass:'btn-danger'}); if(!ok) return; const r=await fetch(api('/api/audit-logs/by-ids'),{method:'DELETE',headers:{'Content-Type':'application/json'},credentials:'include',body:JSON.stringify({ids:Array.from(selectedIds)})}); if(r.ok){ setToast(toastSuccess,'ğŸ—‘ï¸ ØªÙ… Ø­Ø°Ù Ø§Ù„Ø³Ø¬Ù„Ø§Øª Ø§Ù„Ù…Ø­Ø¯Ø¯Ø©'); toastSuccess.show(); page=1; reachedEnd=false; loadLogs({append:false}); } else { setToast(toastError,'âŒ ÙØ´Ù„ Ø­Ø°Ù Ø§Ù„Ø³Ø¬Ù„Ø§Øª Ø§Ù„Ù…Ø­Ø¯Ø¯Ø©'); toastError.show(); }});

  // ========== ØªØ´ØºÙŠÙ„ ==========
  ensureAdmin().then(()=>loadLogs({append:false}));
</script>

</body>
</html>
