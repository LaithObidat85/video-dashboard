<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <title>Ø³Ø¬Ù„ Ø§Ù„Ø¹Ù…Ù„ÙŠØ§Øª - Ù†Ø¸Ø§Ù… Ø§Ù„Ù„Ø¬Ø§Ù†</title>
  <link rel="icon" type="image/png" href="https://www.dropbox.com/scl/fi/f283e4rvv5cf9x12a1cic/my-website-logo.png?rlkey=yia776im7klypy27af32m0scy&e=1&st=vhaprvzh&dl=1">
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.rtl.min.css">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css">
  <style>
    body{background:#f8f9fa;font-family:'Segoe UI',sans-serif}
    .container{max-width:1200px;margin-top:40px}
    .card{border-radius:16px;box-shadow:0 6px 18px rgba(0,0,0,.06)}
    .user-chip{font-size:.9rem}

    /* Ø¨Ø·Ø§Ù‚Ø§Øª Ø§Ù„Ù…Ø­ØªÙˆÙ‰ ÙÙŠ Ø¹Ù…ÙˆØ¯ÙŠ "Ù‚Ø¨Ù„/Ø¨Ø¹Ø¯"  */
    .payload-card{
      background:#fff;border:1px solid #e9ecef;border-radius:12px;padding:10px;
      height:220px;overflow:auto
    }
    .payload-card dt{color:#6c757d;font-weight:600}
    .payload-card dd{margin-bottom:.5rem}
    .payload-json{
      direction:ltr;background:#f6f8fa;border-radius:8px;padding:8px;
      font-family:ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,"Liberation Mono","Courier New",monospace
    }

    .filters .form-control, .filters .form-select{min-width:160px}
    .minw-40{min-width:40px}
    .minw-60{min-width:60px}
    .minw-120{min-width:120px}

    /* Ù„Ø§ ØªÙƒØ³Ù‘Ø± Ø¹Ù†Ø§ÙˆÙŠÙ† Ø§Ù„Ø£Ø¹Ù…Ø¯Ø© */
    .table thead th{vertical-align:middle;white-space:nowrap}

    .sticky-actions{position:sticky;bottom:0;background:#fff;border-top:1px solid #e9ecef;padding:12px;border-radius:0 0 16px 16px}
    .count-badge{font-size:.85rem}

    /* Ø¥Ø¨Ø±Ø§Ø² Ø§Ù„Ø§Ø®ØªÙ„Ø§ÙØ§Øª */
    .diff-added{color:#198754;font-weight:600;background:rgba(25,135,84,.12);border-radius:6px;padding:2px 6px}
    .diff-removed{color:#dc3545;font-weight:600;background:rgba(220,53,69,.12);border-radius:6px;padding:2px 6px}

    /* ØªÙˆØ²ÙŠØ¹ Ø§Ù„Ø£Ø¹Ù…Ø¯Ø© */
    .col-user{width:16%}
    .col-before{width:34%}
    .col-after{width:34%}

    /* Ø§Ø¬Ø¨Ø± Ø§Ù„Ø¬Ø¯ÙˆÙ„ Ø§Ù„Ø£Ø³Ø§Ø³ÙŠ Ø¹Ù„Ù‰ ØªÙˆØ²ÙŠØ¹ Ø«Ø§Ø¨Øª Ø­ØªÙ‰ Ù„Ø§ â€œÙŠÙ†ÙØ´â€ Ø¨Ø³Ø¨Ø¨ Ø®Ù„ÙŠØ© ÙˆØ§Ø­Ø¯Ø© */
    .table { table-layout: fixed; }

    /* Ø§Ù„Ø¬Ø¯Ø§ÙˆÙ„ Ø¯Ø§Ø®Ù„ Ø¨Ø·Ø§Ù‚Ø© â€œØ§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù‚Ø¨Ù„/Ø¨Ø¹Ø¯â€ Ù„Ø§ ØªØªÙ…Ø¯Ø¯ Ø®Ø§Ø±Ø¬ Ø§Ù„Ø¨Ø·Ø§Ù‚Ø© */
    .payload-card .table{ table-layout: fixed; width:100%; }
    .payload-card .table th,
    .payload-card .table td{
      white-space: normal;
      word-break: break-word;       /* Chrome/Edge */
      overflow-wrap: anywhere;      /* Safari/Firefox */
    }

    /* ÙƒÙŠ Ù„Ø§ ØªØªØ¬Ø§ÙˆØ² Ø§Ù„Ø¨Ø§Ø¯Ø¬Ø§Øª Ø­Ø¯ÙˆØ¯ Ø§Ù„Ø®Ù„ÙŠØ© */
    .payload-card .badge { white-space: nowrap; }

    /* Ø³Ø§Ø¹Ø¯ Ø§Ù„Ù†ØµÙˆØµ Ø§Ù„Ù„Ø§ØªÙŠÙ†ÙŠØ©/Ø§Ù„Ø¥ÙŠÙ…ÙŠÙ„ Ø¹Ù„Ù‰ Ø§Ù„Ø§Ù†ÙƒØ³Ø§Ø± Ø¨Ø´ÙƒÙ„ ØµØ­ÙŠ */
    .payload-card { direction: rtl; }
    .payload-card .email,
    .payload-card code,
    .payload-card .payload-json {
      direction: ltr;
      unicode-bidi: plaintext;
      word-break: break-all;
    }

    /* Ø´Ø§Ø±Ø© "Ù„Ø§ ØªØºÙŠÙŠØ± ÙØ¹Ù„ÙŠ" */
    .nochange-note{
      border:1px solid rgba(13,110,253,.25);
      background:rgba(13,110,253,.06);
      color:#0d6efd;
      border-radius:10px;
      padding:4px 8px;
      font-size:.85rem;
    }
  </style>
</head>
<body>
  <div class="container">
    <!-- Header -->
    <div class="d-flex flex-wrap justify-content-between align-items-center mb-4 gap-2">
      <h3 class="mb-0">Ø³Ø¬Ù„ Ø§Ù„Ø¹Ù…Ù„ÙŠØ§Øª</h3>
      <div class="d-flex align-items-center gap-2">
        <span id="userInfo" class="user-chip badge bg-light text-dark border">
          <i class="bi bi-person"></i>
          <span id="userUsername">â€”</span>
          <span class="mx-1">â€”</span>
          <span id="userFullName">â€”</span>
          <span class="ms-2 badge bg-secondary" id="userRole">â€”</span>
        </span>
        <a id="homeLink" class="btn btn-outline-primary" href="#">
          <i class="bi bi-grid"></i> Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ…
        </a>
        <button id="logoutBtn" class="btn btn-danger">
          <i class="bi bi-box-arrow-right"></i> Ø®Ø±ÙˆØ¬
        </button>
      </div>
    </div>

    <!-- ÙÙ„Ø§ØªØ± -->
    <div class="card mb-3">
      <div class="card-body">
        <div class="filters d-flex flex-wrap align-items-end gap-2">
          <div>
            <label class="form-label">Ø§Ù„ØµÙØ­Ø©</label>
            <select id="fModel" class="form-select">
              <option value="">Ø§Ù„ÙƒÙ„</option>
              <option value="Evaluation">ØªÙ‚ÙŠÙŠÙ… Ø§Ù„Ù„Ø¬Ø§Ù†</option>
              <option value="College">Ø§Ù„ÙƒÙ„ÙŠØ§Øª</option>
              <option value="Auditor">Ø§Ù„Ù…Ø¯Ù‚Ù‚ÙˆÙ†</option>
              <option value="Committee">Ø£Ø³Ù…Ø§Ø¡ Ø§Ù„Ù„Ø¬Ø§Ù†</option>
              <option value="Settings">Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª</option>
              <option value="User">Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙˆÙ†</option>
            </select>
          </div>
          <div>
            <label class="form-label">Ø§Ù„Ø¹Ù…Ù„ÙŠØ©</label>
            <select id="fAction" class="form-select">
              <option value="">Ø§Ù„ÙƒÙ„</option>
              <option>create</option>
              <option>update</option>
              <option>delete</option>
            </select>
          </div>
          <div>
            <label class="form-label">Ø¨Ø­Ø« (Ø§Ø³Ù…/Ø¥ÙŠÙ…ÙŠÙ„/Ø§Ø³Ù… Ù…Ø³ØªØ®Ø¯Ù…)</label>
            <input id="fQuery" type="text" class="form-control" placeholder="Ù…Ø«Ù„: laith Ø£Ùˆ b01578">
          </div>
          <div>
            <label class="form-label">Ù…Ù† ØªØ§Ø±ÙŠØ®</label>
            <input id="fFrom" type="date" class="form-control">
          </div>
          <div>
            <label class="form-label">Ø¥Ù„Ù‰ ØªØ§Ø±ÙŠØ®</label>
            <input id="fTo" type="date" class="form-control">
          </div>
          <div class="ms-auto d-flex gap-2">
            <button id="btnSearch" class="btn btn-primary"><i class="bi bi-search"></i> Ø¨Ø­Ø«</button>
            <button id="btnClear" class="btn btn-outline-secondary"><i class="bi bi-x-circle"></i> ØªÙØ±ÙŠØº</button>
          </div>
        </div>
      </div>
    </div>

    <!-- Ø§Ù„Ø¬Ø¯ÙˆÙ„ -->
    <div class="card">
      <div class="card-body p-0">
        <div class="table-responsive">
          <table class="table table-hover align-middle mb-0">
            <thead class="table-light">
              <tr>
                <th class="minw-40 text-center">
                  <input class="form-check-input" type="checkbox" id="chkAll" title="ØªØ­Ø¯ÙŠØ¯/Ø¥Ù„ØºØ§Ø¡ ØªØ­Ø¯ÙŠØ¯ Ø§Ù„ÙƒÙ„">
                </th>
                <th class="minw-60">#</th>
                <th class="minw-120">Ø§Ù„ÙˆÙ‚Øª</th>
                <th>Ø§Ù„ØµÙØ­Ø©</th>
                <th>Ø§Ù„Ø¹Ù…Ù„ÙŠØ©</th>
                <th class="col-user">Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…</th>
                <th class="col-before">Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù‚Ø¨Ù„</th>
                <th class="col-after">Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø¨Ø¹Ø¯</th>
              </tr>
            </thead>
            <tbody id="logsTbody">
              <tr class="text-center text-muted"><td colspan="8">Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„â€¦</td></tr>
            </tbody>
          </table>
        </div>

        <!-- Ø´Ø±ÙŠØ· Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª -->
        <div class="sticky-actions d-flex flex-wrap justify-content-between align-items-center gap-2">
          <div class="d-flex flex-wrap gap-2">
            <button id="btnMore" class="btn btn-outline-secondary">
              <i class="bi bi-plus-circle"></i> ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ø²ÙŠØ¯
            </button>
            <button id="btnPurge" class="btn btn-outline-danger">
              <i class="bi bi-trash3"></i> Ø­Ø°Ù ÙƒÙ„ Ø§Ù„Ø³Ø¬Ù„Ø§Øª
            </button>
            <button id="btnPurgeRange" class="btn btn-outline-warning">
              <i class="bi bi-calendar-x"></i> Ø­Ø°Ù Ø­Ø³Ø¨ Ø§Ù„ØªØ§Ø±ÙŠØ®
            </button>
            <button id="btnDeleteSelected" class="btn btn-danger" disabled>
              <i class="bi bi-check2-square"></i> Ø­Ø°Ù Ø§Ù„Ø³Ø¬Ù„Ø§Øª Ø§Ù„Ù…Ø­Ø¯Ø¯Ø©
            </button>
          </div>
          <div>
            <span class="badge text-bg-light count-badge">
              Ø§Ù„Ù…Ø­Ø¯Ø¯: <span id="selectedCount">0</span>
            </span>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Toasts -->
  <div class="toast-container position-fixed top-0 start-50 translate-middle-x p-3" style="z-index:2000">
    <div id="toastSuccess" class="toast align-items-center text-bg-success border-0 mb-2" role="alert" aria-live="assertive" aria-atomic="true">
      <div class="d-flex">
        <div class="toast-body">âœ… ØªÙ… Ø§Ù„ØªÙ†ÙÙŠØ° Ø¨Ù†Ø¬Ø§Ø­</div>
        <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button>
      </div>
    </div>
    <div id="toastError" class="toast align-items-center text-bg-danger border-0 mb-2" role="alert" aria-live="assertive" aria-atomic="true">
      <div class="d-flex">
        <div class="toast-body">âŒ Ø­Ø¯Ø« Ø®Ø·Ø£</div>
        <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button>
      </div>
    </div>
    <div id="toastInfo" class="toast align-items-center text-bg-primary border-0 mb-2" role="status" aria-live="polite" aria-atomic="true">
      <div class="d-flex">
        <div class="toast-body">â„¹ï¸ Ù…Ø¹Ù„ÙˆÙ…Ø§Øª</div>
        <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button>
      </div>
    </div>
  </div>

  <!-- Modal ØªØ£ÙƒÙŠØ¯ -->
  <div class="modal fade" id="confirmModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
      <div class="modal-content">
        <div class="modal-header">
          <h5 id="confirmModalTitle" class="modal-title">ØªØ£ÙƒÙŠØ¯</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Ø¥ØºÙ„Ø§Ù‚"></button>
        </div>
        <div class="modal-body" id="confirmModalBody">Ù‡Ù„ ØªØ±ÙŠØ¯ Ø§Ù„Ù…ØªØ§Ø¨Ø¹Ø©ØŸ</div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Ø¥Ù„ØºØ§Ø¡</button>
          <button type="button" class="btn btn-danger" id="confirmModalConfirmBtn">ØªØ£ÙƒÙŠØ¯</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Scripts -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script>
  /* ====== GitHub Pages vs Render ====== */
  const API_BASE = location.hostname.endsWith('github.io') ? 'https://vdash-qkyv.onrender.com' : '';
  const api = (path) => API_BASE + path;

  // Ø±Ø§Ø¨Ø· Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ…
  const homeLink = document.getElementById('homeLink');
  homeLink.href = api('/committees-home.html');

  /* ===== Toasts ===== */
  const toastSuccess = new bootstrap.Toast(document.getElementById('toastSuccess'));
  const toastError   = new bootstrap.Toast(document.getElementById('toastError'));
  const toastInfo    = new bootstrap.Toast(document.getElementById('toastInfo'));
  function setToast(el, msg){ el._element.querySelector('.toast-body').innerText = msg; }

  /* ===== Modal confirm helper ===== */
  const confirmModalEl = document.getElementById('confirmModal');
  const confirmModal   = new bootstrap.Modal(confirmModalEl);
  const confirmTitle   = document.getElementById('confirmModalTitle');
  const confirmBody    = document.getElementById('confirmModalBody');
  const confirmBtn     = document.getElementById('confirmModalConfirmBtn');
  function showConfirm({title='ØªØ£ÙƒÙŠØ¯', message='Ù‡Ù„ ØªØ±ÙŠØ¯ Ø§Ù„Ù…ØªØ§Ø¨Ø¹Ø©ØŸ', confirmText='ØªØ£ÙƒÙŠØ¯', confirmBtnClass='btn-danger'}={}){
    return new Promise(resolve=>{
      confirmTitle.textContent = title;
      confirmBody.textContent  = message;
      confirmBtn.className = 'btn ' + confirmBtnClass;
      confirmBtn.textContent = confirmText;
      let resolved = false;
      const onConfirm = () => { resolved = true; confirmModal.hide(); resolve(true); };
      const onHidden  = () => { confirmModalEl.removeEventListener('hidden.bs.modal', onHidden); confirmBtn.removeEventListener('click', onConfirm); if(!resolved) resolve(false); };
      confirmBtn.addEventListener('click', onConfirm, { once:true });
      confirmModalEl.addEventListener('hidden.bs.modal', onHidden, { once:true });
      confirmModal.show();
    });
  }

  /* ===== auth helpers (Ù…ØµØºÙ‘Ø± ÙˆÙ…ØªÙŠÙ†) ===== */
  async function fetchMe(){
    try{
      const r = await fetch(api('/auth/committees/me'),{
        credentials:'include',
        headers:{'Accept':'application/json'}
      });
      if(!r.ok) throw new Error('HTTP '+r.status);
      return await r.json();
    }catch(e){
      return { authenticated:false, _err:String(e) };
    }
  }

  // ÙŠØªØ¹Ø§Ù…Ù„ Ù…Ø¹ ÙƒÙ„ Ø§Ù„Ø£Ø´ÙƒØ§Ù„: object / string / null
  function normalizeUser(u){
    if (!u) return { name:'â€”', username:'â€”', email:'', role:'â€”' };
    if (typeof u === 'string') return { name:u, username:u, email:'', role:'' };
    const username = u.username || (u.email? u.email.split('@')[0] : (u.name || 'â€”'));
    return {
      name: u.name || 'â€”',
      username,
      email: u.email || '',
      role: u.role || 'â€”'
    };
  }

  function renderUser(uRaw){
    const u = normalizeUser(uRaw);
    document.getElementById('userUsername').textContent = u.username;
    document.getElementById('userFullName').textContent = u.name;
    document.getElementById('userRole').textContent = u.role;
  }

  async function ensureAdmin(){
    const me = await fetchMe();

    if(!me.authenticated){
      // Ø§Ø³ØªØ®Ø¯Ù… Ù…Ø³Ø§Ø±Ù‹Ø§ Ù†Ø³Ø¨ÙŠÙ‹Ø§ ÙÙ‚Ø· (Ø¨Ø¯ÙˆÙ† Ø¯ÙˆÙ…ÙŠÙ†) Ø­ØªÙ‰ Ù„Ø§ ÙŠØ±ÙØ¶Ù‡ Ø§Ù„Ø®Ø§Ø¯Ù…
      const rel = location.pathname + location.search + location.hash;
      location.href = api(`/committees-login.html?next=${encodeURIComponent(rel)}`);
      return Promise.reject();
    }

    const role = (me.user?.role || '').toLowerCase();
    if(role!=='admin'){
      setToast(toastError,'âŒ Ù‡Ø°Ù‡ Ø§Ù„ØµÙØ­Ø© Ù„Ù„Ù…Ø´Ø±ÙÙŠÙ† ÙÙ‚Ø·'); toastError.show();
      setTimeout(()=>location.href=api('/committees-home.html'),900);
      return Promise.reject();
    }

    renderUser(me.user);
    return me.user;
  }

  async function logout(){
    try{
      const r = await fetch(api('/auth/committees/logout'),{
        method:'POST',
        headers:{'Content-Type':'application/json'},
        credentials:'include'
      });
      if(r.ok){ setToast(toastSuccess,'âœ… ØªÙ… ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬'); toastSuccess.show(); setTimeout(()=>location.href=api('/committees-login.html'),700); }
      else{ setToast(toastError,'âŒ ØªØ¹Ø°Ø± ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬'); toastError.show(); }
    }catch{ setToast(toastError,'âŒ Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø§ØªØµØ§Ù„'); toastError.show(); }
  }
  document.getElementById('logoutBtn').addEventListener('click', logout);

  /* ===== mapping ===== */
  function modelToPage(model){
    switch(model){
      case 'Evaluation': return 'ØªÙ‚ÙŠÙŠÙ… Ø§Ù„Ù„Ø¬Ø§Ù†';
      case 'College':    return 'Ø§Ù„ÙƒÙ„ÙŠØ§Øª';
      case 'Auditor':    return 'Ø§Ù„Ù…Ø¯Ù‚Ù‚ÙˆÙ†';
      case 'Committee':  return 'Ø£Ø³Ù…Ø§Ø¡ Ø§Ù„Ù„Ø¬Ø§Ù†';
      case 'Settings':   return 'Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª';
      case 'User':       return 'Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙˆÙ†';
      default:           return model||'â€”';
    }
  }
  function badgeAction(action){
    const cls = action==='delete'?'text-bg-danger':(action==='update'?'text-bg-warning':'text-bg-success');
    return `<span class="badge ${cls}">${action||'â€”'}</span>`;
  }
  function fmtUser(uRaw){
    const u = normalizeUser(uRaw);
    const email = u.email ? ` <span class="badge text-bg-light">${u.email}</span>` : '';
    const role  = u.role  ? ` <span class="badge text-bg-secondary">${u.role}</span>` : '';
    return `${u.name} <span class="badge text-bg-info">${u.username}</span>${email}${role}`;
  }

  /* ===== labels & diff helpers (ÙƒÙ…Ø§ Ù‡ÙŠ) ===== */
  const colNameArMap = { committee_name:'Ø§Ø³Ù… Ø§Ù„Ù„Ø¬Ù†Ø©', college:'Ø§Ù„ÙƒÙ„ÙŠØ©', auditor_name:'Ø§Ù„Ù…Ø¯Ù‚Ù‚', createdAt:'ØªØ§Ø±ÙŠØ® Ø§Ù„Ø¥Ù†Ø´Ø§Ø¡', updatedAt:'ØªØ§Ø±ÙŠØ® Ø§Ù„ØªØ­Ø¯ÙŠØ«', notes:'Ù…Ù„Ø§Ø­Ø¸Ø§Øª', score:'Ø§Ù„Ù†ØªÙŠØ¬Ø©', work_plan:'Ø®Ø·Ø© Ø§Ù„Ø¹Ù…Ù„', performance_indicators:'Ù…Ø¤Ø´Ø±Ø§Øª Ø§Ù„Ø§Ø¯Ø§Ø¡', meetings:'Ø¹Ø¯Ø¯ Ø§Ù„Ø§Ø¬ØªÙ…Ø§Ø¹Ø§Øª', consistency:'Ø§Ù„ØªÙˆØ§ÙÙ‚ Ø¨ÙŠÙ† Ø§Ù„Ø¯Ø¹ÙˆØ§Øª ÙˆØ§Ù„Ø§Ø¬ØªÙ…Ø§Ø¹Ø§Øª', coverage_books:'ÙƒØªØ¨ Ø§Ù„ØªØºØ·ÙŠØ©', report1:'ØªÙ‚Ø±ÙŠØ± Ø¥Ù†Ø¬Ø§Ø² 1', report2:'ØªÙ‚Ø±ÙŠØ± Ø¥Ù†Ø¬Ø§Ø² 2', report3:'ØªÙ‚Ø±ÙŠØ± Ø¥Ù†Ø¬Ø§Ø² 3', statistical_analysis:'Ø§Ù„ØªØ­Ù„ÙŠÙ„ Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠ', name:'Ø§Ù„Ø§Ø³Ù…', username:'Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…', role:'Ø§Ù„Ø¯ÙˆØ±', email:'Ø§Ù„Ø¨Ø±ÙŠØ¯', isActive:'Ø§Ù„Ø­Ø§Ù„Ø©', formation_decision:'Ù‚Ø±Ø§Ø± Ø§Ù„ØªØ´ÙƒÙŠÙ„', formationDecision:'Ù‚Ø±Ø§Ø± Ø§Ù„ØªØ´ÙƒÙŠÙ„', decision:'Ù‚Ø±Ø§Ø± Ø§Ù„ØªØ´ÙƒÙŠÙ„', decision_number:'Ù‚Ø±Ø§Ø± Ø§Ù„ØªØ´ÙƒÙŠÙ„', decisionNumber:'Ù‚Ø±Ø§Ø± Ø§Ù„ØªØ´ÙƒÙŠÙ„', formation_no:'Ù‚Ø±Ø§Ø± Ø§Ù„ØªØ´ÙƒÙŠÙ„', formationNo:'Ù‚Ø±Ø§Ø± Ø§Ù„ØªØ´ÙƒÙŠÙ„' };
  const toArabicLabel = k => colNameArMap[k] || k;
  const escapeHtml = s => String(s).replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]));
  const normalizeValue = v => v==null ? '' : (v instanceof Date ? v.toISOString() : (Array.isArray(v)||typeof v==='object') ? JSON.stringify(v) : String(v));
  function computeDiffKeys(before, after){ const b=before||{}, a=after||{}; const keys=new Set([...Object.keys(b),...Object.keys(a)]); const changed=new Set(); keys.forEach(k=>{ if (normalizeValue(b[k]) !== normalizeValue(a[k])) changed.add(k); }); return changed; }
  function stripHtmlPreserveBreaks(html){ try{ const doc=new DOMParser().parseFromString(String(html),'text/html'); const blockBreak=new Set(['P','DIV','LI','BR','H1','H2','H3','H4','H5','H6']); function walk(node){ let out=''; node.childNodes.forEach(n=>{ if(n.nodeType===3) out+=n.textContent; else if(n.nodeType===1){ const tag=n.nodeName; if(tag==='BR') out+='\n'; out+=walk(n); if(blockBreak.has(tag) && out.slice(-1)!=='\n') out+='\n'; } }); return out; } return walk(doc.body).replace(/\n{3,}/g,'\n\n').trim(); }catch{ return String(html).replace(/<[^>]+>/g,'\n').replace(/\n{3,}/g,'\n\n').trim(); } }
  function splitTokens(str){ return stripHtmlPreserveBreaks(str).split(/(\s+|[.,;:!?ØŒØ›()\[\]{}"Â«Â»]+)/g).filter(t=>t!==''); }
  function diffTokens(aTokens,bTokens){ const m=aTokens.length,n=bTokens.length,dp=Array(m+1).fill(null).map(()=>Array(n+1).fill(0)); for(let i=m-1;i>=0;i--)for(let j=n-1;j>=0;j--)dp[i][j]=(aTokens[i]===bTokens[j])?dp[i+1][j+1]+1:Math.max(dp[i+1][j],dp[i][j+1]); const ops=[]; let i=0,j=0; while(i<m&&j<n){ if(aTokens[i]===bTokens[j]){ops.push({type:'eq',token:aTokens[i]}); i++; j++;} else if(dp[i+1][j]>=dp[i][j+1]){ops.push({type:'del',token:aTokens[i++]});} else {ops.push({type:'add',token:bTokens[j++]});} } while(i<m) ops.push({type:'del',token=aTokens[i++]}); while(j<n) ops.push({type:'add',token=bTokens[j++]}); return ops; }
  function renderTextDiff(beforeText,afterText,mode){ const ops=diffTokens(splitTokens(beforeText||''), splitTokens(afterText||'')); let html=''; for (const op of ops){ if(op.type==='eq') html+=escapeHtml(op.token); else if(op.type==='add') html += (mode==='after')?`<span class="diff-added">${escapeHtml(op.token)}</span>`:escapeHtml(op.token); else if(op.type==='del') html += (mode==='before')?`<span class="diff-removed">${escapeHtml(op.token)}</span>`:''; } return (html||'â€”').replace(/\n/g,'<br>'); }
  function kvTextDiff(label,key,beforeObj,afterObj,mode,diffKeys){ const changed=diffKeys&&diffKeys.has(key); const currentVal=(mode==='before')?(beforeObj?.[key]):(afterObj?.[key]); if(currentVal==null||currentVal==='') return ''; if(changed && typeof (beforeObj?.[key]??'')==='string' && typeof (afterObj?.[key]??'')==='string'){ const html=renderTextDiff(beforeObj?.[key]??'', afterObj?.[key]??'', mode); return `<dt>${label}</dt><dd>${html}</dd>`; } const cls=changed?(mode==='before'?'diff-removed':'diff-added'):''; return `<dt>${label}</dt><dd class="${cls}">${escapeHtml(currentVal)}</dd>`; }
  function kvDiff(label,value,key,diffKeys,mode){ if(value===undefined||value===null||value==='') return ''; const cls=diffKeys&&diffKeys.has(key)?(mode==='before'?'diff-removed':'diff-added'):''; return `<dt>${label}</dt><dd class="${cls}">${escapeHtml(value)}</dd>`; }
  function userActiveBadge(val,key,diffKeys,mode){ const isActive=!!val; const base=isActive?'<span class="badge text-bg-success">Ù†Ø´Ø·</span>':'<span class="badge text-bg-danger">Ù…Ø¹Ø·Ù‘Ù„</span>'; const wrapClass=diffKeys&&diffKeys.has(key)?(mode==='before'?'diff-removed':'diff-added'):''; return `<dt>Ø§Ù„Ø­Ø§Ù„Ø©</dt><dd class="${wrapClass}">${base}</dd>`; }
  const roleAr = r => (r==='admin' ? 'Ù…Ø¯ÙŠØ± (admin)' : 'Ù…Ø³ØªØ®Ø¯Ù… (user)');

  function renderCardFromObjectWithDiff(model,obj,diffKeys,mode,otherSide){
    if(!obj) return '<div class="payload-card text-muted">â€”</div>';
    let html='<div class="payload-card"><dl class="row mb-0">'; const d=obj;
    const beforeObj=(mode==='before')?obj:(otherSide||{}); const afterObj=(mode==='after')?obj:(otherSide||{});
    const has = (k)=> d[k]!==undefined && d[k]!==null && d[k]!==''; 
    if(model==='Evaluation'){
      html+=kvDiff('Ø§Ø³Ù… Ø§Ù„Ù„Ø¬Ù†Ø©', d.committee_name, 'committee_name', diffKeys, mode);
      html+=kvDiff('Ø§Ù„ÙƒÙ„ÙŠØ©', d.college, 'college', diffKeys, mode);
      html+=kvDiff('Ø§Ù„Ù…Ø¯Ù‚Ù‚', d.auditor_name, 'auditor_name', diffKeys, mode);
      html+=kvDiff('ØªØ§Ø±ÙŠØ® Ø§Ù„Ø¥Ù†Ø´Ø§Ø¡', d.createdAt?new Date(d.createdAt).toLocaleString('ar-EG'):'', 'createdAt', diffKeys, mode);
      if(has('notes')) html+=kvTextDiff('Ù…Ù„Ø§Ø­Ø¸Ø§Øª','notes',beforeObj,afterObj,mode,diffKeys);
      html+=kvDiff('Ø§Ù„Ù†ØªÙŠØ¬Ø©', d.score, 'score', diffKeys, mode);
      const decisionKeys=['formation_decision','formationDecision','decision','decision_number','decisionNumber','formation_no','formationNo'];
      const decisionKey=decisionKeys.find(k=>k in d); if(decisionKey) html+=kvDiff('Ù‚Ø±Ø§Ø± Ø§Ù„ØªØ´ÙƒÙŠÙ„', d[decisionKey], decisionKey, diffKeys, mode);
      ['work_plan','performance_indicators','meetings','consistency','coverage_books','report1','report2','report3','statistical_analysis'].forEach(k=>{ if(has(k)) html+=kvDiff(toArabicLabel(k), d[k], k, diffKeys, mode); });
    }else if(model==='College'){ html+=kvDiff('Ø§Ù„ÙƒÙ„ÙŠØ©', d.name, 'name', diffKeys, mode);
    }else if(model==='Auditor'){ html+=kvDiff('Ø§Ù„Ù…Ø¯Ù‚Ù‚', d.name, 'name', diffKeys, mode);
    }else if(model==='Committee'){ html+=kvDiff('Ø§Ø³Ù… Ø§Ù„Ù„Ø¬Ù†Ø©', d.name, 'name', diffKeys, mode);
    }else if(model==='Settings'){
      if(d.visibleColumns) html+=kvDiff('Ø§Ù„Ø£Ø¹Ù…Ø¯Ø© Ø§Ù„Ù…Ø±Ø¦ÙŠØ©', (d.visibleColumns||[]).map(toArabicLabel).join('ØŒ '), 'visibleColumns', diffKeys, mode);
      if(d.selectedVisits) html+=kvDiff('Ø§Ù„Ø²ÙŠØ§Ø±Ø§Øª Ø§Ù„Ù…Ø­Ø¯Ø¯Ø©', (d.selectedVisits||[]).map(toArabicLabel).join('ØŒ '), 'selectedVisits', diffKeys, mode);
      const otherKeys=Object.keys(d||{}).filter(k=>!['visibleColumns','selectedVisits','_id','updatedAt','createdAt','__v'].includes(k));
      if(otherKeys.length) html+=kvDiff('ØªØºÙŠÙŠØ±Ø§Øª Ø£Ø®Ø±Ù‰', otherKeys.map(toArabicLabel).join('ØŒ '), '__misc', diffKeys, mode);
    }else if(model==='User'){
      if(has('name'))     html+=kvDiff('Ø§Ù„Ø§Ø³Ù…', d.name, 'name', diffKeys, mode);
      if(has('username')) html+=kvDiff('Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…', d.username, 'username', diffKeys, mode);
      if(has('email'))    html+=kvDiff('Ø§Ù„Ø¨Ø±ÙŠØ¯', d.email, 'email', diffKeys, mode);
      if(has('role'))     html+=kvDiff('Ø§Ù„Ø¯ÙˆØ±', roleAr(d.role), 'role', diffKeys, mode);
      if('isActive' in d) html+=userActiveBadge(d.isActive, 'isActive', diffKeys, mode);
    }else{
      html += '</dl><div class="payload-json"><code>'+escapeHtml(JSON.stringify(obj, null, 2))+'</code></div>';
      html += '</div>'; return html;
    }
    html+='</dl>'; if(!/<dd[^>]*>/.test(html)){ html+='<div class="payload-json"><code>'+escapeHtml(JSON.stringify(obj, null, 2))+'</code></div>'; }
    html+='</div>'; return html;
  }

  function synthesizeBulkAfter(p){
    if (!Array.isArray(p?.before)) return null;
    const action=p?.action;
    if (action==='activate')   return p.before.map(u=>({...u,isActive:true}));
    if (action==='deactivate') return p.before.map(u=>({...u,isActive:false}));
    if (action==='set-role')   return p.before.map(u=>({...u,role: p.role==='admin'?'admin':'user'}));
    if (action==='delete')     return p.before.map(u=>({...u,_deleted:true}));
    return null;
  }

  function renderBulkUsersList(p,mode){
    const listBefore=Array.isArray(p?.before)?p.before:[]; const listAfter=Array.isArray(p?.after)?p.after:synthesizeBulkAfter(p);
    const action=p?.action; const idsCount=Array.isArray(p?.ids)?p.ids.length:0;
    if(listBefore.length===0){
      const actionAr = action==='set-role' ? `ØªØºÙŠÙŠØ± Ø§Ù„Ø¯ÙˆØ± Ø¥Ù„Ù‰ ${roleAr(p.role)}` : action==='activate' ? 'ØªÙØ¹ÙŠÙ„ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ†' : action==='deactivate' ? 'ØªØ¹Ø·ÙŠÙ„ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ†' : (action||'ØªØ¹Ø¯ÙŠÙ„ Ø¬Ù…Ø§Ø¹ÙŠ');
      return `<div class="payload-card"><dl class="row mb-0">
        <dt>Ø¹Ù…Ù„ÙŠØ© Ø¬Ù…Ø§Ø¹ÙŠØ©</dt><dd>${escapeHtml(actionAr)} (Ø¹Ø¯Ø¯: ${idsCount||'â€”'})</dd>
        <dt>Ù…Ù„Ø§Ø­Ø¸Ø©</dt><dd class="text-muted">Ù„ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ø£Ø³Ù…Ø§Ø¡ Ø³Ø¬Ù‘Ù„ Ø§Ù„Ø®Ø§Ø¯Ù… <code>payload.before</code> (ÙˆÙŠÙÙØ¶Ù‘Ù„ Ø£ÙŠØ¶Ù‹Ø§ <code>payload.after</code>).</dd>
      </dl></div>`;
    }
    let noChanges=false;
    if(listAfter && listAfter.length===listBefore.length){
      if(action==='activate' || action==='deactivate'){ noChanges=listBefore.every((u,i)=> !!u.isActive === !!(listAfter[i]?.isActive)); }
      else if(action==='set-role'){ noChanges=listBefore.every((u,i)=> (u.role||'user') === ((listAfter[i]?.role)||'user')); }
    }
    const rows=listBefore.map((u,i)=>{
      const a=(listAfter && listAfter[i])||{};
      const U=normalizeUser(u); const A=normalizeUser(a);
      let cell='â€”';
      if(action==='activate' || action==='deactivate'){
        const is=(mode==='before')?!!u.isActive:!!a.isActive;
        cell = is ? '<span class="badge text-bg-success">Ù†Ø´Ø·</span>' : '<span class="badge text-bg-danger">Ù…Ø¹Ø·Ù‘Ù„</span>';
        if(mode==='after'){ cell=(is?'<span class="diff-added">Ù†Ø´Ø·</span>':'<span class="diff-removed">Ù…Ø¹Ø·Ù‘Ù„</span>')+` <span class="ms-1">${cell}</span>`; }
      }else if(action==='set-role'){
        const roleTxt = roleAr((mode==='before'?u.role:a.role));
        cell = mode==='after' ? `<span class="diff-added">${roleTxt}</span>` : `<span class="diff-removed">${roleTxt}</span>`;
      }else if(action==='delete'){
        cell = mode==='after' ? '<span class="badge text-bg-danger">ØªÙ… Ø§Ù„Ø­Ø°Ù</span>' : roleAr(u.role);
      }
      return `<tr>
        <td>${U.name} <span class="badge text-bg-info">${U.username}</span> ${U.email?`<span class="badge text-bg-light">${U.email}</span>`:''}</td>
        <td class="text-nowrap">${cell}</td>
      </tr>`;
    }).join('');
    const secondColTitle = (action==='set-role') ? 'Ø§Ù„Ø¯ÙˆØ±' : 'Ø§Ù„Ø­Ø§Ù„Ø©';
    const title=(mode==='before')?`${secondColTitle} Ù‚Ø¨Ù„`:`${secondColTitle} Ø¨Ø¹Ø¯`;
    const headerRight=(mode==='after')?`<div class="d-flex align-items-center gap-2">${noChanges?'<span class="nochange-note">Ù„Ø§ ØªØºÙŠÙŠØ± ÙØ¹Ù„ÙŠ</span>':''}<span class="badge text-bg-light">Ø¹Ø¯Ø¯: ${idsCount || listBefore.length}</span></div>`:'';
    const actionTitle=(action==='set-role')?('ØªØºÙŠÙŠØ± Ø§Ù„Ø¯ÙˆØ± â†’ '+roleAr(p.role)):(action==='activate'?'ØªÙØ¹ÙŠÙ„':(action==='deactivate'?'ØªØ¹Ø·ÙŠÙ„':(action||'â€”')));
    return `<div class="payload-card">
      <div class="d-flex justify-content-between align-items-center mb-2">
        <div>${mode==='after'?('<strong>Ø¹Ù…Ù„ÙŠØ© Ø¬Ù…Ø§Ø¹ÙŠØ©:</strong> '+actionTitle):''}</div>
        ${headerRight}
      </div>
      <div class="table-responsive">
        <table class="table table-sm mb-0">
          <thead class="table-light"><tr><th>Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…</th><th>${title}</th></tr></thead>
          <tbody>${rows}</tbody>
        </table>
      </div>
    </div>`;
  }

  function renderSettingsDiff(before,after,mode){
    const list = (arr)=> (Array.isArray(arr)&&arr.length)?arr.map(toArabicLabel).join('ØŒ '):'â€”';
    return `<div class="payload-card"><dl class="row mb-0">
      <dt>Ø§Ù„Ø£Ø¹Ù…Ø¯Ø© Ø§Ù„Ù…Ø±Ø¦ÙŠØ©</dt><dd>${list((mode==='before'?before:after)?.visibleColumns)}</dd>
      <dt>Ø§Ù„Ø²ÙŠØ§Ø±Ø§Øª Ø§Ù„Ù…Ø­Ø¯Ø¯Ø©</dt><dd>${list((mode==='before'?before:after)?.selectedVisits)}</dd>
    </dl></div>`;
  }

  function renderBeforeCell(log){
    const p=log.payload||{};
    if(log.model==='Settings'){
      if(log.action==='create') return '<div class="payload-card text-muted">ÙƒØ§Ù†Øª ÙØ§Ø±ØºØ©</div>';
      if(log.action==='delete') return renderSettingsDiff(p, {}, 'before');
      if(p && p.before && p.after) return renderSettingsDiff(p.before, p.after, 'before');
      if(p && p.before) return renderSettingsDiff(p.before, {}, 'before');
      return '<div class="payload-card text-muted">â€”</div>';
    }
    if(log.model==='User' && p && p.bulk){ return renderBulkUsersList(p,'before'); }
    if(log.action==='create') return '<div class="payload-card text-muted">ÙƒØ§Ù†Øª ÙØ§Ø±ØºØ©</div>';
    if(log.action==='delete'){ const allKeys=p?new Set(Object.keys(p)):new Set(); return renderCardFromObjectWithDiff(log.model, p, allKeys, 'before', {}); }
    if(p && p.before && p.after){ const diff=computeDiffKeys(p.before,p.after); return renderCardFromObjectWithDiff(log.model, p.before, diff, 'before', p.after); }
    if(p && p.before){ return renderCardFromObjectWithDiff(log.model, p.before, null, 'before', {}); }
    return '<div class="payload-card text-muted">â€”</div>';
  }
  function renderAfterCell(log){
    const p=log.payload||{};
    if(log.model==='Settings'){
      if(log.action==='delete') return '<div class="payload-card text-muted">ØªÙ… Ø§Ù„Ø­Ø°Ù</div>';
      if(log.action==='create') return renderSettingsDiff({}, p, 'after');
      if(p && p.before && p.after) return renderSettingsDiff(p.before, p.after, 'after');
      if(p && p.after) return renderSettingsDiff({}, p.after, 'after');
      return renderSettingsDiff({}, p, 'after');
    }
    if(log.model==='User' && p && p.bulk){ return renderBulkUsersList(p,'after'); }
    if(log.action==='delete') return '<div class="payload-card text-muted">ØªÙ… Ø§Ù„Ø­Ø°Ù</div>';
    if(log.action==='create'){ const allKeys=p?new Set(Object.keys(p)):new Set(); return renderCardFromObjectWithDiff(log.model, p, allKeys, 'after', {}); }
    if(p && p.after && p.before){ const diff=computeDiffKeys(p.before,p.after); return renderCardFromObjectWithDiff(log.model, p.after, diff, 'after', p.before); }
    if(p && p.after){ return renderCardFromObjectWithDiff(log.model, p.after, null, 'after', {}); }
    return renderCardFromObjectWithDiff(log.model, p, null, 'after', {});
  }

  /* ===== listing & selection ===== */
  let page=1, limit=20, reachedEnd=false;
  let rowCounterStart=1;
  const selectedIds=new Set();
  function updateSelectedCount(){ document.getElementById('selectedCount').textContent=selectedIds.size; document.getElementById('btnDeleteSelected').disabled=selectedIds.size===0; }
  function buildQuery(){
    const m=document.getElementById('fModel').value.trim();
    const a=document.getElementById('fAction').value.trim();
    const q=document.getElementById('fQuery').value.trim();
    const f=document.getElementById('fFrom').value;
    const t=document.getElementById('fTo').value;
    const params=new URLSearchParams();
    if(m) params.set('model',m);
    if(a) params.set('action',a);
    if(q) params.set('q',q);
    if(f) params.set('from',f);
    if(t) params.set('to',t);
    params.set('page',page);
    params.set('limit',limit);
    return params.toString();
  }

  async function loadLogs({append=false}={}){
    if(reachedEnd && append) return;
    const tbody=document.getElementById('logsTbody');
    if(!append){
      tbody.innerHTML = `<tr class="text-center text-muted"><td colspan="8">Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„â€¦</td></tr>`;
      rowCounterStart=(page-1)*limit + 1;
      selectedIds.clear(); updateSelectedCount(); document.getElementById('chkAll').checked=false;
    }
    try{
      const r = await fetch(api('/api/audit-logs?')+buildQuery(),{credentials:'include', headers:{'Accept':'application/json'}});
      if(!r.ok) throw new Error('HTTP '+r.status);
      const data=await r.json();
      const items=Array.isArray(data)?data:(data.items||[]);
      reachedEnd = Array.isArray(data)? items.length<limit : (data.hasMore===false);
      if(!append) tbody.innerHTML='';
      if(items.length===0 && !append){ tbody.innerHTML=`<tr class="text-center text-muted"><td colspan="8">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø³Ø¬Ù„Ø§Øª</td></tr>`; return; }
      let n=rowCounterStart;
      items.forEach(log=>{
        const when = log.createdAt ? new Date(log.createdAt).toLocaleString('ar-EG') : 'â€”';
        const id = log._id || log.id || '';
        const disabled = id ? '' : 'disabled';
        const checked  = (id && selectedIds.has(id)) ? 'checked' : '';
        const row = document.createElement('tr');
        row.setAttribute('data-id', id);
        row.innerHTML = `
          <td class="text-center"><input class="form-check-input chkRow" type="checkbox" value="${id}" ${checked} ${disabled}></td>
          <td class="text-muted">${n++}</td>
          <td>${when}</td>
          <td>${modelToPage(log.model)}</td>
          <td>${badgeAction(log.action)}</td>
          <td class="col-user">${fmtUser(log.user)}</td>
          <td class="col-before">${renderBeforeCell(log)}</td>
          <td class="col-after">${renderAfterCell(log)}</td>`;
        tbody.appendChild(row);
      });
      rowCounterStart = n;
    }catch(err){
      tbody.innerHTML = `<tr class="text-center text-danger"><td colspan="8">Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ Ø¬Ù„Ø¨ Ø§Ù„Ø³Ø¬Ù„Ø§Øª</td></tr>`;
      setToast(toastError, 'ØªØ¹Ø°Ù‘Ø± Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø§Ù„Ø³ÙŠØ±ÙØ± Ø£Ùˆ Ø§Ù†ØªÙ‡Øª Ø§Ù„Ø¬Ù„Ø³Ø©. Ø³Ø¬Ù‘Ù„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø«Ù… Ø¬Ø±Ù‘Ø¨ Ù…Ø¬Ø¯Ø¯Ù‹Ø§.'); toastError.show();
    }
  }

  /* ===== filters & selection & delete (ÙƒÙ…Ø§ Ù‡ÙŠ) ===== */
  document.getElementById('btnSearch').addEventListener('click', ()=>{ page=1; reachedEnd=false; loadLogs({append:false}); });
  document.getElementById('btnClear').addEventListener('click', ()=>{ document.getElementById('fModel').value=''; document.getElementById('fAction').value=''; document.getElementById('fQuery').value=''; document.getElementById('fFrom').value=''; document.getElementById('fTo').value=''; page=1; reachedEnd=false; loadLogs({append:false}); });
  document.getElementById('btnMore').addEventListener('click', ()=>{ if(!reachedEnd){ page++; loadLogs({append:true}); } else { setToast(toastInfo,'Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ù…Ø²ÙŠØ¯ Ù…Ù† Ø§Ù„Ø³Ø¬Ù„Ø§Øª'); toastInfo.show(); } });
  document.getElementById('chkAll').addEventListener('change', (e)=>{ const chk=e.target.checked; document.querySelectorAll('#logsTbody .chkRow:not([disabled])').forEach(input=>{ input.checked=chk; const id=input.value; if(chk) selectedIds.add(id); else selectedIds.delete(id); }); updateSelectedCount(); });
  document.getElementById('logsTbody').addEventListener('change', (e)=>{ if(e.target.classList.contains('chkRow')){ const id=e.target.value; if(e.target.checked) selectedIds.add(id); else selectedIds.delete(id); const all=document.querySelectorAll('#logsTbody .chkRow:not([disabled])'); const allChecked=all.length>0 && Array.from(all).every(x=>x.checked); document.getElementById('chkAll').checked=allChecked; updateSelectedCount(); } });
  document.getElementById('btnPurge').addEventListener('click', async ()=>{ const ok=await showConfirm({ title:'ØªØ£ÙƒÙŠØ¯ Ø­Ø°Ù Ø§Ù„ÙƒÙ„', message:'Ø³ÙŠØªÙ… Ø­Ø°Ù Ø¬Ù…ÙŠØ¹ Ø³Ø¬Ù„Ø§Øª Ø§Ù„Ø¹Ù…Ù„ÙŠØ§ØªØŒ ÙˆÙ„Ø§ ÙŠÙ…ÙƒÙ† Ø§Ù„ØªØ±Ø§Ø¬Ø¹.', confirmText:'Ù†Ø¹Ù…ØŒ Ø§Ø­Ø°Ù Ø§Ù„ÙƒÙ„', confirmBtnClass:'btn-danger' }); if(!ok) return; try{ const r=await fetch(api('/api/audit-logs'), { method:'DELETE', credentials:'include' }); if(!r.ok) throw new Error('HTTP '+r.status); const data=await r.json().catch(()=>({})); setToast(toastSuccess, data?.message || 'ğŸ§¹ ØªÙ… Ø­Ø°Ù Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø³Ø¬Ù„Ø§Øª'); toastSuccess.show(); page=1; reachedEnd=false; loadLogs({append:false}); }catch(e){ setToast(toastError,'âŒ ÙØ´Ù„ Ø­Ø°Ù Ø§Ù„Ø³Ø¬Ù„Ø§Øª'); toastError.show(); } });
  document.getElementById('btnPurgeRange').addEventListener('click', async ()=>{ const f=document.getElementById('fFrom').value, t=document.getElementById('fTo').value; if(!f && !t){ setToast(toastInfo,'Ø§Ù„Ø±Ø¬Ø§Ø¡ ØªØ­Ø¯ÙŠØ¯ ØªØ§Ø±ÙŠØ® "Ù…Ù†" Ø£Ùˆ "Ø¥Ù„Ù‰" Ø£ÙˆÙ„Ù‹Ø§'); toastInfo.show(); return; } if(f && t && (new Date(f) > new Date(t))){ setToast(toastError,'âŒ Ù†Ø·Ø§Ù‚ Ø§Ù„ØªØ§Ø±ÙŠØ® ØºÙŠØ± ØµØ­ÙŠØ­'); toastError.show(); return; } const ok=await showConfirm({ title:'ØªØ£ÙƒÙŠØ¯ Ø§Ù„Ø­Ø°Ù Ø­Ø³Ø¨ Ø§Ù„ØªØ§Ø±ÙŠØ®', message:`Ø³ÙŠØªÙ… Ø­Ø°Ù Ø§Ù„Ø³Ø¬Ù„Ø§Øª Ø¶Ù…Ù† Ø§Ù„Ù†Ø·Ø§Ù‚: ${f||'â€”'} â€” ${t||'â€”'}.`, confirmText:'Ø­Ø°Ù Ø¶Ù…Ù† Ø§Ù„Ù†Ø·Ø§Ù‚', confirmBtnClass:'btn-warning' }); if(!ok) return; const qs=new URLSearchParams(); if(f) qs.set('from',f); if(t) qs.set('to',t); try{ const r=await fetch(api('/api/audit-logs?')+qs.toString(), { method:'DELETE', credentials:'include' }); if(!r.ok) throw new Error('HTTP '+r.status); const data=await r.json().catch(()=>({})); const msg=(typeof data?.deletedCount==='number') ? `ğŸ—‚ï¸ ØªÙ… Ø­Ø°Ù ${data.deletedCount} Ø³Ø¬Ù„ Ø¶Ù…Ù† Ø§Ù„Ù†Ø·Ø§Ù‚` : (data?.message || 'ğŸ—‚ï¸ ØªÙ… Ø­Ø°Ù Ø§Ù„Ø³Ø¬Ù„Ø§Øª Ø¶Ù…Ù† Ø§Ù„Ù†Ø·Ø§Ù‚'); setToast(toastSuccess, msg); toastSuccess.show(); page=1; reachedEnd=false; loadLogs({append:false}); }catch(e){ setToast(toastError,'âŒ ÙØ´Ù„ ÙÙŠ Ø­Ø°Ù Ø§Ù„Ø³Ø¬Ù„Ø§Øª Ø¶Ù…Ù† Ø§Ù„Ù†Ø·Ø§Ù‚'); toastError.show(); } });
  document.getElementById('btnDeleteSelected').addEventListener('click', async ()=>{ const count=selectedIds.size; if(count===0){ setToast(toastInfo,'Ù„Ù… ÙŠØªÙ… ØªØ­Ø¯ÙŠØ¯ Ø£ÙŠ Ø³Ø¬Ù„Ø§Øª'); toastInfo.show(); return; } const ok=await showConfirm({ title:'ØªØ£ÙƒÙŠØ¯ Ø­Ø°Ù Ø§Ù„Ù…Ø­Ø¯Ø¯', message:`Ø³ÙŠØªÙ… Ø­Ø°Ù ${count} Ù…Ù† Ø§Ù„Ø³Ø¬Ù„Ø§Øª Ø§Ù„Ù…Ø­Ø¯Ø¯Ø©.`, confirmText:'Ø­Ø°Ù Ø§Ù„Ù…Ø­Ø¯Ø¯', confirmBtnClass:'btn-danger' }); if(!ok) return; try{ const r=await fetch(api('/api/audit-logs/by-ids'), { method:'DELETE', headers:{'Content-Type':'application/json'}, credentials:'include', body: JSON.stringify({ ids: Array.from(selectedIds) }) }); if(!r.ok) throw new Error('HTTP '+r.status); const data=await r.json().catch(()=>({})); const msg=(typeof data?.deletedCount==='number') ? `ğŸ—‘ï¸ ØªÙ… Ø­Ø°Ù ${data.deletedCount} Ø³Ø¬Ù„ Ù…Ø­Ø¯Ø¯` : (data?.message || 'ğŸ—‘ï¸ ØªÙ… Ø­Ø°Ù Ø§Ù„Ø³Ø¬Ù„Ø§Øª Ø§Ù„Ù…Ø­Ø¯Ø¯Ø©'); setToast(toastSuccess, msg); toastSuccess.show(); page=1; reachedEnd=false; loadLogs({append:false}); }catch(e){ setToast(toastError,'âŒ ÙØ´Ù„ Ø­Ø°Ù Ø§Ù„Ø³Ø¬Ù„Ø§Øª Ø§Ù„Ù…Ø­Ø¯Ø¯Ø©'); toastError.show(); } });

  /* ===== Ø¥Ù‚Ù„Ø§Ø¹ ===== */
  ensureAdmin().then(()=>loadLogs({append:false}));
</script>


</body>
</html>
