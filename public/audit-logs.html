<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <title>سجل العمليات - نظام اللجان</title>
  <link rel="icon" type="image/png" href="https://www.dropbox.com/scl/fi/f283e4rvv5cf9x12a1cic/my-website-logo.png?rlkey=yia776im7klypy27af32m0scy&e=1&st=vhaprvzh&dl=1">
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.rtl.min.css">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css">
  <style>
    body{background:#f8f9fa;font-family:'Segoe UI',sans-serif}
    .container{max-width:1200px;margin-top:40px}
    .card{border-radius:16px;box-shadow:0 6px 18px rgba(0,0,0,.06)}
    .user-chip{font-size:.9rem}

    /* بطاقات المحتوى في عمودي "قبل/بعد"  */
    .payload-card{
      background:#fff;border:1px solid #e9ecef;border-radius:12px;padding:10px;
      height:220px;overflow:auto
    }
    .payload-card dt{color:#6c757d;font-weight:600}
    .payload-card dd{margin-bottom:.5rem}
    .payload-json{
      direction:ltr;background:#f6f8fa;border-radius:8px;padding:8px;
      font-family:ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,"Liberation Mono","Courier New",monospace
    }

    .filters .form-control, .filters .form-select{min-width:160px}
    .minw-40{min-width:40px}
    .minw-60{min-width:60px}
    .minw-120{min-width:120px}

    /* لا تكسّر عناوين الأعمدة */
    .table thead th{vertical-align:middle;white-space:nowrap}

    .sticky-actions{position:sticky;bottom:0;background:#fff;border-top:1px solid #e9ecef;padding:12px;border-radius:0 0 16px 16px}
    .count-badge{font-size:.85rem}

    /* إبراز الاختلافات */
    .diff-added{color:#198754;font-weight:600;background:rgba(25,135,84,.12);border-radius:6px;padding:2px 6px}
    .diff-removed{color:#dc3545;font-weight:600;background:rgba(220,53,69,.12);border-radius:6px;padding:2px 6px}

    /* توزيع الأعمدة */
    .col-user{width:16%}
    .col-before{width:34%}
    .col-after{width:34%}

    /* اجبر الجدول الأساسي على توزيع ثابت حتى لا “ينفش” بسبب خلية واحدة */
    .table { table-layout: fixed; }

    /* الجداول داخل بطاقة “البيانات قبل/بعد” لا تتمدد خارج البطاقة */
    .payload-card .table{ table-layout: fixed; width:100%; }
    .payload-card .table th,
    .payload-card .table td{
      white-space: normal;
      word-break: break-word;       /* Chrome/Edge */
      overflow-wrap: anywhere;      /* Safari/Firefox */
    }

    /* كي لا تتجاوز البادجات حدود الخلية */
    .payload-card .badge { white-space: nowrap; }

    /* ساعد النصوص اللاتينية/الإيميل على الانكسار بشكل صحي */
    .payload-card { direction: rtl; }
    .payload-card .email,
    .payload-card code,
    .payload-card .payload-json {
      direction: ltr;
      unicode-bidi: plaintext;
      word-break: break-all;
    }

    /* شارة "لا تغيير فعلي" */
    .nochange-note{
      border:1px solid rgba(13,110,253,.25);
      background:rgba(13,110,253,.06);
      color:#0d6efd;
      border-radius:10px;
      padding:4px 8px;
      font-size:.85rem;
    }
  </style>
</head>
<body>
  <div class="container">
    <!-- Header -->
    <div class="d-flex flex-wrap justify-content-between align-items-center mb-4 gap-2">
      <h3 class="mb-0">سجل العمليات</h3>
      <div class="d-flex align-items-center gap-2">
        <span id="userInfo" class="user-chip badge bg-light text-dark border">
          <i class="bi bi-person"></i>
          <span id="userUsername">—</span>
          <span class="mx-1">—</span>
          <span id="userFullName">—</span>
          <span class="ms-2 badge bg-secondary" id="userRole">—</span>
        </span>
        <a id="homeLink" class="btn btn-outline-primary" href="#">
          <i class="bi bi-grid"></i> لوحة التحكم
        </a>
        <button id="logoutBtn" class="btn btn-danger">
          <i class="bi bi-box-arrow-right"></i> خروج
        </button>
      </div>
    </div>

    <!-- فلاتر -->
    <div class="card mb-3">
      <div class="card-body">
        <div class="filters d-flex flex-wrap align-items-end gap-2">
          <div>
            <label class="form-label">الصفحة</label>
            <select id="fModel" class="form-select">
              <option value="">الكل</option>
              <option value="Evaluation">تقييم اللجان</option>
              <option value="College">الكليات</option>
              <option value="Auditor">المدققون</option>
              <option value="Committee">أسماء اللجان</option>
              <option value="Settings">الإعدادات</option>
              <option value="User">المستخدمون</option>
            </select>
          </div>
          <div>
            <label class="form-label">العملية</label>
            <select id="fAction" class="form-select">
              <option value="">الكل</option>
              <option>create</option>
              <option>update</option>
              <option>delete</option>
            </select>
          </div>
          <div>
            <label class="form-label">بحث (اسم/إيميل/اسم مستخدم)</label>
            <input id="fQuery" type="text" class="form-control" placeholder="مثل: laith أو b01578">
          </div>
          <div>
            <label class="form-label">من تاريخ</label>
            <input id="fFrom" type="date" class="form-control">
          </div>
          <div>
            <label class="form-label">إلى تاريخ</label>
            <input id="fTo" type="date" class="form-control">
          </div>
          <div class="ms-auto d-flex gap-2">
            <button id="btnSearch" class="btn btn-primary"><i class="bi bi-search"></i> بحث</button>
            <button id="btnClear" class="btn btn-outline-secondary"><i class="bi bi-x-circle"></i> تفريغ</button>
          </div>
        </div>
      </div>
    </div>

    <!-- الجدول -->
    <div class="card">
      <div class="card-body p-0">
        <div class="table-responsive">
          <table class="table table-hover align-middle mb-0">
            <thead class="table-light">
              <tr>
                <th class="minw-40 text-center">
                  <input class="form-check-input" type="checkbox" id="chkAll" title="تحديد/إلغاء تحديد الكل">
                </th>
                <th class="minw-60">#</th>
                <th class="minw-120">الوقت</th>
                <th>الصفحة</th>
                <th>العملية</th>
                <th class="col-user">المستخدم</th>
                <th class="col-before">البيانات قبل</th>
                <th class="col-after">البيانات بعد</th>
              </tr>
            </thead>
            <tbody id="logsTbody">
              <tr class="text-center text-muted"><td colspan="8">جاري التحميل…</td></tr>
            </tbody>
          </table>
        </div>

        <!-- شريط الإجراءات -->
        <div class="sticky-actions d-flex flex-wrap justify-content-between align-items-center gap-2">
          <div class="d-flex flex-wrap gap-2">
            <button id="btnMore" class="btn btn-outline-secondary">
              <i class="bi bi-plus-circle"></i> تحميل المزيد
            </button>
            <button id="btnPurge" class="btn btn-outline-danger">
              <i class="bi bi-trash3"></i> حذف كل السجلات
            </button>
            <button id="btnPurgeRange" class="btn btn-outline-warning">
              <i class="bi bi-calendar-x"></i> حذف حسب التاريخ
            </button>
            <button id="btnDeleteSelected" class="btn btn-danger" disabled>
              <i class="bi bi-check2-square"></i> حذف السجلات المحددة
            </button>
          </div>
          <div>
            <span class="badge text-bg-light count-badge">
              المحدد: <span id="selectedCount">0</span>
            </span>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Toasts -->
  <div class="toast-container position-fixed top-0 start-50 translate-middle-x p-3" style="z-index:2000">
    <div id="toastSuccess" class="toast align-items-center text-bg-success border-0 mb-2" role="alert" aria-live="assertive" aria-atomic="true">
      <div class="d-flex">
        <div class="toast-body">✅ تم التنفيذ بنجاح</div>
        <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button>
      </div>
    </div>
    <div id="toastError" class="toast align-items-center text-bg-danger border-0 mb-2" role="alert" aria-live="assertive" aria-atomic="true">
      <div class="d-flex">
        <div class="toast-body">❌ حدث خطأ</div>
        <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button>
      </div>
    </div>
    <div id="toastInfo" class="toast align-items-center text-bg-primary border-0 mb-2" role="status" aria-live="polite" aria-atomic="true">
      <div class="d-flex">
        <div class="toast-body">ℹ️ معلومات</div>
        <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button>
      </div>
    </div>
  </div>

  <!-- Modal تأكيد -->
  <div class="modal fade" id="confirmModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
      <div class="modal-content">
        <div class="modal-header">
          <h5 id="confirmModalTitle" class="modal-title">تأكيد</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="إغلاق"></button>
        </div>
        <div class="modal-body" id="confirmModalBody">هل تريد المتابعة؟</div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">إلغاء</button>
          <button type="button" class="btn btn-danger" id="confirmModalConfirmBtn">تأكيد</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Scripts -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

  
  <script>
  // ========== إعداد المسارات ==========
  const API_BASE = location.hostname.endsWith('github.io') ? 'https://vdash-qkyv.onrender.com' : '';
  const api = (p)=> API_BASE + p;

  // رابط لوحة التحكم
  document.getElementById('homeLink').href = api('/committees-home.html');

  // ========== Toasts ==========
  const toastSuccess = new bootstrap.Toast(document.getElementById('toastSuccess'));
  const toastError   = new bootstrap.Toast(document.getElementById('toastError'));
  const toastInfo    = new bootstrap.Toast(document.getElementById('toastInfo'));
  const setToast = (t,msg)=> t._element.querySelector('.toast-body').innerText = msg;

  // ========== Modal confirm ==========
  const confirmModalEl = document.getElementById('confirmModal');
  const confirmModal   = new bootstrap.Modal(confirmModalEl);
  const confirmTitle   = document.getElementById('confirmModalTitle');
  const confirmBody    = document.getElementById('confirmModalBody');
  const confirmBtn     = document.getElementById('confirmModalConfirmBtn');
  const showConfirm = ({title='تأكيد',message='هل تريد المتابعة؟',confirmText='تأكيد',confirmBtnClass='btn-danger'}={})=>{
    return new Promise(resolve=>{
      confirmTitle.textContent=title; confirmBody.textContent=message;
      confirmBtn.className='btn '+confirmBtnClass; confirmBtn.textContent=confirmText;
      let ok=false;
      const onConfirm=()=>{ ok=true; confirmModal.hide(); resolve(true); };
      const onHidden =()=>{ confirmModalEl.removeEventListener('hidden.bs.modal',onHidden); confirmBtn.removeEventListener('click',onConfirm); if(!ok) resolve(false); };
      confirmBtn.addEventListener('click',onConfirm,{once:true});
      confirmModalEl.addEventListener('hidden.bs.modal',onHidden,{once:true});
      confirmModal.show();
    });
  };

  // ========== أدوات شبكة قوية ==========
  async function fetchJSON(url, options={}){
    const r = await fetch(url, { credentials:'include', headers:{'Accept':'application/json', ...(options.headers||{})}, ...options });
    const ctype = (r.headers.get('content-type')||'').toLowerCase();
    if(!ctype.includes('application/json')){
      return { __nonJSON__: true, status: r.status };
    }
    let data;
    try { data = await r.json(); }
    catch { return { __badJSON__: true, status: r.status }; }
    return { ok: r.ok, status: r.status, data };
  }

  // ========== مصادقة ==========
  const normalizeUser = (u)=>{
    if(!u) return { name:'—', username:'—', email:'', role:'—' };
    if(typeof u==='string') return { name:u, username:u, email:'', role:'' };
    const username = u.username || (u.email ? u.email.split('@')[0] : (u.name||'—'));
    return { name:u.name||'—', username, email:u.email||'', role:u.role||'—' };
  };
  function renderUser(uRaw){
    const u = normalizeUser(uRaw);
    document.getElementById('userUsername').textContent = u.username;
    document.getElementById('userFullName').textContent = u.name;
    document.getElementById('userRole').textContent     = u.role;
  }
  async function ensureAdmin(){
    const meRes = await fetchJSON(api('/auth/committees/me'));
    if(meRes.__nonJSON__ || meRes.__badJSON__ || !meRes.ok){
      const rel = location.pathname + location.search + location.hash;
      location.href = api(`/committees-login.html?next=${encodeURIComponent(rel)}`);
      throw new Error('unauthenticated');
    }
    const me = meRes.data || {};
    if(!me.authenticated){
      const rel = location.pathname + location.search + location.hash;
      location.href = api(`/committees-login.html?next=${encodeURIComponent(rel)}`);
      throw new Error('unauthenticated');
    }
    const role = (me.user?.role||'').toLowerCase();
    if(role!=='admin'){
      setToast(toastError,'❌ هذه الصفحة للمشرفين فقط'); toastError.show();
      setTimeout(()=>location.href=api('/committees-home.html'),900);
      throw new Error('not-admin');
    }
    renderUser(me.user);
    return me.user;
  }
  async function logout(){
    try{
      const r = await fetch(api('/auth/committees/logout'),{ method:'POST', headers:{'Content-Type':'application/json'}, credentials:'include' });
      if(r.ok){ setToast(toastSuccess,'✅ تم تسجيل الخروج'); toastSuccess.show(); setTimeout(()=>location.href=api('/committees-login.html'),700); }
      else    { setToast(toastError,'❌ تعذر تسجيل الخروج'); toastError.show(); }
    }catch{ setToast(toastError,'❌ خطأ في الاتصال'); toastError.show(); }
  }
  document.getElementById('logoutBtn').addEventListener('click', logout);

  // ========== مساعدات عرض ==========
  function modelToPage(m){ return ({Evaluation:'تقييم اللجان',College:'الكليات',Auditor:'المدققون',Committee:'أسماء اللجان',Settings:'الإعدادات',User:'المستخدمون'})[m] || (m||'—'); }
  function badgeAction(a){ const cls = a==='delete'?'text-bg-danger':(a==='update'?'text-bg-warning':'text-bg-success'); return `<span class="badge ${cls}">${a||'—'}</span>`; }
  function fmtUser(uRaw){ const u=normalizeUser(uRaw); const email=u.email?` <span class="badge text-bg-light">${u.email}</span>`:''; const role=u.role?` <span class="badge text-bg-secondary">${u.role}</span>`:''; return `${u.name} <span class="badge text-bg-info">${u.username}</span>${email}${role}`; }

  // ==== diff helpers ====
  const colNameArMap={ committee_name:'اسم اللجنة', college:'الكلية', auditor_name:'المدقق', createdAt:'تاريخ الإنشاء', updatedAt:'تاريخ التحديث', notes:'ملاحظات', score:'النتيجة', work_plan:'خطة العمل', performance_indicators:'مؤشرات الاداء', meetings:'عدد الاجتماعات', consistency:'التوافق بين الدعوات والاجتماعات', coverage_books:'كتب التغطية', report1:'تقرير إنجاز 1', report2:'تقرير إنجاز 2', report3:'تقرير إنجاز 3', statistical_analysis:'التحليل الإحصائي', name:'الاسم', username:'اسم المستخدم', role:'الدور', email:'البريد', isActive:'الحالة', formation_decision:'قرار التشكيل', formationDecision:'قرار التشكيل', decision:'قرار التشكيل', decision_number:'قرار التشكيل', decisionNumber:'قرار التشكيل', formation_no:'قرار التشكيل', formationNo:'قرار التشكيل' };
  const toArabicLabel=(k)=> colNameArMap[k]||k;
  const escapeHtml=(s)=> String(s).replace(/[&<>"']/g, m=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]));
  const normalizeValue=(v)=> v==null? '' : (v instanceof Date? v.toISOString() : (Array.isArray(v)||typeof v==='object')? JSON.stringify(v) : String(v));
  function computeDiffKeys(b,a){ const B=b||{},A=a||{}; const keys=new Set([...Object.keys(B),...Object.keys(A)]); const changed=new Set(); keys.forEach(k=>{ if(normalizeValue(B[k])!==normalizeValue(A[k])) changed.add(k); }); return changed; }
  const roleAr = (r)=> r==='admin'?'مدير (admin)':'مستخدم (user)';
  function kv(label,val,key,diff,mode){ if(val==null||val==='') return ''; const cls=diff&&diff.has(key)?(mode==='before'?'diff-removed':'diff-added'):''; return `<dt>${label}</dt><dd class="${cls}">${escapeHtml(val)}</dd>`; }
  function userActiveBadge(val,key,diff,mode){ const is=!!val; const base=is?'<span class="badge text-bg-success">نشط</span>':'<span class="badge text-bg-danger">معطّل</span>'; const cls=diff&&diff.has(key)?(mode==='before'?'diff-removed':'diff-added'):''; return `<dt>الحالة</dt><dd class="${cls}">${base}</dd>`; }

  function renderCardFromObjectWithDiff(model,obj,diffKeys,mode,otherSide){
    if(!obj) return '<div class="payload-card text-muted">—</div>';
    let h='<div class="payload-card"><dl class="row mb-0">', d=obj, has=(k)=> d[k]!=null && d[k]!=='';    
    if(model==='Evaluation'){
      h+=kv('اسم اللجنة',d.committee_name,'committee_name',diffKeys,mode)
        +kv('الكلية',d.college,'college',diffKeys,mode)
        +kv('المدقق',d.auditor_name,'auditor_name',diffKeys,mode)
        +kv('تاريخ الإنشاء', d.createdAt?new Date(d.createdAt).toLocaleString('ar-EG'):'','createdAt',diffKeys,mode)
        +kv('النتيجة',d.score,'score',diffKeys,mode);
      const decisionKey=['formation_decision','formationDecision','decision','decision_number','decisionNumber','formation_no','formationNo'].find(k=>k in d);
      if(decisionKey) h+=kv('قرار التشكيل', d[decisionKey], decisionKey, diffKeys, mode);
      ['work_plan','performance_indicators','meetings','consistency','coverage_books','report1','report2','report3','statistical_analysis'].forEach(k=>{ if(has(k)) h+=kv(toArabicLabel(k),d[k],k,diffKeys,mode); });
    }else if(model==='College' || model==='Auditor' || model==='Committee'){
      const label = (model==='College') ? 'الكلية' : (model==='Auditor' ? 'المدقق' : 'اسم اللجنة');
      h+=kv(label, d.name, 'name', diffKeys, mode);
    }else if(model==='Settings'){
      if(d.visibleColumns) h+=kv('الأعمدة المرئية',(d.visibleColumns||[]).map(toArabicLabel).join('، '),'visibleColumns',diffKeys,mode);
      if(d.selectedVisits) h+=kv('الزيارات المحددة',(d.selectedVisits||[]).map(toArabicLabel).join('، '),'selectedVisits',diffKeys,mode);
    }else if(model==='User'){
      if(has('name'))h+=kv('الاسم',d.name,'name',diffKeys,mode);
      if(has('username'))h+=kv('اسم المستخدم',d.username,'username',diffKeys,mode);
      if(has('email'))h+=kv('البريد',d.email,'email',diffKeys,mode);
      if(has('role'))h+=kv('الدور',roleAr(d.role),'role',diffKeys,mode);
      if('isActive' in d) h+=userActiveBadge(d.isActive,'isActive',diffKeys,mode);
    }else{
      h+='</dl><div class="payload-json"><code>'+escapeHtml(JSON.stringify(obj,null,2))+'</code></div></div>'; 
      return h;
    }
    h+='</dl>'; 
    if(!/<dd[^>]*>/.test(h)){ h+='<div class="payload-json"><code>'+escapeHtml(JSON.stringify(obj,null,2))+'</code></div>'; } 
    h+='</div>'; 
    return h;
  }

  // ========== كتلة عرض "التعديل الجماعي" ==========
  function synthesizeBulkAfter(p){
    if (!Array.isArray(p?.before)) return null;
    const action=p?.action;
    if (action==='activate')   return p.before.map(u=>({...u,isActive:true}));
    if (action==='deactivate') return p.before.map(u=>({...u,isActive:false}));
    if (action==='set-role')   return p.before.map(u=>({...u,role: p.role==='admin'?'admin':'user'}));
    if (action==='delete')     return p.before.map(u=>({...u,_deleted:true}));
    return null;
  }

  function renderBulkUsersList(p,mode){
    const listBefore=Array.isArray(p?.before)?p.before:[];
    const listAfter =Array.isArray(p?.after)?p.after:synthesizeBulkAfter(p);
    const action=p?.action;
    const idsCount=Array.isArray(p?.ids)?p.ids.length:0;

    if(listBefore.length===0){
      const actionAr = action==='set-role' ? `تغيير الدور إلى ${roleAr(p.role)}`
                    : action==='activate' ? 'تفعيل المستخدمين'
                    : action==='deactivate' ? 'تعطيل المستخدمين'
                    : (action || 'تعديل جماعي');
      return `<div class="payload-card"><dl class="row mb-0">
        <dt>عملية جماعية</dt><dd>${escapeHtml(actionAr)} (عدد: ${idsCount||'—'})</dd>
        <dt>ملاحظة</dt><dd class="text-muted">لتفاصيل الأسماء سجّل الخادم <code>payload.before</code> (ويُفضّل أيضًا <code>payload.after</code>).</dd>
      </dl></div>`;
    }

    let noChanges=false;
    if(listAfter && listAfter.length===listBefore.length){
      if(action==='activate' || action==='deactivate'){
        noChanges=listBefore.every((u,i)=> !!u.isActive === !!(listAfter[i]?.isActive));
      }else if(action==='set-role'){
        noChanges=listBefore.every((u,i)=> (u.role||'user') === ((listAfter[i]?.role)||'user'));
      }
    }

    const rows=listBefore.map((u,i)=>{
      const a=(listAfter && listAfter[i])||{};
      const U=normalizeUser(u);
      let cell='—';
      if(action==='activate' || action==='deactivate'){
        const is=(mode==='before')?!!u.isActive:!!a.isActive;
        cell = is ? '<span class="badge text-bg-success">نشط</span>' : '<span class="badge text-bg-danger">معطّل</span>';
        if(mode==='after'){ cell=(is?'<span class="diff-added">نشط</span>':'<span class="diff-removed">معطّل</span>')+` <span class="ms-1">${cell}</span>`; }
      }else if(action==='set-role'){
        const roleTxt = roleAr((mode==='before'?u.role:a.role));
        cell = mode==='after' ? `<span class="diff-added">${roleTxt}</span>` : `<span class="diff-removed">${roleTxt}</span>`;
      }else if(action==='delete'){
        cell = mode==='after' ? '<span class="badge text-bg-danger">تم الحذف</span>' : roleAr(u.role);
      }
      return `<tr>
        <td>${U.name} <span class="badge text-bg-info">${U.username}</span> ${U.email?`<span class="badge text-bg-light">${U.email}</span>`:''}</td>
        <td class="text-nowrap">${cell}</td>
      </tr>`;
    }).join('');

    const secondColTitle = (action==='set-role') ? 'الدور' : 'الحالة';
    const title=(mode==='before')?`${secondColTitle} قبل`:`${secondColTitle} بعد`;
    const headerRight=(mode==='after')?`<div class="d-flex align-items-center gap-2">${noChanges?'<span class="nochange-note">لا تغيير فعلي</span>':''}<span class="badge text-bg-light">عدد: ${idsCount || listBefore.length}</span></div>`:'';
    const actionTitle=(action==='set-role')?('تغيير الدور → '+roleAr(p.role)):(action==='activate'?'تفعيل':(action==='deactivate'?'تعطيل':(action||'—')));

    return `<div class="payload-card">
      <div class="d-flex justify-content-between align-items-center mb-2">
        <div>${mode==='after'?('<strong>عملية جماعية:</strong> '+actionTitle):''}</div>
        ${headerRight}
      </div>
      <div class="table-responsive">
        <table class="table table-sm mb-0">
          <thead class="table-light"><tr><th>المستخدم</th><th>${title}</th></tr></thead>
          <tbody>${rows}</tbody>
        </table>
      </div>
    </div>`;
  }

  // ========== before/after ==========
  function isBulkUserPayload(log){
    const p = log.payload || {};
    return log.model==='User' && (p.bulk || Array.isArray(p.before) || Array.isArray(p.after) || Array.isArray(p.ids));
  }

  function renderSettingsDiff(before,after,mode){
    const list=(arr)=> (Array.isArray(arr)&&arr.length)?arr.map(toArabicLabel).join('، '):'—';
    return `<div class="payload-card"><dl class="row mb-0"><dt>الأعمدة المرئية</dt><dd>${list((mode==='before'?before:after)?.visibleColumns)}</dd><dt>الزيارات المحددة</dt><dd>${list((mode==='before'?before:after)?.selectedVisits)}</dd></dl></div>`;
  }

  function renderBeforeCell(log){
    const p=log.payload||{};
    if(log.model==='Settings'){
      if(log.action==='create') return '<div class="payload-card text-muted">كانت فارغة</div>';
      if(log.action==='delete') return renderSettingsDiff(p,{},'before');
      if(p.before&&p.after)     return renderSettingsDiff(p.before,p.after,'before');
      if(p.before)              return renderSettingsDiff(p.before,{},'before');
      return '<div class="payload-card text-muted">—</div>';
    }
    if(isBulkUserPayload(log)) return renderBulkUsersList(p,'before');
    if(log.action==='create') return '<div class="payload-card text-muted">كانت فارغة</div>';
    if(log.action==='delete'){ const ks=p?new Set(Object.keys(p)):new Set(); return renderCardFromObjectWithDiff(log.model,p,ks,'before',{}); }
    if(p.before&&p.after){ const diff=computeDiffKeys(p.before,p.after); return renderCardFromObjectWithDiff(log.model,p.before,diff,'before',p.after); }
    if(p.before){ return renderCardFromObjectWithDiff(log.model,p.before,null,'before',{}); }
    return '<div class="payload-card text-muted">—</div>';
  }

  function renderAfterCell(log){
    const p=log.payload||{};
    if(log.model==='Settings'){
      if(log.action==='delete') return '<div class="payload-card text-muted">تم الحذف</div>';
      if(log.action==='create') return renderSettingsDiff({},p,'after');
      if(p.before&&p.after)     return renderSettingsDiff(p.before,p.after,'after');
      if(p.after)               return renderSettingsDiff({},p.after,'after');
      return renderSettingsDiff({},p,'after');
    }
    if(isBulkUserPayload(log)) return renderBulkUsersList(p,'after');
    if(log.action==='delete')  return '<div class="payload-card text-muted">تم الحذف</div>';
    if(log.action==='create'){ const ks=p?new Set(Object.keys(p)):new Set(); return renderCardFromObjectWithDiff(log.model,p,ks,'after',{}); }
    if(p.after&&p.before){ const diff=computeDiffKeys(p.before,p.after); return renderCardFromObjectWithDiff(log.model,p.after,diff,'after',p.before); }
    if(p.after){ return renderCardFromObjectWithDiff(log.model,p.after,null,'after',{}); }
    return renderCardFromObjectWithDiff(log.model,p,null,'after',{});
  }

  // ========== تحميل السجلات ==========
  let page=1, limit=20, reachedEnd=false, rowCounterStart=1;
  const selectedIds=new Set();
  const updateSelectedCount=()=>{ document.getElementById('selectedCount').textContent=selectedIds.size; document.getElementById('btnDeleteSelected').disabled=selectedIds.size===0; };
  function buildQuery(){
    const m=document.getElementById('fModel').value.trim();
    const a=document.getElementById('fAction').value.trim();
    const q=document.getElementById('fQuery').value.trim();
    const f=document.getElementById('fFrom').value;
    const t=document.getElementById('fTo').value;
    const p=new URLSearchParams(); if(m)p.set('model',m); if(a)p.set('action',a); if(q)p.set('q',q); if(f)p.set('from',f); if(t)p.set('to',t);
    p.set('page',page); p.set('limit',limit); return p.toString();
  }
  async function loadLogs({append=false}={}){
    if(reachedEnd && append) return;
    const tbody=document.getElementById('logsTbody');
    if(!append){
      tbody.innerHTML = `<tr class="text-center text-muted"><td colspan="8">جاري التحميل…</td></tr>`;
      rowCounterStart=(page-1)*limit + 1; selectedIds.clear(); updateSelectedCount(); document.getElementById('chkAll').checked=false;
    }
    const res = await fetchJSON(api('/api/audit-logs?')+buildQuery());
    if(res.__nonJSON__ || res.__badJSON__ || !res.ok){
      tbody.innerHTML = `<tr class="text-center text-danger"><td colspan="8">انتهت الجلسة أو تعذّر الاتصال. يُرجى تسجيل الدخول.</td></tr>`;
      setToast(toastError, 'تعذّر جلب السجلات (جلسة منتهية/توجيه HTML)'); toastError.show();
      setTimeout(()=>{
        const rel = location.pathname + location.search + location.hash;
        location.href = api(`/committees-login.html?next=${encodeURIComponent(rel)}`);
      }, 800);
      return;
    }
    const data = res.data;
    const items = Array.isArray(data) ? data : (data.items||[]);
    reachedEnd = Array.isArray(data) ? (items.length<limit) : (data.hasMore===false);
    if(!append) tbody.innerHTML='';
    if(items.length===0 && !append){ tbody.innerHTML = `<tr class="text-center text-muted"><td colspan="8">لا توجد سجلات</td></tr>`; return; }
    let n=rowCounterStart;
    items.forEach(log=>{
      const when = log.createdAt ? new Date(log.createdAt).toLocaleString('ar-EG') : '—';
      const id   = log._id || log.id || '';
      const row  = document.createElement('tr');
      row.setAttribute('data-id',id);
      row.innerHTML = `
        <td class="text-center"><input class="form-check-input chkRow" type="checkbox" value="${id}" ${id?'':'disabled'} ${selectedIds.has(id)?'checked':''}></td>
        <td class="text-muted">${n++}</td>
        <td>${when}</td>
        <td>${modelToPage(log.model)}</td>
        <td>${badgeAction(log.action)}</td>
        <td class="col-user">${fmtUser(log.user)}</td>
        <td class="col-before">${renderBeforeCell(log)}</td>
        <td class="col-after">${renderAfterCell(log)}</td>`;
      tbody.appendChild(row);
    });
    rowCounterStart = n;
  }

  // ========== تحكم الأزرار ==========
  document.getElementById('btnSearch').addEventListener('click', ()=>{ page=1; reachedEnd=false; loadLogs({append:false}); });
  document.getElementById('btnClear').addEventListener('click', ()=>{ ['fModel','fAction','fQuery','fFrom','fTo'].forEach(id=>document.getElementById(id).value=''); page=1; reachedEnd=false; loadLogs({append:false}); });
  document.getElementById('btnMore').addEventListener('click', ()=>{ if(!reachedEnd){ page++; loadLogs({append:true}); } else { setToast(toastInfo,'لا يوجد مزيد من السجلات'); toastInfo.show(); }});
  document.getElementById('chkAll').addEventListener('change', (e)=>{ const chk=e.target.checked; document.querySelectorAll('#logsTbody .chkRow:not([disabled])').forEach(i=>{ i.checked=chk; const id=i.value; if(chk) selectedIds.add(id); else selectedIds.delete(id); }); updateSelectedCount(); });
  document.getElementById('logsTbody').addEventListener('change', (e)=>{ if(e.target.classList.contains('chkRow')){ const id=e.target.value; if(e.target.checked) selectedIds.add(id); else selectedIds.delete(id); const all=document.querySelectorAll('#logsTbody .chkRow:not([disabled])'); document.getElementById('chkAll').checked = all.length>0 && Array.from(all).every(x=>x.checked); updateSelectedCount(); }});
  document.getElementById('btnPurge').addEventListener('click', async ()=>{ const ok=await showConfirm({title:'تأكيد حذف الكل',message:'سيتم حذف جميع سجلات العمليات، ولا يمكن التراجع.',confirmText:'نعم، احذف الكل',confirmBtnClass:'btn-danger'}); if(!ok) return; const r=await fetch(api('/api/audit-logs'),{method:'DELETE',credentials:'include'}); if(r.ok){ setToast(toastSuccess,'🧹 تم حذف جميع السجلات'); toastSuccess.show(); page=1; reachedEnd=false; loadLogs({append:false}); } else { setToast(toastError,'❌ فشل حذف السجلات'); toastError.show(); }});
  document.getElementById('btnPurgeRange').addEventListener('click', async ()=>{ const f=fFrom.value, t=fTo.value; if(!f && !t){ setToast(toastInfo,'حدّد تاريخ "من" أو "إلى"'); toastInfo.show(); return; } if(f && t && (new Date(f)>new Date(t))){ setToast(toastError,'❌ نطاق التاريخ غير صحيح'); toastError.show(); return; } const ok=await showConfirm({title:'تأكيد الحذف حسب التاريخ',message:`سيتم حذف ضمن النطاق: ${f||'—'} — ${t||'—'}.`,confirmText:'حذف ضمن النطاق',confirmBtnClass:'btn-warning'}); if(!ok) return; const qs=new URLSearchParams(); if(f) qs.set('from',f); if(t) qs.set('to',t); const r=await fetch(api('/api/audit-logs?')+qs.toString(),{method:'DELETE',credentials:'include'}); if(r.ok){ setToast(toastSuccess,'🗂️ تم حذف السجلات ضمن النطاق'); toastSuccess.show(); page=1; reachedEnd=false; loadLogs({append:false}); } else { setToast(toastError,'❌ فشل في حذف السجلات ضمن النطاق'); toastError.show(); }});
  document.getElementById('btnDeleteSelected').addEventListener('click', async ()=>{ const count=selectedIds.size; if(count===0){ setToast(toastInfo,'لم يتم تحديد أي سجلات'); toastInfo.show(); return; } const ok=await showConfirm({title:'تأكيد حذف المحدد',message:`سيتم حذف ${count} من السجلات المحددة.`,confirmText:'حذف المحدد',confirmBtnClass:'btn-danger'}); if(!ok) return; const r=await fetch(api('/api/audit-logs/by-ids'),{method:'DELETE',headers:{'Content-Type':'application/json'},credentials:'include',body:JSON.stringify({ids:Array.from(selectedIds)})}); if(r.ok){ setToast(toastSuccess,'🗑️ تم حذف السجلات المحددة'); toastSuccess.show(); page=1; reachedEnd=false; loadLogs({append:false}); } else { setToast(toastError,'❌ فشل حذف السجلات المحددة'); toastError.show(); }});

  // ========== تشغيل ==========
  ensureAdmin().then(()=>loadLogs({append:false}));
</script>

</body>
</html>
