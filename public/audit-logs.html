<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>سجلّ العمليات (Audit Logs)</title>
  <style>
    :root { --bg:#f7f7f9; --card:#fff; --text:#222; --muted:#666; --pri:#145DA0; --pri-2:#0F4C81; --danger:#b00020; --border:#e3e3e7; }
    * { box-sizing: border-box; }
    body { margin:0; font-family: system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial, "Noto Sans", "Apple Color Emoji", "Segoe UI Emoji"; background: var(--bg); color: var(--text); }
    header { background: var(--card); border-bottom:1px solid var(--border); position: sticky; top:0; z-index: 5; }
    .container { max-width:1100px; margin:0 auto; padding: 16px; }
    h1 { font-size:20px; margin:0 0 8px; }
    .topbar { display:flex; gap:12px; align-items:center; flex-wrap: wrap; }
    select, input[type="date"], input[type="text"], input[type="number"] { padding:8px 10px; border:1px solid var(--border); border-radius:10px; background:#fff; min-width: 120px; }
    input[type="text"]{ min-width:220px; }
    button { padding:8px 12px; border:0; border-radius:10px; cursor:pointer; background:var(--pri); color:#fff; }
    button.secondary { background:#eee; color:#111; border:1px solid var(--border); }
    button.danger { background: var(--danger); }
    .card { background:var(--card); border:1px solid var(--border); border-radius:14px; padding: 14px; }
    .grid { display:grid; gap:12px; }
    .filters { margin-top:10px; }
    .filters .row { display:flex; gap:10px; flex-wrap:wrap; }
    table { width:100%; border-collapse: collapse; background:var(--card); border-radius:14px; overflow:hidden; }
    thead th { background:#fafafc; color:#333; font-weight:600; border-bottom:1px solid var(--border); padding:10px; text-align: right; }
    tbody td { border-bottom:1px solid var(--border); padding:10px; vertical-align: top; }
    .muted { color: var(--muted); font-size: 12px; }
    .nowrap { white-space: nowrap; }
    .payload { display:grid; gap:6px; }
    .payload pre { margin:0; background:#fcfcfe; border:1px solid var(--border); padding:8px; border-radius:10px; max-height: 240px; overflow:auto; }
    .row-actions { display:flex; gap:6px; align-items:center; }
    .table-wrap { overflow:auto; border:1px solid var(--border); border-radius:14px; }
    .toolbar { display:flex; justify-content: space-between; align-items:center; margin:12px 0; gap:10px; flex-wrap: wrap; }
    .pagination { display:flex; gap:6px; align-items:center; }
    .pill { display:inline-flex; align-items:center; gap:6px; font-size:12px; padding:4px 8px; background:#f0f4ff; color:#0F4C81; border-radius:999px; }
    .danger-ghost { background:#fff5f6; color:#b00020; border:1px solid #ffd5da; }
    .url-list { margin:0; padding:0 0 0 16px; }
    .url-list li { margin:2px 0; }
    .tag { background:#eef6fb; color:#0F4C81; padding:2px 6px; border-radius:8px; font-size: 11px; }
    .k { color:#444; }
    .v { color:#000; }
    .subnav { display:flex; gap:8px; align-items:center; padding:8px 0 12px; }
    .subnav select { min-width: 200px; }
  </style>
</head>
<body>

<header>
  <div class="container">
    <h1>سجلّ العمليات (Audit Logs)</h1>

    <!-- قائمة الصفحات (التنقل): تمت إضافة CommitteeAssignment و CommitteeFiles -->
    <div class="subnav">
      <label for="pageNav" class="muted">الانتقال إلى صفحة:</label>
      <select id="pageNav">
        <option value="">— اختر صفحة —</option>
        <option value="/dashboard.html">لوحة التحكم (الفيديو)</option>
        <option value="/links.html">روابط الفيديو</option>
        <option value="/backups.html">النسخ الاحتياطية</option>
        <option value="/committees-manage.html">إدارة أسماء اللجان</option>
        <option value="/index.html">الصفحة الرئيسية</option>
        <!-- إدخالات نظام اللجان -->
        <option value="/committees.html">تقييمات اللجان (Evaluation)</option>
        <option value="/committee-assignments.html">CommitteeAssignment</option>
        <option value="/committees-files.html">CommitteeFiles</option>
        <!-- هذه الصفحة -->
        <option value="/audit-logs.html" selected>سجلّ العمليات</option>
      </select>
      <button class="secondary" id="goPage">اذهب</button>
    </div>

    <div class="card filters">
      <div class="grid">
        <div class="row">
          <!-- تمت إضافة CommitteeAssignment و CommitteeFiles في فلتر الـ Model -->
          <select id="filterModel" title="النموذج">
            <option value="">كل النماذج</option>
            <option>Evaluation</option>
            <option>User</option>
            <option>Settings</option>
            <option>College</option>
            <option>Committee</option>
            <option>Auditor</option>
            <option>CommitteeFiles</option>
            <option>CommitteeAssignment</option>
          </select>

          <select id="filterAction" title="الإجراء">
            <option value="">كل الإجراءات</option>
            <option>create</option>
            <option>update</option>
            <option>delete</option>
            <option>upsert</option>
          </select>

          <input id="filterFrom" type="date" />
          <input id="filterTo" type="date" />
          <input id="filterQ" type="text" placeholder="بحث في المستخدم (اسم/بريد/اسم مستخدم)..." />
          <label class="muted">حجم الصفحة</label>
          <input id="filterLimit" type="number" min="1" max="100" value="20" />
          <button id="btnApply">تطبيق</button>
          <button id="btnReset" class="secondary">تصفير</button>
        </div>

        <div class="row">
          <button id="btnDeleteRange" class="danger">حذف ضمن النطاق الزمني</button>
          <button id="btnDeleteSelected" class="danger">حذف المحدد بالمعرفات</button>
          <span class="muted">لن تُحذف سجلات بدون تحديد نطاق أو معرفات.</span>
        </div>
      </div>
    </div>
  </div>
</header>

<main class="container">
  <div class="toolbar">
    <div class="pill"><strong id="totalCount">0</strong> إجمالي السجلات</div>
    <div class="pagination">
      <button id="prevPage" class="secondary">السابق</button>
      <span class="muted">صفحة <span id="pageNum">1</span></span>
      <button id="nextPage" class="secondary">التالي</button>
    </div>
  </div>

  <div class="table-wrap">
    <table>
      <thead>
        <tr>
          <th style="width:34px;"><input id="selAll" type="checkbox" /></th>
          <th>التاريخ</th>
          <th>النموذج</th>
          <th>الإجراء</th>
          <th>المعرف</th>
          <th>المستخدم</th>
          <th>الحمولة (Payload)</th>
        </tr>
      </thead>
      <tbody id="rows">
        <tr><td colspan="7" class="muted" style="text-align:center;padding:18px;">لا توجد بيانات.</td></tr>
      </tbody>
    </table>
  </div>
</main>

<script>
(function(){
  const qs = (s,el=document)=>el.querySelector(s);
  const qsa = (s,el=document)=>Array.from(el.querySelectorAll(s));

  const state = {
    page: 1,
    limit: 20,
    model: '',
    action: '',
    from: '',
    to: '',
    q: '',
    hasMore: false,
    total: 0,
    items: []
  };

  // تنقل بين الصفحات (القائمة العلوية)
  qs('#goPage').addEventListener('click', () => {
    const v = qs('#pageNav').value;
    if (v) location.href = v;
  });

  // تحميل من معلمات العنوان (للاستمرارية)
  function parseUrlParams(){
    const p = new URLSearchParams(location.search);
    state.page   = parseInt(p.get('page')||'1',10) || 1;
    state.limit  = parseInt(p.get('limit')||'20',10) || 20;
    state.model  = p.get('model')||'';
    state.action = p.get('action')||'';
    state.from   = p.get('from')||'';
    state.to     = p.get('to')||'';
    state.q      = p.get('q')||'';
    // اسقاط إلى الواجهة
    qs('#filterLimit').value = state.limit;
    qs('#filterModel').value = state.model;
    qs('#filterAction').value= state.action;
    qs('#filterFrom').value  = state.from;
    qs('#filterTo').value    = state.to;
    qs('#filterQ').value     = state.q;
    qs('#pageNum').textContent = state.page;
  }

  function pushUrlParams(){
    const p = new URLSearchParams();
    if (state.page>1) p.set('page', state.page);
    if (state.limit!==20) p.set('limit', state.limit);
    if (state.model) p.set('model', state.model);
    if (state.action) p.set('action', state.action);
    if (state.from) p.set('from', state.from);
    if (state.to) p.set('to', state.to);
    if (state.q) p.set('q', state.q);
    history.replaceState(null, '', '?' + p.toString());
  }

  function fmtDate(iso){
    try {
      const d = new Date(iso);
      if (!+d) return '';
      const y=d.getFullYear(), m=String(d.getMonth()+1).padStart(2,'0'), da=String(d.getDate()).padStart(2,'0');
      const hh=String(d.getHours()).padStart(2,'0'), mm=String(d.getMinutes()).padStart(2,'0');
      return `${y}-${m}-${da} ${hh}:${mm}`;
    } catch { return ''; }
  }

  // عرض مخصص للـ payload لبعض النماذج، مع الحفاظ على طريقة العرض العامة
  function renderPayloadCell(item){
    const { model, payload } = item || {};
    if (!payload || typeof payload !== 'object') {
      return `<pre dir="ltr">${escapeHTML(JSON.stringify(payload))}</pre>`;
    }

    // CommitteeAssignment: عرض لقطة المستخدم before/after/create
    if (model === 'CommitteeAssignment') {
      // create: payload.user + college + committee_name + note
      if (payload.user && !payload.before && !payload.after) {
        return `
          <div class="payload">
            <div><span class="tag">create</span></div>
            ${renderUserSnapshot(payload.user)}
            <div><span class="k">الكلية:</span> <span class="v">${escapeHTML(payload.college||'')}</span></div>
            <div><span class="k">اللجنة:</span> <span class="v">${escapeHTML(payload.committee_name||'')}</span></div>
            ${payload.note ? `<div><span class="k">ملاحظة:</span> <span class="v">${escapeHTML(payload.note)}</span></div>`:''}
          </div>
        `;
      }
      // update/delete: payload.before / payload.after وفي كليهما لقطة user
      if (payload.before || payload.after) {
        const before = payload.before || payload;
        const after  = payload.after;
        return `
          <div class="payload">
            <div><span class="tag">${after ? 'update' : 'delete'}</span></div>
            <div><strong>قبل:</strong></div>
            ${renderAssignmentSnapshot(before)}
            ${after ? (`<div><strong>بعد:</strong></div>` + renderAssignmentSnapshot(after)) : ''}
          </div>
        `;
      }
    }

    // CommitteeFiles: عرض urlObj والمصفوفات عبر normalize
    if (model === 'CommitteeFiles') {
      const k = (x)=>`<span class="k">${x}</span>`;
      const blockUrl = (u) => {
        if (!u || !u.value) return '<span class="muted">—</span>';
        const t = (u.title||'').trim();
        return `<a href="${escapeAttr(u.value)}" target="_blank" rel="noopener">${escapeHTML(t||u.value)}</a>`;
      };
      const listUrl = (arr) => {
        if (!Array.isArray(arr) || !arr.length) return '<span class="muted">—</span>';
        return `<ul class="url-list">` + arr.map(u=>`<li>${blockUrl(u)}</li>`).join('') + `</ul>`;
      };
      if (payload.before || payload.after) {
        const before = payload.before||{};
        const after  = payload.after||{};
        return `
          <div class="payload">
            <div><span class="tag">${payload.after ? 'update' : 'delete'}</span></div>
            <div><strong>قبل:</strong></div>
            ${renderFilesSnapshot(before, {k, blockUrl, listUrl})}
            ${payload.after ? (`<div><strong>بعد:</strong></div>` + renderFilesSnapshot(after, {k, blockUrl, listUrl})) : ''}
          </div>
        `;
      } else {
        // upsert/create
        const p = payload;
        return `
          <div class="payload">
            <div><span class="tag">${item.action}</span></div>
            ${renderFilesTop(p)}
            <div>${k('قرار التشكيل:')} ${blockUrl(p.formation_decision)}</div>
            <div>${k('خطة العمل:')} ${blockUrl(p.work_plan)}</div>
            <div>${k('الدعوات:')}</div>${listUrl(p.invitations)}
            <div>${k('المحاضر:')}</div>${listUrl(p.minutes)}
            <div>${k('كتب التغطية:')}</div>${listUrl(p.coverage_letters)}
            <div>${k('تقرير 1:')} ${blockUrl(p.report1)}</div>
            <div>${k('تقرير 2:')} ${blockUrl(p.report2)}</div>
            <div>${k('تقرير 3:')} ${blockUrl(p.report3)}</div>
            <div>${k('التحليل الإحصائي:')} ${blockUrl(p.statistical_analysis)}</div>
          </div>
        `;
      }
    }

    // User: عرض حالات كلمات المرور كبطاقات صغيرة إن وجدت
    if (model === 'User' && payload) {
      if (payload.bulkPasswordReset || payload.selfPasswordChange || payload.passwordChanged) {
        const chips = [];
        if (payload.bulkPasswordReset) chips.push('<span class="tag">تغيير كلمات مرور جماعي</span>');
        if (payload.selfPasswordChange) chips.push('<span class="tag">تغيير ذاتي</span>');
        if (payload.passwordChanged && payload.targetName) {
          chips.push(`<span class="tag">تغيير كلمة المرور: ${escapeHTML(payload.targetName)}</span>`);
        }
        return `
          <div class="payload">
            <div>${chips.join(' ')}</div>
            <pre dir="ltr">${escapeHTML(JSON.stringify(payload, null, 2))}</pre>
          </div>
        `;
      }
    }

    // الافتراضي: JSON عادي
    return `<pre dir="ltr">${escapeHTML(JSON.stringify(payload, null, 2))}</pre>`;
  }

  function renderUserSnapshot(u){
    if (!u) return '';
    return `
      <div><span class="k">المستخدم:</span>
        <span class="v">${escapeHTML(u.name||'')}</span>
        <span class="muted">(${escapeHTML(u.username||'')})</span>
      </div>
      <div class="muted">${escapeHTML(u.email||'')} · <span class="tag">${escapeHTML(u.role||'')}</span></div>
    `;
  }

  function renderAssignmentSnapshot(x){
    if (!x) return '';
    const user = x.user || {};
    return `
      ${renderUserSnapshot(user)}
      <div><span class="k">الكلية:</span> <span class="v">${escapeHTML(x.college||'')}</span></div>
      <div><span class="k">اللجنة:</span> <span class="v">${escapeHTML(x.committee_name||'')}</span></div>
      ${x.note ? `<div><span class="k">ملاحظة:</span> <span class="v">${escapeHTML(x.note)}</span></div>`:''}
    `;
  }

  function renderFilesTop(p){
    return `
      <div><span class="k">الكلية:</span> <span class="v">${escapeHTML(p.college||'')}</span></div>
      <div><span class="k">اللجنة:</span> <span class="v">${escapeHTML(p.committee_name||'')}</span></div>
      <div><span class="k">العام الجامعي:</span> <span class="v">${escapeHTML(p.academicYear||'')}</span></div>
      <div><span class="k">الفصل:</span> <span class="v">${escapeHTML(p.term||'')}</span></div>
    `;
  }

  function renderFilesSnapshot(x, helpers){
    if (!x) return '<div class="muted">—</div>';
    const {k, blockUrl, listUrl} = helpers;
    return `
      ${renderFilesTop(x)}
      <div>${k('قرار التشكيل:')} ${blockUrl(x.formation_decision)}</div>
      <div>${k('خطة العمل:')} ${blockUrl(x.work_plan)}</div>
      <div>${k('الدعوات:')}</div>${listUrl(x.invitations)}
      <div>${k('المحاضر:')}</div>${listUrl(x.minutes)}
      <div>${k('كتب التغطية:')}</div>${listUrl(x.coverage_letters)}
      <div>${k('تقرير 1:')} ${blockUrl(x.report1)}</div>
      <div>${k('تقرير 2:')} ${blockUrl(x.report2)}</div>
      <div>${k('تقرير 3:')} ${blockUrl(x.report3)}</div>
      <div>${k('التحليل الإحصائي:')} ${blockUrl(x.statistical_analysis)}</div>
    `;
  }

  function escapeHTML(s){
    return String(s==null?'':s)
      .replace(/&/g,'&amp;')
      .replace(/</g,'&lt;')
      .replace(/>/g,'&gt;')
      .replace(/"/g,'&quot;');
  }
  function escapeAttr(s){
    return escapeHTML(s).replace(/"/g, '&quot;');
  }

  // تحميل البيانات
  async function load(){
    const params = new URLSearchParams();
    if (state.model) params.set('model', state.model);
    if (state.action) params.set('action', state.action);
    if (state.from) params.set('from', state.from);
    if (state.to) params.set('to', state.to);
    if (state.q) params.set('q', state.q);
    params.set('page', state.page);
    params.set('limit', state.limit);

    const url = `/api/audit-logs?${params.toString()}`;
    const res = await fetch(url, { credentials:'include' });
    if (!res.ok) {
      qs('#rows').innerHTML = `<tr><td colspan="7" class="muted" style="text-align:center;padding:18px;">تعذر الجلب (${res.status})</td></tr>`;
      return;
    }
    const data = await res.json();
    state.items = data.items || [];
    state.total = data.total || 0;
    state.hasMore = !!data.hasMore;

    qs('#totalCount').textContent = state.total;
    qs('#pageNum').textContent = state.page;

    renderRows();
    pushUrlParams();
  }

  function renderRows(){
    const tbody = qs('#rows');
    if (!state.items.length) {
      tbody.innerHTML = `<tr><td colspan="7" class="muted" style="text-align:center;padding:18px;">لا توجد بيانات.</td></tr>`;
      return;
    }
    const rows = state.items.map(it=>{
      const user = it.user || {};
      const userLine = user
        ? `${escapeHTML(user.name||'')} <span class="muted">(${escapeHTML(user.username||'')})</span><div class="muted">${escapeHTML(user.email||'')}</div>`
        : '<span class="muted">—</span>';
      const docId = it.docId ? `<code dir="ltr">${escapeHTML(it.docId)}</code>` : '<span class="muted">—</span>';
      return `
        <tr data-id="${escapeAttr(it._id)}">
          <td><input type="checkbox" class="rowSel" /></td>
          <td class="nowrap">${fmtDate(it.createdAt)}</td>
          <td>${escapeHTML(it.model||'')}</td>
          <td><span class="tag">${escapeHTML(it.action||'')}</span></td>
          <td>${docId}</td>
          <td>${userLine}</td>
          <td>${renderPayloadCell(it)}</td>
        </tr>
      `;
    }).join('');
    tbody.innerHTML = rows;

    // سلوك تحديد الكل
    qs('#selAll').checked = false;
    qsa('.rowSel').forEach(chk => {
      chk.addEventListener('change', ()=> {
        // لا شيء إضافي الآن
      });
    });
  }

  // تحكم الصفحة
  qs('#btnApply').addEventListener('click', () => {
    state.page = 1;
    state.limit = clamp(parseInt(qs('#filterLimit').value||'20',10),1,100);
    state.model = qs('#filterModel').value;
    state.action = qs('#filterAction').value;
    state.from = qs('#filterFrom').value;
    state.to   = qs('#filterTo').value;
    state.q    = qs('#filterQ').value.trim();
    load();
  });
  qs('#btnReset').addEventListener('click', () => {
    qs('#filterModel').value='';
    qs('#filterAction').value='';
    qs('#filterFrom').value='';
    qs('#filterTo').value='';
    qs('#filterQ').value='';
    qs('#filterLimit').value='20';
    state.page=1; state.limit=20; state.model=''; state.action=''; state.from=''; state.to=''; state.q='';
    load();
  });

  qs('#prevPage').addEventListener('click', ()=>{
    if (state.page>1){ state.page--; load(); }
  });
  qs('#nextPage').addEventListener('click', ()=>{
    if (state.hasMore){ state.page++; load(); }
  });

  qs('#selAll').addEventListener('change', (e)=>{
    qsa('.rowSel').forEach(chk=> chk.checked = e.target.checked);
  });

  // حذف ضمن نطاق زمني
  qs('#btnDeleteRange').addEventListener('click', async ()=>{
    const from = qs('#filterFrom').value;
    const to   = qs('#filterTo').value;
    if (!from && !to) { alert('يجب تحديد تاريخ البداية أو النهاية.'); return; }
    if (!confirm('سيتم حذف السجلات ضمن النطاق الزمني المحدد، هل أنت متأكد؟')) return;
    const url = `/api/audit-logs?${new URLSearchParams({ ...(from?{from}:{}) , ...(to?{to}:{}) }).toString() }`;
    const res = await fetch(url, { method:'DELETE', credentials:'include' });
    if (!res.ok){ alert('تعذر الحذف.'); return; }
    await load();
  });

  // حذف المحدّد بالمعرفات
  qs('#btnDeleteSelected').addEventListener('click', async ()=>{
    const ids = qsa('#rows tr').filter(tr => qs('.rowSel', tr)?.checked).map(tr => tr.getAttribute('data-id'));
    if (!ids.length){ alert('لم يتم تحديد أي سجل.'); return; }
    if (!confirm(`سيتم حذف ${ids.length} سجلاً. هل أنت متأكد؟`)) return;
    const res = await fetch('/api/audit-logs/by-ids', {
      method:'DELETE',
      headers: { 'Content-Type':'application/json' },
      credentials:'include',
      body: JSON.stringify({ ids })
    });
    if (!res.ok){ alert('تعذر الحذف.'); return; }
    await load();
  });

  function clamp(n,min,max){ return Math.max(min, Math.min(max, isNaN(n)?min:n)); }

  // بدء
  parseUrlParams();
  load();
})();
</script>

</body>
</html>
