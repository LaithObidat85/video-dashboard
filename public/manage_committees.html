<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8">
  <title>Ø¥Ø¯Ø§Ø±Ø© ØªÙ‚ÙŠÙŠÙ… Ø§Ù„Ù„Ø¬Ø§Ù† - Ù†Ø¸Ø§Ù… Ø§Ù„Ù„Ø¬Ø§Ù†</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <link rel="icon" type="image/png" href="https://www.dropbox.com/scl/fi/f283e4rvv5cf9x12a1cic/my-website-logo.png?rlkey=yia776im7klypy27af32m0scy&e=1&st=vhaprvzh&dl=1">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.rtl.min.css">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css">
  <style>
    body{background:#f8f9fa;font-family:'Segoe UI',sans-serif}
    /* Ù†Ø²Ù‘Ù„ Ø§Ù„Ù‡ÙŠØ¯Ø± Ù…Ø«Ù„ ØµÙØ­Ø© Ø§Ù„Ù…Ø¯Ù‚Ù‚ÙŠÙ† */
    .container{margin-top:40px;max-width:98vw}
    .user-chip{display:inline-flex;align-items:center;gap:.25rem;font-size:1rem!important;padding:.375rem .75rem!important;line-height:1.5!important;border-radius:.375rem;font-weight:700!important}
    .user-chip.badge #userRole{font-weight:500!important}

    table{background:#fff;border-radius:12px;overflow:hidden;font-size:14px;width:100%;margin:auto}
    th,td{text-align:center;vertical-align:middle}
    th{background:#f8f9fa;color:#000}
    td.invalid{background:#fde2e1!important}
    .highlight{background:#d4edda!important;transition:background-color 1s ease}
    .hidden-col{display:none!important}

    .sticky-header{background:#f8f9fa;padding-top:10px}
    #evaluationsTableWrapper thead th{position:sticky;top:0;z-index:9;background:#f8f9fa;color:#000}
    #evaluationsTableWrapper th.date-col,#evaluationsTableWrapper td.date-col{direction:ltr;text-align:center;width:140px;max-width:140px}

    /* Ø£Ø­Ø¬Ø§Ù… Ø§Ù„Ø£Ø¹Ù…Ø¯Ø©  */
    th.w-wide, td.w-wide{min-width:200px}
    th.w-narrow, td.w-narrow{min-width:70px;max-width:90px}
    td.w-narrow input{padding:.125rem .25rem}

    .toast-container{position:fixed;top:20px;left:50%;transform:translateX(-50%);z-index:2000}
    #completionRateContainer,#selectedVisitsContainer,#termBadge{text-align:center;font-weight:bold;margin:5px 0;font-size:16px;min-height:24px}
    #termBadge .badge{font-size:.95rem}

    .filters{margin-bottom:12px;width:99%;margin-left:auto;margin-right:auto}

    .mini-toolbar{display:flex;gap:.25rem;margin-bottom:.5rem;flex-wrap:wrap}
    .mini-toolbar button{border:1px solid #ced4da;background:#f8f9fa;padding:.25rem .5rem;border-radius:.375rem}
    .mini-editor{border:1px solid #ced4da;border-radius:.5rem;padding:.5rem;min-height:180px;background:#fff}
    .muted{color:#6c757d}

    /* Ø´Ø±ÙŠØ· Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª */
    .bulk-bar{display:flex;gap:.5rem;flex-wrap:wrap;align-items:center;justify-content:flex-start}
    .bulk-title{font-weight:700;margin-inline-end:.25rem}
    .form-switch .form-check-input{cursor:pointer}

    /* ØªÙ…ÙŠÙŠØ² Ø§Ù„ØµÙ Ø§Ù„Ø¬Ø¯ÙŠØ¯ Ù…Ø¤Ù‚ØªÙ‹Ø§ */
    tr.is-new{background:#e9f7ff}
  </style>
</head>
<body>
  <div class="container">
    <!-- Header (Ø£Ù†Ø²Ù„Ù†Ø§Ù‡ Ù‚Ù„ÙŠÙ„Ù‹Ø§ ÙˆØ£Ø¶ÙÙ†Ø§ mb-4 Ù„ØªØ¨Ø§Ø¹Ø¯ Ø£ÙƒØ¨Ø± Ù…Ø«Ù„ ØµÙØ­Ø© Ø§Ù„Ù…Ø¯Ù‚Ù‚ÙŠÙ†) -->
    <div class="d-flex flex-wrap justify-content-between align-items-center mb-4 gap-2">
      <h4 class="mb-0">Ø¥Ø¯Ø§Ø±Ø© ØªÙ‚ÙŠÙŠÙ… Ø§Ù„Ù„Ø¬Ø§Ù†</h4>
      <div class="d-flex align-items-center gap-2">
        <span id="userInfo" class="user-chip badge bg-light text-dark border">
          <i class="bi bi-person"></i>
          <span id="userUsername">â€”</span>
          <span class="mx-1">â€”</span>
          <span id="userFullName">â€”</span>
          <span class="ms-2 badge bg-secondary" id="userRole">â€”</span>
        </span>
        <a class="btn btn-outline-primary" id="homeBtn" href="/committees-home.html">
          <i class="bi bi-grid"></i> Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ…
        </a>
        <button id="logoutBtn" class="btn btn-danger">
          <i class="bi bi-box-arrow-right"></i> Ø®Ø±ÙˆØ¬
        </button>
      </div>
    </div>

    <div class="sticky-header">
      <!-- ÙÙ„Ø§ØªØ± -->
      <div class="filters row">
        <div class="col-md-3 mb-2">
          <label class="form-label">Ø§Ù„ÙƒÙ„ÙŠØ©</label>
          <select id="collegeFilter" class="form-select">
            <option value="">Ø¬Ù…ÙŠØ¹ Ø§Ù„ÙƒÙ„ÙŠØ§Øª</option>
          </select>
        </div>
        <div class="col-md-3 mb-2">
          <label class="form-label">Ø§Ø³Ù… Ø§Ù„Ù…Ø¯Ù‚Ù‚</label>
          <select id="auditorFilter" class="form-select">
            <option value="">Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù…Ø¯Ù‚Ù‚ÙŠÙ†</option>
          </select>
        </div>
        <div class="col-md-3 mb-2">
          <label class="form-label">Ø¨Ø­Ø« Ø¨Ø§Ø³Ù… Ø§Ù„Ù„Ø¬Ù†Ø©</label>
          <input type="text" id="committeeSearch" class="form-control" placeholder="Ø§ÙƒØªØ¨ Ù„Ù„Ø¨Ø­Ø«...">
        </div>
        <div class="col-md-3 mb-2"><!-- Ø®Ø§Ù†Ø© Ø§Ø­ØªÙŠØ§Ø·/Ù…ÙˆØ§Ø²Ù†Ø© --></div>
      </div>

      <!-- Ù…Ø¬Ù…ÙˆØ¹Ø© Ø§Ù„Ø²ÙŠØ§Ø±Ø§Øª/Ø§Ù„Ø£Ø¹Ù…Ø¯Ø©/Ø§Ù„ÙØµÙ„/Ø§Ù„Ø¹Ø§Ù… (Admin ÙÙ‚Ø·) -->
      <div class="card mb-3 d-none" id="visitsCard">
        <div class="card-body d-flex flex-wrap justify-content-center gap-3">
          <div class="form-check"><input class="form-check-input visit-toggle" type="checkbox" id="visit1" value="Ø§Ù„Ø²ÙŠØ§Ø±Ø© Ø§Ù„Ø£ÙˆÙ„Ù‰"><label class="form-check-label" for="visit1">Ø§Ù„Ø²ÙŠØ§Ø±Ø© Ø§Ù„Ø£ÙˆÙ„Ù‰</label></div>
          <div class="form-check"><input class="form-check-input visit-toggle" type="checkbox" id="visit2" value="Ø§Ù„Ø²ÙŠØ§Ø±Ø© Ø§Ù„Ø«Ø§Ù†ÙŠØ©"><label class="form-check-label" for="visit2">Ø§Ù„Ø²ÙŠØ§Ø±Ø© Ø§Ù„Ø«Ø§Ù†ÙŠØ©</label></div>
          <div class="form-check"><input class="form-check-input visit-toggle" type="checkbox" id="visit3" value="Ø§Ù„Ø²ÙŠØ§Ø±Ø© Ø§Ù„Ø«Ø§Ù„Ø«Ø©"><label class="form-check-label" for="visit3">Ø§Ù„Ø²ÙŠØ§Ø±Ø© Ø§Ù„Ø«Ø§Ù„Ø«Ø©</label></div>
          <div class="form-check"><input class="form-check-input visit-toggle" type="checkbox" id="visit4" value="Ø§Ù„Ø²ÙŠØ§Ø±Ø© Ø§Ù„Ø±Ø§Ø¨Ø¹Ø©"><label class="form-check-label" for="visit4">Ø§Ù„Ø²ÙŠØ§Ø±Ø© Ø§Ù„Ø±Ø§Ø¨Ø¹Ø©</label></div>
          <div class="form-check"><input class="form-check-input visit-toggle" type="checkbox" id="visit5" value="Ø§Ù„Ø²ÙŠØ§Ø±Ø© Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠØ©"><label class="form-check-label" for="visit5">Ø§Ù„Ø²ÙŠØ§Ø±Ø© Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠØ©</label></div>
          <button class="btn btn-sm btn-success" id="saveSettingsBtn" title="Ø­ÙØ¸ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª">ğŸ’¾</button>
        </div>
      </div>

      <div class="card mb-3 d-none" id="termCard">
        <div class="card-body row g-3 align-items-end">
          <div class="col-md-4">
            <label class="form-label">Ø§Ù„ÙØµÙ„</label>
            <select id="termSelect" class="form-select">
              <option value="">â€” Ø§Ø®ØªØ± Ø§Ù„ÙØµÙ„ â€”</option>
              <option value="Ø§Ù„ÙØµÙ„ Ø§Ù„Ø£ÙˆÙ„">Ø§Ù„ÙØµÙ„ Ø§Ù„Ø£ÙˆÙ„</option>
              <option value="Ø§Ù„ÙØµÙ„ Ø§Ù„Ø«Ø§Ù†ÙŠ">Ø§Ù„ÙØµÙ„ Ø§Ù„Ø«Ø§Ù†ÙŠ</option>
              <option value="Ø§Ù„ÙØµÙ„ Ø§Ù„ØµÙŠÙÙŠ">Ø§Ù„ÙØµÙ„ Ø§Ù„ØµÙŠÙÙŠ</option>
            </select>
          </div>
          <div class="col-md-4">
            <label class="form-label">Ø§Ù„Ø¹Ø§Ù… Ø§Ù„Ø¬Ø§Ù…Ø¹ÙŠ</label>
            <input type="text" id="academicYearInput" class="form-control" placeholder="Ù…Ø«Ø§Ù„: 2024-2025 Ø£Ùˆ 2024/2025">
          </div>
          <div class="col-md-4">
            <button class="btn btn-primary w-100" id="saveTermBtn">Ø­ÙØ¸ Ø§Ù„ÙØµÙ„/Ø§Ù„Ø¹Ø§Ù…</button>
          </div>
        </div>
      </div>

      <div class="card mb-2 d-none" id="columnsCard">
        <div class="card-body d-flex flex-wrap justify-content-center gap-3 align-items-center" id="columnToggles">
          <div class="form-check"><input class="form-check-input col-toggle" type="checkbox" data-field="formation_decision" checked><label class="form-check-label">Ù‚Ø±Ø§Ø± Ø§Ù„ØªØ´ÙƒÙŠÙ„</label></div>
          <div class="form-check"><input class="form-check-input col-toggle" type="checkbox" data-field="work_plan" checked><label class="form-check-label">Ø®Ø·Ø© Ø§Ù„Ø¹Ù…Ù„</label></div>
          <div class="form-check"><input class="form-check-input col-toggle" type="checkbox" data-field="performance_indicators" checked><label class="form-check-label">Ù…Ø¤Ø´Ø±Ø§Øª Ø§Ù„Ø£Ø¯Ø§Ø¡</label></div>
          <div class="form-check"><input class="form-check-input col-toggle" type="checkbox" data-field="meetings" checked><label class="form-check-label">Ø¹Ø¯Ø¯ Ø§Ù„Ø§Ø¬ØªÙ…Ø§Ø¹Ø§Øª</label></div>
          <div class="form-check"><input class="form-check-input col-toggle" type="checkbox" data-field="consistency" checked><label class="form-check-label">Ø§Ù„ØªÙˆØ§ÙÙ‚ Ø¨ÙŠÙ† Ø§Ù„Ø¯Ø¹ÙˆØ§Øª ÙˆØ§Ù„Ø§Ø¬ØªÙ…Ø§Ø¹Ø§Øª</label></div>
          <div class="form-check"><input class="form-check-input col-toggle" type="checkbox" data-field="coverage_books" checked><label class="form-check-label">ÙƒØªØ¨ Ø§Ù„ØªØºØ·ÙŠØ©</label></div>
          <div class="form-check"><input class="form-check-input col-toggle" type="checkbox" data-field="report1" checked><label class="form-check-label">ØªÙ‚Ø±ÙŠØ± Ø¥Ù†Ø¬Ø§Ø² 1</label></div>
          <div class="form-check"><input class="form-check-input col-toggle" type="checkbox" data-field="report2" checked><label class="form-check-label">ØªÙ‚Ø±ÙŠØ± Ø¥Ù†Ø¬Ø§Ø² 2</label></div>
          <div class="form-check"><input class="form-check-input col-toggle" type="checkbox" data-field="report3" checked><label class="form-check-label">ØªÙ‚Ø±ÙŠØ± Ø¥Ù†Ø¬Ø§Ø² 3</label></div>
          <div class="form-check"><input class="form-check-input col-toggle" type="checkbox" data-field="statistical_analysis" checked><label class="form-check-label">Ø§Ù„ØªØ­Ù„ÙŠÙ„ Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠ</label></div>
        </div>
      </div>

      <!-- Ø´Ø§Ø±Ø© Ø§Ù„ÙØµÙ„/Ø§Ù„Ø¹Ø§Ù… -->
      <div id="termBadge"></div>
      <!-- Ù†Øµ Ø§Ù„Ø²ÙŠØ§Ø±Ø§Øª ÙŠØ¸Ù‡Ø± Ù‡Ù†Ø§ -->
      <div id="selectedVisitsContainer"></div>
      <!-- Ù†Ø³Ø¨Ø© Ø§Ù„Ø§ÙƒØªÙ…Ø§Ù„ -->
      <div id="completionRateContainer"></div>

      <!-- Ø´Ø±ÙŠØ· Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª -->
      <div class="card p-2 mb-2">
        <div class="bulk-bar">
          <span class="bulk-title">Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª Ø³Ø±ÙŠØ¹Ø©</span>
          <button class="btn btn-sm btn-primary" id="addRowBtn" title="Ø¥Ø¶Ø§ÙØ© Ø³Ø¬Ù„ Ø¬Ø¯ÙŠØ¯">â• Ø¥Ø¶Ø§ÙØ© Ø³Ø¬Ù„</button>
          <button class="btn btn-sm btn-success" id="saveAllBtn" title="Ø­ÙØ¸ Ø¬Ù…ÙŠØ¹ Ø§Ù„ØµÙÙˆÙ Ø§Ù„Ù…Ø¹Ø¯Ù„Ø©">ğŸ’¾ Ø­ÙØ¸ Ø§Ù„ÙƒÙ„</button>
          <button class="btn btn-sm btn-outline-secondary" id="reloadBtn">ØªØ­Ø¯ÙŠØ«</button>
        </div>
      </div>
    </div>

    <!-- Ø¬Ø¯ÙˆÙ„ -->
    <table class="table table-bordered table-striped table-responsive" id="evaluationsTableWrapper">
      <thead>
        <tr>
          <th>#</th>
          <th class="w-wide">Ø§Ù„ÙƒÙ„ÙŠØ©</th>
          <th class="w-wide">Ø§Ø³Ù… Ø§Ù„Ù„Ø¬Ù†Ø©</th>
          <th class="w-wide">Ø§Ø³Ù… Ø§Ù„Ù…Ø¯Ù‚Ù‚</th>
          <th class="date-col">ØªØ§Ø±ÙŠØ® Ø§Ù„ØªØ¯Ù‚ÙŠÙ‚</th>

          <th class="col-formation_decision w-narrow">Ù‚Ø±Ø§Ø± Ø§Ù„ØªØ´ÙƒÙŠÙ„</th>
          <th class="col-work_plan w-narrow">Ø®Ø·Ø© Ø§Ù„Ø¹Ù…Ù„</th>
          <th class="col-performance_indicators w-narrow">Ù…Ø¤Ø´Ø±Ø§Øª Ø§Ù„Ø£Ø¯Ø§Ø¡</th>
          <th class="col-meetings w-narrow">Ø¹Ø¯Ø¯ Ø§Ù„Ø§Ø¬ØªÙ…Ø§Ø¹Ø§Øª</th>
          <th class="col-consistency w-narrow">Ø§Ù„ØªÙˆØ§ÙÙ‚ Ø¨ÙŠÙ† Ø§Ù„Ø¯Ø¹ÙˆØ§Øª ÙˆØ§Ù„Ø§Ø¬ØªÙ…Ø§Ø¹Ø§Øª</th>
          <th class="col-coverage_books w-narrow">ÙƒØªØ¨ Ø§Ù„ØªØºØ·ÙŠØ©</th>
          <th class="col-report1 w-narrow">ØªÙ‚Ø±ÙŠØ± Ø¥Ù†Ø¬Ø§Ø² 1</th>
          <th class="col-report2 w-narrow">ØªÙ‚Ø±ÙŠØ± Ø¥Ù†Ø¬Ø§Ø² 2</th>
          <th class="col-report3 w-narrow">ØªÙ‚Ø±ÙŠØ± Ø¥Ù†Ø¬Ø§Ø² 3</th>
          <th class="col-statistical_analysis w-narrow">Ø§Ù„ØªØ­Ù„ÙŠÙ„ Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠ</th>

          <th id="availabilityHeader" class="w-narrow">Ø¯Ø±Ø¬Ø© Ø§Ù„ØªÙˆÙØ± Ù…Ù† (9)</th>
          <th class="w-wide">Ø§Ù„Ù…Ù„Ø§Ø­Ø¸Ø§Øª</th>
          <th class="w-narrow">Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª</th>
        </tr>
      </thead>
      <tbody id="committeesTable">
        <tr><td colspan="18" class="text-center">Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...</td></tr>
      </tbody>
    </table>
  </div>

  <!-- datalist/Ù…ØµØ§Ø¯Ø± -->
  <datalist id="dl_colleges"></datalist>
  <datalist id="dl_committees"></datalist>
  <datalist id="dl_auditors"></datalist>

  <!-- Ù…ÙˆØ¯Ø§Ù„ Ù…ÙˆØ­Ù‘Ø¯: ØªÙØ§ØµÙŠÙ„ + Ù…Ù„Ø§Ø­Ø¸Ø§Øª -->
  <div class="modal fade" id="editUnifiedModal" tabindex="-1">
    <div class="modal-dialog modal-xl"><div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„ØªÙ‚ÙŠÙŠÙ… ÙˆØ§Ù„Ù…Ù„Ø§Ø­Ø¸Ø§Øª</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <!-- Ù‚Ø³Ù… ØªÙØ§ØµÙŠÙ„ Ø§Ù„ØªÙ‚ÙŠÙŠÙ… -->
        <div class="row g-3 mb-3">
          <div class="col-md-4">
            <label class="form-label">Ø§Ù„ÙƒÙ„ÙŠØ©</label>
            <select id="er_college" class="form-select"></select>
          </div>
          <div class="col-md-4">
            <label class="form-label">Ø§Ø³Ù… Ø§Ù„Ù„Ø¬Ù†Ø©</label>
            <select id="er_committee" class="form-select"></select>
          </div>
          <div class="col-md-4">
            <label class="form-label">Ø§Ø³Ù… Ø§Ù„Ù…Ø¯Ù‚Ù‚</label>
            <select id="er_auditor" class="form-select"></select>
          </div>
          <div class="col-md-4">
            <label class="form-label">ØªØ§Ø±ÙŠØ® Ø§Ù„ØªØ¯Ù‚ÙŠÙ‚</label>
            <input type="date" id="er_date" class="form-control">
          </div>
        </div>

        <hr class="my-2">

        <!-- Ù‚Ø³Ù… Ø§Ù„Ù…Ù„Ø§Ø­Ø¸Ø§Øª -->
        <h6 class="mb-2">ğŸ“ Ø§Ù„Ù…Ù„Ø§Ø­Ø¸Ø§Øª</h6>
        <div id="viewNotes" class="mb-2"></div>
        <div class="mini-toolbar">
          <button type="button" data-cmd="bold"><b>B</b></button>
          <button type="button" data-cmd="italic"><i>I</i></button>
          <button type="button" data-cmd="underline"><u>U</u></button>
          <button type="button" data-cmd="insertUnorderedList">â€¢ Ù‚Ø§Ø¦Ù…Ø©</button>
        </div>
        <div id="er_editor" class="mini-editor" contenteditable="true"></div>
      </div>
      <div class="modal-footer">
        <button class="btn btn-primary" id="saveUnifiedBtn">ğŸ’¾ Ø­ÙØ¸</button>
        <button class="btn btn-secondary" data-bs-dismiss="modal">Ø¥ØºÙ„Ø§Ù‚</button>
      </div>
    </div></div>
  </div>

  <!-- Toasts -->
  <div class="toast-container">
    <div id="toastSuccess" class="toast align-items-center text-bg-success border-0 mb-2" role="alert">
      <div class="d-flex"><div class="toast-body">âœ… Ø§Ù„Ø¹Ù…Ù„ÙŠØ© Ù†Ø¬Ø­Øª</div><button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button></div>
    </div>
    <div id="toastError" class="toast align-items-center text-bg-danger border-0 mb-2" role="alert">
      <div class="d-flex"><div class="toast-body">âŒ Ø­Ø¯Ø« Ø®Ø·Ø£</div><button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button></div>
    </div>
    <div id="toastConfirm" class="toast align-items-center text-bg-warning border-0 mb-2" role="alert">
      <div class="d-flex">
        <div class="toast-body" id="toastConfirmMsg">âš ï¸ Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ØŸ</div>
        <div class="me-2 m-auto">
          <button type="button" class="btn btn-sm btn-danger" id="confirmYes">Ù†Ø¹Ù…</button>
          <button type="button" class="btn btn-sm btn-secondary" data-bs-dismiss="toast">Ø¥Ù„ØºØ§Ø¡</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Scripts -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
  <script>
    /* ====== Ø¨ÙŠØ¦Ø© Ù…ÙˆØ­Ù‘Ø¯Ø© ====== */
    const RENDER_BASE='https://vdash-qkyv.onrender.com';
    const host=location.hostname;
    const isGithub=host.endsWith('github.io');
    const isLocal=host==='localhost'||host==='127.0.0.1';
    const API_BASE=isGithub?RENDER_BASE:(isLocal?'http://localhost:3000':'');
    const go=(path)=>isGithub?(RENDER_BASE+path):path;

    const toastSuccess=new bootstrap.Toast(document.getElementById('toastSuccess'));
    const toastError  =new bootstrap.Toast(document.getElementById('toastError'));
    const toastConfirmEl=document.getElementById('toastConfirm');
    const toastConfirm=new bootstrap.Toast(toastConfirmEl);
    let confirmCallback=null;

    function showSuccess(msg="âœ… Ø§Ù„Ø¹Ù…Ù„ÙŠØ© Ù†Ø¬Ø­Øª"){document.querySelector("#toastSuccess .toast-body").innerText=msg;toastSuccess.show()}
    function showError(msg="âŒ Ø­Ø¯Ø« Ø®Ø·Ø£"){document.querySelector("#toastError .toast-body").innerText=msg;toastError.show()}
    function showConfirm(msg,cb){document.getElementById("toastConfirmMsg").innerText=msg;confirmCallback=cb;toastConfirm.show()}
    document.getElementById("confirmYes").addEventListener("click",()=>{toastConfirm.hide();if(confirmCallback)confirmCallback()})
    const apiFetch=(path,opts={})=>fetch(`${API_BASE}${path}`,{credentials:'include',...opts});

    /* ====== Ø´Ø§Ø±Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… + ØµÙ„Ø§Ø­ÙŠØ§Øª ====== */
    let CURRENT_USER=null;
    function renderUser(u){
      const username=u?.username||(u?.email?u.email.split('@')[0]:'â€”');
      document.getElementById('userUsername').textContent=username;
      document.getElementById('userFullName').textContent=u?.name||'â€”';
      document.getElementById('userRole').textContent=u?.role||'â€”';
    }
    async function ensureAuth(){
      try{
        const r=await apiFetch('/auth/committees/me');
        const j=await r.json();
        if(!j?.authenticated){
          location.href=go('/committees-login.html?next='+encodeURIComponent('/manage_committees.html'));throw 0;
        }
        if(j.user?.isActive===false){
          showError('ğŸš« Ø­Ø³Ø§Ø¨Ùƒ Ù…Ø¹Ø·Ù‘Ù„. Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø§Ù„ØªÙˆØ§ØµÙ„ Ù…Ø¹ Ø§Ù„Ù…Ø´Ø±Ù.');
          setTimeout(()=>location.href=go('/committees-home.html'),1200);throw 0;
        }
        CURRENT_USER=j.user;renderUser(j.user);
        const isAdmin=(j.user?.role||'').toLowerCase()==='admin';
        document.getElementById('visitsCard').classList.toggle('d-none',!isAdmin);
        document.getElementById('columnsCard').classList.toggle('d-none',!isAdmin);
        document.getElementById('termCard').classList.toggle('d-none',!isAdmin);
      }catch{throw 0;}
    }
    document.getElementById('homeBtn').href=go('/committees-home.html');
    document.getElementById('logoutBtn').addEventListener('click',async()=>{
      try{
        const r=await apiFetch('/auth/committees/logout',{method:'POST',headers:{'Content-Type':'application/json'}});
        if(r.ok){showSuccess('âœ… ØªÙ… ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬');setTimeout(()=>location.href=go('/committees-login.html'),700)}
        else{showError('âŒ ØªØ¹Ø°Ø± ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬')}
      }catch{showError('âŒ Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø§ØªØµØ§Ù„')}
    });

    /* ====== Ø£Ø¯ÙˆØ§Øª Ù…Ø³Ø§Ø¹Ø¯Ø© Ù„Ù„Ù‚ÙˆØ§Ø¦Ù… ====== */
    function normalizeName(item){
      if(typeof item==='string')return item;
      return item?.name??item?.committee_name??item?.college??item?.auditor_name??'';
    }
    function fillSelect(sel,arr,placeholder='â€” Ø§Ø®ØªØ± â€”'){
      sel.innerHTML=`<option value="">${placeholder}</option>`;
      (arr||[]).forEach(v=>{const val=normalizeName(v);if(!val)return;const o=document.createElement('option');o.value=o.textContent=val;sel.appendChild(o);});
    }
    function buildSelect(optionsArray,current,field){
      const sel=document.createElement('select');
      sel.className='form-select form-select-sm';
      sel.dataset.field=field;
      const opts=(optionsArray||[]).map(normalizeName).filter(Boolean);
      const set=new Set(opts);
      if(current && !set.has(current)) set.add(current);
      sel.innerHTML=`<option value=""></option>`+Array.from(set).map(v=>`<option value="${v}"${v===current?' selected':''}>${v}</option>`).join('');
      if(current) sel.value=current;
      return sel;
    }

    /* ====== Ù…ØµØ§Ø¯Ø± (Ù‚ÙˆØ§Ø¦Ù…) ====== */
    let LIST_COLLEGES=[],LIST_AUDITORS=[],LIST_COMMITTEES=[];
    async function loadDatalists(){
      try{
        const [cR,aR,mR]=await Promise.all([
          apiFetch('/api/colleges'),
          apiFetch('/api/auditors'),
          apiFetch('/api/committee-names?q=').catch(()=>apiFetch('/api/committees-master'))
        ]);
        LIST_COLLEGES=await cR.json().catch(()=>[]);
        LIST_AUDITORS=await aR.json().catch(()=>[]);
        LIST_COMMITTEES=await mR.json().catch(()=>[]);

        const collegeFilter=document.getElementById('collegeFilter');
        const auditorFilter=document.getElementById('auditorFilter');
        (LIST_COLLEGES||[]).forEach(c=>{const n=normalizeName(c);if(!n)return;const opt=document.createElement('option');opt.value=n;opt.textContent=n;collegeFilter.appendChild(opt);});
        (LIST_AUDITORS||[]).forEach(a=>{const n=normalizeName(a);if(!n)return;const opt=document.createElement('option');opt.value=n;opt.textContent=n;auditorFilter.appendChild(opt);});

        fillSelect(document.getElementById('er_college'),LIST_COLLEGES,'â€” Ø§Ù„ÙƒÙ„ÙŠØ© â€”');
        fillSelect(document.getElementById('er_committee'),LIST_COMMITTEES,'â€” Ø§Ø³Ù… Ø§Ù„Ù„Ø¬Ù†Ø© â€”');
        fillSelect(document.getElementById('er_auditor'),LIST_AUDITORS,'â€” Ø§Ø³Ù… Ø§Ù„Ù…Ø¯Ù‚Ù‚ â€”');
      }catch(e){console.warn('datalist load error',e);}
    }

    /* ====== Mini Editor ====== */
    document.addEventListener('click',(e)=>{
      const btn=e.target.closest('[data-cmd]'); if(!btn) return;
      const cmd=btn.getAttribute('data-cmd'); document.execCommand(cmd,false,null);
      const mm=document.getElementById('er_editor'); if(mm) mm.focus();
    });
    function stripHtml(html){const tmp=document.createElement('div');tmp.innerHTML=html;return (tmp.textContent||tmp.innerText||'').trim();}

    /* ====== Ø§Ù„Ø­Ù‚ÙˆÙ„ Ø§Ù„Ø¹Ø¯Ø¯ÙŠØ© ====== */
    const NUMERIC_FIELDS=["formation_decision","work_plan","performance_indicators","meetings","consistency","coverage_books","report1","report2","report3","statistical_analysis"];
    function getVisibleNumericFields(){
      return NUMERIC_FIELDS.filter(f=>{
        const th=document.querySelector(`th.col-${f}`);
        return th && !th.classList.contains('hidden-col');
      });
    }
    function clamp01(val){
      let v=Number(String(val).replace(',', '.'));
      if(isNaN(v)) return null;
      if(v<0) v=0; if(v>1) v=1;
      return Math.round(v*100)/100;
    }

    function updateAvailabilityHeader(){
      const n=getVisibleNumericFields().length;
      document.getElementById("availabilityHeader").innerText=`Ø¯Ø±Ø¬Ø© Ø§Ù„ØªÙˆÙØ± Ù…Ù† (${n})`;
    }
    function updateAvailability(row){
      const fields=getVisibleNumericFields();
      let sum=0;
      fields.forEach(f=>{
        const cell=row.querySelector(`[data-field="${f}"]`);
        if(!cell) return;
        const v=parseFloat((cell.querySelector('input')?.value ?? cell.innerText ?? '').toString().replace(',', '.'));
        if(!isNaN(v)) sum+=v;
      });
      const availabilityCell=row.querySelector(".availability-cell");
      if(availabilityCell){
        availabilityCell.innerText=(Math.round(sum*100)/100).toFixed(2);
        availabilityCell.classList.add("highlight");
        setTimeout(()=>availabilityCell.classList.remove("highlight"),800);
      }
    }
    function recalcAllAvailability(){
      document.querySelectorAll('#committeesTable tr').forEach(updateAvailability);
    }
    function updateCompletionRate(){
      const rows=document.querySelectorAll('#committeesTable tr');
      let totalAvailability=0,numCommittees=0;
      rows.forEach(row=>{
        if(row.style.display==='none') return;
        const availabilityCell=row.querySelector('.availability-cell');
        if(availabilityCell){ totalAvailability+=parseFloat(availabilityCell.innerText)||0; numCommittees++; }
      });
      const denominator=numCommittees * getVisibleNumericFields().length;
      const pct=denominator>0 ? ((totalAvailability/denominator)*100).toFixed(2) : '0.00';
      const lastCollege=document.getElementById('collegeFilter').value || 'Ø¬Ù…ÙŠØ¹ Ø§Ù„ÙƒÙ„ÙŠØ§Øª';
      document.getElementById("completionRateContainer").innerHTML=`ğŸ“Œ Ù†Ø³Ø¨Ø© Ø§Ù„Ø§ÙƒØªÙ…Ø§Ù„ Ù„Ù€ <b>${lastCollege}</b> = ${pct}% â€” <span class="muted">Ø¹Ø¯Ø¯ Ø§Ù„Ù„Ø¬Ø§Ù†: ${numCommittees}</span>`;
    }

    /* ====== Ø¥Ø¸Ù‡Ø§Ø±/Ø¥Ø®ÙØ§Ø¡ Ø§Ù„Ø£Ø¹Ù…Ø¯Ø© ====== */
    function applyColumnVisibilityInstant(){
      document.querySelectorAll('.col-toggle').forEach(cb=>{
        const field=cb.dataset.field; const show=cb.checked;
        document.querySelectorAll(`th.col-${field}`).forEach(el=>el.classList.toggle('hidden-col',!show));
        document.querySelectorAll(`#committeesTable td[data-field="${field}"]`).forEach(el=>el.classList.toggle('hidden-col',!show));
      });
      updateAvailabilityHeader();
      recalcAllAvailability();
      updateCompletionRate();
    }
    document.getElementById('columnsCard')?.addEventListener('change',(e)=>{
      if(e.target.classList.contains('col-toggle')) applyColumnVisibilityInstant();
    });

    /* ====== ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª + Ø´Ø§Ø±Ø© Ø§Ù„ÙØµÙ„/Ø§Ù„Ø¹Ø§Ù… ====== */
    async function loadSettings(){
      try{
        const res=await apiFetch('/api/settings'); const settings=await res.json();

        // Ø²ÙŠØ§Ø±Ø§Øª
        if(settings?.selectedVisits){
          document.querySelectorAll('.visit-toggle').forEach(cb=>{cb.checked=settings.selectedVisits.includes(cb.value)});
        }

        // Ø­Ø§Ù„Ø© Ø§Ù„Ø£Ø¹Ù…Ø¯Ø©
        if(Array.isArray(settings?.visibleColumns) && settings.visibleColumns.length){
          document.querySelectorAll('.col-toggle').forEach(cb=>{cb.checked=settings.visibleColumns.includes(cb.dataset.field)});
        }
        applyColumnVisibilityInstant();

        // Ø§Ù„Ø´Ø§Ø±Ø©
        const term=settings?.term||''; const ay=settings?.academicYear||'';
        let html=''; if(term||ay){html=`<span class="badge text-bg-info">ğŸ“š Ø§Ù„ÙØµÙ„ Ø§Ù„Ø­Ø§Ù„ÙŠ: <b>${term||'â€”'}</b> â€” Ø§Ù„Ø¹Ø§Ù…: <b>${ay||'â€”'}</b></span>`;}
        document.getElementById('termBadge').innerHTML=html;

        // âœ… Ø¥Ø¸Ù‡Ø§Ø± Ù†Øµ Ø§Ù„Ø²ÙŠØ§Ø±Ø§Øª Ø£Ø¹Ù„Ù‰ Ù†Ø³Ø¨Ø© Ø§Ù„Ø§ÙƒØªÙ…Ø§Ù„ Ù‚Ø¨Ù„ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¬Ø¯ÙˆÙ„
        updateSelectedVisits();

      }catch(e){ /* ØªØ¬Ø§Ù‡Ù„ */ }
    }

    function updateSelectedVisits(){
      const selected=Array.from(document.querySelectorAll('.visit-toggle:checked')).map(cb=>cb.value);
      document.getElementById('selectedVisitsContainer').innerHTML=selected.length?("Ø§Ù„Ø²ÙŠØ§Ø±Ø§Øª: "+selected.join(' | ')):'';
    }

    // Ø­ÙØ¸ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª (Ø§Ù„Ø£Ø¹Ù…Ø¯Ø©/Ø§Ù„Ø²ÙŠØ§Ø±Ø§Øª)
    document.getElementById('saveSettingsBtn')?.addEventListener('click',async()=>{
      try{
        const visibleColumns=Array.from(document.querySelectorAll('.col-toggle:checked')).map(cb=>cb.getAttribute('data-field'));
        const selectedVisits=Array.from(document.querySelectorAll('.visit-toggle:checked')).map(cb=>cb.value);
        await axios.put(`${API_BASE}/api/settings`,{visibleColumns,selectedVisits},{withCredentials:true});
        showSuccess("âœ… ØªÙ… Ø­ÙØ¸ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø¨Ù†Ø¬Ø§Ø­");
        updateSelectedVisits();
        applyColumnVisibilityInstant();
      }catch(err){console.error(err);showError("âŒ Ø®Ø·Ø£ ÙÙŠ Ø­ÙØ¸ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª")}
    });

    // âœ… Ø²Ø± Ø­ÙØ¸ Ø§Ù„ÙØµÙ„/Ø§Ù„Ø¹Ø§Ù…
    document.getElementById('saveTermBtn')?.addEventListener('click', async ()=>{
      try{
        const term = document.getElementById('termSelect').value.trim();
        const academicYear = document.getElementById('academicYearInput').value.trim();
        const rx = /^(20\d{2})[\/-](20\d{2})$/;
        if(academicYear && !rx.test(academicYear)){
          showError('âš ï¸ ØµÙŠØºØ© Ø§Ù„Ø¹Ø§Ù… Ø§Ù„Ø¬Ø§Ù…Ø¹ÙŠ ÙŠØ¬Ø¨ Ø£Ù† ØªÙƒÙˆÙ† 2024-2025 Ø£Ùˆ 2024/2025');
          return;
        }
        const payload = { term, academicYear };
        const r = await axios.put(`${API_BASE}/api/settings`, payload, { withCredentials:true });
        const s = r.data || {};
        const t = s.term || term || 'â€”';
        const ay = s.academicYear || academicYear || 'â€”';
        document.getElementById('termBadge').innerHTML = `<span class="badge text-bg-info">ğŸ“š Ø§Ù„ÙØµÙ„ Ø§Ù„Ø­Ø§Ù„ÙŠ: <b>${t}</b> â€” Ø§Ù„Ø¹Ø§Ù…: <b>${ay}</b></span>`;
        showSuccess('âœ… ØªÙ… Ø­ÙØ¸ Ø§Ù„ÙØµÙ„/Ø§Ù„Ø¹Ø§Ù…');
      }catch(e){
        console.error(e);
        showError('âŒ Ø®Ø·Ø£ ÙÙŠ Ø­ÙØ¸ Ø§Ù„ÙØµÙ„/Ø§Ù„Ø¹Ø§Ù…');
      }
    });

    /* ====== Ø¥Ù†Ø´Ø§Ø¡ ØµÙ ====== */
    function buildRow(c,idx){
      const tr=document.createElement('tr');
      tr.dataset.id=c._id||'';
      if(c.__isNew) { tr.dataset.new="1"; tr.classList.add('is-new','table-info'); }

      const selCollege=buildSelect(LIST_COLLEGES,c.college,'college');
      const selCommittee=buildSelect(LIST_COMMITTEES,c.committee_name,'committee_name');
      const selAuditor=buildSelect(LIST_AUDITORS,c.auditor_name,'auditor_name');

      tr.innerHTML=`
        <td class="row-idx">${idx+1}</td>

        <td class="w-wide" data-field="college"></td>
        <td class="w-wide" data-field="committee_name"></td>
        <td class="w-wide" data-field="auditor_name"></td>

        <td class="date-col" data-field="audit_date">
          <input type="date" class="form-control form-control-sm" value="${c.audit_date ? c.audit_date.split('T')[0] : ''}">
        </td>

        <td class="w-narrow col-formation_decision" data-field="formation_decision"><input type="text" class="form-control form-control-sm" value="${c.formation_decision ?? 0}"></td>
        <td class="w-narrow col-work_plan" data-field="work_plan"><input type="text" class="form-control form-control-sm" value="${c.work_plan ?? 0}"></td>
        <td class="w-narrow col-performance_indicators" data-field="performance_indicators"><input type="text" class="form-control form-control-sm" value="${c.performance_indicators ?? 0}"></td>
        <td class="w-narrow col-meetings" data-field="meetings"><input type="text" class="form-control form-control-sm" value="${c.meetings ?? 0}"></td>
        <td class="w-narrow col-consistency" data-field="consistency"><input type="text" class="form-control form-control-sm" value="${c.consistency ?? 0}"></td>
        <td class="w-narrow col-coverage_books" data-field="coverage_books"><input type="text" class="form-control form-control-sm" value="${c.coverage_books ?? 0}"></td>
        <td class="w-narrow col-report1" data-field="report1"><input type="text" class="form-control form-control-sm" value="${c.report1 ?? 0}"></td>
        <td class="w-narrow col-report2" data-field="report2"><input type="text" class="form-control form-control-sm" value="${c.report2 ?? 0}"></td>
        <td class="w-narrow col-report3" data-field="report3"><input type="text" class="form-control form-control-sm" value="${c.report3 ?? 0}"></td>
        <td class="w-narrow col-statistical_analysis" data-field="statistical_analysis"><input type="text" class="form-control form-control-sm" value="${c.statistical_analysis ?? 0}"></td>

        <td class="availability-cell w-narrow">${c.availability_score ?? 0}</td>

        <td class="w-wide" data-field="notes">
          ${
            (c.notes && stripHtml(c.notes))
            ? `<button class="btn btn-sm btn-secondary btn-edit-open">Ø¹Ø±Ø¶ Ø§Ù„Ù…Ù„Ø§Ø­Ø¸Ø§Øª</button>`
            : `<span class="text-muted">Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ù„Ø§Ø­Ø¸Ø§Øª</span>`
          }
        </td>

        <td class="w-narrow">
          <div class="d-flex justify-content-center align-items-center gap-1">
            <button class="btn btn-sm btn-primary btn-edit-open" title="ØªØ¹Ø¯ÙŠÙ„"><i class="bi bi-pencil-square"></i></button>
            <button class="btn btn-sm btn-success save-row" title="Ø­ÙØ¸"><i class="bi bi-save"></i></button>
            <button class="btn btn-sm btn-danger delete-row" title="Ø­Ø°Ù"><i class="bi bi-trash"></i></button>
          </div>
        </td>
      `;

      tr.querySelector('[data-field="college"]').appendChild(selCollege);
      tr.querySelector('[data-field="committee_name"]').appendChild(selCommittee);
      tr.querySelector('[data-field="auditor_name"]').appendChild(selAuditor);

      tr.__notesHTML=c.notes||'';
      attachInputListeners(tr);
      updateAvailability(tr);
      return tr;
    }

    function renumberRows(){
      document.querySelectorAll('#committeesTable tr .row-idx').forEach((td,i)=>{td.textContent=i+1;});
    }

    function attachInputListeners(tr){
      const numericFieldsSet=new Set(NUMERIC_FIELDS);
      tr.querySelectorAll('[data-field] input').forEach(inp=>{
        const field=inp.closest('td').dataset.field;
        if(!numericFieldsSet.has(field) && field!=='audit_date') return;

        inp.addEventListener('input',()=>{
          if(numericFieldsSet.has(field)){
            const clamped=clamp01(inp.value);
            const invalid=(clamped===null);
            inp.classList.toggle('is-invalid',invalid);
            if(!invalid) inp.value=clamped;
            markRowChanged(tr);
            updateAvailability(tr);
            updateCompletionRate();
          }else{
            markRowChanged(tr);
          }
        });
      });
      tr.querySelectorAll('select,input[type="date"]').forEach(el=>{
        el.addEventListener('change',()=>{ markRowChanged(tr); if(el.type!=='date'){} });
      });
    }
    function markRowChanged(tr){tr.dataset.dirty="1";tr.classList.add('table-warning')}
    function clearRowChanged(tr){delete tr.dataset.dirty;tr.classList.remove('table-warning','is-new','table-info')}

    /* ====== Ø¥Ø¶Ø§ÙØ© Ø³Ø¬Ù„ Ø¬Ø¯ÙŠØ¯ ====== */
    document.getElementById('addRowBtn').addEventListener('click',()=>{
      const tbody=document.getElementById('committeesTable');
      const c={
        __isNew:true,
        college:'',
        committee_name:'',
        auditor_name:'',
        audit_date:'',
        formation_decision:0,work_plan:0,performance_indicators:0,meetings:0,consistency:0,
        coverage_books:0,report1:0,report2:0,report3:0,statistical_analysis:0,
        availability_score:0,notes:''
      };
      const tr=buildRow(c,0);
      tbody.prepend(tr);
      renumberRows();
      applyColumnVisibilityInstant();
      updateCompletionRate();
    });

    /* ====== ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø³Ø¬Ù„Ø§Øª ====== */
    async function loadCommittees(){
      try{
        const college=document.getElementById('collegeFilter').value;
        const auditor=document.getElementById('auditorFilter').value;
        let url='/api/committees';
        const params=[];
        if(college) params.push('college='+encodeURIComponent(college));
        if(auditor) params.push('auditor_name='+encodeURIComponent(auditor));
        if(params.length) url+='?'+params.join('&');

        const res=await apiFetch(url);
        const arr=await res.json();

        const tbody=document.getElementById('committeesTable');
        tbody.innerHTML='';

        if(!Array.isArray(arr)||arr.length===0){
          tbody.innerHTML=`<tr><td colspan="18" class="text-center">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª</td></tr>`;
          document.getElementById("completionRateContainer").innerHTML='';
          document.getElementById("selectedVisitsContainer").innerHTML='';
          return;
        }

        arr.sort((a,b)=>(a.college||'').localeCompare(b.college||'','ar') || (a.committee_name||'').localeCompare(b.committee_name||'','ar'));

        arr.forEach((c,idx)=>{ const tr=buildRow(c,idx); document.getElementById('committeesTable').appendChild(tr); });

        applyColumnVisibilityInstant();
        applyCommitteeSearch();
        updateCompletionRate();
        renumberRows();
      }catch(err){
        console.error(err);
        showError('âŒ ÙØ´Ù„ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª');
        const tbody=document.getElementById('committeesTable');
        tbody.innerHTML=`<tr><td colspan="18" class="text-center text-danger">ÙØ´Ù„ Ø§Ù„Ø¬Ù„Ø¨</td></tr>`;
      }
    }

    /* ====== Ø­ÙØ¸ ÙƒÙ„ Ø§Ù„Ù…Ø¹Ø¯Ù„ ====== */
    document.getElementById('saveAllBtn').addEventListener('click',async()=>{
      try{
        const rows=Array.from(document.querySelectorAll('#committeesTable tr.table-warning, #committeesTable tr.is-new'));
        if(!rows.length){showError('Ù„Ø§ ØªÙˆØ¬Ø¯ ØªØ¹Ø¯ÙŠÙ„Ø§Øª');return;}
        for(const tr of rows){
          const payload=collectRowData(tr);
          const date=payload.audit_date?.trim();
          if(date && !/^\d{4}-\d{2}-\d{2}$/.test(date)){showError('âš ï¸ ØµÙŠØºØ© Ø§Ù„ØªØ§Ø±ÙŠØ® ÙŠØ¬Ø¨ Ø£Ù† ØªÙƒÙˆÙ† YYYY-MM-DD');return;}
          if(tr.dataset.new==="1"){
            await axios.post(`${API_BASE}/api/committees`,payload,{withCredentials:true});
          }else{
            const id=tr.dataset.id;
            await axios.put(`${API_BASE}/api/committees/${id}`,payload,{withCredentials:true});
          }
        }
        showSuccess('âœ… ØªÙ… Ø­ÙØ¸ Ø¬Ù…ÙŠØ¹ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„Ø§Øª');
        await loadCommittees(); // Ù„Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„ÙØ±Ø² ÙˆÙˆØ¶Ø¹ Ø§Ù„Ø³Ø¬Ù„Ø§Øª Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø© ÙÙŠ Ø£Ù…Ø§ÙƒÙ†Ù‡Ø§
      }catch(e){console.error(e);showError('âŒ Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø­ÙØ¸ Ø§Ù„ÙƒÙ„');}
    });

    /* ====== Ø¨Ø­Ø« Ø¨Ø§Ø³Ù… Ø§Ù„Ù„Ø¬Ù†Ø© ====== */
    function applyCommitteeSearch(){
      const searchTerm=document.getElementById("committeeSearch").value.trim().toLowerCase();
      document.querySelectorAll("#committeesTable tr").forEach(row=>{
        const committee=row.querySelector('[data-field="committee_name"] select')?.value||'';
        row.style.display=committee.toLowerCase().includes(searchTerm)?'':'none';
      });
    }
    document.getElementById('committeeSearch').addEventListener('input',()=>{applyCommitteeSearch();updateCompletionRate();});
    document.getElementById('collegeFilter').addEventListener('change',loadCommittees);
    document.getElementById('auditorFilter').addEventListener('change',loadCommittees);
    document.getElementById('reloadBtn').addEventListener('click',loadCommittees);

    /* ====== Ù…ÙˆØ¯Ø§Ù„ Ù…ÙˆØ­Ù‘Ø¯: ÙØªØ­/Ø­ÙØ¸ ====== */
    let EDITING_ROW=null;
    function openUnifiedModal(tr){
      EDITING_ROW=tr;
      fillSelect(document.getElementById('er_college'),LIST_COLLEGES,'â€” Ø§Ù„ÙƒÙ„ÙŠØ© â€”');
      fillSelect(document.getElementById('er_committee'),LIST_COMMITTEES,'â€” Ø§Ø³Ù… Ø§Ù„Ù„Ø¬Ù†Ø© â€”');
      fillSelect(document.getElementById('er_auditor'),LIST_AUDITORS,'â€” Ø§Ø³Ù… Ø§Ù„Ù…Ø¯Ù‚Ù‚ â€”');

      document.getElementById('er_college').value   = tr.querySelector('[data-field="college"] select')?.value || '';
      document.getElementById('er_committee').value = tr.querySelector('[data-field="committee_name"] select')?.value || '';
      document.getElementById('er_auditor').value   = tr.querySelector('[data-field="auditor_name"] select')?.value || '';
      document.getElementById('er_date').value      = tr.querySelector('[data-field="audit_date"] input')?.value || '';

      const html=tr.__notesHTML||'';
      document.getElementById('viewNotes').innerHTML = html || '<i class="muted">Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ù„Ø§Ø­Ø¸Ø§Øª</i>';
      document.getElementById('er_editor').innerHTML = html || '';

      new bootstrap.Modal(document.getElementById('editUnifiedModal')).show();
    }
    document.getElementById('committeesTable').addEventListener('click',async(e)=>{
      const tr=e.target.closest('tr'); if(!tr) return;
      if(e.target.closest('.btn-edit-open')){ openUnifiedModal(tr); return; }

      const btnSave=e.target.closest('.save-row');
      const btnDelete=e.target.closest('.delete-row');

      if(btnSave){
        const payload=collectRowData(tr);
        const date=payload.audit_date?.trim();
        if(date && !/^\d{4}-\d{2}-\d{2}$/.test(date)){showError('âš ï¸ ØµÙŠØºØ© Ø§Ù„ØªØ§Ø±ÙŠØ® ÙŠØ¬Ø¨ Ø£Ù† ØªÙƒÙˆÙ† YYYY-MM-DD');return;}
        try{
          if(tr.dataset.new==="1"){
            await axios.post(`${API_BASE}/api/committees`,payload,{withCredentials:true});
          }else{
            const id=tr.dataset.id;
            await axios.put(`${API_BASE}/api/committees/${id}`,payload,{withCredentials:true});
          }
          showSuccess("âœ… ØªÙ… Ø­ÙØ¸ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„Ø§Øª");
          await loadCommittees(); // Ù„Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„ÙØ±Ø² ÙÙˆØ±Ù‹Ø§
        }catch(err){console.error(err);showError("âŒ Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„Ø­ÙØ¸");}
        return;
      }
      if(btnDelete){
        // Ø¥Ø°Ø§ ÙƒØ§Ù† ØµÙ Ø¬Ø¯ÙŠØ¯ ÙˆØºÙŠØ± Ù…Ø­ÙÙˆØ¸ Ø¨Ø¹Ø¯ØŒ Ù†Ø­Ø°ÙÙ‡ Ù…Ø­Ù„ÙŠÙ‹Ø§ ÙÙ‚Ø·
        if(tr.dataset.new==="1" && !tr.dataset.id){
          tr.remove(); renumberRows(); updateCompletionRate();
          return;
        }
        showConfirm("âš ï¸ Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø§Ù„Ø­Ø°ÙØŸ",async()=>{
          try{
            await axios.delete(`${API_BASE}/api/committees/${tr.dataset.id}`,{withCredentials:true});
            showSuccess("ğŸ—‘ï¸ ØªÙ… Ø­Ø°Ù Ø§Ù„Ø³Ø¬Ù„ Ø¨Ù†Ø¬Ø§Ø­");
            loadCommittees();
          }catch(err){console.error(err);showError("âŒ ÙØ´Ù„ Ø§Ù„Ø­Ø°Ù");}
        });
      }
    });

    document.getElementById('saveUnifiedBtn').addEventListener('click',()=>{
      if(!EDITING_ROW) return;
      EDITING_ROW.querySelector('[data-field="college"] select').value        = document.getElementById('er_college').value || '';
      EDITING_ROW.querySelector('[data-field="committee_name"] select').value = document.getElementById('er_committee').value || '';
      EDITING_ROW.querySelector('[data-field="auditor_name"] select').value   = document.getElementById('er_auditor').value || '';
      EDITING_ROW.querySelector('[data-field="audit_date"] input').value      = document.getElementById('er_date').value || '';

      const newHtml=document.getElementById('er_editor').innerHTML;
      EDITING_ROW.__notesHTML=newHtml||'';
      const notesCell=EDITING_ROW.querySelector('[data-field="notes"]');
      if(stripHtml(EDITING_ROW.__notesHTML)) notesCell.innerHTML='<button class="btn btn-sm btn-secondary btn-edit-open">Ø¹Ø±Ø¶ Ø§Ù„Ù…Ù„Ø§Ø­Ø¸Ø§Øª</button>';
      else notesCell.innerHTML='<span class="text-muted">Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ù„Ø§Ø­Ø¸Ø§Øª</span>';

      markRowChanged(EDITING_ROW);
      bootstrap.Modal.getInstance(document.getElementById('editUnifiedModal')).hide();
      showSuccess('ØªÙ… ØªØ­Ø¯ÙŠØ« Ø§Ù„ØµÙ (ØªØ­ØªØ§Ø¬ Ø­ÙØ¸ Ø§Ù„ØµÙ)');
    });

    /* ====== Ø¬Ù…Ø¹ Ø¨ÙŠØ§Ù†Ø§Øª ØµÙ ====== */
    function collectRowData(row){
      const data={};
      data.college=row.querySelector('[data-field="college"] select')?.value?.trim()||'';
      data.committee_name=row.querySelector('[data-field="committee_name"] select')?.value?.trim()||'';
      data.auditor_name=row.querySelector('[data-field="auditor_name"] select')?.value?.trim()||'';
      data.audit_date=row.querySelector('[data-field="audit_date"] input')?.value||'';

      NUMERIC_FIELDS.forEach(f=>{
        const inp=row.querySelector(`[data-field="${f}"] input`); if(!inp) return;
        const clamped=clamp01(inp.value);
        data[f]=(clamped===null)?0:clamped;
      });

      const availabilityCell=row.querySelector('.availability-cell');
      data.availability_score=parseFloat(availabilityCell?.innerText)||0;
      data.notes=row.__notesHTML||'';
      return data;
    }

    /* ====== Ø¨Ø¯Ø¡ Ø§Ù„ØªØ´ØºÙŠÙ„ ====== */
    (async function init(){
      try{
        await ensureAuth();
        document.getElementById('homeBtn').href=go('/committees-home.html');
        await loadDatalists();
        // âœ… Ø£ÙˆÙ„Ù‹Ø§: Ø­Ù…Ù„ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª ÙˆØ£Ø¸Ù‡Ø± Ø§Ù„Ø²ÙŠØ§Ø±Ø§ØªØŒ Ø«Ù… Ø­Ù…Ù„ Ø§Ù„Ø¬Ø¯ÙˆÙ„
        await loadSettings();
        await loadCommittees();
      }catch{}
    })();
  </script>
</body>
</html>
