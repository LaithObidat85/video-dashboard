<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <title>ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„ÙÙŠØ¯ÙŠÙˆÙ‡Ø§Øª</title>
  <link rel="icon" type="image/png" href="https://www.dropbox.com/scl/fi/f283e4rvv5cf9x12a1cic/my-website-logo.png?rlkey=yia776im7klypy27af32m0scy&e=1&st=vhaprvzh&dl=1">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.rtl.min.css">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css">
  <link href="https://cdn.quilljs.com/1.3.6/quill.snow.css" rel="stylesheet">
  <style>
    body { background-color: #f4f6f9; font-family: 'Segoe UI', sans-serif; font-size:16px; padding:20px; transition: background 0.3s, color 0.3s; }
    .video-card {
      background: white; border-radius: 12px; box-shadow: 0 2px 6px rgba(0,0,0,0.1);
      padding: 12px; margin: 5px; width: 300px; display: flex; flex-direction: column;
      transition: transform 0.2s ease, box-shadow 0.2s ease;
    }
    .video-card:hover { transform: scale(1.02); box-shadow: 0 4px 12px rgba(0,0,0,0.15); }
    .video-title { font-weight: bold; margin-bottom: 6px; min-height: 48px; overflow: hidden; display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; }
    .video-description { color: #0d6efd; cursor: pointer; min-height: 40px; overflow: hidden; display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; margin-bottom: 8px; }
    .video-grid { display: flex; flex-wrap: wrap; justify-content: center; gap: 15px; }
    video, iframe { width: 100%; height: 200px; border-radius: 6px; }
    .sharepoint-frame { width: 100%; height: 200px; border-radius: 6px; display: block; object-fit: cover; }
    .popout-button { background-color: #0d6efd; color: white; border: none; padding: 6px 12px; border-radius: 5px; cursor: pointer; margin-top: 6px; }
    .action-buttons { display: flex; justify-content: space-between; margin-top: 10px; }
    #editor { height: 200px; background: white; }
    .toast-container { position: fixed; top: 20px; left: 50%; transform: translateX(-50%); z-index: 9999; }

    /* Ø§Ù„ÙˆØ¶Ø¹ Ø§Ù„Ù„ÙŠÙ„ÙŠ */
    body.dark-mode { background-color: #121212; color: #eaeaea; }
    body.dark-mode .video-card { background: #1e1e1e; color: #ddd; }
    body.dark-mode .modal-content { background: #1e1e1e; color: #fff; }
    body.dark-mode .btn-close { filter: invert(1); }

    /* Ø´Ø§Ø´Ø© Ø§Ù„ØªØ­Ù…ÙŠÙ„ Ù…Ø¹ Fade */
    #loadingOverlay {
      position: fixed; top: 0; left: 0; width: 100%; height: 100%;
      background: rgba(0,0,0,0.5); display: flex;
      align-items: center; justify-content: center; flex-direction: column;
      z-index: 3000; color: #fff; font-size: 1.2rem;
      opacity: 0; visibility: hidden;
      transition: opacity 0.4s ease, visibility 0.4s ease;
    }
    #loadingOverlay.active { opacity: 1; visibility: visible; }

    #pageContent { display: none; }

    /* ØªØ­Ø³ÙŠÙ† Ø§Ù„ØªÙˆÙ„ØªÙŠØ¨ */
    .custom-tooltip.bs-tooltip-top {
      --bs-tooltip-bg: #0d6efd;
      --bs-tooltip-color: #fff;
      font-size: 0.85rem;
      padding: 6px 10px;
      border-radius: 8px;
      box-shadow: 0 2px 6px rgba(0,0,0,0.15);
    }
  </style>
</head>
<body>

<!-- Ø´Ø§Ø´Ø© Ø§Ù„ØªØ­Ù…ÙŠÙ„ -->
<div id="loadingOverlay" class="active">
  <div class="spinner-border text-light" role="status" style="width:3rem; height:3rem;"></div>
  <p class="mt-3" id="loadingText">Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...â³</p>
</div>

<div id="pageContent">
  <!-- Ø£Ø²Ø±Ø§Ø± Ø¹Ù„ÙˆÙŠØ© -->
  <div class="d-flex justify-content-between mb-3 mt-3">
    <div>
      <button id="logoutBtn" class="btn btn-danger me-2" data-bs-toggle="tooltip" title="ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬"><i class="bi bi-box-arrow-right"></i></button>
      <button id="dashboardBtn" class="btn btn-secondary" data-bs-toggle="tooltip" title="Ø§Ù„Ø¹ÙˆØ¯Ø© Ù„Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ…"><i class="bi bi-speedometer2"></i></button>
    </div>
    <div>
      <button id="themeToggle" class="btn btn-outline-dark" data-bs-toggle="tooltip" title="Ø§Ù„ÙˆØ¶Ø¹ Ø§Ù„Ù„ÙŠÙ„ÙŠ/Ø§Ù„Ù†Ù‡Ø§Ø±ÙŠ"><i class="bi bi-moon-stars-fill"></i></button>
    </div>
  </div>

  <div class="container text-center">
    <h3 class="mb-4">Ø¥Ø¯Ø§Ø±Ø© ÙˆØªØ¹Ø¯ÙŠÙ„ Ø§Ù„ÙÙŠØ¯ÙŠÙˆÙ‡Ø§Øª</h3>
    <select id="departmentSelect" class="form-select mb-3" style="max-width: 300px; margin: auto;" data-bs-toggle="tooltip" title="Ø§Ø®ØªØ± Ø§Ù„Ù‚Ø³Ù…">
      <option value="">-- Ø§Ø®ØªØ± Ø§Ù„Ù‚Ø³Ù… --</option>
    </select>
    <input id="searchInput" class="form-control mb-4" type="text" placeholder="Ø§Ø¨Ø­Ø« Ø¨Ø¹Ù†ÙˆØ§Ù† Ø£Ùˆ ÙˆØµÙ Ø§Ù„ÙÙŠØ¯ÙŠÙˆ..." disabled data-bs-toggle="tooltip" title="Ø§ÙƒØªØ¨ ÙƒÙ„Ù…Ø© Ù„Ù„Ø¨Ø­Ø«">
    <div id="videoContainer" class="video-grid"></div>
  </div>
</div>

<!-- Ù†Ø§ÙØ°Ø© Ø¹Ø±Ø¶ Ø§Ù„ÙˆØµÙ -->
<div class="modal fade" id="descModal" tabindex="-1">
  <div class="modal-dialog modal-lg"><div class="modal-content">
    <div class="modal-header"><h5 class="modal-title" id="descTitle"></h5>
      <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
    </div>
    <div class="modal-body" id="descContent" style="white-space: pre-wrap; text-align: justify;"></div>
  </div></div>
</div>

<!-- Ù†Ø§ÙØ°Ø© ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„ÙÙŠØ¯ÙŠÙˆ -->
<div class="modal fade" id="editModal" tabindex="-1">
  <div class="modal-dialog modal-lg"><div class="modal-content">
    <div class="modal-header"><h5 class="modal-title">ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„ÙÙŠØ¯ÙŠÙˆ</h5>
      <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
    </div>
    <div class="modal-body">
      <input type="hidden" id="editId">
      <label>Ø§Ù„Ø¹Ù†ÙˆØ§Ù†</label>
      <input type="text" class="form-control mb-2" id="editTitle">
      <label>Ø§Ù„ÙˆØµÙ</label>
      <div id="editor"></div>
      <label class="mt-3">Ø±Ø§Ø¨Ø· Ø§Ù„ÙÙŠØ¯ÙŠÙˆ</label>
      <input type="text" class="form-control mb-2" id="editUrl">
      <label>Ø§Ù„Ù‚Ø³Ù…</label>
      <select class="form-select mb-2" id="editDeptSelect" required>
        <option value="">-- Ø§Ø®ØªØ± Ø§Ù„Ù‚Ø³Ù… --</option>
      </select>
    </div>
    <div class="modal-footer">
      <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Ø¥ØºÙ„Ø§Ù‚</button>
      <button type="button" class="btn btn-primary" onclick="saveEdit()">Ø­ÙØ¸</button>
    </div>
  </div></div>
</div>

<!-- Ù†Ø§ÙØ°Ø© ØªØ£ÙƒÙŠØ¯ Ø§Ù„Ø­Ø°Ù -->
<div class="modal fade" id="confirmDeleteModal" tabindex="-1">
  <div class="modal-dialog"><div class="modal-content">
    <div class="modal-header bg-danger text-white"><h5 class="modal-title">ØªØ£ÙƒÙŠØ¯ Ø§Ù„Ø­Ø°Ù</h5>
      <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
    </div>
    <div class="modal-body">Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ø£Ù†Ùƒ ØªØ±ÙŠØ¯ Ø­Ø°Ù Ù‡Ø°Ø§ Ø§Ù„ÙÙŠØ¯ÙŠÙˆØŸ
      <input type="hidden" id="deleteVideoId">
    </div>
    <div class="modal-footer">
      <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Ø¥Ù„ØºØ§Ø¡</button>
      <button type="button" class="btn btn-danger" onclick="confirmDelete()">ØªØ£ÙƒÙŠØ¯ Ø§Ù„Ø­Ø°Ù</button>
    </div>
  </div></div>
</div>

<!-- Toast -->
<div class="toast-container" id="toastContainer"></div>
<div id="loginModalContainer"></div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script src="https://cdn.quilljs.com/1.3.6/quill.js"></script>
<script src="login-guard.js"></script>
<script>
let videos = [];
let departments = [];
let quill = new Quill('#editor', {
  theme: 'snow',
  modules: { toolbar: [['bold','italic','underline'],[{ 'list':'ordered'},{ 'list':'bullet'}],['link','image'],[{ 'direction':'rtl'}],['clean']] }
});

// âœ… Ø¯ÙˆØ§Ù„ Overlay Ù…Ø¹ Fade
function showOverlay(text="Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...â³"){
  const overlay = document.getElementById("loadingOverlay");
  document.getElementById("loadingText").textContent = text;
  overlay.classList.add("active");
}
function hideOverlay(){
  const overlay = document.getElementById("loadingOverlay");
  overlay.classList.remove("active");
  document.getElementById("loadingText").textContent = "Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...â³";
}

// âœ… Toast
function showToast(message, type="success") {
  let icon = type==="success" ? "âœ…" : type==="danger" ? "âŒ" : "â„¹ï¸";
  const toast = document.createElement('div');
  toast.className = `toast align-items-center text-bg-${type} border-0 mb-2`;
  toast.innerHTML = `<div class="d-flex"><div class="toast-body">${icon} ${message}</div>
    <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button></div>`;
  document.getElementById('toastContainer').appendChild(toast);
  new bootstrap.Toast(toast, { delay: 1500 }).show();
}

// âœ… ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬
document.addEventListener("DOMContentLoaded", () => {
  if (sessionStorage.getItem("logoutPending") === "true") {
    sessionStorage.removeItem("logoutPending");
    sessionStorage.removeItem("loggedInAt_edit");
    showToast("ØªÙ… ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬ Ø¨Ù†Ø¬Ø§Ø­","success");
    setTimeout(() => { window.location.href="dashboard.html"; }, 1500);
  }
});
document.getElementById("logoutBtn").addEventListener("click", () => {
  sessionStorage.setItem("logoutPending", "true");
  location.reload();
});

// âœ… Ø§Ù„ÙˆØ¶Ø¹ Ø§Ù„Ù„ÙŠÙ„ÙŠ
document.getElementById("themeToggle").addEventListener("click",()=>{
  document.body.classList.toggle("dark-mode");
  const icon=document.querySelector("#themeToggle i");
  if(document.body.classList.contains("dark-mode")){
    icon.classList.replace("bi-moon-stars-fill","bi-brightness-high-fill");
  } else {
    icon.classList.replace("bi-brightness-high-fill","bi-moon-stars-fill");
  }
});

// âœ… Dashboard
document.getElementById("dashboardBtn").addEventListener("click",()=>{window.location.href="dashboard.html";});

// âœ… Tooltips
document.addEventListener("DOMContentLoaded", () => {
  const tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'))
  tooltipTriggerList.forEach(el => { new bootstrap.Tooltip(el,{ trigger:'hover focus', placement:'top', delay:{show:300,hide:150}, customClass:'custom-tooltip'}); });
});

// ğŸ”½ ÙˆØ¸Ø§Ø¦Ù Ø§Ù„ÙÙŠØ¯ÙŠÙˆÙ‡Ø§Øª
async function fetchDepartments(){ try{const res=await fetch("/api/departments");departments=await res.json();}catch(e){console.error(e);} }
function populateDeptSelect(select,selected=""){select.innerHTML='<option value="">-- Ø§Ø®ØªØ± Ø§Ù„Ù‚Ø³Ù… --</option>';departments.forEach(dep=>{const o=document.createElement('option');o.value=dep.name;o.textContent=dep.name;if(dep.name===selected)o.selected=true;select.appendChild(o);});}
async function fetchVideos(){const res=await fetch("/api/videos");videos=await res.json();populateDepartmentOptions();}
function populateDepartmentOptions(){const counts=videos.reduce((a,v)=>{a[v.department]=(a[v.department]||0)+1;return a;},{});const sel=document.getElementById('departmentSelect');sel.innerHTML='<option value="">-- Ø§Ø®ØªØ± Ø§Ù„Ù‚Ø³Ù… --</option>';Object.entries(counts).forEach(([d,c])=>{const o=document.createElement('option');o.value=d;o.textContent=`${d} (${c})`;sel.appendChild(o);});}
function renderVideos(){const dept=document.getElementById('departmentSelect').value;const q=document.getElementById('searchInput').value.trim().toLowerCase();const cont=document.getElementById('videoContainer');cont.innerHTML='';if(!dept)return;const f=videos.filter(v=>v.department?.trim().toLowerCase()===dept.trim().toLowerCase()&&(v.title?.toLowerCase().includes(q)||v.description?.toLowerCase().includes(q)));if(!f.length){cont.innerHTML='<p class="text-muted">ğŸš« Ù„Ø§ ØªÙˆØ¬Ø¯ ÙÙŠØ¯ÙŠÙˆÙ‡Ø§Øª Ù…Ø·Ø§Ø¨Ù‚Ø©</p>';return;}f.forEach(video=>{const card=document.createElement('div');card.className='video-card';const title=`<div class="video-title" title="${video.title}">Ø¹Ù†ÙˆØ§Ù† Ø§Ù„ÙÙŠØ¯ÙŠÙˆ: ${video.title}</div>`;const desc=`<div class="video-description" title="Ø¹Ø±Ø¶ Ø§Ù„ÙˆØµÙ Ø§Ù„ÙƒØ§Ù…Ù„" onclick="showDescription('${escapeHtml(video.title)}','${escapeHtml(video.description)}')">ÙˆØµÙ Ø§Ù„ÙÙŠØ¯ÙŠÙˆ: ${video.description}</div>`;const link=video.link||video.url||'';let media='';let pop=link;if(link.includes('youtube.com')||link.includes('youtu.be')){media=`<iframe src="https://www.youtube.com/embed/${extractYouTubeID(link)}" allowfullscreen></iframe>`;}else if(link.includes('drive.google.com/file/d/')){const m=link.match(/\/file\/d\/(.*?)(\/|$)/);media=m?`<iframe src="https://drive.google.com/file/d/${m[1]}/preview" allowfullscreen></iframe>`:`<video controls src="${link}"></video>`;}else if(link.includes("sharepoint.com/")&&link.includes("/embed.aspx")){media=`<iframe class="sharepoint-frame" src="${link}" allowfullscreen></iframe>`;const u=link.match(/UniqueId=([a-zA-Z0-9\-]+)/);if(u)pop=`https://ymkh-my.sharepoint.com/personal/laith_obaidat_iu_edu_jo/_layouts/15/stream.aspx?UniqueId=${u[1]}`;}else if(link.includes("sharepoint.com/")&&link.includes("/stream.aspx")){const u=link.match(/UniqueId=([a-zA-Z0-9\-]+)/);if(u){const e=`https://ymkh-my.sharepoint.com/personal/laith_obaidat_iu_edu_jo/_layouts/15/embed.aspx?UniqueId=${u[1]}&embed=%7B%22ust%22%3Atrue%7D`;media=`<iframe class="sharepoint-frame" src="${e}" allowfullscreen></iframe>`;pop=link;}else{media=`<video controls src="${link}"></video>`;}}else{media=`<video controls src="${link}"></video>`;}const popBtn=`<button class="popout-button" onclick="window.open('${pop}','_blank','width=800,height=600')">Ø¹Ø±Ø¶ Ø§Ù„ÙÙŠØ¯ÙŠÙˆ</button>`;const actions=`<div class="action-buttons"><button class="btn btn-warning btn-sm" onclick="openEditModal('${video._id}')">ØªØ¹Ø¯ÙŠÙ„</button><button class="btn btn-danger btn-sm" onclick="showDeleteModal('${video._id}')">Ø­Ø°Ù</button></div>`;card.innerHTML=title+desc+media+popBtn+actions;cont.appendChild(card);});}
function escapeHtml(t){return t?.replace(/"/g,'&quot;').replace(/'/g,'&#39;')||'';}
function extractYouTubeID(u){const m=u.match(/[?&]v=([^&#]*)|youtu\.be\/([^&#]*)/);return m?(m[1]||m[2]):'';}
function showDescription(t,d){document.getElementById('descTitle').textContent=t;document.getElementById('descContent').innerHTML=d;new bootstrap.Modal(document.getElementById('descModal')).show();}
async function openEditModal(id){await fetchDepartments();const v=videos.find(v=>v._id===id);document.getElementById('editId').value=v._id;document.getElementById('editTitle').value=v.title;document.getElementById('editUrl').value=v.url;quill.root.innerHTML=v.description||'';populateDeptSelect(document.getElementById('editDeptSelect'),v.department);new bootstrap.Modal(document.getElementById('editModal')).show();}
async function saveEdit(){const id=document.getElementById('editId').value;const upd={title:document.getElementById('editTitle').value,description:quill.root.innerHTML,url:document.getElementById('editUrl').value,department:document.getElementById('editDeptSelect').value};showOverlay("Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø­ÙØ¸...â³");try{await fetch(`/api/videos/${id}`,{method:'PUT',headers:{'Content-Type':'application/json'},body:JSON.stringify(upd)});showToast('âœ… ØªÙ… Ø­ÙØ¸ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„Ø§Øª');fetchVideos();bootstrap.Modal.getInstance(document.getElementById('editModal')).hide();}catch{showToast('âŒ ÙØ´Ù„ Ø§Ù„Ø­ÙØ¸',"danger");}finally{hideOverlay();}}
function showDeleteModal(id){document.getElementById('deleteVideoId').value=id;new bootstrap.Modal(document.getElementById('confirmDeleteModal')).show();}
async function confirmDelete(){const id=document.getElementById('deleteVideoId').value;showOverlay("Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø­Ø°Ù...â³");try{await fetch(`/api/videos/${id}`,{method:'DELETE'});showToast('ğŸ—‘ï¸ ØªÙ… Ø­Ø°Ù Ø§Ù„ÙÙŠØ¯ÙŠÙˆ',"danger");fetchVideos();bootstrap.Modal.getInstance(document.getElementById('confirmDeleteModal')).hide();}catch{showToast('âŒ ÙØ´Ù„ Ø§Ù„Ø­Ø°Ù',"danger");}finally{hideOverlay();}}

document.getElementById('departmentSelect').addEventListener('change',()=>{document.getElementById('searchInput').disabled=false;renderVideos();});
document.getElementById('searchInput').addEventListener('input',renderVideos);

// Ø¨Ø¯Ø¡ ØªØ­Ù…ÙŠÙ„ Ø§Ù„ÙÙŠØ¯ÙŠÙˆÙ‡Ø§Øª
fetchVideos();
</script>
</body>
</html>
