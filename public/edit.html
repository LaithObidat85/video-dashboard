<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <title>تعديل الفيديوهات</title>
  <link rel="icon" type="image/png" href="https://www.dropbox.com/scl/fi/f283e4rvv5cf9x12a1cic/my-website-logo.png?rlkey=yia776im7klypy27af32m0scy&e=1&st=vhaprvzh&dl=1">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.rtl.min.css">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css">
  <link href="https://cdn.quilljs.com/1.3.6/quill.snow.css" rel="stylesheet">
  <style>
    body { background-color: #f4f6f9; font-family: 'Segoe UI', sans-serif; transition: background 0.3s, color 0.3s; font-size:16px; padding:20px; }
    .video-card {
      background: white; border-radius: 12px; box-shadow: 0 2px 6px rgba(0,0,0,0.1);
      padding: 12px; margin: 5px; width: 300px; display: flex; flex-direction: column;
      transition: transform 0.2s ease, box-shadow 0.2s ease;
    }
    .video-card:hover { transform: scale(1.02); box-shadow: 0 4px 12px rgba(0,0,0,0.15); }
    .video-title { font-weight: bold; margin-bottom: 6px; min-height: 48px; overflow: hidden; display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; }
    .video-description { color: #0d6efd; cursor: pointer; min-height: 40px; overflow: hidden; display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; margin-bottom: 8px; }
    .video-grid { display: flex; flex-wrap: wrap; justify-content: center; gap: 15px; }
    video, iframe { width: 100%; height: 200px; border-radius: 6px; }
    .sharepoint-frame { width: 100%; height: 200px; border-radius: 6px; display: block; object-fit: cover; }
    .popout-button { background-color: #0d6efd; color: white; border: none; padding: 6px 12px; border-radius: 5px; cursor: pointer; margin-top: 6px; }
    .action-buttons { display: flex; justify-content: space-between; margin-top: 10px; }
    #editor { height: 200px; background: white; }
    .toast-container { position: fixed; top: 20px; left: 50%; transform: translateX(-50%); z-index: 9999; }

    /* الوضع الليلي */
    body.dark-mode { background-color: #121212; color: #eaeaea; }
    body.dark-mode .video-card { background: #1e1e1e; color: #ddd; }
    body.dark-mode .modal-content { background: #1e1e1e; color: #fff; }
    body.dark-mode .btn-close { filter: invert(1); }

    /* شاشة التحميل مع Fade */
    #loadingOverlay {
      position: fixed; top: 0; left: 0; width: 100%; height: 100%;
      background: rgba(0,0,0,0.5); 
      display: flex;
      align-items: center; justify-content: center; flex-direction: column;
      z-index: 3000; color: #fff; font-size: 1.2rem;

      opacity: 0;
      visibility: hidden;
      transition: opacity 0.4s ease, visibility 0.4s ease;
    }
    #loadingOverlay.active {
      opacity: 1;
      visibility: visible;
    }

    #pageContent { display: none; }
    /* تحسين التولتيب */
    .custom-tooltip.bs-tooltip-auto[x-placement^=top],
    .custom-tooltip.bs-tooltip-top {
      --bs-tooltip-bg: #0d6efd;
      --bs-tooltip-color: #fff;
      font-size: 0.85rem;
      padding: 6px 10px;
      border-radius: 8px;
      box-shadow: 0 2px 6px rgba(0,0,0,0.15);
    }
  </style>
</head>
<body>

<!-- شاشة التحميل -->
<div id="loadingOverlay">
  <div class="spinner-border text-light" role="status" style="width:3rem; height:3rem;"></div>
  <p class="mt-3" id="loadingText">جاري التحميل...⏳</p>
</div>

<div id="pageContent">
  <!-- أزرار علوية -->
  <div class="d-flex justify-content-between mb-3 mt-3">
    <div>
      <button id="logoutBtn" class="btn btn-danger me-2" data-bs-toggle="tooltip" title="تسجيل الخروج"><i class="bi bi-box-arrow-right"></i></button>
      <button id="dashboardBtn" class="btn btn-secondary" data-bs-toggle="tooltip" title="العودة للوحة التحكم"><i class="bi bi-speedometer2"></i></button>
    </div>
    <div>
      <button id="themeToggle" class="btn btn-outline-dark" data-bs-toggle="tooltip" title="الوضع الليلي/النهاري"><i class="bi bi-moon-stars-fill"></i></button>
    </div>
  </div>

  <div class="container text-center">
    <h3 class="mb-4">إدارة وتعديل الفيديوهات</h3>
    <select id="departmentSelect" class="form-select mb-3" style="max-width: 300px; margin: auto;" data-bs-toggle="tooltip" title="اختر القسم">
      <option value="">-- اختر القسم --</option>
    </select>
    <input id="searchInput" class="form-control mb-4" type="text" placeholder="ابحث بعنوان أو وصف الفيديو..." disabled data-bs-toggle="tooltip" title="اكتب كلمة للبحث">
    <div id="videoContainer" class="video-grid"></div>
  </div>
</div>

<div class="toast-container" id="toastContainer"></div>
<div id="loginModalContainer"></div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script src="https://cdn.quilljs.com/1.3.6/quill.js"></script>
<script src="login-guard.js"></script>
<script>
let videos = [];
let departments = [];
let quill = new Quill('#editor', {
  theme: 'snow',
  modules: { toolbar: [['bold','italic','underline'],[{ 'list':'ordered'},{ 'list':'bullet'}],['link','image'],[{ 'direction':'rtl'}],['clean']] }
});

// ✅ دوال Overlay مع Fade
function showOverlay(text="جاري التحميل...⏳"){
  const overlay = document.getElementById("loadingOverlay");
  document.getElementById("loadingText").textContent = text;
  overlay.classList.add("active");
}
function hideOverlay(){
  const overlay = document.getElementById("loadingOverlay");
  overlay.classList.remove("active");
  document.getElementById("loadingText").textContent = "جاري التحميل...⏳";
}

// Toast
function showToast(message, type="success") {
  let icon = type === "success" ? "✅" : type === "danger" ? "❌" : "ℹ️";
  const toast = document.createElement('div');
  toast.className = `toast align-items-center text-bg-${type} border-0 mb-2`;
  toast.innerHTML = `<div class="d-flex"><div class="toast-body">${icon} ${message}</div>
    <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button></div>`;
  document.getElementById('toastContainer').appendChild(toast);
  new bootstrap.Toast(toast, { delay: 1500 }).show();
}

// منع الرجوع بعد تسجيل الخروج
window.history.pushState(null, "", window.location.href);
window.addEventListener("popstate", function () {
  if (!sessionStorage.getItem("loggedInAt_edit")) {
    window.location.replace("index.html");
  }
});

// تسجيل الخروج
document.addEventListener("DOMContentLoaded", () => {
  if (sessionStorage.getItem("logoutPending") === "true") {
    sessionStorage.removeItem("logoutPending");
    sessionStorage.removeItem("loggedInAt_edit");
    showToast("تم تسجيل الخروج بنجاح","success");
    setTimeout(() => { window.location.href="dashboard.html"; }, 1500);
  }
});
document.getElementById("logoutBtn").addEventListener("click", () => {
  sessionStorage.setItem("logoutPending", "true");
  location.reload();
});

// الوضع الليلي
document.getElementById("themeToggle").addEventListener("click",()=>{
  document.body.classList.toggle("dark-mode");
  const icon=document.querySelector("#themeToggle i");
  if(document.body.classList.contains("dark-mode")){
    icon.classList.replace("bi-moon-stars-fill","bi-brightness-high-fill");
  } else {
    icon.classList.replace("bi-brightness-high-fill","bi-moon-stars-fill");
  }
});

// Dashboard
document.getElementById("dashboardBtn").addEventListener("click",()=>{window.location.href="dashboard.html";});

// Tooltips
document.addEventListener("DOMContentLoaded", () => {
  const tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'))
  tooltipTriggerList.forEach(el => { new bootstrap.Tooltip(el,{ trigger:'hover focus', placement:'top', delay:{show:300,hide:150}, customClass:'custom-tooltip'}); });
});

// Overlay عند تحميل الصفحة
window.addEventListener("load",()=>{
  if(sessionStorage.getItem("loggedInAt_edit")){
    hideOverlay();
    document.getElementById("pageContent").style.display="block";
  } else {
    window.location.replace("index.html");
  }
});

// أثناء حفظ التعديلات
async function saveEdit(){
  const id=document.getElementById('editId').value;
  const upd={title:document.getElementById('editTitle').value,description:quill.root.innerHTML,url:document.getElementById('editUrl').value,department:document.getElementById('editDeptSelect').value};

  showOverlay("جاري الحفظ...⏳");
  try {
    await fetch(`/api/videos/${id}`,{method:'PUT',headers:{'Content-Type':'application/json'},body:JSON.stringify(upd)});
    showToast('✅ تم حفظ التعديلات');
    fetchVideos();
    bootstrap.Modal.getInstance(document.getElementById('editModal')).hide();
  } catch {
    showToast('❌ فشل الحفظ',"danger");
  } finally {
    hideOverlay();
  }
}

// أثناء الحذف
async function confirmDelete(){
  const id=document.getElementById('deleteVideoId').value;
  showOverlay("جاري الحذف...⏳");
  try {
    await fetch(`/api/videos/${id}`,{method:'DELETE'});
    showToast('🗑️ تم حذف الفيديو',"danger");
    fetchVideos();
    bootstrap.Modal.getInstance(document.getElementById('confirmDeleteModal')).hide();
  } catch {
    showToast('❌ فشل الحذف',"danger");
  } finally {
    hideOverlay();
  }
}

// باقي الدوال fetchVideos(), renderVideos() ... كما هي عندك
</script>
</body>
</html>
