<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8">
  <title>Ù„ÙˆØ­Ø© Ù…ØªØ§Ø¨Ø¹Ø© Ø§Ù„ØªÙ‚ÙŠÙŠÙ…Ø§Øª</title>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.rtl.min.css">
  <style>
    body { background-color: #f8f9fa; font-family: 'Segoe UI', sans-serif; }
    .container { margin-top: 30px; }
    table { background: #fff; border-radius: 10px; overflow: hidden; font-size: 14px; }
    th { background-color: #0d6efd; color: #fff; text-align: center; }
    td { text-align: center; vertical-align: middle; }

    /* ØªØ­Ø¯ÙŠØ¯ Ø¹Ø±Ø¶ Ø¹Ù…ÙˆØ¯ Ø§Ù„Ù…Ù„Ø§Ø­Ø¸Ø§Øª */
    #evaluationsTableWrapper th.notes-col,
    #evaluationsTableWrapper td.notes-col {
      width: 300px;
      max-width: 300px;
      white-space: normal;
      word-wrap: break-word;
    }

    .filters { margin-bottom: 20px; }
    #completionRateContainer {
      text-align: center;
      font-weight: bold;
      margin: 15px 0;
      font-size: 18px;
      color: #0d6efd;
    }

    /* âœ… ØªÙ†Ø³ÙŠÙ‚Ø§Øª Ø§Ù„Ø·Ø¨Ø§Ø¹Ø© */
    @media print {
      @page { size: landscape; margin: 15mm; }
      body { font-size: 12px; }

      /* Ø¥Ø®ÙØ§Ø¡ ÙƒÙ„ Ø´ÙŠØ¡ Ø¹Ø¯Ø§ Ø§Ù„Ù‡ÙŠØ¯Ø± ÙˆØ§Ù„Ø¬Ø¯ÙˆÙ„ */
      body * { visibility: hidden; }
      #printHeader, #printHeader * ,
      #evaluationsTableWrapper, #evaluationsTableWrapper * {
        visibility: visible;
      }

      #printHeader {
        display: block !important;
        text-align: center;
        margin-bottom: 15px;
        position: relative;
        top: 0;
        left: 0;
        width: 100%;
        font-size: 16px;
      }

      #evaluationsTableWrapper {
        position: relative;
        width: 100%;
      }

      /* Ù…Ù†Ø¹ ØªÙ‚Ø·ÙŠØ¹ Ø§Ù„ØµÙÙˆÙ */
      #evaluationsTableWrapper tr { page-break-inside: avoid; }

      /* Ø§Ù„Ù…Ù„Ø§Ø­Ø¸Ø§Øª */
      #evaluationsTableWrapper td.notes-col { font-size: 11px; }
      #evaluationsTableWrapper td.notes-col.long-notes { font-size: 9px; }

      /* Ø¥Ø®ÙØ§Ø¡ Ø§Ù„Ø¹Ù†Ø§ØµØ± ØºÙŠØ± Ø§Ù„Ù…Ø·Ù„ÙˆØ¨Ø© */
      .filters, .card, .print-btn, .toast-container { display: none !important; }

      /* âœ… Ø§Ù„Ù…Ù„Ø§Ø­Ø¸Ø§Øª: Ø¹Ø±Ø¶ Ø§Ù„Ù†Øµ ÙÙ‚Ø· */
      .screen-notes { display: none !important; }
      .print-notes { display: inline !important; white-space: pre-wrap; }
    }

    #printHeader { display: none; }

    /* Ø²Ø± Ø§Ù„Ø·Ø¨Ø§Ø¹Ø© */
    .print-btn {
      position: absolute;
      top: 10px;
      left: 15px;
    }
  </style>
</head>
<body>
  <div class="container position-relative">
    <button class="btn btn-secondary print-btn" onclick="printTable()">ğŸ–¨ï¸</button>
    <h3 class="text-center mb-4">ğŸ“Š Ù„ÙˆØ­Ø© Ù…ØªØ§Ø¨Ø¹Ø© Ø§Ù„ØªÙ‚ÙŠÙŠÙ…Ø§Øª</h3>

    <!-- Ø§Ù„ÙÙ„Ø§ØªØ± -->
    <div class="filters row">
      <div class="col-md-6 mb-2">
        <label class="form-label">Ø§Ù„ÙƒÙ„ÙŠØ©</label>
        <select id="collegeFilter" class="form-select">
          <option value="">Ø¬Ù…ÙŠØ¹ Ø§Ù„ÙƒÙ„ÙŠØ§Øª</option>
        </select>
      </div>
      <div class="col-md-6 mb-2">
        <label class="form-label">Ø§Ø³Ù… Ø§Ù„Ù…Ø¯Ù‚Ù‚</label>
        <select id="auditorFilter" class="form-select">
          <option value="">Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù…Ø¯Ù‚Ù‚ÙŠÙ†</option>
        </select>
      </div>
    </div>

    <!-- Ø®ÙŠØ§Ø±Ø§Øª Ø§Ù„Ø¥Ø®ÙØ§Ø¡ -->
    <div class="card mb-3">
      <div class="card-body d-flex justify-content-center align-items-center gap-3">
        <div class="form-check">
          <input class="form-check-input" type="checkbox" id="hideAuditorCheckbox">
          <label class="form-check-label ms-2" for="hideAuditorCheckbox">Ø¥Ø®ÙØ§Ø¡ Ø§Ø³Ù… Ø§Ù„Ù…Ø¯Ù‚Ù‚</label>
        </div>
        <span>|</span>
        <div class="form-check">
          <input class="form-check-input" type="checkbox" id="hideDateCheckbox">
          <label class="form-check-label ms-2" for="hideDateCheckbox">Ø¥Ø®ÙØ§Ø¡ ØªØ§Ø±ÙŠØ® Ø§Ù„ØªØ¯Ù‚ÙŠÙ‚</label>
        </div>
        <span>|</span>
        <div class="form-check">
          <input class="form-check-input" type="checkbox" id="hideCollegeCheckbox">
          <label class="form-check-label ms-2" for="hideCollegeCheckbox">Ø¥Ø®ÙØ§Ø¡ Ø§Ù„ÙƒÙ„ÙŠØ©</label>
        </div>
      </div>
    </div>

    <!-- Ù†Ø³Ø¨Ø© Ø§Ù„Ø§ÙƒØªÙ…Ø§Ù„ -->
    <div id="completionRateContainer"></div>

    <!-- Ù‡ÙŠØ¯Ø± Ù„Ù„Ø·Ø¨Ø§Ø¹Ø© -->
    <div id="printHeader"></div>

    <!-- Modal Ù„Ø¹Ø±Ø¶ Ø§Ù„Ù…Ù„Ø§Ø­Ø¸Ø§Øª -->
    <div class="modal fade" id="notesModal" tabindex="-1">
      <div class="modal-dialog modal-lg">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title">ğŸ“ Ø§Ù„Ù…Ù„Ø§Ø­Ø¸Ø§Øª</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
          </div>
          <div class="modal-body" id="notesContent"></div>
        </div>
      </div>
    </div>

    <!-- Ø§Ù„Ø¬Ø¯ÙˆÙ„ -->
    <table class="table table-bordered table-striped" id="evaluationsTableWrapper">
      <thead>
        <tr>
          <th>#</th>
          <th class="college-col">Ø§Ù„ÙƒÙ„ÙŠØ©</th>
          <th>Ø§Ø³Ù… Ø§Ù„Ù„Ø¬Ù†Ø©</th>
          <th class="auditor-col">Ø§Ø³Ù… Ø§Ù„Ù…Ø¯Ù‚Ù‚</th>
          <th class="date-col">ØªØ§Ø±ÙŠØ® Ø§Ù„ØªØ¯Ù‚ÙŠÙ‚</th>
          <th>Ù‚Ø±Ø§Ø± Ø§Ù„ØªØ´ÙƒÙŠÙ„</th>
          <th>Ø®Ø·Ø© Ø§Ù„Ø¹Ù…Ù„</th>
          <th>Ù…Ø¤Ø´Ø±Ø§Øª Ø§Ù„Ø£Ø¯Ø§Ø¡</th>
          <th>Ø¹Ø¯Ø¯ Ø§Ù„Ø§Ø¬ØªÙ…Ø§Ø¹Ø§Øª</th>
          <th>Ø§Ù„ØªÙˆØ§ÙÙ‚ Ø¨ÙŠÙ† Ø§Ù„Ø¯Ø¹ÙˆØ§Øª ÙˆØ§Ù„Ø§Ø¬ØªÙ…Ø§Ø¹Ø§Øª</th>
          <th>ÙƒØªØ¨ Ø§Ù„ØªØºØ·ÙŠØ©</th>
          <th>ØªÙ‚Ø±ÙŠØ± Ø¥Ù†Ø¬Ø§Ø² 1</th>
          <th>ØªÙ‚Ø±ÙŠØ± Ø¥Ù†Ø¬Ø§Ø² 2</th>
          <th>ØªÙ‚Ø±ÙŠØ± Ø¥Ù†Ø¬Ø§Ø² 3</th>
          <th>Ø§Ù„ØªØ­Ù„ÙŠÙ„ Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠ</th>
          <th>Ø¯Ø±Ø¬Ø© Ø§Ù„ØªÙˆÙØ±</th>
          <th class="notes-col">Ø§Ù„Ù…Ù„Ø§Ø­Ø¸Ø§Øª</th>
        </tr>
      </thead>
      <tbody id="evaluationsTable">
        <tr><td colspan="17" class="text-center">Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...</td></tr>
      </tbody>
    </table>
  </div>

  <!-- Ù…ÙƒØªØ¨Ø§Øª -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>

  <script>
    let lastCompletionRate = null;
    let lastCollegeName = "Ø¬Ù…ÙŠØ¹ Ø§Ù„ÙƒÙ„ÙŠØ§Øª";
    let lastCommitteesCount = 0;

    async function loadFilters() {
      const colleges = await axios.get('/api/colleges');
      const collegeSelect = document.getElementById('collegeFilter');
      colleges.data.forEach(c => {
        const opt = document.createElement('option');
        opt.value = c.name;
        opt.textContent = c.name;
        collegeSelect.appendChild(opt);
      });

      const auditors = await axios.get('/api/auditors');
      const auditorSelect = document.getElementById('auditorFilter');
      auditors.data.forEach(a => {
        const opt = document.createElement('option');
        opt.value = a.name;
        opt.textContent = a.name;
        auditorSelect.appendChild(opt);
      });
    }

    async function loadEvaluations() {
      const college = document.getElementById('collegeFilter').value;
      const auditor = document.getElementById('auditorFilter').value;
      lastCollegeName = college || "Ø¬Ù…ÙŠØ¹ Ø§Ù„ÙƒÙ„ÙŠØ§Øª";

      let url = '/api/committees';
      const params = [];
      if (college) params.push(`college=${encodeURIComponent(college)}`);
      if (auditor) params.push(`auditor_name=${encodeURIComponent(auditor)}`);
      if (params.length > 0) url += '?' + params.join('&');

      const res = await axios.get(url);
      const tbody = document.getElementById('evaluationsTable');
      tbody.innerHTML = "";

      if (res.data.length === 0) {
        tbody.innerHTML = `<tr><td colspan="17" class="text-center">Ù„Ø§ ØªÙˆØ¬Ø¯ ØªÙ‚ÙŠÙŠÙ…Ø§Øª</td></tr>`;
        document.getElementById("completionRateContainer").innerHTML = "";
        lastCompletionRate = null;
        lastCommitteesCount = 0;
        return;
      }

      let totalAvailability = 0;
      res.data.forEach((ev, index) => {
        totalAvailability += ev.availability_score ?? 0;

        function stripHTML(html) {
          let div = document.createElement("div");
          div.innerHTML = html;
          return div.innerText.trim();
        }

        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td>${index + 1}</td>
          <td class="college-col">${ev.college || '-'}</td>
          <td>${ev.committee_name || '-'}</td>
          <td class="auditor-col">${ev.auditor_name || '-'}</td>
          <td class="date-col">${ev.audit_date ? new Date(ev.audit_date).toLocaleDateString('ar-EG') : '-'}</td>
          <td>${ev.formation_decision ?? 0}</td>
          <td>${ev.work_plan ?? 0}</td>
          <td>${ev.performance_indicators ?? 0}</td>
          <td>${ev.meetings ?? 0}</td>
          <td>${ev.consistency ?? 0}</td>
          <td>${ev.coverage_books ?? 0}</td>
          <td>${ev.report1 ?? 0}</td>
          <td>${ev.report2 ?? 0}</td>
          <td>${ev.report3 ?? 0}</td>
          <td>${ev.statistical_analysis ?? 0}</td>
          <td>${ev.availability_score ?? 0}</td>
          <td class="notes-col ${ev.notes && ev.notes.length > 800 ? 'long-notes' : ''}">
            <span class="screen-notes">
              ${
                ev.notes && ev.notes.trim() !== "" && ev.notes.trim() !== "<p><br></p>"
                  ? `<button class="btn btn-sm btn-info" onclick="showNotes(\`${ev.notes}\`)">ğŸ” Ø¹Ø±Ø¶</button>`
                  : '<span class="text-muted">Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ù„Ø§Ø­Ø¸Ø§Øª</span>'
              }
            </span>
            <span class="print-notes d-none">
              ${
                ev.notes && ev.notes.trim() !== "" && ev.notes.trim() !== "<p><br></p>"
                  ? stripHTML(ev.notes)
                  : 'Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ù„Ø§Ø­Ø¸Ø§Øª'
              }
            </span>
          </td>
        `;
        tbody.appendChild(tr);
      });

      const numCommittees = res.data.length;
      lastCommitteesCount = numCommittees;
      const denominator = numCommittees * 9;
      const completionRate = ((totalAvailability / denominator) * 100).toFixed(2);

      if (college) {
        document.getElementById("completionRateContainer").innerHTML =
          `ğŸ“Œ Ù†Ø³Ø¨Ø© Ø§Ù„Ø§ÙƒØªÙ…Ø§Ù„ Ù„ÙƒÙ„ÙŠØ© ${college} = ${completionRate}%<br>
           ğŸ“‹ Ø¹Ø¯Ø¯ Ù„Ø¬Ø§Ù† ÙƒÙ„ÙŠØ© ${college} = ${numCommittees}`;
      } else {
        document.getElementById("completionRateContainer").innerHTML =
          `ğŸ“Œ Ù†Ø³Ø¨Ø© Ø§Ù„Ø§ÙƒØªÙ…Ø§Ù„ Ù„Ø¬Ù…ÙŠØ¹ Ø§Ù„ÙƒÙ„ÙŠØ§Øª = ${completionRate}%<br>
           ğŸ“‹ Ø¹Ø¯Ø¯ Ù„Ø¬Ø§Ù† Ø¬Ù…ÙŠØ¹ Ø§Ù„ÙƒÙ„ÙŠØ§Øª = ${numCommittees}`;
      }

      lastCompletionRate = completionRate;
    }

    function printTable() {
      const headerDiv = document.getElementById("printHeader");
      if (lastCollegeName === "Ø¬Ù…ÙŠØ¹ Ø§Ù„ÙƒÙ„ÙŠØ§Øª") {
        headerDiv.innerHTML =
          `<h4>ğŸ“Š Ù†ØªØ§Ø¦Ø¬ ØªÙ‚ÙŠÙŠÙ… Ø§Ù„Ù„Ø¬Ø§Ù† - Ø¬Ù…ÙŠØ¹ Ø§Ù„ÙƒÙ„ÙŠØ§Øª</h4>` +
          (lastCompletionRate ? `<p>ğŸ“Œ Ù†Ø³Ø¨Ø© Ø§Ù„Ø§ÙƒØªÙ…Ø§Ù„ Ù„Ø¬Ù…ÙŠØ¹ Ø§Ù„ÙƒÙ„ÙŠØ§Øª = ${lastCompletionRate}%</p>` : "") +
          `<p>ğŸ“‹ Ø¹Ø¯Ø¯ Ù„Ø¬Ø§Ù† Ø¬Ù…ÙŠØ¹ Ø§Ù„ÙƒÙ„ÙŠØ§Øª = ${lastCommitteesCount}</p>`;
      } else {
        headerDiv.innerHTML =
          `<h4>ğŸ“Š Ù†ØªØ§Ø¦Ø¬ ØªÙ‚ÙŠÙŠÙ… Ø§Ù„Ù„Ø¬Ø§Ù† - ${lastCollegeName}</h4>` +
          (lastCompletionRate ? `<p>ğŸ“Œ Ù†Ø³Ø¨Ø© Ø§Ù„Ø§ÙƒØªÙ…Ø§Ù„ Ù„ÙƒÙ„ÙŠØ© ${lastCollegeName} = ${lastCompletionRate}%</p>` : "") +
          `<p>ğŸ“‹ Ø¹Ø¯Ø¯ Ù„Ø¬Ø§Ù† ÙƒÙ„ÙŠØ© ${lastCollegeName} = ${lastCommitteesCount}</p>`;
      }
      window.print();
      headerDiv.innerHTML = "";
    }

    function showNotes(html) {
      document.getElementById('notesContent').innerHTML = html || "<i>Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ù„Ø§Ø­Ø¸Ø§Øª</i>";
      new bootstrap.Modal(document.getElementById('notesModal')).show();
    }

    loadFilters().then(loadEvaluations);
    document.getElementById('collegeFilter').addEventListener('change', loadEvaluations);
    document.getElementById('auditorFilter').addEventListener('change', loadEvaluations);

    document.getElementById('hideAuditorCheckbox').addEventListener('change', function () {
      document.getElementById('evaluationsTableWrapper').classList.toggle('hide-auditor', this.checked);
    });
    document.getElementById('hideDateCheckbox').addEventListener('change', function () {
      document.getElementById('evaluationsTableWrapper').classList.toggle('hide-date', this.checked);
    });
    document.getElementById('hideCollegeCheckbox').addEventListener('change', function () {
      document.getElementById('evaluationsTableWrapper').classList.toggle('hide-college', this.checked);
    });
  </script>
</body>
</html>
