<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>سجلّ العمليات</title>
  <style>
    :root{
      --bg:#0f172a;          /* slate-900 */
      --card:#111827;       /* gray-900 */
      --muted:#94a3b8;      /* slate-400 */
      --text:#e5e7eb;       /* gray-200 */
      --accent:#22d3ee;     /* cyan-400 */
      --accent-2:#818cf8;   /* indigo-400 */
      --danger:#ef4444;     /* red-500 */
      --ok:#10b981;         /* emerald-500 */
      --chip:#1f2937;       /* gray-800 */
      --border:#1f2937;
      --shadow: 0 10px 30px rgba(0,0,0,.35);
      --radius:16px;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;background:linear-gradient(180deg,#0b1224, #0f172a 40%);
      color:var(--text);font-family:system-ui, -apple-system, "Segoe UI", Roboto, "Noto Kufi Arabic", "Noto Sans Arabic", Tahoma, Arial, sans-serif;
    }
    .container{max-width:1200px;margin:24px auto;padding:0 16px}

    /* Header */
    .hdr{
      display:flex;align-items:center;justify-content:space-between;gap:12px;
      margin-bottom:16px;
    }
    .hdr .title{
      display:flex;align-items:center;gap:10px;
      font-weight:800;letter-spacing:.5px;font-size:clamp(18px,2vw,22px);
      background:linear-gradient(90deg,var(--accent),var(--accent-2));
      -webkit-background-clip:text;background-clip:text;color:transparent;
      text-shadow:0 0 30px rgba(34,211,238,.2), 0 0 20px rgba(129,140,248,.15);
    }
    .hdr .subtitle{
      color:var(--muted);font-size:12px;margin-top:2px
    }

    /* Toolbar */
    .toolbar{
      background:rgba(255,255,255,.03);
      border:1px solid var(--border);
      box-shadow:var(--shadow);
      border-radius:var(--radius);
      padding:14px;
      display:grid;
      grid-template-columns: repeat(12, 1fr);
      gap:10px;
      position:sticky;top:8px;backdrop-filter: blur(8px);z-index:5;
    }
    .toolbar .field{display:flex;flex-direction:column;gap:6px}
    .toolbar label{font-size:12px;color:var(--muted)}
    .toolbar input,.toolbar select{
      width:100%;padding:9px 10px;border-radius:12px;border:1px solid var(--border);
      background:#0b1020;color:var(--text);outline:none;
    }
    .toolbar .btn{
      padding:10px 12px;border-radius:14px;border:1px solid var(--border);
      background:linear-gradient(180deg,#0a1020,#0d1428);
      color:var(--text);cursor:pointer;font-weight:600;
      transition:transform .08s ease, box-shadow .2s ease;
      box-shadow:0 6px 18px rgba(0,0,0,.25);
      white-space:nowrap
    }
    .toolbar .btn:hover{transform:translateY(-1px)}
    .btn-primary{
      background:linear-gradient(90deg,var(--accent-2),var(--accent));
      color:#0a0e1a;border:none;
      box-shadow:0 8px 24px rgba(129,140,248,.25), 0 8px 28px rgba(34,211,238,.18);
    }
    .btn-danger{
      background:linear-gradient(90deg,#ef4444,#f59e0b);
      color:#0b0f1a;border:none;
      box-shadow:0 8px 24px rgba(239,68,68,.25), 0 8px 28px rgba(245,158,11,.18);
    }

    /* Grid */
    .grid{
      margin-top:16px;
      display:grid;
      grid-template-columns:repeat(12,1fr);
      gap:14px;
    }
    .card{
      grid-column: span 12;
      background:radial-gradient(1200px 300px at 100% -10%, rgba(129,140,248,.10), transparent 30%),
                 linear-gradient(180deg, #0b1020, #0d1326);
      border:1px solid var(--border);
      border-radius:18px;padding:14px 14px 10px 14px;
      box-shadow:var(--shadow);
      position:relative;overflow:hidden;
    }
    .card .row{display:flex;align-items:center;gap:10px;flex-wrap:wrap}
    .chip{background:var(--chip);color:#d1d5db;border:1px solid var(--border);padding:4px 10px;border-radius:999px;font-size:12px}
    .chip.ok{background:rgba(16,185,129,.08);color:#a7f3d0;border-color:rgba(16,185,129,.25)}
    .chip.warn{background:rgba(245,158,11,.08);color:#fde68a;border-color:rgba(245,158,11,.25)}
    .chip.danger{background:rgba(239,68,68,.08);color:#fecaca;border-color:rgba(239,68,68,.25)}
    .muted{color:var(--muted)}

    .payload{
      margin-top:10px;border:1px dashed var(--border);border-radius:14px;overflow:hidden
    }
    .payload-header{
      display:flex;align-items:center;justify-content:space-between;
      background:rgba(255,255,255,.02);padding:10px 12px;border-bottom:1px dashed var(--border)
    }
    .payload-body{display:none;padding:12px;background:#0a0f1e}
    .payload.open .payload-body{display:block}

    /* Diff */
    .diff{
      display:grid;grid-template-columns: 1fr 1fr;gap:10px
    }
    pre{
      margin:0;background:#0a0f1e;border:1px solid var(--border);border-radius:12px;padding:10px;overflow:auto;
      font-family:ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", monospace;
      font-size:12px;line-height:1.6;color:#dbeafe;max-height:360px;
    }
    .line-changed{background:rgba(129,140,248,.14)}
    .line-added{background:rgba(16,185,129,.14)}
    .line-removed{background:rgba(239,68,68,.14)}
    .k{color:#93c5fd}
    .v{color:#a7f3d0}
    .n{color:#fde68a}
    .null{color:#fca5a5}

    /* Footer / Pagination */
    .footer{
      display:flex;align-items:center;justify-content:space-between;gap:12px;margin:16px 0
    }
    .pg{
      display:flex;align-items:center;gap:8px
    }
    .pg button{
      padding:8px 10px;border-radius:10px;border:1px solid var(--border);background:#0b1020;color:var(--text);cursor:pointer
    }
    .pg .page-info{color:var(--muted);font-size:12px}

    .empty{
      text-align:center;color:var(--muted);padding:40px;border:1px dashed var(--border);border-radius:16px;background:rgba(255,255,255,.02)
    }

    /* Layout for toolbar fields */
    .col-2{grid-column: span 2}
    .col-3{grid-column: span 3}
    .col-4{grid-column: span 4}
    .col-6{grid-column: span 6}
    .col-8{grid-column: span 8}
    .col-12{grid-column: span 12}

    @media (max-width:900px){
      .col-2,.col-3,.col-4,.col-6,.col-8{grid-column: span 12}
      .diff{grid-template-columns:1fr}
    }

    /* Loader */
    .loader{display:flex;align-items:center;gap:10px}
    .spinner{
      width:18px;height:18px;border-radius:50%;
      border:2px solid rgba(255,255,255,.15);border-top-color:var(--accent);
      animation:spin .9s linear infinite
    }
    @keyframes spin{to{transform:rotate(360deg)}}

    /* Checkbox bulk */
    .selectbar{
      display:flex;align-items:center;gap:10px;color:var(--muted);font-size:13px;margin-top:6px
    }
    .sel-all{cursor:pointer;color:#c7d2fe}
  </style>
</head>
<body>
  <div class="container">
    <div class="hdr">
      <div>
        <div class="title">سجلّ العمليات (Audit Logs)</div>
        <div class="subtitle">عرض عمليات النظام مع فلترة متقدمة، واطّلاع تفصيلي على الـ payload والفروق.</div>
      </div>
      <div class="loader" id="liveStatus" style="opacity:.7">
        <div class="spinner"></div><span>جلب البيانات…</span>
      </div>
    </div>

    <!-- Toolbar -->
    <div class="toolbar" id="toolbar">
      <div class="field col-3">
        <label for="model">النموذج (Model)</label>
        <select id="model">
          <option value="">الكل</option>
          <!-- تُملأ ديناميكيًا أيضًا عند الجلب الأول -->
          <option>User</option>
          <option>Evaluation</option>
          <option>College</option>
          <option>Committee</option>
          <option>Auditor</option>
          <option>Settings</option>
          <option>CommitteeFiles</option>
          <option>CommitteeAssignment</option>
        </select>
      </div>
      <div class="field col-3">
        <label for="action">الإجراء (Action)</label>
        <select id="action">
          <option value="">الكل</option>
          <option>create</option>
          <option>update</option>
          <option>delete</option>
          <option>upsert</option>
        </select>
      </div>
      <div class="field col-3">
        <label for="from">من تاريخ</label>
        <input type="date" id="from">
      </div>
      <div class="field col-3">
        <label for="to">إلى تاريخ</label>
        <input type="date" id="to">
      </div>
      <div class="field col-6">
        <label for="q">بحث حر (اسم المستخدم/البريد/اسم الدخول)</label>
        <input id="q" placeholder="ابحث…">
      </div>
      <div class="field col-2">
        <label for="limit">عدد بالس página</label>
        <select id="limit">
          <option>10</option>
          <option selected>20</option>
          <option>50</option>
          <option>100</option>
        </select>
      </div>
      <div class="field col-2">
        <label style="opacity:0">.</label>
        <button class="btn btn-primary" id="applyBtn">تطبيق الفلاتر</button>
      </div>
      <div class="field col-2">
        <label style="opacity:0">.</label>
        <button class="btn" id="resetBtn">إعادة تعيين</button>
      </div>
      <div class="field col-3">
        <label style="opacity:0">.</label>
        <button class="btn btn-danger" id="deleteSelectedBtn">حذف المحدد</button>
      </div>
      <div class="field col-3">
        <label style="opacity:0">.</label>
        <button class="btn btn-danger" id="deleteByRangeBtn">حذف ضمن النطاق الزمني</button>
      </div>
      <div class="col-12 selectbar" id="selectBar" style="display:none">
        <span id="selectedCount">0</span> عنصر محدّد — <span class="sel-all" id="toggleSelectAll">تحديد/إلغاء الكل</span>
      </div>
    </div>

    <!-- Results grid -->
    <div class="grid" id="grid"></div>

    <!-- Footer / Pagination -->
    <div class="footer">
      <div class="pg">
        <button id="prevBtn">السابق</button>
        <span class="page-info" id="pageInfo">صفحة 1</span>
        <button id="nextBtn">التالي</button>
      </div>
      <div class="muted" id="metaInfo">—</div>
    </div>
  </div>

  <script>
    const state = {
      page: 1,
      limit: 20,
      model: '',
      action: '',
      from: '',
      to: '',
      q: '',
      total: 0,
      hasMore: false,
      items: [],
      selected: new Set()
    };

    const els = {
      grid: document.getElementById('grid'),
      model: document.getElementById('model'),
      action: document.getElementById('action'),
      from: document.getElementById('from'),
      to: document.getElementById('to'),
      q: document.getElementById('q'),
      limit: document.getElementById('limit'),
      applyBtn: document.getElementById('applyBtn'),
      resetBtn: document.getElementById('resetBtn'),
      prevBtn: document.getElementById('prevBtn'),
      nextBtn: document.getElementById('nextBtn'),
      pageInfo: document.getElementById('pageInfo'),
      metaInfo: document.getElementById('metaInfo'),
      liveStatus: document.getElementById('liveStatus'),
      deleteSelectedBtn: document.getElementById('deleteSelectedBtn'),
      deleteByRangeBtn: document.getElementById('deleteByRangeBtn'),
      selectBar: document.getElementById('selectBar'),
      selectedCount: document.getElementById('selectedCount'),
      toggleSelectAll: document.getElementById('toggleSelectAll')
    };

    function setLoading(v){
      els.liveStatus.style.visibility = v ? 'visible' : 'hidden';
    }

    function toQS(obj){
      const p = new URLSearchParams();
      Object.entries(obj).forEach(([k,v])=>{
        if(v!==undefined && v!==null && String(v).trim()!=='') p.append(k, v);
      });
      return p.toString();
    }

    async function fetchLogs(){
      setLoading(true);
      try{
        const qs = toQS({
          model: state.model,
          action: state.action,
          from: state.from,
          to: state.to,
          q: state.q,
          page: state.page,
          limit: state.limit
        });
        const res = await fetch(`/api/audit-logs?${qs}`, { credentials:'include' });
        if(!res.ok){
          throw new Error('فشل الجلب: ' + res.status);
        }
        const data = await res.json();
        state.items = data.items || data.data || [];
        state.total = data.total || 0;
        state.hasMore = !!data.hasMore;
        render();
        // تعبئة القوائم بالخيارات المتاحة (ديناميكياً)
        hydrateFiltersFromData(state.items);
      }catch(e){
        console.error(e);
        els.grid.innerHTML = `<div class="card"><div class="empty">فشل تحميل السجلّات. تأكد من تسجيل الدخول كـ Admin.</div></div>`;
        els.metaInfo.textContent = '—';
      }finally{
        setLoading(false);
      }
    }

    function hydrateFiltersFromData(items){
      const models = new Set(['']);
      const actions = new Set(['']);
      items.forEach(x=>{ if(x.model) models.add(x.model); if(x.action) actions.add(x.action); });
      const modelSel = els.model;
      const actionSel = els.action;

      // لا نعيد البناء إن كانت هناك قيمة مستخدمة يدوياً
      const keepModel = new Set([...modelSel.options].map(o=>o.value));
      models.forEach(m=>{
        if(!keepModel.has(m) && m) {
          const opt = document.createElement('option'); opt.value=m; opt.textContent=m; modelSel.appendChild(opt);
        }
      });
      const keepAction = new Set([...actionSel.options].map(o=>o.value));
      actions.forEach(a=>{
        if(!keepAction.has(a) && a) {
          const opt = document.createElement('option'); opt.value=a; opt.textContent=a; actionSel.appendChild(opt);
        }
      });
    }

    function fmtDate(d){
      try{
        const dt = new Date(d);
        return dt.toLocaleString('ar-EG', { hour12:false });
      }catch{ return d }
    }

    function badgeForAction(a){
      if(a==='create' || a==='upsert') return 'ok';
      if(a==='delete') return 'danger';
      if(a==='update') return 'warn';
      return '';
    }

    function summarizeUser(u){
      if(!u) return '—';
      const parts = [];
      if(u.name) parts.push(u.name);
      if(u.username) parts.push('(' + u.username + ')');
      if(u.email) parts.push('— ' + u.email);
      if(u.role) parts.push('[' + u.role + ']');
      return parts.join(' ');
    }

    function render(){
      // رأس/فووتر
      els.pageInfo.textContent = `صفحة ${state.page}`;
      els.metaInfo.textContent = `عدد إجمالي تقريبي: ${state.total.toLocaleString('ar-EG')} — ${state.hasMore ? 'هناك المزيد' : 'نهاية النتائج'}`;

      // شريط التحديد
      const selCount = state.selected.size;
      els.selectedCount.textContent = selCount;
      els.selectBar.style.display = selCount ? 'flex' : 'none';

      // شبكة النتائج
      if(!state.items.length){
        els.grid.innerHTML = `<div class="card"><div class="empty">لا توجد بيانات مطابقة للفلتر الحالي.</div></div>`;
        return;
      }

      els.grid.innerHTML = '';
      state.items.forEach(item=>{
        const id = String(item._id || '');
        const createdAt = fmtDate(item.createdAt);
        const user = item.user || item.user || {};

        const hasBeforeAfter = item.payload && (item.payload.before || item.payload.after);
        const payloadTitle = hasBeforeAfter ? 'البيانات (قبل/بعد)' : 'البيانات (Payload)';

        const card = document.createElement('div');
        card.className = 'card';

        // العنوان + الشيبس
        const topRow = document.createElement('div');
        topRow.className='row';
        topRow.innerHTML = `
          <input type="checkbox" data-id="${id}" ${state.selected.has(id)?'checked':''} style="width:18px;height:18px;accent-color:#6366f1;outline:none;border:none;cursor:pointer">
          <span class="chip ${badgeForAction(item.action)}">${item.action || '—'}</span>
          <span class="chip">${item.model || '—'}</span>
          <span class="muted">#${id.slice(-8)}</span>
          <span class="muted" style="margin-inline-start:auto">${createdAt}</span>
        `;

        // معلومات المستخدم
        const userRow = document.createElement('div');
        userRow.className='row';
        userRow.style.marginTop='4px';
        userRow.innerHTML = `
          <span class="muted">المستخدم:</span>
          <span>${summarizeUser(item.user)}</span>
        `;

        // الحمولة
        const payload = document.createElement('div');
        payload.className = 'payload';
        payload.innerHTML = `
          <div class="payload-header">
            <div>${payloadTitle}</div>
            <div class="row">
              ${hasBeforeAfter ? '<button class="btn" data-tt="toggle-diff">عرض/إخفاء الفروقات</button>' : ''}
              <button class="btn" data-tt="toggle-json">عرض/إخفاء JSON</button>
            </div>
          </div>
          <div class="payload-body">
            ${ renderPayloadBody(item.payload || {}) }
          </div>
        `;

        // تجميع
        card.appendChild(topRow);
        card.appendChild(userRow);
        card.appendChild(payload);

        // أحداث
        card.querySelectorAll('input[type=checkbox]').forEach(cb=>{
          cb.addEventListener('change', (e)=>{
            const id = e.target.getAttribute('data-id');
            if(e.target.checked) state.selected.add(id);
            else state.selected.delete(id);
            render(); // لتحديث شريط العدّاد
          });
        });

        const hasDiffBtn = card.querySelector('button[data-tt="toggle-diff"]');
        if(hasDiffBtn){
          hasDiffBtn.addEventListener('click',()=>{
            const body = payload.querySelector('.payload-body');
            const diff = body.querySelector('.diff');
            diff.style.display = diff.style.display==='none' ? 'grid' : 'none';
          });
        }
        const jsonBtn = card.querySelector('button[data-tt="toggle-json"]');
        jsonBtn.addEventListener('click',()=>{
          payload.classList.toggle('open');
        });

        els.grid.appendChild(card);
      });
    }

    function renderPayloadBody(payload){
      // قبل/بعد إن وُجد
      let before = payload.before ?? null;
      let after = payload.after ?? null;

      // تنسيق JSON الجميل لأي payload آخر أيضًا
      const fullJson = syntaxHighlightJSON(payload);

      let diffHTML = '';
      if(before!==null || after!==null){
        diffHTML = `
          <div class="diff" style="">
            <div>
              <div class="muted" style="margin:6px 0">قبل (before)</div>
              ${renderPrettyJson(before)}
            </div>
            <div>
              <div class="muted" style="margin:6px 0">بعد (after)</div>
              ${renderPrettyJson(after)}
            </div>
          </div>
        `;
      }

      return `
        ${diffHTML}
        <div style="margin-top:10px">
          <div class="muted" style="margin:6px 0">JSON كامل</div>
          <pre>${fullJson}</pre>
        </div>
      `;
    }

    function renderPrettyJson(obj){
      const json = syntaxHighlightJSON(obj);
      return `<pre>${json}</pre>`;
    }

    function syntaxHighlightJSON(obj){
      try{
        const str = JSON.stringify(obj, replacerSorted, 2);
        return str
          .replace(/&/g,'&amp;').replace(/</g,'&lt;')
          .replace(/("(\\u[a-zA-Z0-9]{4}|\\[^u]|[^\\"])*"(\\s*:)?|\b(true|false|null)\b|-?\\d+(?:\\.\\d*)?(?:[eE][+\\-]?\\d+)?)/g, function (match) {
            let cls = 'v';
            if (/^"/.test(match)) {
              if (/:$/.test(match)) {
                cls = 'k'; // key
              } else {
                cls = 'v'; // string
              }
            } else if (/true|false/.test(match)) {
              cls = 'n'; // boolean/number alike style
            } else if (/null/.test(match)) {
              cls = 'null';
            } else {
              cls = 'n'; // number
            }
            return '<span class="'+cls+'">'+match+'</span>';
          });
      }catch{
        return String(obj);
      }
    }

    function replacerSorted(key, value){
      // ترتيب المفاتيح لضمان مقارنة أسهل بين before/after
      if(value && typeof value === 'object' && !Array.isArray(value)){
        const out = {};
        Object.keys(value).sort().forEach(k=>{ out[k] = value[k]; });
        return out;
      }
      return value;
    }

    // Pagination
    els.prevBtn.addEventListener('click', ()=>{
      if(state.page>1){ state.page--; fetchLogs(); }
    });
    els.nextBtn.addEventListener('click', ()=>{
      if(state.hasMore){ state.page++; fetchLogs(); }
    });

    // Apply / Reset
    els.applyBtn.addEventListener('click', ()=>{
      state.model = els.model.value;
      state.action = els.action.value;
      state.from = els.from.value;
      state.to = els.to.value;
      state.q = els.q.value.trim();
      state.limit = parseInt(els.limit.value, 10) || 20;
      state.page = 1;
      state.selected.clear();
      fetchLogs();
    });

    els.resetBtn.addEventListener('click', ()=>{
      els.model.value = '';
      els.action.value = '';
      els.from.value = '';
      els.to.value = '';
      els.q.value = '';
      els.limit.value = '20';
      state.model=''; state.action=''; state.from=''; state.to=''; state.q=''; state.limit=20; state.page=1;
      state.selected.clear();
      fetchLogs();
    });

    // Bulk: toggle select all on current page
    els.toggleSelectAll.addEventListener('click', ()=>{
      const ids = state.items.map(x=>String(x._id||''));
      const allSelected = ids.every(id=>state.selected.has(id));
      if(allSelected){ ids.forEach(id=>state.selected.delete(id)); }
      else{ ids.forEach(id=>state.selected.add(id)); }
      render();
    });

    // Delete selected by IDs
    els.deleteSelectedBtn.addEventListener('click', async ()=>{
      const ids = [...state.selected];
      if(!ids.length) { alert('لم تحدد أي عناصر.'); return; }
      if(!confirm('متأكد من حذف السجلات المحدّدة؟')) return;
      try{
        setLoading(true);
        const res = await fetch('/api/audit-logs/by-ids', {
          method:'DELETE',
          headers:{ 'Content-Type':'application/json' },
          credentials:'include',
          body: JSON.stringify({ ids })
        });
        if(!res.ok){ throw new Error('فشل الحذف'); }
        state.selected.clear();
        await fetchLogs();
        alert('تم حذف السجلات المحددة.');
      }catch(e){
        console.error(e); alert('فشل حذف السجلات.');
      }finally{
        setLoading(false);
      }
    });

    // Delete by date range
    els.deleteByRangeBtn.addEventListener('click', async ()=>{
      const from = els.from.value || '';
      const to = els.to.value || '';
      if(!from && !to){
        if(!confirm('ستقوم بحذف جميع السجلات بالكامل. هل أنت متأكد؟')) return;
      }else{
        if(!confirm('حذف السجلات ضمن النطاق الزمني المحدد؟')) return;
      }
      try{
        setLoading(true);
        const qs = toQS({ from, to });
        const res = await fetch(`/api/audit-logs?${qs}`, {
          method:'DELETE',
          credentials:'include'
        });
        if(!res.ok) throw new Error('فشل الحذف');
        await fetchLogs();
        alert('تم تنفيذ الحذف.');
      }catch(e){
        console.error(e); alert('تعذر إتمام الحذف.');
      }finally{
        setLoading(false);
      }
    });

    // تهيئة أولية
    (function init(){
      // إن كان لديك قيم افتراضية للمدى الزمني، ضَعها هنا.
      setLoading(false);
      fetchLogs();
    })();
  </script>
</body>
</html>
