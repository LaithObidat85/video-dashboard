<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <title>Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ† - Ù†Ø¸Ø§Ù… Ø§Ù„Ù„Ø¬Ø§Ù†</title>
  <link rel="icon" type="image/png" href="https://www.dropbox.com/scl/fi/f283e4rvv5cf9x12a1cic/my-website-logo.png?rlkey=yia776im7klypy27af32m0scy&e=1&st=vhaprvzh&dl=1">
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.rtl.min.css">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css">
  <style>
    body{background:#f8f9fa;font-family:'Segoe UI',sans-serif}
    .container{max-width:1200px;margin-top:40px}
    .card{border-radius:16px;box-shadow:0 6px 18px rgba(0,0,0,.06)}
    .user-chip{font-size:.9rem}
    .muted{opacity:.75}

    /* Ø³ÙƒÙ„ØªÙˆÙ† */
    .skeleton{position:relative;overflow:hidden;background:linear-gradient(90deg,#eee 25%,#f5f5f5 37%,#eee 63%);background-size:400% 100%;animation:shimmer 1.2s infinite}
    @keyframes shimmer{0%{background-position:100% 0}100%{background-position:-100% 0}}

    /* Ø´Ø§Ø±Ø© Ø§Ù„Ø­Ø§Ù„Ø© */
    .badge-active{background:#1987541a;color:#198754}
    .badge-inactive{background:#dc35451a;color:#dc3545}

    /* ØªÙˆØ¶ÙŠØ­ Ø§Ù„ØªØ­Ø¯ÙŠØ« Ø§Ù„ÙÙˆØ±ÙŠ */
    .saving{opacity:.5;pointer-events:none}
    .row-highlight{animation:flash .8s ease}
    @keyframes flash{0%{background:#fff3cd}100%{background:transparent}}

    /* Ø¬Ø¯ÙˆÙ„ Ø«Ø§Ø¨Øª Ø§Ù„Ø±Ø£Ø³ */
    .table-responsive{max-height:540px;overflow:auto}
    thead th{position:sticky;top:0;z-index:1;background:#fff}

    /* Ù‚ÙˆØ© ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± */
    .pw-meter{height:6px;border-radius:6px;overflow:hidden;background:#e9ecef}
    .pw-meter > div{height:100%}

    /* Ø£Ø¯ÙˆØ§Øª Ø£Ø¹Ù„Ù‰ Ø§Ù„Ø¬Ø¯ÙˆÙ„ */
    .toolbar{gap:.5rem}
  </style>
</head>
<body>
  <div class="container">
    <!-- Header -->
    <div class="d-flex flex-wrap justify-content-between align-items-center mb-4 gap-2">
      <div class="d-flex align-items-center gap-2">
        <a class="btn btn-outline-primary" href="/committees-home.html">
          <i class="bi bi-arrow-right-circle"></i> Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ…
        </a>
        <h3 class="mb-0">Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ†</h3>
      </div>
      <div class="d-flex align-items-center gap-2">
        <span id="userInfo" class="user-chip badge bg-light text-dark border">
          <i class="bi bi-person"></i>
          <span id="userUsername">â€”</span>
          <span class="mx-1">â€”</span>
          <span id="userFullName">â€”</span>
          <span class="ms-2 badge bg-secondary" id="userRole">â€”</span>
        </span>
        <button id="logoutBtn" class="btn btn-danger">
          <i class="bi bi-box-arrow-right"></i> Ø®Ø±ÙˆØ¬
        </button>
      </div>
    </div>

    <!-- Ø¥Ø¶Ø§ÙØ© Ù…Ø³ØªØ®Ø¯Ù… -->
    <div class="card mb-4">
      <div class="card-body">
        <h5 class="card-title mb-3"><i class="bi bi-person-plus"></i> Ø¥Ø¶Ø§ÙØ© Ù…Ø³ØªØ®Ø¯Ù… Ø¬Ø¯ÙŠØ¯</h5>
        <form id="addUserForm" class="row g-3">
          <div class="col-md-3">
            <label class="form-label">Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…</label>
            <input type="text" class="form-control" name="username" autocomplete="username" required>
            <div class="form-text" id="userCheckHint"></div>
          </div>
          <div class="col-md-3">
            <label class="form-label">Ø§Ù„Ø§Ø³Ù… Ø§Ù„ÙƒØ§Ù…Ù„</label>
            <input type="text" class="form-control" name="name" required>
          </div>
          <div class="col-md-3">
            <label class="form-label">Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ</label>
            <input type="email" class="form-control" name="email" autocomplete="email" required>
            <div class="form-text" id="emailCheckHint"></div>
          </div>
          <div class="col-md-3">
            <label class="form-label">ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±</label>
            <div class="input-group">
              <input type="password" class="form-control" name="password" id="pwInput" minlength="8" required>
              <button type="button" class="btn btn-outline-secondary" id="genPwBtn" title="ØªÙˆÙ„ÙŠØ¯ ÙƒÙ„Ù…Ø© Ù‚ÙˆÙŠØ©"><i class="bi bi-magic"></i></button>
            </div>
            <div class="pw-meter mt-2"><div id="pwBar"></div></div>
            <div class="form-text" id="pwHint">ÙŠÙØ¶Ù‘Ù„ 10+ Ø£Ø­Ø±Ù Ù…Ø¹ Ø­Ø±ÙˆÙ ÙƒØ¨ÙŠØ±Ø© ÙˆØµØºÙŠØ±Ø© ÙˆØ£Ø±Ù‚Ø§Ù… ÙˆØ±Ù…ÙˆØ².</div>
          </div>
          <div class="col-md-3">
            <label class="form-label">Ø§Ù„Ø¯ÙˆØ±</label>
            <select class="form-select" name="role" required>
              <option value="user">user</option>
              <option value="admin">admin</option>
            </select>
          </div>
          <div class="col-12">
            <button class="btn btn-primary" id="addBtn"><span class="btn-label"><i class="bi bi-check2-circle"></i> Ø¥Ø¶Ø§ÙØ©</span></button>
            <span class="ms-2 text-muted muted">ÙŠÙØ³Ø¬Ù‘ÙÙ„ Ø§Ù„Ø­Ø¯Ø« ÙÙŠ Ø³Ø¬Ù„ Ø§Ù„Ø¹Ù…Ù„ÙŠØ§Øª.</span>
          </div>
        </form>
      </div>
    </div>

    <!-- Ø£Ø¯ÙˆØ§Øª Ø§Ù„Ø¬Ø¯ÙˆÙ„ -->
    <div class="card mb-3">
      <div class="card-body d-flex flex-wrap align-items-end toolbar">
        <div>
          <label class="form-label">Ø¨Ø­Ø«</label>
          <input type="text" id="q" class="form-control" placeholder="Ø§Ø³Ù…/Ø§Ø³Ù… Ù…Ø³ØªØ®Ø¯Ù…/Ø¨Ø±ÙŠØ¯">
        </div>
        <div>
          <label class="form-label">Ø§Ù„Ø¯ÙˆØ±</label>
          <select id="fRole" class="form-select">
            <option value="">Ø§Ù„ÙƒÙ„</option>
            <option value="admin">admin</option>
            <option value="user">user</option>
          </select>
        </div>
        <div>
          <label class="form-label">Ø§Ù„Ø­Ø§Ù„Ø©</label>
          <select id="fActive" class="form-select">
            <option value="">Ø§Ù„ÙƒÙ„</option>
            <option value="true">Ù†Ø´Ø·</option>
            <option value="false">Ù…Ø¹Ø·Ù‘Ù„</option>
          </select>
        </div>
        <div>
          <label class="form-label">Ø§Ù„ØªØ±ØªÙŠØ¨</label>
          <select id="sort" class="form-select">
            <option value="-createdAt">Ø§Ù„Ø£Ø­Ø¯Ø« Ø£ÙˆÙ„Ù‹Ø§</option>
            <option value="createdAt">Ø§Ù„Ø£Ù‚Ø¯Ù… Ø£ÙˆÙ„Ù‹Ø§</option>
            <option value="name">Ø§Ù„Ø§Ø³Ù… (Ø£-ÙŠ)</option>
            <option value="-name">Ø§Ù„Ø§Ø³Ù… (ÙŠ-Ø£)</option>
          </select>
        </div>
        <div>
          <label class="form-label">Ù„ÙƒÙ„ ØµÙØ­Ø©</label>
          <select id="limit" class="form-select">
            <option>10</option><option selected>20</option><option>50</option>
          </select>
        </div>
        <div class="ms-auto d-flex gap-2">
          <button class="btn btn-outline-secondary" id="btnExport"><i class="bi bi-filetype-csv"></i> ØªØµØ¯ÙŠØ± CSV</button>
          <button class="btn btn-outline-secondary" id="btnReload"><i class="bi bi-arrow-repeat"></i> ØªØ­Ø¯ÙŠØ«</button>
        </div>
      </div>
    </div>

    <!-- Ø§Ù„Ø¬Ø¯ÙˆÙ„ -->
    <div class="card">
      <div class="card-body">
        <!-- Ø´Ø±ÙŠØ· Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª Ø¬Ù…Ø§Ø¹ÙŠØ© -->
        <div class="d-flex justify-content-between align-items-center mb-2">
          <div class="d-flex flex-wrap gap-2">
            <button class="btn btn-sm btn-outline-success" id="bulkActivate" disabled><i class="bi bi-toggle-on"></i> ØªÙØ¹ÙŠÙ„</button>
            <button class="btn btn-sm btn-outline-warning" id="bulkDeactivate" disabled><i class="bi bi-toggle-off"></i> ØªØ¹Ø·ÙŠÙ„</button>
            <div class="btn-group">
              <button class="btn btn-sm btn-outline-secondary dropdown-toggle" data-bs-toggle="dropdown"><i class="bi bi-person-gear"></i> ØªØºÙŠÙŠØ± Ø§Ù„Ø¯ÙˆØ±</button>
              <ul class="dropdown-menu">
                <li><a class="dropdown-item" href="#" data-role="admin">Ø§Ø¬Ø¹Ù„Ù‡Ù… admin</a></li>
                <li><a class="dropdown-item" href="#" data-role="user">Ø§Ø¬Ø¹Ù„Ù‡Ù… user</a></li>
              </ul>
            </div>
            <button class="btn btn-sm btn-outline-danger" id="bulkDelete" disabled><i class="bi bi-trash3"></i> Ø­Ø°Ù Ø§Ù„Ù…Ø­Ø¯Ø¯</button>
          </div>
          <div class="text-muted"><span id="countSpan">â€”</span></div>
        </div>

        <div class="table-responsive">
          <table class="table table-hover align-middle">
            <thead class="table-light">
              <tr>
                <th style="width:40px" class="text-center"><input class="form-check-input" type="checkbox" id="chkAll"></th>
                <th>#</th>
                <th>Ø§Ù„Ø§Ø³Ù… Ø§Ù„ÙƒØ§Ù…Ù„</th>
                <th>Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…</th>
                <th>Ø§Ù„Ø¨Ø±ÙŠØ¯</th>
                <th>Ø§Ù„Ø¯ÙˆØ±</th>
                <th>Ø§Ù„Ø­Ø§Ù„Ø©</th>
                <th>Ø¢Ø®Ø± Ø¥Ù†Ø´Ø§Ø¡</th>
                <th>Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª</th>
              </tr>
            </thead>
            <tbody id="usersTbody">
              <!-- Ø³ÙƒÙ„ØªÙˆÙ† Ø£ÙˆÙ„ÙŠ -->
              <tr><td colspan="9">
                <div class="skeleton" style="height:18px;margin:8px 0;"></div>
                <div class="skeleton" style="height:18px;margin:8px 0;"></div>
                <div class="skeleton" style="height:18px;margin:8px 0;"></div>
              </td></tr>
            </tbody>
          </table>
        </div>

        <!-- ØµÙØ­Ø§Øª -->
        <div class="d-flex justify-content-between align-items-center mt-3">
          <div class="text-muted">Ø§Ù„ØµÙØ­Ø© <span id="pageNum">1</span></div>
          <div class="btn-group">
            <button class="btn btn-outline-secondary btn-sm" id="prevPage"><i class="bi bi-chevron-right"></i> Ø§Ù„Ø³Ø§Ø¨Ù‚</button>
            <button class="btn btn-outline-secondary btn-sm" id="nextPage">Ø§Ù„ØªØ§Ù„ÙŠ <i class="bi bi-chevron-left"></i></button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Modal: Ø¥Ø¹Ø§Ø¯Ø© ÙƒÙ„Ù…Ø© Ù…Ø±ÙˆØ± -->
  <div class="modal fade" id="resetPwModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ† ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <div class="mb-2">Ø³ÙŠØªÙ… ØªØ¹ÙŠÙŠÙ† ÙƒÙ„Ù…Ø© Ù…Ø±ÙˆØ± Ø¬Ø¯ÙŠØ¯Ø© Ù„Ù„Ù…Ø³ØªØ®Ø¯Ù…: <strong id="resetTargetName">â€”</strong></div>
          <label class="form-label">ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø©</label>
          <div class="input-group">
            <input type="text" id="newPwInput" class="form-control" autocomplete="off">
            <button class="btn btn-outline-secondary" id="regenBtn" type="button"><i class="bi bi-magic"></i></button>
          </div>
          <div class="form-text">Ø§Ù†Ø³Ø®Ù‡Ø§ ÙˆØ£Ø¨Ù„Øº Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø¨Ù‡Ø§ Ø¨Ø£Ù…Ø§Ù†.</div>
        </div>
        <div class="modal-footer">
          <button class="btn btn-secondary" data-bs-dismiss="modal">Ø¥ØºÙ„Ø§Ù‚</button>
          <button class="btn btn-primary" id="applyResetBtn"><i class="bi bi-check2-circle"></i> ØªØ·Ø¨ÙŠÙ‚</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Toasts -->
  <div class="toast-container position-fixed top-0 start-50 translate-middle-x p-3" style="z-index:2000">
    <div id="toastSuccess" class="toast align-items-center text-bg-success border-0 mb-2" role="alert" aria-live="assertive" aria-atomic="true">
      <div class="d-flex">
        <div class="toast-body">âœ… ØªÙ… Ø§Ù„ØªÙ†ÙÙŠØ° Ø¨Ù†Ø¬Ø§Ø­</div>
        <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button>
      </div>
    </div>
    <div id="toastError" class="toast align-items-center text-bg-danger border-0 mb-2" role="alert" aria-live="assertive" aria-atomic="true">
      <div class="d-flex">
        <div class="toast-body">âŒ Ø­Ø¯Ø« Ø®Ø·Ø£</div>
        <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button>
      </div>
    </div>
    <div id="toastInfo" class="toast align-items-center text-bg-primary border-0 mb-2" role="status" aria-live="polite" aria-atomic="true">
      <div class="d-flex">
        <div class="toast-body">â„¹ï¸ Ù…Ø¹Ù„ÙˆÙ…Ø§Øª</div>
        <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button>
      </div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  <script>
    /* ====== Toasts ====== */
    const toastSuccess = new bootstrap.Toast(document.getElementById('toastSuccess'));
    const toastError   = new bootstrap.Toast(document.getElementById('toastError'));
    const toastInfo    = new bootstrap.Toast(document.getElementById('toastInfo'));
    const setToast = (el,msg)=>{ el._element.querySelector('.toast-body').innerText = msg; };

    /* ====== Auth ====== */
    async function fetchMe(){
      try{
        const r = await fetch('/auth/committees/me',{credentials:'include'});
        if(!r.ok) throw 0;
        return await r.json();
      }catch{ return {authenticated:false}; }
    }
    function renderUser(user){
      const username = user?.username || (user?.email? user.email.split('@')[0] : 'â€”');
      document.getElementById('userUsername').textContent = username;
      document.getElementById('userFullName').textContent = user?.name || 'â€”';
      document.getElementById('userRole').textContent = user?.role || 'â€”';
    }
    async function ensureAdmin(){
      const me = await fetchMe();
      if(!me.authenticated){
        const next = encodeURIComponent('/users-manage.html');
        location.href = `/committees-login.html?next=${next}`;
        return Promise.reject();
      }
      if((me.user?.role||'').toLowerCase()!=='admin'){
        setToast(toastError,'âŒ Ù‡Ø°Ù‡ Ø§Ù„ØµÙØ­Ø© Ù„Ù„Ù…Ø´Ø±ÙÙŠÙ† ÙÙ‚Ø·'); toastError.show();
        setTimeout(()=>location.href='/committees-home.html',1000);
        return Promise.reject();
      }
      renderUser(me.user);
      return me.user;
    }
    document.getElementById('logoutBtn').addEventListener('click', async ()=>{
      try{
        const r = await fetch('/auth/committees/logout',{method:'POST',headers:{'Content-Type':'application/json'},credentials:'include'});
        if(r.ok){ setToast(toastSuccess,'âœ… ØªÙ… ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬'); toastSuccess.show(); setTimeout(()=>location.href='/committees-login.html',700); }
        else{ setToast(toastError,'âŒ ØªØ¹Ø°Ø± ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬'); toastError.show(); }
      }catch{ setToast(toastError,'âŒ Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø§ØªØµØ§Ù„'); toastError.show(); }
    });

    /* ====== Helpers ====== */
    const qs = {
      get(){ return new URLSearchParams(location.search); },
      set(obj){
        const p = new URLSearchParams();
        Object.entries(obj).forEach(([k,v])=>{ if(v!=='' && v!=null) p.set(k,v); });
        history.replaceState(null,'','?'+p.toString());
      }
    };
    const state = {
      page: 1, limit: 20, sort: '-createdAt',
      search: '', role: '', active: '',
      total: 0, items: [],
      selected: new Set(),
    };

    function saveFilters(){
      localStorage.setItem('users.filters', JSON.stringify({
        search: state.search, role: state.role, active: state.active, sort: state.sort, limit: state.limit
      }));
    }
    function loadFilters(){
      try{
        const o = JSON.parse(localStorage.getItem('users.filters')||'{}');
        if(o.search!=null) document.getElementById('q').value = o.search;
        if(o.role!=null)   document.getElementById('fRole').value = o.role;
        if(o.active!=null) document.getElementById('fActive').value = o.active;
        if(o.sort!=null)   document.getElementById('sort').value = o.sort;
        if(o.limit!=null)  document.getElementById('limit').value = o.limit;
      }catch{}
    }

    const tbody = document.getElementById('usersTbody');
    function rowCheckbox(id, checked){ return `<input class="form-check-input chkRow" type="checkbox" value="${id}" ${checked?'checked':''}>`; }
    function roleSelect(id, role){ return `
      <select class="form-select form-select-sm inline-role" data-id="${id}" title="ØªØºÙŠÙŠØ± ÙÙˆØ±ÙŠ">
        <option value="user" ${role==='user'?'selected':''}>user</option>
        <option value="admin" ${role==='admin'?'selected':''}>admin</option>
      </select>`; }
    function activeToggle(id, isActive){ return `
      <div class="form-check form-switch">
        <input class="form-check-input inline-active" type="checkbox" role="switch" data-id="${id}" ${isActive?'checked':''} title="ØªÙØ¹ÙŠÙ„/ØªØ¹Ø·ÙŠÙ„ ÙÙˆØ±ÙŠ">
      </div>`; }

    function renderRows(users, offset=0){
      if(!Array.isArray(users) || users.length===0){
        tbody.innerHTML = `<tr class="text-center text-muted"><td colspan="9">Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ù†ØªØ§Ø¦Ø¬</td></tr>`;
        return;
      }
      tbody.innerHTML = users.map((u,i)=>`
        <tr data-id="${u._id||u.id}">
          <td class="text-center">${rowCheckbox(u._id||u.id, state.selected.has(u._id||u.id))}</td>
          <td>${offset + i + 1}</td>
          <td>${u.name||'â€”'}</td>
          <td><span class="badge text-bg-light">${u.username||'â€”'}</span></td>
          <td>${u.email||'â€”'}</td>
          <td style="width:140px">${roleSelect(u._id||u.id, u.role||'user')}</td>
          <td style="width:110px">
            ${u.isActive===false?'<span class="badge badge-inactive">Ù…Ø¹Ø·Ù‘Ù„</span>':'<span class="badge badge-active">Ù†Ø´Ø·</span>'}
            ${activeToggle(u._id||u.id, u.isActive!==false)}
          </td>
          <td>${u.createdAt? new Date(u.createdAt).toLocaleString('ar-EG') : 'â€”'}</td>
          <td>
            <button class="btn btn-sm btn-outline-primary resetBtn" data-id="${u._id||u.id}" data-name="${u.name||u.username||'â€”'}"><i class="bi bi-key"></i></button>
            <button class="btn btn-sm btn-outline-danger delBtn" data-id="${u._id||u.id}" data-name="${u.name||u.username||'â€”'}"><i class="bi bi-trash3"></i></button>
          </td>
        </tr>
      `).join('');
      updateBulkBar();
    }

    function updateBulkBar(){
      const any = state.selected.size>0;
      document.getElementById('bulkActivate').disabled = !any;
      document.getElementById('bulkDeactivate').disabled = !any;
      document.getElementById('bulkDelete').disabled = !any;
      document.getElementById('countSpan').textContent = `Ø§Ù„Ù…Ø­Ø¯Ù‘Ø¯: ${state.selected.size} | Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ: ${state.total}`;
    }

    /* ====== ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ† ====== */
    async function fetchUsers(){
      // Ù‚Ø±Ø§Ø¡Ø© Ø§Ù„ÙÙ„Ø§ØªØ± Ù…Ù† UI
      state.search = document.getElementById('q').value.trim();
      state.role   = document.getElementById('fRole').value;
      state.active = document.getElementById('fActive').value;
      state.sort   = document.getElementById('sort').value;
      state.limit  = parseInt(document.getElementById('limit').value,10) || 20;

      saveFilters();
      qs.set({ q: state.search, role: state.role, active: state.active, sort: state.sort, limit: state.limit, page: state.page });

      tbody.innerHTML = `<tr><td colspan="9">
        <div class="skeleton" style="height:18px;margin:8px 0;"></div>
        <div class="skeleton" style="height:18px;margin:8px 0;"></div>
        <div class="skeleton" style="height:18px;margin:8px 0;"></div>
      </td></tr>`;
      try{
        const params = new URLSearchParams();
        if(state.search) params.set('search',state.search);
        if(state.role)   params.set('role',state.role);
        if(state.active) params.set('active',state.active);
        if(state.sort)   params.set('sort',state.sort);
        params.set('page', state.page);
        params.set('limit', state.limit);

        const r = await fetch('/api/users?'+params.toString(), { credentials:'include' });
        if(r.status===401 || r.status===403){
          setToast(toastError,'âŒ Ø§Ù†ØªÙ‡Øª Ø§Ù„Ø¬Ù„Ø³Ø© Ø£Ùˆ Ù„Ø§ ØªÙ…Ù„Ùƒ ØµÙ„Ø§Ø­ÙŠØ©'); toastError.show();
          setTimeout(()=>location.href='/committees-login.html',900);
          return;
        }
        if(!r.ok) throw new Error('HTTP '+r.status);
        const data = await r.json();
        state.items = data.data || data; // ÙŠØ¯Ø¹Ù… Ø§Ù„Ø§Ø³ØªØ¬Ø§Ø¨Ø© Ø§Ù„Ù‚Ø¯ÙŠÙ…Ø© (Ù…ØµÙÙˆÙØ©) Ø£Ùˆ Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø© ({data,meta})
        state.total = data?.meta?.total ?? state.items.length;
        document.getElementById('pageNum').textContent = state.page;
        renderRows(state.items, (state.page-1)*state.limit);
      }catch(e){
        tbody.innerHTML = `<tr class="text-center text-danger"><td colspan="9">Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ Ø¬Ù„Ø¨ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ†</td></tr>`;
      }
    }

    /* ====== ØªØ¹Ø¯ÙŠÙ„ ÙÙˆØ±ÙŠ: Ø§Ù„Ø¯ÙˆØ±/Ø§Ù„Ø­Ø§Ù„Ø© ====== */
    async function updateUserPartial(id, patch){
      const row = tbody.querySelector(`tr[data-id="${id}"]`);
      row?.classList.add('saving');
      try{
        const r = await fetch('/api/users/'+id,{
          method:'PUT',
          headers:{'Content-Type':'application/json'},
          credentials:'include',
          body: JSON.stringify(patch)
        });
        const data = await r.json().catch(()=> ({}));
        if(!r.ok) throw new Error(data?.message || 'ÙØ´Ù„ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„');
        row?.classList.add('row-highlight');
        setTimeout(()=>row?.classList.remove('row-highlight'),600);
        return true;
      }catch(err){
        setToast(toastError,'âŒ '+(err.message||'ÙØ´Ù„ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„')); toastError.show();
        return false;
      }finally{
        row?.classList.remove('saving');
        fetchUsers(); // Ù„ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø´Ø§Ø±Ø§Øª
      }
    }

    /* ====== Ø­Ø°Ù ÙˆØ§Ø­Ø¯ ====== */
    async function deleteUser(id, name){
      if(!confirm(`Ø³ÙŠØªÙ… Ø­Ø°Ù Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…: ${name}\nÙ„Ø§ ÙŠÙ…ÙƒÙ† Ø§Ù„ØªØ±Ø§Ø¬Ø¹.`)) return;
      try{
        const r = await fetch('/api/users/'+id,{ method:'DELETE', credentials:'include' });
        const data = await r.json().catch(()=> ({}));
        if(!r.ok) throw new Error(data?.message || 'ÙØ´Ù„ Ø§Ù„Ø­Ø°Ù');
        setToast(toastSuccess,'ğŸ—‘ï¸ ØªÙ… Ø­Ø°Ù Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…'); toastSuccess.show();
        state.selected.delete(id);
        fetchUsers();
      }catch(err){
        setToast(toastError,'âŒ '+(err.message||'ÙØ´Ù„ Ø§Ù„Ø­Ø°Ù')); toastError.show();
      }
    }

    /* ====== Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ† ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± ====== */
    const resetModal = new bootstrap.Modal(document.getElementById('resetPwModal'));
    let resetTargetId = null;
    function genStrongPw(){
      const chars = 'ABCDEFGHJKLMNPQRSTUVWXYZabcdefghijkmnopqrstuvwxyz23456789!@#$%^&*()_+-=';
      let s=''; for(let i=0;i<14;i++) s += chars[Math.floor(Math.random()*chars.length)];
      return s;
    }
    document.getElementById('regenBtn').addEventListener('click', ()=>{
      document.getElementById('newPwInput').value = genStrongPw();
    });
    document.getElementById('applyResetBtn').addEventListener('click', async ()=>{
      const pw = document.getElementById('newPwInput').value.trim();
      if(!pw){ setToast(toastInfo,'Ø£Ø¯Ø®Ù„ ÙƒÙ„Ù…Ø© Ù…Ø±ÙˆØ± Ø¬Ø¯ÙŠØ¯Ø©'); toastInfo.show(); return; }
      try{
        const r = await fetch('/api/users/'+resetTargetId+'/password',{
          method:'PUT', credentials:'include',
          headers:{'Content-Type':'application/json'},
          body: JSON.stringify({ newPassword: pw })
        });
        const data = await r.json().catch(()=> ({}));
        if(!r.ok) throw new Error(data?.message || 'ÙØ´Ù„ Ø§Ù„ØªØºÙŠÙŠØ±');
        setToast(toastSuccess,'âœ… ØªÙ… ØªØºÙŠÙŠØ± ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±'); toastSuccess.show();
        resetModal.hide();
      }catch(err){
        setToast(toastError,'âŒ '+(err.message||'ÙØ´Ù„ ØªØºÙŠÙŠØ± ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±')); toastError.show();
      }
    });

    /* ====== Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª Ø¬Ù…Ø§Ø¹ÙŠØ© ====== */
    async function bulkAction(payload, okMsg){
      if(state.selected.size===0) return;
      try{
        const r = await fetch('/api/users/bulk',{
          method:'POST', credentials:'include',
          headers:{'Content-Type':'application/json'},
          body: JSON.stringify({ ids:[...state.selected], ...payload })
        });
        const data = await r.json().catch(()=> ({}));
        if(!r.ok) throw new Error(data?.message || 'ÙØ´Ù„ Ø§Ù„ØªÙ†ÙÙŠØ°');
        setToast(toastSuccess, okMsg); toastSuccess.show();
        state.selected.clear();
        fetchUsers();
      }catch(err){
        setToast(toastError,'âŒ '+(err.message||'ÙØ´Ù„ Ø§Ù„ØªÙ†ÙÙŠØ°')); toastError.show();
      }
    }

    /* ====== Ø¥Ø¶Ø§ÙØ© Ù…Ø³ØªØ®Ø¯Ù… (ØªØ­Ù‚Ù‚ ÙÙˆØ±ÙŠ + Ù…Ù‚ÙŠØ§Ø³ Ù‚ÙˆØ©) ====== */
    const addForm = document.getElementById('addUserForm');
    const addBtn = document.getElementById('addBtn');
    function pwStrength(pw){
      let s=0;
      if(pw.length>=8) s++;
      if(/[A-Z]/.test(pw) && /[a-z]/.test(pw)) s++;
      if(/\d/.test(pw)) s++;
      if(/[^A-Za-z0-9]/.test(pw)) s++;
      if(pw.length>=12) s++;
      return Math.min(s,5);
    }
    function renderPwMeter(){
      const pw = document.getElementById('pwInput').value;
      const score = pwStrength(pw);
      const bar = document.getElementById('pwBar');
      const colors = ['#dc3545','#fd7e14','#ffc107','#20c997','#198754'];
      bar.style.width = (score*20)+'%';
      bar.style.background = colors[Math.max(0,score-1)] || '#e9ecef';
    }
    document.getElementById('pwInput').addEventListener('input', renderPwMeter);
    document.getElementById('genPwBtn').addEventListener('click', ()=>{
      const p = genStrongPw();
      document.getElementById('pwInput').value = p;
      renderPwMeter();
    });

    // ØªØ­Ù‚Ù‘Ù‚ Ø¨Ø³ÙŠØ· Ù…Ù† Ø§Ù„ØªÙØ±Ù‘Ø¯ Ø¹Ø¨Ø± Ø§Ù„Ø¨Ø­Ø« (ÙŠØ¹ØªÙ…Ø¯ ØªÙˆØ³Ø¹Ø© GET /api/users)
    let _debTimer;
    function debounce(fn,ms){ return (...a)=>{ clearTimeout(_debTimer); _debTimer=setTimeout(()=>fn(...a),ms); }; }
    const checkUnique = debounce(async ()=>{
      const u = addForm.username.value.trim();
      const e = addForm.email.value.trim();
      if(!u && !e) return;
      try{
        const params = new URLSearchParams({ search: u||e, limit: 5 });
        const r = await fetch('/api/users?'+params.toString(), { credentials:'include' });
        if(!r.ok) return;
        const data = await r.json();
        const arr = data.data || data;
        const uTaken = u && arr.some(x => (x.username||'').toLowerCase()===u.toLowerCase());
        const eTaken = e && arr.some(x => (x.email||'').toLowerCase()===e.toLowerCase());
        document.getElementById('userCheckHint').textContent = uTaken ? 'âš ï¸ Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ù…Ø³ØªØ®Ø¯Ù…' : '';
        document.getElementById('emailCheckHint').textContent = eTaken ? 'âš ï¸ Ø§Ù„Ø¨Ø±ÙŠØ¯ Ù…Ø³ØªØ®Ø¯Ù…' : '';
      }catch{}
    }, 450);
    addForm.username.addEventListener('blur', checkUnique);
    addForm.email.addEventListener('blur', checkUnique);

    addForm.addEventListener('submit', async (e)=>{
      e.preventDefault();
      addBtn.disabled = true; addBtn.classList.add('saving');
      try{
        const fd = new FormData(addForm);
        const payload = Object.fromEntries(fd.entries());
        const r = await fetch('/auth/committees/register', {
          method:'POST', headers:{'Content-Type':'application/json'}, credentials:'include',
          body: JSON.stringify(payload)
        });
        const data = await r.json().catch(()=> ({}));
        if(!r.ok) throw new Error(data?.message || 'ÙØ´Ù„ Ø§Ù„Ø¥Ø¶Ø§ÙØ©');
        setToast(toastSuccess,'âœ… ØªÙ… Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…'); toastSuccess.show();
        addForm.reset(); renderPwMeter();
        // Ø§Ù„Ø¹ÙˆØ¯Ø© Ø¥Ù„Ù‰ Ø§Ù„ØµÙØ­Ø© 1 Ù„Ø±Ø¤ÙŠØ© Ø§Ù„Ø¬Ø¯ÙŠØ¯
        state.page = 1; fetchUsers();
      }catch(err){
        setToast(toastError,'âŒ '+(err.message||'ÙØ´Ù„ Ø§Ù„Ø¥Ø¶Ø§ÙØ©')); toastError.show();
      }finally{
        addBtn.disabled = false; addBtn.classList.remove('saving');
      }
    });

    /* ====== ØªØµØ¯ÙŠØ± CSV Ù„Ù…Ø§ Ù‡Ùˆ Ù…Ø¹Ø±ÙˆØ¶ ====== */
    function exportCSV(rows){
      const header = ['name','username','email','role','isActive','createdAt'];
      const toCSV = s => `"${String(s??'').replace(/"/g,'""')}"`;
      const lines = [header.join(',')].concat(rows.map(r =>
        [r.name, r.username, r.email, r.role, r.isActive!==false, r.createdAt?new Date(r.createdAt).toISOString():'']
          .map(toCSV).join(',')
      ));
      const blob = new Blob([lines.join('\n')], {type:'text/csv;charset=utf-8;'});
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a'); a.href = url; a.download = 'users.csv'; a.click();
      URL.revokeObjectURL(url);
    }

    /* ====== Ø£Ø­Ø¯Ø§Ø« Ø§Ù„Ø¬Ø¯ÙˆÙ„ ====== */
    document.getElementById('btnReload').addEventListener('click', ()=>{ state.page=1; fetchUsers(); });
    document.getElementById('btnExport').addEventListener('click', ()=> exportCSV(state.items));

    document.getElementById('q').addEventListener('input', debounce(()=>{ state.page=1; fetchUsers(); }, 400));
    document.getElementById('fRole').addEventListener('change', ()=>{ state.page=1; fetchUsers(); });
    document.getElementById('fActive').addEventListener('change', ()=>{ state.page=1; fetchUsers(); });
    document.getElementById('sort').addEventListener('change', ()=>{ state.page=1; fetchUsers(); });
    document.getElementById('limit').addEventListener('change', ()=>{ state.page=1; fetchUsers(); });

    document.getElementById('prevPage').addEventListener('click', ()=>{ if(state.page>1){ state.page--; fetchUsers(); } });
    document.getElementById('nextPage').addEventListener('click', ()=>{ if(state.items.length===state.limit){ state.page++; fetchUsers(); } });

    document.getElementById('chkAll').addEventListener('change', (e)=>{
      const ch = e.target.checked;
      document.querySelectorAll('.chkRow').forEach(x=>{
        x.checked = ch;
        const id = x.value;
        if(ch) state.selected.add(id); else state.selected.delete(id);
      });
      updateBulkBar();
    });

    tbody.addEventListener('change', (e)=>{
      const t = e.target;
      if(t.classList.contains('chkRow')){
        const id = t.value;
        if(t.checked) state.selected.add(id); else state.selected.delete(id);
        // ØªØ­Ø¯ÙŠØ« Ø­Ø§Ù„Ø© "ØªØ­Ø¯ÙŠØ¯ Ø§Ù„ÙƒÙ„"
        const all = Array.from(tbody.querySelectorAll('.chkRow'));
        document.getElementById('chkAll').checked = (all.length>0 && all.every(x=>x.checked));
        updateBulkBar();
      } else if(t.classList.contains('inline-role')){
        const id = t.dataset.id;
        updateUserPartial(id, { role: t.value });
      } else if(t.classList.contains('inline-active')){
        const id = t.dataset.id;
        updateUserPartial(id, { isActive: t.checked });
      }
    });

    tbody.addEventListener('click', (e)=>{
      const btn = e.target.closest('button');
      if(!btn) return;
      if(btn.classList.contains('delBtn')){
        deleteUser(btn.dataset.id, btn.dataset.name);
      }else if(btn.classList.contains('resetBtn')){
        resetTargetId = btn.dataset.id;
        document.getElementById('resetTargetName').textContent = btn.dataset.name;
        document.getElementById('newPwInput').value = genStrongPw();
        resetModal.show();
      }
    });

    // ØªØºÙŠÙŠØ± Ø§Ù„Ø¯ÙˆØ± Ø¬Ù…Ø§Ø¹ÙŠÙ‹Ø§ Ù…Ù† Ø§Ù„Ù‚Ø§Ø¦Ù…Ø©
    document.querySelectorAll('.dropdown-menu [data-role]').forEach(a=>{
      a.addEventListener('click', (e)=>{
        e.preventDefault();
        const role = a.dataset.role;
        if(state.selected.size===0) return;
        bulkAction({ action:'set-role', role }, 'âœ… ØªÙ… ØªØºÙŠÙŠØ± Ø§Ù„Ø£Ø¯ÙˆØ§Ø±');
      });
    });
    document.getElementById('bulkActivate').addEventListener('click', ()=> bulkAction({ action:'activate' }, 'âœ… ØªÙ… ØªÙØ¹ÙŠÙ„ Ø§Ù„Ù…Ø­Ø¯Ø¯ÙŠÙ†'));
    document.getElementById('bulkDeactivate').addEventListener('click', ()=> bulkAction({ action:'deactivate' }, 'âœ… ØªÙ… ØªØ¹Ø·ÙŠÙ„ Ø§Ù„Ù…Ø­Ø¯Ø¯ÙŠÙ†'));
    document.getElementById('bulkDelete').addEventListener('click', ()=>{
      if(confirm(`Ø³ÙŠØªÙ… Ø­Ø°Ù ${state.selected.size} Ù…Ø³ØªØ®Ø¯Ù…/ÙŠÙ†. Ù„Ø§ ÙŠÙ…ÙƒÙ† Ø§Ù„ØªØ±Ø§Ø¬Ø¹.`)){
        bulkAction({ action:'delete' }, 'ğŸ—‘ï¸ ØªÙ… Ø­Ø°Ù Ø§Ù„Ù…Ø­Ø¯Ø¯ÙŠÙ†');
      }
    });

    /* ====== Ø¥Ù‚Ù„Ø§Ø¹ ====== */
    await ensureAdmin();
    loadFilters();
    // Ù‚Ø±Ø§Ø¡Ø© ØµÙØ­Ø© Ù…Ù† Ø§Ù„Ø§Ø³ØªØ¹Ù„Ø§Ù… Ø¥Ù† ÙˆÙØ¬Ø¯
    const urlp = new URLSearchParams(location.search);
    state.page  = parseInt(urlp.get('page')||'1',10);
    fetchUsers();
  </script>
</body>
</html>
