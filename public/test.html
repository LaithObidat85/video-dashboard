<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <title>ุฅุถุงูุฉ ุฑูุงุจุท ูููุงุช ุงููุฌุงู - ูุธุงู ุงููุฌุงู</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <link rel="icon" type="image/png" href="https://www.dropbox.com/scl/fi/f283e4rvv5cf9x12a1cic/my-website-logo.png?rlkey=yia776im7klypy27af32m0scy&e=1&st=vhaprvzh&dl=1">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.rtl.min.css">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css">
  <style>
    body{background:#f8f9fa;font-family:'Segoe UI',sans-serif}
    .container{margin-top:40px;max-width:98vw}
    .user-chip{display:inline-flex;align-items:center;gap:.25rem;font-size:1rem!important;padding:.375rem .75rem!important;line-height:1.5!important;border-radius:.375rem;font-weight:700!important}
    .user-chip.badge #userRole{font-weight:500!important}
    .muted{color:#6c757d}
    .toast-container{position:fixed;top:20px;left:50%;transform:translateX(-50%);z-index:2000}
    .required-asterisk{color:#dc3545;margin-inline-start:.25rem}
    .disabled-cover{pointer-events:none;opacity:.65}

    /* ุชุจููุจุงุช */
    .nav-tabs .nav-link{border-radius:.5rem .5rem 0 0}
    .tab-pane{background:#fff;border:1px solid #dee2e6;border-top:0;border-radius:0 0 .5rem .5rem;padding:1rem}

    /* ุตููู ุงูููุงุฆู ุงูุฏููุงููููุฉ */
    .list-row{display:flex;gap:.5rem;align-items:center;background:#fff;border:1px solid #e9ecef;border-radius:.5rem;padding:.5rem}
    .list-row .index{width:2rem;text-align:center;color:#6c757d}
    .list-row .actions .btn{padding:.25rem .5rem}

    /* ููุฎุต */
    .sticky-panel{position:sticky;top:12px}
    .counter-badge{font-weight:700}
  </style>
</head>
<body>
  <div class="container">
    <!-- Header -->
    <div class="d-flex flex-wrap justify-content-between align-items-center mb-4 gap-2">
      <h4 class="mb-0">ุฅุถุงูุฉ ุฑูุงุจุท ูููุงุช ุงููุฌุงู</h4>
      <div class="d-flex align-items-center gap-2">
        <span id="userInfo" class="user-chip badge bg-light text-dark border">
          <i class="bi bi-person"></i>
          <span id="userUsername">โ</span>
          <span class="mx-1">โ</span>
          <span id="userFullName">โ</span>
          <span class="ms-2 badge bg-secondary" id="userRole">โ</span>
        </span>
        <a class="btn btn-outline-primary" id="homeBtn" href="/committees-home.html">
          <i class="bi bi-grid"></i> ููุญุฉ ุงูุชุญูู
        </a>
        <button id="logoutBtn" class="btn btn-danger">
          <i class="bi bi-box-arrow-right"></i> ุฎุฑูุฌ
        </button>
      </div>
    </div>

    <!-- ุงุฎุชูุงุฑ ุงููููุฉ/ุงููุฌูุฉ + ุงููุตู/ุงูุนุงู -->
    <div class="card mb-3">
      <div class="card-body row g-3 align-items-end">
        <div class="col-md-3">
          <label class="form-label">ุงููููุฉ <span class="required-asterisk">*</span></label>
          <select id="collegeSelect" class="form-select">
            <option value="">โ ุงุฎุชุฑ ุงููููุฉ โ</option>
          </select>
        </div>
        <div class="col-md-3">
          <label class="form-label">ุงุณู ุงููุฌูุฉ <span class="required-asterisk">*</span></label>
          <select id="committeeSelect" class="form-select">
            <option value="">โ ุงุฎุชุฑ ุงููุฌูุฉ โ</option>
          </select>
        </div>
        <div class="col-md-2">
          <label class="form-label">ุงููุตู ุงูุฏุฑุงุณู <span class="required-asterisk">*</span></label>
          <select id="termSelect" class="form-select">
            <option value="">โ ุงุฎุชุฑ ุงููุตู โ</option>
            <option value="ุงููุตู ุงูุฃูู">ุงููุตู ุงูุฃูู</option>
            <option value="ุงููุตู ุงูุซุงูู">ุงููุตู ุงูุซุงูู</option>
            <option value="ุงููุตู ุงูุตููู">ุงููุตู ุงูุตููู</option>
          </select>
        </div>
        <div class="col-md-2">
          <label class="form-label">ุงูุนุงู ุงูุฌุงูุนู <span class="required-asterisk">*</span></label>
          <input id="academicYearInput" type="text" class="form-control" placeholder="ูุซุงู: 2024-2025 ุฃู 2024/2025">
          <div id="ayHelp" class="form-text">ุตูุบุฉ ุตุญูุญุฉ: 20xx-20yy ุฃู 20xx/20yy</div>
        </div>
        <div class="col-md-2">
          <div class="alert alert-info w-100 mb-0 py-2">
            ูุชุงุญ ููุฃุฏูุงุฑ: <b>admin</b>ุ <b>user</b>ุ <b>subuser-member</b>
          </div>
        </div>
      </div>
    </div>

    <div class="row g-4">
      <!-- ุงููุณุงุฑ: ุงูุชุจููุจุงุช -->
      <div class="col-lg-9">
        <!-- Tabs -->
        <ul class="nav nav-tabs mb-0" id="filesTabs" role="tablist">
          <li class="nav-item" role="presentation">
            <button class="nav-link active" id="core-tab" data-bs-toggle="tab" data-bs-target="#core" type="button" role="tab" aria-controls="core" aria-selected="true">
              ุงููุณุชูุฏุงุช ุงูุฃุณุงุณูุฉ
            </button>
          </li>
          <li class="nav-item" role="presentation">
            <button class="nav-link" id="inv-tab" data-bs-toggle="tab" data-bs-target="#inv" type="button" role="tab" aria-controls="inv" aria-selected="false">
              ุฏุนูุงุช ุงูุงุฌุชูุงุน <span class="badge bg-secondary ms-1" id="badgeInv">0</span>
            </button>
          </li>
          <li class="nav-item" role="presentation">
            <button class="nav-link" id="min-tab" data-bs-toggle="tab" data-bs-target="#min" type="button" role="tab" aria-controls="min" aria-selected="false">
              ูุญุงุถุฑ ุงูุงุฌุชูุงุน <span class="badge bg-secondary ms-1" id="badgeMin">0</span>
            </button>
          </li>
          <li class="nav-item" role="presentation">
            <button class="nav-link" id="cov-tab" data-bs-toggle="tab" data-bs-target="#cov" type="button" role="tab" aria-controls="cov" aria-selected="false">
              ูุชุจ ุงูุชุบุทูุฉ <span class="badge bg-secondary ms-1" id="badgeCov">0</span>
            </button>
          </li>
          <li class="nav-item" role="presentation">
            <button class="nav-link" id="rep-tab" data-bs-toggle="tab" data-bs-target="#rep" type="button" role="tab" aria-controls="rep" aria-selected="false">
              ุงูุชูุงุฑูุฑ ูุงูุชุญููู
            </button>
          </li>
        </ul>

        <div class="tab-content">
          <!-- ุงููุณุชูุฏุงุช ุงูุฃุณุงุณูุฉ -->
          <div class="tab-pane fade show active" id="core" role="tabpanel" aria-labelledby="core-tab" tabindex="0">
            <div class="row g-3">
              <div class="col-md-6">
                <label class="form-label">ุฑุงุจุท ูุฑุงุฑ ุงูุชุดููู</label>
                <div class="input-group">
                  <span class="input-group-text"><i class="bi bi-link-45deg"></i></span>
                  <input id="fdUrl" type="url" class="form-control" placeholder="https://example.com/formation.pdf">
                </div>
                <div id="fdHint" class="form-text">ุฃุฏุฎู ุฑุงุจุทูุง ูุจุงุดุฑูุง ุฃู ุตูุญุฉ ููุซููุฉ ุชุญุชูู ุนูู ุงููุณุชูุฏ.</div>
              </div>
              <div class="col-md-6">
                <label class="form-label">ุฑุงุจุท ุฎุทุฉ ุงูุนูู</label>
                <div class="input-group">
                  <span class="input-group-text"><i class="bi bi-link-45deg"></i></span>
                  <input id="wpUrl" type="url" class="form-control" placeholder="https://example.com/workplan.pdf">
                </div>
              </div>
            </div>
          </div>

          <!-- ุงูุฏุนูุงุช (ูุชุนุฏุฏ) -->
          <div class="tab-pane fade" id="inv" role="tabpanel" aria-labelledby="inv-tab" tabindex="0">
            <div class="d-flex justify-content-between align-items-center mb-2">
              <h6 class="mb-0">ุฑูุงุจุท ุฏุนูุงุช ุงูุงุฌุชูุงุน</h6>
              <button id="addInvitationBtn" class="btn btn-sm btn-primary"><i class="bi bi-plus-circle"></i> ุฅุถุงูุฉ ุฏุนูุฉ</button>
            </div>
            <div id="invitationsList" class="vstack gap-2"></div>
          </div>

          <!-- ุงููุญุงุถุฑ (ูุชุนุฏุฏ) -->
          <div class="tab-pane fade" id="min" role="tabpanel" aria-labelledby="min-tab" tabindex="0">
            <div class="d-flex justify-content-between align-items-center mb-2">
              <h6 class="mb-0">ุฑูุงุจุท ูุญุงุถุฑ ุงูุงุฌุชูุงุน</h6>
              <button id="addMinuteBtn" class="btn btn-sm btn-primary"><i class="bi bi-plus-circle"></i> ุฅุถุงูุฉ ูุญุถุฑ</button>
            </div>
            <div id="minutesList" class="vstack gap-2"></div>
          </div>

          <!-- ูุชุจ ุงูุชุบุทูุฉ (ูุชุนุฏุฏ) -->
          <div class="tab-pane fade" id="cov" role="tabpanel" aria-labelledby="cov-tab" tabindex="0">
            <div class="d-flex justify-content-between align-items-center mb-2">
              <h6 class="mb-0">ุฑูุงุจุท ูุชุจ ุงูุชุบุทูุฉ</h6>
              <button id="addCoverageBtn" class="btn btn-sm btn-primary"><i class="bi bi-plus-circle"></i> ุฅุถุงูุฉ ูุชุงุจ ุชุบุทูุฉ</button>
            </div>
            <div id="coverageList" class="vstack gap-2"></div>
          </div>

          <!-- ุงูุชูุงุฑูุฑ ูุงูุชุญููู (ููุฑุฏุฉ) -->
          <div class="tab-pane fade" id="rep" role="tabpanel" aria-labelledby="rep-tab" tabindex="0">
            <div class="row g-3">
              <div class="col-md-6">
                <label class="form-label">ุฑุงุจุท ุชูุฑูุฑ ุฅูุฌุงุฒ 1</label>
                <div class="input-group">
                  <span class="input-group-text"><i class="bi bi-link-45deg"></i></span>
                  <input id="r1Url" type="url" class="form-control" placeholder="https://example.com/report1.pdf">
                </div>
              </div>
              <div class="col-md-6">
                <label class="form-label">ุฑุงุจุท ุชูุฑูุฑ ุฅูุฌุงุฒ 2</label>
                <div class="input-group">
                  <span class="input-group-text"><i class="bi bi-link-45deg"></i></span>
                  <input id="r2Url" type="url" class="form-control" placeholder="https://example.com/report2.pdf">
                </div>
              </div>
              <div class="col-md-6">
                <label class="form-label">ุฑุงุจุท ุชูุฑูุฑ ุฅูุฌุงุฒ 3</label>
                <div class="input-group">
                  <span class="input-group-text"><i class="bi bi-link-45deg"></i></span>
                  <input id="r3Url" type="url" class="form-control" placeholder="https://example.com/report3.pdf">
                </div>
              </div>
              <div class="col-md-6">
                <label class="form-label">ุฑุงุจุท ุงูุชุญููู ุงูุฅุญุตุงุฆู</label>
                <div class="input-group">
                  <span class="input-group-text"><i class="bi bi-link-45deg"></i></span>
                  <input id="saUrl" type="url" class="form-control" placeholder="https://example.com/statistics.pdf">
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- ุฅุฌุฑุงุกุงุช -->
        <div class="card mt-3 mb-5">
          <div class="card-body d-flex flex-wrap gap-2">
            <button id="saveBtn" class="btn btn-success"><i class="bi bi-save"></i> ุญูุธ</button>
            <button id="resetBtn" class="btn btn-outline-secondary"><i class="bi bi-arrow-counterclockwise"></i> ุชูุฑูุบ</button>
            <a id="backBtn" class="btn btn-outline-primary" href="#"><i class="bi bi-arrow-right-circle"></i> ุฑุฌูุน</a>
          </div>
        </div>
      </div>

      <!-- ุงููููู: ููุฎุต -->
      <div class="col-lg-3">
        <div class="sticky-panel">
          <div class="card">
            <div class="card-body">
              <h6 class="mb-3">ููุฎุต ุณุฑูุน</h6>
              <div class="small mb-1">ุงููููุฉ: <b id="sumCollege">โ</b></div>
              <div class="small mb-1">ุงููุฌูุฉ: <b id="sumCommittee">โ</b></div>
              <div class="small mb-3">ุงููุตู/ุงูุนุงู: <b id="sumTermAy">โ</b></div>

              <ul class="list-unstyled small vstack gap-2">
                <li>ูุฑุงุฑ ุงูุชุดููู: <span id="sumFD" class="counter-badge">โ</span></li>
                <li>ุฎุทุฉ ุงูุนูู: <span id="sumWP" class="counter-badge">โ</span></li>
                <li>ุงูุฏุนูุงุช: <span id="sumInv" class="counter-badge">0</span></li>
                <li>ุงููุญุงุถุฑ: <span id="sumMin" class="counter-badge">0</span></li>
                <li>ูุชุจ ุงูุชุบุทูุฉ: <span id="sumCov" class="counter-badge">0</span></li>
                <li>ุชูุฑูุฑ 1: <span id="sumR1" class="counter-badge">โ</span></li>
                <li>ุชูุฑูุฑ 2: <span id="sumR2" class="counter-badge">โ</span></li>
                <li>ุชูุฑูุฑ 3: <span id="sumR3" class="counter-badge">โ</span></li>
                <li>ุงูุชุญููู ุงูุฅุญุตุงุฆู: <span id="sumSA" class="counter-badge">โ</span></li>
              </ul>

              <hr>
              <div class="small muted">ุณูุชู ุฑุจุท ุงูุญูุธ ุจููุงูุงุช ุงูุณูุฑูุฑ ูุงุญููุง.</div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Toasts -->
    <div class="toast-container">
      <div id="toastSuccess" class="toast align-items-center text-bg-success border-0 mb-2" role="alert">
        <div class="d-flex"><div class="toast-body">โ ุชู ุชุฌููุฒ ุงูุจูุงูุงุช ููุฅุฑุณุงู</div><button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button></div>
      </div>
      <div id="toastError" class="toast align-items-center text-bg-danger border-0 mb-2" role="alert">
        <div class="d-flex"><div class="toast-body">โ ุญุฏุซ ุฎุทุฃ</div><button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button></div>
      </div>
    </div>
  </div>

  <!-- Scripts -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  <script>
    /* ====== ุจูุฆุฉ ููุญูุฏุฉ ====== */
    const RENDER_BASE='https://vdash-qkyv.onrender.com';
    const host=location.hostname;
    const isGithub=host.endsWith('github.io');
    const isLocal=host==='localhost'||host==='127.0.0.1';
    const API_BASE=isGithub?RENDER_BASE:(isLocal?'http://localhost:3000':'');
    const go=(path)=>isGithub?(RENDER_BASE+path):path;

    const toastSuccess=new bootstrap.Toast(document.getElementById('toastSuccess'));
    const toastError  =new bootstrap.Toast(document.getElementById('toastError'));
    const apiFetch=(path,opts={})=>fetch(`${API_BASE}${path}`,{credentials:'include',...opts});

    /* ====== ุตูุงุญูุงุช/ุฌูุณุฉ ====== */
    let CURRENT_USER=null;
    function renderUser(u){
      const username=u?.username||(u?.email?u.email.split('@')[0]:'โ');
      document.getElementById('userUsername').textContent=username;
      document.getElementById('userFullName').textContent=u?.name||'โ';
      document.getElementById('userRole').textContent=u?.role||'โ';
    }
    async function ensureAuth(){
      try{
        const r=await apiFetch('/auth/committees/me');
        const j=await r.json();
        if(!j?.authenticated){
          location.href=go('/committees-login.html?next='+encodeURIComponent('/committees-files-add.html'));throw 0;
        }
        if(j.user?.isActive===false){
          alert('๐ซ ุญุณุงุจู ูุนุทูู. ุงูุฑุฌุงุก ุงูุชูุงุตู ูุน ุงููุดุฑู.');
          location.href=go('/committees-home.html');throw 0;
        }
        CURRENT_USER=j.user;renderUser(j.user);
      }catch{throw 0;}
    }
    document.getElementById('homeBtn').href=go('/committees-home.html');
    document.getElementById('logoutBtn').addEventListener('click',async()=>{
      try{
        const r=await apiFetch('/auth/committees/logout',{method:'POST',headers:{'Content-Type':'application/json'}});
        if(r.ok){toastSuccess.show();setTimeout(()=>location.href=go('/committees-login.html'),700)}
        else{toastError.show()}
      }catch{toastError.show()}
    });
    document.getElementById('backBtn').href=go('/committees-home.html');

    /* ====== ุงูููุงุฆู (ูููุฉ/ูุฌูุฉ) ====== */
    function normalizeName(item){ if(typeof item==='string') return item; return item?.name||item?.committee_name||item?.college||''; }
    async function loadDatalists(){
      const [cR,mR]=await Promise.all([
        apiFetch('/api/colleges'),
        apiFetch('/api/committee-names?q=').catch(()=>apiFetch('/api/committees-master'))
      ]);
      const colleges=await cR.json().catch(()=>[]);
      const committees=await mR.json().catch(()=>[]);
      const collegeSel=document.getElementById('collegeSelect');
      const committeeSel=document.getElementById('committeeSelect');
      (colleges||[]).forEach(c=>{const n=normalizeName(c);if(!n)return;const o=document.createElement('option');o.value=o.textContent=n;collegeSel.appendChild(o);});
      (committees||[]).forEach(c=>{const n=normalizeName(c);if(!n)return;const o=document.createElement('option');o.value=o.textContent=n;committeeSel.appendChild(o);});
    }

    /* ====== ุงูุญุงูุฉ ุงูุนุงูุฉ ====== */
    const state={
      college:'',
      committee_name:'',
      term:'',
      academicYear:'',
      formation_decision:null, // {type:'url', value:'...'}
      work_plan:null,
      invitations:[], // [{value, title}]
      minutes:[],
      coverage_letters:[],
      report1:null, report2:null, report3:null,
      statistical_analysis:null
    };

    /* ====== ููุฎุต ูุญุงูุฉ ุงูุฃุฒุฑุงุฑ ====== */
    function refreshSummary(){
      document.getElementById('sumCollege').textContent=state.college||'โ';
      document.getElementById('sumCommittee').textContent=state.committee_name||'โ';
      document.getElementById('sumTermAy').textContent=(state.term||'โ')+' / '+(state.academicYear||'โ');
      document.getElementById('sumFD').textContent=state.formation_decision? 'ุฑุงุจุท' : 'โ';
      document.getElementById('sumWP').textContent=state.work_plan? 'ุฑุงุจุท' : 'โ';
      document.getElementById('sumInv').textContent=state.invitations.length;
      document.getElementById('sumMin').textContent=state.minutes.length;
      document.getElementById('sumCov').textContent=state.coverage_letters.length;
      document.getElementById('sumR1').textContent=state.report1? 'ุฑุงุจุท' : 'โ';
      document.getElementById('sumR2').textContent=state.report2? 'ุฑุงุจุท' : 'โ';
      document.getElementById('sumR3').textContent=state.report3? 'ุฑุงุจุท' : 'โ';
      document.getElementById('sumSA').textContent=state.statistical_analysis? 'ุฑุงุจุท' : 'โ';
      document.getElementById('badgeInv').textContent=state.invitations.length;
      document.getElementById('badgeMin').textContent=state.minutes.length;
      document.getElementById('badgeCov').textContent=state.coverage_letters.length;
      toggleActions();
    }
    function toggleActions(){
      const requiredFilled = !!(state.college && state.committee_name && state.term && validAcademicYear(state.academicYear));
      document.getElementById('saveBtn').classList.toggle('disabled-cover',!requiredFilled);
    }

    /* ====== ุฑุจุท ูุฏุฎูุงุช ุงููููุฉ ====== */
    document.getElementById('collegeSelect').addEventListener('change',e=>{state.college=e.target.value;refreshSummary();});
    document.getElementById('committeeSelect').addEventListener('change',e=>{state.committee_name=e.target.value;refreshSummary();});
    document.getElementById('termSelect').addEventListener('change',e=>{state.term=e.target.value;refreshSummary();});

    /* ====== ุงูุชุญูู ูู ุงูุนุงู ุงูุฌุงูุนู ====== */
    const ayInput=document.getElementById('academicYearInput');
    function validAcademicYear(v){
      if(!v) return false;
      const rx=/^(20\d{2})[\/-](20\d{2})$/; // ูุซู ุงูุณูุฑูุฑ
      return rx.test(String(v).trim());
    }
    function normalizeAcademicYear(v){
      const t=String(v).trim();
      if(!validAcademicYear(t)) return '';
      const m=t.match(/(20\d{2}).*(20\d{2})/);
      if(!m) return t;
      return `${m[1]}-${m[2]}`; // ูุฎุฒููุง ุฏุงุฆูุงู ุจุดุฑุทุฉ
    }
    ayInput.addEventListener('input',()=>{
      const v=ayInput.value;
      const ok=validAcademicYear(v);
      ayInput.classList.toggle('is-invalid',!ok && v.trim().length>0);
      state.academicYear = ok ? normalizeAcademicYear(v) : '';
      refreshSummary();
    });

    /* ====== ุงูุชุญูู ูู ุงูุฑูุงุจุท ====== */
    function isValidUrl(u){ try{ new URL(u); return true; } catch{ return false; } }
    function wireSingleUrl(inputId, setter){
      const el=document.getElementById(inputId);
      el.addEventListener('input',()=>{
        const v=el.value.trim();
        if(!v){ setter(null); el.classList.remove('is-invalid'); refreshSummary(); return; }
        if(isValidUrl(v)){ setter({type:'url', value:v}); el.classList.remove('is-invalid'); }
        else{ setter(null); el.classList.add('is-invalid'); }
        refreshSummary();
      });
    }
    wireSingleUrl('fdUrl', (x)=>state.formation_decision=x);
    wireSingleUrl('wpUrl', (x)=>state.work_plan=x);
    wireSingleUrl('r1Url', (x)=>state.report1=x);
    wireSingleUrl('r2Url', (x)=>state.report2=x);
    wireSingleUrl('r3Url', (x)=>state.report3=x);
    wireSingleUrl('saUrl', (x)=>state.statistical_analysis=x);

    /* ====== ุงูููุงุฆู ุงููุชุนุฏุฏุฉ (ุฑูุงุจุท ููุท) ====== */
    function addMultiUrlRow(listEl, arrRef){
      const row=document.createElement('div');
      row.className='list-row';
      row.innerHTML=`
        <span class="index">#</span>
        <div class="flex-grow-1">
          <div class="input-group">
            <span class="input-group-text"><i class="bi bi-link-45deg"></i></span>
            <input type="url" class="form-control url-input" placeholder="https://example.com/doc.pdf">
          </div>
          <div class="form-text">ููููู ูุชุงุจุฉ ุนููุงู ูุฎุชุตุฑ (ุงุฎุชูุงุฑู).</div>
          <input type="text" class="form-control form-control-sm mt-1 title-input" placeholder="ุนููุงู ุงุฎุชูุงุฑู">
        </div>
        <div class="actions ms-2">
          <button class="btn btn-outline-danger"><i class="bi bi-trash"></i></button>
        </div>
      `;
      const idxSpan=row.querySelector('.index');
      const urlInput=row.querySelector('.url-input');
      const titleInput=row.querySelector('.title-input');
      const delBtn=row.querySelector('.actions .btn');

      const item={value:'', title:''};
      arrRef.push(item);

      function refreshIndex(){ idxSpan.textContent = (Array.from(listEl.children).indexOf(row)+1); }

      urlInput.addEventListener('input',()=>{
        const v=urlInput.value.trim();
        if(isValidUrl(v)){ item.value=v; urlInput.classList.remove('is-invalid'); }
        else{ item.value=''; if(v) urlInput.classList.add('is-invalid'); else urlInput.classList.remove('is-invalid'); }
        refreshSummary();
      });
      titleInput.addEventListener('input',()=>{ item.title=titleInput.value.trim(); });

      delBtn.addEventListener('click',()=>{
        const i=arrRef.indexOf(item);
        if(i>=0) arrRef.splice(i,1);
        row.remove();
        Array.from(listEl.children).forEach(refreshIndex);
        refreshSummary();
      });

      listEl.appendChild(row);
      Array.from(listEl.children).forEach(refreshIndex);
      refreshSummary();
    }
    document.getElementById('addInvitationBtn').addEventListener('click',()=>addMultiUrlRow(document.getElementById('invitationsList'), state.invitations));
    document.getElementById('addMinuteBtn').addEventListener('click',()=>addMultiUrlRow(document.getElementById('minutesList'), state.minutes));
    document.getElementById('addCoverageBtn').addEventListener('click',()=>addMultiUrlRow(document.getElementById('coverageList'), state.coverage_letters));

    /* ====== ุจูุงุก ุงูุญูููุฉ ูุญูุธ/ุชูุฑูุบ ====== */
    function buildPayload(){
      return {
        college: state.college,
        committee_name: state.committee_name,
        term: state.term,
        academicYear: state.academicYear, // ููุทุจูุน ุจุตูุบุฉ 2024-2025
        formation_decision: state.formation_decision,
        work_plan: state.work_plan,
        invitations: state.invitations.filter(x=>x.value).map(x=>({ type:'url', value:x.value, title:x.title||'' })),
        minutes: state.minutes.filter(x=>x.value).map(x=>({ type:'url', value:x.value, title:x.title||'' })),
        coverage_letters: state.coverage_letters.filter(x=>x.value).map(x=>({ type:'url', value:x.value, title:x.title||'' })),
        report1: state.report1,
        report2: state.report2,
        report3: state.report3,
        statistical_analysis: state.statistical_analysis
      };
    }

    document.getElementById('saveBtn').addEventListener('click',async()=>{
      try{
        // ุชุญูู ุงูุญููู ุงูุฅูุฒุงููุฉ
        if(!state.college){ alert('ุงูุฑุฌุงุก ุงุฎุชูุงุฑ ุงููููุฉ'); return; }
        if(!state.committee_name){ alert('ุงูุฑุฌุงุก ุงุฎุชูุงุฑ ุงุณู ุงููุฌูุฉ'); return; }
        if(!state.term){ alert('ุงูุฑุฌุงุก ุงุฎุชูุงุฑ ุงููุตู ุงูุฏุฑุงุณู'); return; }
        if(!validAcademicYear(ayInput.value)){ ayInput.classList.add('is-invalid'); ayInput.focus(); alert('ุตูุบุฉ ุงูุนุงู ุงูุฌุงูุนู ุบูุฑ ุตุญูุญุฉ'); return; }

        const payload=buildPayload();
        console.log('Prepared payload (preview only):', payload);
        // ูุงุญููุง: ุฅุฑุณุงู ุฅูู ุงูุฎุงุฏู
        // await fetch(`${API_BASE}/api/committees-files`, { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify(payload), credentials:'include' });
        toastSuccess.show();
      }catch(e){ console.error(e); toastError.show(); }
    });

    document.getElementById('resetBtn').addEventListener('click',()=>location.reload());

    /* ====== ุจุฏุก ุงูุชุดุบูู ====== */
    (async function init(){
      try{
        await ensureAuth();
        await loadDatalists();
        refreshSummary();
      }catch{}
    })();
  </script>
</body>
</html>
